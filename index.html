<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Gaming Hub</title>
  <link id="favicon" rel="icon" href="https://www.google.com/s2/favicons?domain=classroom.google.com&sz=64" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&family=Raleway:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dark Theme (Default) */
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #aaaaaa;
      --text-muted: #666666;
      --accent: #ff8800;
      --accent-hover: #ff6600;
      --success: #00ff00;
      --danger: #cc0000;
      --warning: #ffcc00;
      --info: #0066cc;
    }

    [data-theme="light"] {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e0e0e0;
      --text-primary: #1a1a1a;
      --text-secondary: #555555;
      --text-muted: #888888;
      --accent: #ff6600;
      --accent-hover: #ff4400;
    }

    [data-theme="neon"] {
      --bg-primary: #0a0a1a;
      --bg-secondary: #1a1a3a;
      --bg-tertiary: #2a2a4a;
      --text-primary: #ffffff;
      --text-secondary: #bb99ff;
      --text-muted: #7755aa;
      --accent: #ff00ff;
      --accent-hover: #cc00cc;
      --success: #00ffff;
      --danger: #ff0066;
      --warning: #ffff00;
      --info: #00ccff;
    }

    [data-theme="ocean"] {
      --bg-primary: #0a1628;
      --bg-secondary: #152238;
      --bg-tertiary: #1e3a5f;
      --text-primary: #e0f0ff;
      --text-secondary: #8ab4d4;
      --text-muted: #5588aa;
      --accent: #00bfff;
      --accent-hover: #0099cc;
      --success: #00ff88;
      --danger: #ff4466;
    }

    [data-theme="forest"] {
      --bg-primary: #0a1a0a;
      --bg-secondary: #1a2a1a;
      --bg-tertiary: #2a3a2a;
      --text-primary: #e0ffe0;
      --text-secondary: #88bb88;
      --text-muted: #558855;
      --accent: #44ff44;
      --accent-hover: #22cc22;
      --success: #88ff88;
      --danger: #ff6644;
    }

    [data-theme="sunset"] {
      --bg-primary: #1a0a0a;
      --bg-secondary: #2a1515;
      --bg-tertiary: #3a2020;
      --text-primary: #ffe0d0;
      --text-secondary: #dd9988;
      --text-muted: #aa6655;
      --accent: #ff6644;
      --accent-hover: #ff4422;
      --success: #ffaa44;
      --danger: #ff2222;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    html, body {
      margin: 0 !important;
      padding: 0 !important;
      background-color: var(--bg-primary) !important;
      font-family: 'Poppins', sans-serif;
      color: var(--text-primary);
      width: 100% !important;
      height: 100% !important;
      overflow-x: hidden;
    }

    /* Font Classes */
    .font-poppins { font-family: 'Poppins', sans-serif; }
    .font-roboto { font-family: 'Roboto', sans-serif; }
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-opensans { font-family: 'Open Sans', sans-serif; }
    .font-raleway { font-family: 'Raleway', sans-serif; }

    /* Compact Mode */
    .compact-mode .game-card { width: 160px; padding: 10px; }
    .compact-mode .game-thumbnail { height: 80px; font-size: 30px; }
    .compact-mode .game-info h3 { font-size: 12px; }
    .compact-mode .sidebar { width: 300px; }
    .compact-mode .chat-panel { width: 300px; height: 400px; }
    .compact-mode .profile-pic-large { width: 60px; height: 60px; }
    .compact-mode .friend-card { padding: 8px; }
    .compact-mode .sidebar-btn { padding: 6px 12px; font-size: 12px; }

    /* ===== PARTICLES ===== */
    #particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      pointer-events: none;
      animation: fall linear infinite;
    }

    .particle.snow {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      box-shadow: 0 0 10px white;
    }

    .particle.star {
      width: 3px;
      height: 3px;
      background: gold;
      border-radius: 50%;
      box-shadow: 0 0 6px gold;
      animation: twinkle 2s ease-in-out infinite, fall linear infinite;
    }

    .particle.rain {
      width: 2px;
      height: 15px;
      background: linear-gradient(to bottom, transparent, #88ccff);
      border-radius: 2px;
    }

    .particle.confetti {
      width: 10px;
      height: 10px;
      animation: confettiFall linear infinite;
    }

    .particle.hearts {
      font-size: 16px;
      animation: floatUp 4s ease-in-out infinite;
    }

    .particle.bubbles {
      width: 15px;
      height: 15px;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 50%;
      animation: floatUp 5s ease-in-out infinite;
    }

    @keyframes fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    @keyframes confettiFall {
      0% { transform: translateY(-10px) rotate(0deg) scale(1); }
      100% { transform: translateY(100vh) rotate(720deg) scale(0.5); }
    }

    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-10px) scale(1); opacity: 0; }
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s, visibility 0.5s;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 4px solid var(--bg-tertiary);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: var(--accent);
      margin-top: 20px;
      font-size: 18px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-quote {
      color: var(--text-secondary);
      margin-top: 15px;
      font-size: 14px;
      font-style: italic;
      max-width: 400px;
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ===== CUSTOM BACKGROUND ===== */
    .custom-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      z-index: -1;
      opacity: 0.3;
    }

/* ============ SKELETON LOADING ============ */
.skeleton {
    animation: skeleton-loading 1s linear infinite alternate;
    border-radius: 8px;
}

@keyframes skeleton-loading {
    0% { background-color: hsl(200, 20%, 80%); }
    100% { background-color: hsl(200, 20%, 95%); }
}

.skeleton-text {
    width: 100%;
    height: 1rem;
    margin-bottom: 0.5rem;
    border-radius: 4px;
}

.skeleton-text:last-child {
    width: 80%;
}

.skeleton-avatar {
    width: 50px;
    height: 50px;
    border-radius: 50%;
}

.skeleton-post {
    padding: 20px;
    margin-bottom: 20px;
    border-radius: 12px;
    background: var(--card-bg);
}

/* Dark mode skeleton */
.dark-mode .skeleton {
    animation: skeleton-loading-dark 1s linear infinite alternate;
}

@keyframes skeleton-loading-dark {
    0% { background-color: hsl(200, 20%, 20%); }
    100% { background-color: hsl(200, 20%, 30%); }
}

/* ============ PAGE TRANSITIONS ============ */
.page-transition {
    animation: pageSlide 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes pageSlide {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.fade-in {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

/* ============ TOAST NOTIFICATIONS ============ */
.toast-container {
    position: fixed;
    top: 80px;
    right: 20px;
    z-index: 10000;
    display: flex;
    flex-direction: column;
    gap: 10px;
    pointer-events: none;
}

.toast {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 16px 24px;
    border-radius: 12px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    display: flex;
    align-items: center;
    gap: 12px;
    min-width: 300px;
    max-width: 500px;
    position: relative;
    overflow: hidden;
    pointer-events: all;
    cursor: pointer;
    animation: slideInRight 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}

.toast.success {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
}

.toast.error {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
}

.toast.info {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
}

.toast.warning {
    background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

.toast-exit {
    animation: slideOutRight 0.3s forwards;
}

@keyframes slideOutRight {
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.toast-icon {
    font-size: 24px;
}

.toast-progress {
    position: absolute;
    bottom: 0;
    left: 0;
    height: 4px;
    width: 100%;
    background: rgba(255,255,255,0.3);
    animation: progress 3s linear;
}

@keyframes progress {
    from { width: 100%; }
    to { width: 0%; }
}

/* ============ ACHIEVEMENT BADGES ============ */
.achievement-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(0);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    padding: 30px;
    border-radius: 20px;
    color: white;
    text-align: center;
    z-index: 10001;
    animation: achievementPop 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
}

@keyframes achievementPop {
    to {
        transform: translate(-50%, -50%) scale(1);
    }
}

.achievement-icon {
    font-size: 60px;
    margin-bottom: 15px;
    animation: bounce 1s infinite;
}

@keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.achievement-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 20px;
    padding: 20px;
}

.achievement-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    position: relative;
    transition: transform 0.3s, box-shadow 0.3s;
    cursor: pointer;
}

.achievement-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.achievement-card.locked {
    opacity: 0.5;
    filter: grayscale(1);
}

.achievement-card.legendary {
    background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    color: white;
}

.achievement-card.epic {
    background: linear-gradient(135deg, #8e2de2 0%, #4a00e0 100%);
    color: white;
}

.achievement-card.rare {
    background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    color: white;
}

/* ============ BATTLE PASS ============ */
.battle-pass-container {
    background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
    padding: 30px;
    border-radius: 20px;
    margin: 20px;
    color: white;
}

.battle-pass-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.battle-pass-tier {
    display: flex;
    align-items: center;
    gap: 15px;
    font-size: 24px;
    font-weight: bold;
}

.tier-icon {
    width: 60px;
    height: 60px;
    background: linear-gradient(135deg, #f2994a 0%, #f2c94c 100%);
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 30px;
}

.battle-pass-progress {
    background: rgba(255,255,255,0.2);
    height: 30px;
    border-radius: 15px;
    overflow: hidden;
    margin-bottom: 30px;
}

.battle-pass-progress-fill {
    background: linear-gradient(90deg, #56ab2f 0%, #a8e063 100%);
    height: 100%;
    border-radius: 15px;
    transition: width 0.5s ease;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding-right: 10px;
    font-weight: bold;
}

.battle-pass-rewards {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    padding-bottom: 10px;
}

.reward-item {
    min-width: 100px;
    text-align: center;
    padding: 15px;
    background: rgba(255,255,255,0.1);
    border-radius: 12px;
    transition: all 0.3s;
    cursor: pointer;
}

.reward-item:hover {
    background: rgba(255,255,255,0.2);
    transform: scale(1.05);
}

.reward-item.claimed {
    background: rgba(86, 171, 47, 0.3);
    border: 2px solid #56ab2f;
}

.reward-item.locked {
    opacity: 0.5;
    cursor: not-allowed;
}

/* ============ VIRTUAL PET ============ */
.virtual-pet-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
}

.virtual-pet {
    width: 80px;
    height: 80px;
    background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23ffeb3b"/><circle cx="35" cy="40" r="5" fill="%23000"/><circle cx="65" cy="40" r="5" fill="%23000"/><path d="M 30 60 Q 50 70 70 60" stroke="%23000" stroke-width="3" fill="none"/></svg>') no-repeat center;
    background-size: contain;
    cursor: pointer;
    animation: petBounce 2s ease-in-out infinite;
    transition: all 0.3s;
}

@keyframes petBounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
}

.virtual-pet:hover {
    transform: scale(1.2) rotate(10deg);
}

.pet-stats {
    background: var(--card-bg);
    padding: 15px;
    border-radius: 12px;
    position: absolute;
    bottom: 100px;
    right: 0;
    width: 200px;
    display: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}

.pet-stats.show {
    display: block;
    animation: fadeIn 0.3s;
}

.pet-stat {
    display: flex;
    justify-content: space-between;
    margin: 10px 0;
}

.pet-stat-bar {
    width: 100px;
    height: 10px;
    background: #ddd;
    border-radius: 5px;
    overflow: hidden;
}

.pet-stat-fill {
    height: 100%;
    transition: width 0.3s;
}

.pet-stat-fill.health {
    background: linear-gradient(90deg, #e74c3c, #c0392b);
}

.pet-stat-fill.happiness {
    background: linear-gradient(90deg, #f39c12, #e67e22);
}

.pet-stat-fill.hunger {
    background: linear-gradient(90deg, #27ae60, #2ecc71);
}

/* ============ KONAMI CODE EASTER EGG ============ */
.konami-activated {
    animation: rainbow 2s linear infinite;
}

@keyframes rainbow {
    0% { filter: hue-rotate(0deg); }
    100% { filter: hue-rotate(360deg); }
}

.matrix-rain {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    opacity: 0.1;
}

.matrix-rain canvas {
    width: 100%;
    height: 100%;
}

/* ============ ENHANCED THEMES ============ */
.theme-cyberpunk {
    --bg-color: #0a0e27;
    --text-color: #00ff9f;
    --card-bg: linear-gradient(135deg, #1e1e3f 0%, #2a2a5e 100%);
    --accent: #ff00ff;
    --border: #00ffff;
}

.theme-retrowave {
    --bg-color: #1a0033;
    --text-color: #ff71ce;
    --card-bg: linear-gradient(135deg, #2e0057 0%, #4a0080 100%);
    --accent: #01cdfe;
    --border: #ffb700;
}

.theme-forest {
    --bg-color: #0d1f0d;
    --text-color: #8bc34a;
    --card-bg: linear-gradient(135deg, #1b3a1b 0%, #2e5a2e 100%);
    --accent: #4caf50;
    --border: #689f38;
}

.theme-ocean {
    --bg-color: #001f3f;
    --text-color: #7fdbff;
    --card-bg: linear-gradient(135deg, #003366 0%, #004d99 100%);
    --accent: #39cccc;
    --border: #0074d9;
}

.theme-sunset {
    --bg-color: #2c1810;
    --text-color: #ffd700;
    --card-bg: linear-gradient(135deg, #4a2c2a 0%, #6e4c41 100%);
    --accent: #ff6b6b;
    --border: #ffa500;
}

/* Custom Theme Builder */
.theme-builder {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    padding: 30px;
    border-radius: 20px;
    z-index: 10000;
    width: 400px;
    max-height: 80vh;
    overflow-y: auto;
    display: none;
}

.theme-builder.show {
    display: block;
    animation: fadeIn 0.3s;
}

.color-picker-group {
    margin: 15px 0;
}

.color-picker-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.color-picker-group input[type="color"] {
    width: 100%;
    height: 40px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

/* ============ ADMIN FEATURES ============ */
.admin-badge {
    background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    color: white;
    padding: 5px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: bold;
    display: inline-block;
    margin-left: 10px;
}

.ban-modal {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--card-bg);
    padding: 30px;
    border-radius: 20px;
    z-index: 10000;
    width: 400px;
    display: none;
}

.ban-modal.show {
    display: block;
    animation: fadeIn 0.3s;
}

.ban-form-group {
    margin: 15px 0;
}

.ban-form-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
}

.ban-form-group input,
.ban-form-group select,
.ban-form-group textarea {
    width: 100%;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: var(--bg-color);
    color: var(--text-color);
}

/* ============ INFINITE SCROLL ============ */
.infinite-scroll-loader {
    text-align: center;
    padding: 20px;
    display: none;
}

.infinite-scroll-loader.show {
    display: block;
}

.infinite-scroll-end {
    text-align: center;
    padding: 20px;
    color: var(--text-color);
    opacity: 0.6;
    display: none;
}

.infinite-scroll-end.show {
    display: block;
}




    
    /* ===== TAB CLOAK MODAL ===== */
    .cloak-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 3000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .cloak-modal.open {
      display: flex;
    }

    .cloak-box {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      border: 2px solid var(--accent);
    }

    .cloak-box h2 {
      color: var(--accent);
      margin: 0 0 20px 0;
      text-align: center;
    }

    .cloak-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .cloak-option {
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
    }

    .cloak-option:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
    }

    .cloak-option img {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
    }

    .cloak-option span {
      display: block;
      color: var(--text-primary);
      font-size: 13px;
    }

    .cloak-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .about-blank-btn {
      background: linear-gradient(135deg, var(--info), #0044aa);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      transition: 0.3s;
    }

    .about-blank-btn:hover {
      transform: scale(1.05);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      width: 100%;
      margin: 0;
      padding: 0;
      background-color: transparent;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* ===== STATS BANNER ===== */
    .stats-banner {
      background: linear-gradient(90deg, var(--bg-secondary), var(--bg-tertiary));
      padding: 12px 20px;
      display: flex;
      justify-content: center;
      gap: 40px;
      border-bottom: 1px solid var(--bg-tertiary);
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      color: var(--accent);
      font-size: 20px;
      font-weight: bold;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 11px;
    }

    /* ===== NAVBAR ===== */
    .navbar {
      background-color: var(--bg-secondary);
      padding: 15px;
      text-align: center;
      width: 100%;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--bg-tertiary);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .navbar a {
      color: var(--text-primary);
      text-decoration: none;
      margin: 0 10px;
      font-size: 16px;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }

    .navbar a:hover {
      color: var(--accent);
    }

    .navbar a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--accent);
      transition: width 0.3s;
    }

    .navbar a:hover::after {
      width: 100%;
    }

    #usernameDisplay {
      color: var(--success);
      font-size: 14px;
      margin-left: 10px;
    }

    /* ===== XP BAR ===== */
    .xp-bar-container {
      background: var(--bg-primary);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .level-badge {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    .xp-bar {
      flex: 1;
      height: 20px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .xp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      border-radius: 10px;
      transition: width 0.5s ease-out;
      position: relative;
    }

    .xp-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .xp-text {
      color: var(--text-secondary);
      font-size: 12px;
      min-width: 120px;
      text-align: right;
    }

    .coins-display {
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--bg-tertiary);
      padding: 5px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .coins-display:hover {
      background: var(--bg-secondary);
    }

    .coins-display span {
      color: gold;
      font-weight: bold;
    }

    /* ===== SIDEBAR ===== */
    .sidebar-toggle {
      position: fixed;
      top: 150px;
      right: 0;
      background-color: var(--success);
      color: black;
      border: none;
      padding: 10px 8px;
      font-size: 20px;
      cursor: pointer;
      border-radius: 5px 0 0 5px;
      z-index: 1000;
      transition: 0.3s;
    }

    .sidebar-toggle:hover {
      background-color: #00cc00;
      transform: translateX(-3px);
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background-color: var(--bg-secondary);
      transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999;
      overflow-y: auto;
      padding: 20px;
      border-left: 2px solid var(--success);
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar h2 {
      color: var(--text-primary);
      text-align: center;
      margin-top: 10px;
    }

    .sidebar h3 {
      color: var(--accent);
      margin: 20px 0 10px 0;
      font-size: 18px;
    }

    .sidebar label {
      color: var(--text-secondary);
      font-size: 13px;
      display: block;
      margin-bottom: 5px;
    }

    .sidebar-input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      margin-bottom: 10px;
      transition: 0.3s;
    }

    .sidebar-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .sidebar-input::placeholder {
      color: var(--text-muted);
    }

    .sidebar-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .sidebar-btn:hover {
      transform: translateY(-2px);
    }

    .sidebar-btn-green { background-color: var(--success); color: black; }
    .sidebar-btn-green:hover { box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3); }

    .sidebar-btn-orange { background-color: var(--accent); color: black; }
    .sidebar-btn-orange:hover { box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3); }

    .sidebar-btn-gray { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .sidebar-btn-gray:hover { background-color: #444; }

    .sidebar-btn-red { background-color: var(--danger); color: white; }
    .sidebar-btn-red:hover { box-shadow: 0 4px 15px rgba(204, 0, 0, 0.3); }

    .sidebar-btn-blue { background-color: var(--info); color: white; }
    .sidebar-btn-blue:hover { box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3); }

    .sidebar-btn-purple { background-color: #9b59b6; color: white; }
    .sidebar-btn-purple:hover { box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }

    .sidebar-divider {
      border: none;
      border-top: 1px solid var(--bg-tertiary);
      margin: 15px 0;
    }

    .sidebar-close {
      position: absolute;
      top: 10px;
      right: 15px;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      transition: 0.3s;
    }

    .sidebar-close:hover {
      color: var(--accent);
      transform: rotate(90deg);
    }

    /* ===== SIDEBAR TABS ===== */
    .sidebar-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .sidebar-tab {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      transition: 0.3s;
      min-width: 45px;
    }

    .sidebar-tab.active {
      background-color: var(--accent);
      color: black;
    }

    .sidebar-tab.admin-tab {
      background-color: #660000;
      color: #ff6666;
    }

    .sidebar-tab.admin-tab.active {
      background-color: var(--danger);
      color: white;
    }

    .sidebar-panel {
      display: none;
      animation: fadeIn 0.3s;
    }

    .sidebar-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== PROFILE STYLES ===== */
    .profile-card {
      background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
      border-radius: 15px;
      padding: 0;
      margin-bottom: 15px;
      text-align: center;
      border: 1px solid var(--bg-tertiary);
      transition: 0.3s;
      overflow: hidden;
    }

    .profile-card:hover {
      border-color: var(--accent);
    }

    .profile-banner {
      width: 100%;
      height: 80px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      background-size: cover;
      background-position: center;
    }

    .profile-card-content {
      padding: 15px;
      margin-top: -40px;
    }

    .profile-pic-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-secondary);
      display: block;
      margin: 0 auto 10px auto;
      transition: 0.3s;
      background: var(--bg-tertiary);
    }

    .profile-pic-large:hover {
      transform: scale(1.1);
    }

    .profile-name {
      color: var(--text-primary);
      font-size: 18px;
      margin: 5px 0;
      font-weight: 600;
    }

    .profile-level {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .profile-role {
      color: var(--accent);
      font-size: 13px;
    }

    .profile-bio {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 5px;
    }

    .profile-status {
      color: var(--success);
      font-size: 12px;
      margin-top: 8px;
      padding: 5px 10px;
      background-color: rgba(0, 255, 0, 0.1);
      border-radius: 15px;
      display: inline-block;
    }

    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--bg-tertiary);
    }

    .profile-stat {
      text-align: center;
    }

    .profile-stat-num {
      color: var(--accent);
      font-size: 18px;
      font-weight: bold;
    }

    .profile-stat-label {
      color: var(--text-muted);
      font-size: 11px;
    }

    .owner-badge { color: var(--success); font-size: 11px; font-weight: bold; }
    .coowner-badge { color: var(--accent); font-size: 11px; font-weight: bold; }

    /* ===== FRIEND CARDS ===== */
    .friend-card {
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: 0.3s;
      cursor: pointer;
    }

    .friend-card:hover {
      background-color: #3a3a3a;
      transform: translateX(5px);
    }

    .friend-card img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .friend-card-info { flex: 1; }

    .friend-card-name {
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
    }

    .friend-card-status {
      color: var(--text-muted);
      font-size: 11px;
    }

    .friend-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: 0.3s;
    }

    /* ===== STATUS DOT ===== */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .status-online {
      background-color: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .status-offline {
      background-color: var(--text-muted);
    }

    /* ===== CHAT STYLES ===== */
    .chat-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      border: none;
      padding: 15px 25px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 50px;
      z-index: 1000;
      transition: all 0.3s;
      font-family: inherit;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(255, 136, 0, 0.4);
    }

    .chat-toggle:hover {
      transform: scale(1.05) translateY(-2px);
    }

    .chat-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--danger);
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 50%;
      display: none;
      animation: pulse 1s infinite;
    }

    .chat-panel {
      position: fixed;
      bottom: 90px;
      left: 20px;
      width: 400px;
      height: 520px;
      background-color: var(--bg-secondary);
      border-radius: 20px;
      border: 2px solid var(--accent);
      z-index: 999;
      display: none;
      flex-direction: column;
      overflow: hidden;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
    }

    .chat-panel.open {
      display: flex;
      animation: scaleIn 0.3s;
    }

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .chat-header {
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
      padding: 15px 20px;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .chat-header-tabs {
      display: flex;
      gap: 8px;
    }

    .chat-header-tab {
      padding: 6px 14px;
      border: none;
      border-radius: 15px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
      transition: 0.3s;
      font-family: inherit;
    }

    .chat-header-tab.active {
      background-color: var(--accent);
      color: black;
    }

    .chat-close {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .chat-close:hover {
      color: var(--accent);
      transform: rotate(90deg);
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .chat-message {
      background-color: var(--bg-tertiary);
      border-radius: 15px;
      padding: 12px;
      max-width: 85%;
      position: relative;
    }

    .chat-message.mine {
      align-self: flex-end;
      background: linear-gradient(135deg, #3a3a00, #2a2a00);
      border: 1px solid var(--accent);
    }

    .chat-message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .chat-message-pic {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      transition: 0.3s;
    }

    .chat-message-pic:hover {
      transform: scale(1.1);
    }

    .chat-message-name {
      color: var(--accent);
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
    }

    .chat-message-name:hover {
      text-decoration: underline;
    }

    .chat-message-level {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .chat-message-time {
      color: var(--text-muted);
      font-size: 10px;
      margin-left: auto;
    }

    .chat-message-text {
      color: var(--text-primary);
      font-size: 14px;
      word-wrap: break-word;
      line-height: 1.4;
    }

    .chat-message-text .mention {
      color: var(--info);
      background: rgba(0, 102, 204, 0.2);
      padding: 1px 4px;
      border-radius: 4px;
      cursor: pointer;
    }

    .chat-input-area {
      padding: 15px;
      background-color: var(--bg-tertiary);
      display: flex;
      gap: 10px;
      align-items: center;
    }

    .chat-input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      border-radius: 25px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: 0.3s;
    }

    .chat-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .chat-send {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      transition: 0.3s;
    }

    .chat-send:hover {
      transform: scale(1.05);
    }

    /* ===== TYPING INDICATOR ===== */
    .typing-indicator {
      padding: 10px 15px;
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
      display: none;
    }

    .typing-indicator.show {
      display: block;
    }

    .typing-dots {
      display: inline-flex;
      gap: 3px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background-color: var(--text-muted);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    /* ===== EMOJI REACTIONS ===== */
    .emoji-reactions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      background-color: var(--bg-secondary);
      border: none;
      padding: 4px 8px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
    }

    .emoji-btn:hover {
      background-color: var(--bg-tertiary);
      transform: scale(1.1);
    }

    .emoji-btn.active {
      background-color: var(--accent);
    }

    .reaction-count {
      font-size: 11px;
      color: var(--text-primary);
      margin-left: 3px;
    }

    .add-reaction-btn {
      background-color: var(--bg-secondary);
      border: none;
      padding: 4px 10px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-muted);
      transition: 0.3s;
    }

    .add-reaction-btn:hover {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 10px;
      display: none;
      gap: 5px;
      flex-wrap: wrap;
      width: 220px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .emoji-picker.show {
      display: flex;
    }

    .emoji-picker button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: 0.2s;
    }

    .emoji-picker button:hover {
      background-color: var(--bg-secondary);
      transform: scale(1.2);
    }

    /* ===== MENTIONS DROPDOWN ===== */
    .mentions-dropdown {
      position: absolute;
      bottom: 100%;
      left: 15px;
      right: 15px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
    }

    .mentions-dropdown.show {
      display: block;
    }

    .mention-option {
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .mention-option:hover {
      background: var(--bg-secondary);
    }

    .mention-option img {
      width: 25px;
      height: 25px;
      border-radius: 50%;
    }

    .mention-option span {
      color: var(--text-primary);
      font-size: 13px;
    }

    /* ===== GAME CARDS ===== */
    .games-list {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      padding: 20px;
    }

    .game-link {
      text-decoration: none;
      color: inherit;
    }

    .game-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 15px;
      padding: 0;
      width: 220px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--bg-tertiary);
    }

    .game-card:hover {
      transform: translateY(-8px);
      border-color: var(--accent);
      box-shadow: 0 10px 30px rgba(255, 136, 0, 0.2);
    }

    .game-thumbnail {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
    }

    .game-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .game-info {
      padding: 15px;
    }

    .game-card h3 {
      color: var(--accent);
      margin: 0 0 8px 0;
      font-size: 14px;
    }

    .game-rating {
      display: flex;
      justify-content: center;
      gap: 3px;
      margin-bottom: 5px;
    }

    .game-rating .star {
      color: var(--bg-tertiary);
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .game-rating .star.filled {
      color: gold;
    }

    .game-rating .star:hover {
      transform: scale(1.2);
    }

    .game-rating-count {
      color: var(--text-muted);
      font-size: 11px;
    }

    .game-playtime {
      color: var(--text-muted);
      font-size: 10px;
      margin-top: 5px;
    }

    .fav-star {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
      transition: 0.3s;
      color: white;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .fav-star:hover {
      transform: scale(1.3);
      color: var(--accent);
    }

    .fav-star.favorited {
      color: var(--accent);
    }

    /* ===== RANDOM GAME BUTTON ===== */
    .random-game-btn {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      margin: 20px auto;
      display: block;
      transition: 0.3s;
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
    }

    .random-game-btn:hover {
      transform: scale(1.05);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px) rotate(-5deg); }
      75% { transform: translateX(10px) rotate(5deg); }
    }

    /* ===== MINI GAMES MODAL ===== */
    .minigame-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2500;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .minigame-modal.open {
      display: flex;
    }

    .minigame-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 20px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      position: relative;
    }

    .minigame-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 30px;
      cursor: pointer;
    }

    .minigame-canvas {
      border: 2px solid var(--accent);
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .minigame-controls {
      text-align: center;
      margin-top: 15px;
      color: var(--text-secondary);
    }

    .minigame-score {
      color: var(--accent);
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }

    /* ===== SHOP MODAL ===== */
    .shop-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .shop-modal.open {
      display: flex;
    }

    .shop-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--accent);
    }

    .shop-header {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shop-header h2 {
      margin: 0;
      font-size: 24px;
    }

    .shop-coins {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 20px;
      font-weight: bold;
    }

    .shop-close {
      background: none;
      border: none;
      font-size: 30px;
      cursor: pointer;
      color: black;
    }

    .shop-tabs {
      display: flex;
      background: var(--bg-tertiary);
      padding: 10px;
      gap: 10px;
      overflow-x: auto;
    }

    .shop-tab {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      transition: 0.3s;
    }

    .shop-tab.active {
      background: var(--accent);
      color: black;
    }

    .shop-items {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .shop-item {
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 2px solid transparent;
      transition: 0.3s;
      cursor: pointer;
    }

    .shop-item:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
    }

    .shop-item.owned {
      border-color: var(--success);
      opacity: 0.7;
    }

    .shop-item-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .shop-item-name {
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .shop-item-price {
      color: gold;
      font-size: 16px;
      font-weight: bold;
    }

    .shop-item-owned {
      color: var(--success);
      font-size: 12px;
    }

    .shop-item-rarity {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 5px;
      display: inline-block;
    }

    .rarity-common { background: #888; color: white; }
    .rarity-uncommon { background: #2ecc71; color: white; }
    .rarity-rare { background: #3498db; color: white; }
    .rarity-epic { background: #9b59b6; color: white; }
    .rarity-legendary { background: linear-gradient(135deg, #f39c12, #e74c3c); color: white; }

    /* ===== TRADING MODAL ===== */
    .trade-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .trade-modal.open {
      display: flex;
    }

    .trade-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow: hidden;
      border: 2px solid var(--accent);
    }

    .trade-header {
      background: var(--bg-tertiary);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .trade-header h3 {
      margin: 0;
      color: var(--text-primary);
    }

    .trade-content {
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    .trade-side {
      flex: 1;
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 15px;
    }

    .trade-side h4 {
      color: var(--accent);
      margin: 0 0 10px 0;
      text-align: center;
    }

    .trade-items {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .trade-item {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .trade-item:hover {
      border-color: var(--accent);
    }

    .trade-item.selected {
      border-color: var(--success);
      background: rgba(0, 255, 0, 0.1);
    }

    .trade-actions {
      padding: 15px 20px;
      background: var(--bg-tertiary);
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    /* ===== CASINO ===== */
    .casino-section {
      background: linear-gradient(135deg, #1a0a2e, #2a1a3e);
      border-radius: 15px;
      padding: 20px;
      margin: 20px;
      border: 2px solid #9b59b6;
    }

    .casino-section h2 {
      color: #9b59b6;
      text-align: center;
      margin-bottom: 20px;
    }

    .casino-games {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .casino-game {
      background: var(--bg-tertiary);
      border-radius: 15px;
      padding: 20px;
      width: 200px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .casino-game:hover {
      border-color: #9b59b6;
      transform: translateY(-5px);
    }

    .casino-game-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .casino-game-name {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
    }

    .casino-game-desc {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 5px;
    }

    /* ===== SLOTS GAME ===== */
    .slots-container {
      text-align: center;
      padding: 20px;
    }

    .slots-display {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .slot-reel {
      background: var(--bg-primary);
      width: 80px;
      height: 100px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      border: 3px solid var(--accent);
      overflow: hidden;
    }

    .slot-reel.spinning {
      animation: slotSpin 0.1s linear infinite;
    }

    @keyframes slotSpin {
      0% { transform: translateY(-10px); }
      100% { transform: translateY(10px); }
    }

    .slots-bet {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
    }

    .slots-bet input {
      width: 100px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      text-align: center;
      font-size: 16px;
    }

    .spin-btn {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 25px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .spin-btn:hover {
      transform: scale(1.05);
    }

    .spin-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== COIN FLIP ===== */
    .coinflip-container {
      text-align: center;
      padding: 20px;
    }

    .coin {
      width: 150px;
      height: 150px;
      margin: 30px auto;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.1s;
    }

    .coin.flipping {
      animation: coinFlip 2s ease-out forwards;
    }

    @keyframes coinFlip {
      0% { transform: rotateY(0); }
      100% { transform: rotateY(1800deg); }
    }

    .coin-side {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      backface-visibility: hidden;
    }

    .coin-heads {
      background: linear-gradient(135deg, gold, #ffa500);
    }

    .coin-tails {
      background: linear-gradient(135deg, silver, #888);
      transform: rotateY(180deg);
    }

    .coinflip-choice {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .choice-btn {
      padding: 15px 30px;
      border: 3px solid transparent;
      border-radius: 15px;
      font-size: 18px;
      cursor: pointer;
      transition: 0.3s;
    }

    .choice-btn.heads {
      background: linear-gradient(135deg, gold, #ffa500);
      color: black;
    }

    .choice-btn.tails {
      background: linear-gradient(135deg, silver, #888);
      color: black;
    }

    .choice-btn.selected {
      border-color: var(--success);
      transform: scale(1.1);
    }

    /* ===== ADMIN PANEL ===== */
    .admin-section {
      background: linear-gradient(135deg, #2a1a1a, #1a1020);
      border: 1px solid #660000;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .admin-section h4 {
      color: #ff6666;
      margin: 0 0 12px 0;
      font-size: 14px;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    .admin-stat {
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 18px;
      text-align: center;
    }

    .admin-stat-number {
      color: var(--accent);
      font-size: 28px;
      font-weight: bold;
    }

    .admin-stat-label {
      color: var(--text-muted);
      font-size: 12px;
    }

    .admin-cmd-input {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .admin-cmd-input input {
      flex: 1;
    }

    .audit-log {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 10px;
    }

    .audit-item {
      padding: 8px;
      border-bottom: 1px solid var(--bg-tertiary);
      font-size: 12px;
    }

    .audit-item:last-child {
      border-bottom: none;
    }

    .audit-admin {
      color: var(--accent);
      font-weight: bold;
    }

    .audit-action {
      color: var(--text-primary);
    }

    .audit-time {
      color: var(--text-muted);
      font-size: 10px;
    }

    /* ===== PROFILE MODAL ===== */
    .profile-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .profile-modal-overlay.open {
      display: flex;
    }

    .profile-modal {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 20px;
      max-width: 450px;
      width: 90%;
      text-align: center;
      border: 2px solid var(--accent);
      position: relative;
      overflow: hidden;
    }

    .profile-modal-banner {
      width: 100%;
      height: 100px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      background-size: cover;
      background-position: center;
    }

    .profile-modal-content {
      padding: 20px;
      margin-top: -50px;
    }

    .profile-modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      transition: 0.3s;
    }

    .profile-modal-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-secondary);
      margin-bottom: 10px;
    }

    .profile-modal-name {
      color: var(--text-primary);
      font-size: 24px;
      margin: 0 0 5px 0;
      font-weight: 600;
    }

    .profile-modal-level {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .profile-modal-role {
      color: var(--accent);
      font-size: 14px;
      margin-bottom: 10px;
    }

    .profile-modal-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      padding: 15px 0;
      border-top: 1px solid var(--bg-tertiary);
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .profile-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* ===== POPUP ===== */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .popup-box {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 20px;
      padding: 40px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border: 2px solid var(--accent);
    }

    .popup-box h2 {
      color: var(--accent);
      margin: 0 0 15px 0;
      font-size: 26px;
    }

    .popup-box p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .popup-box input {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      outline: none;
      margin-bottom: 15px;
      text-align: center;
    }

    /* ===== ANNOUNCEMENT BANNER ===== */
    .announcement-banner {
      background: linear-gradient(90deg, var(--accent-hover), var(--accent));
      color: black;
      text-align: center;
      padding: 12px;
      font-weight: bold;
      display: none;
    }

    .announcement-banner.show {
      display: block;
    }

    /* ===== SOUND TOGGLE ===== */
    .sound-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      transition: 0.3s;
    }

    .sound-toggle:hover {
      background-color: var(--bg-secondary);
      transform: scale(1.1);
    }

    .sound-toggle.muted {
      color: var(--text-muted);
    }

    /* ===== CLOAK BUTTON ===== */
    .cloak-toggle {
      position: fixed;
      bottom: 75px;
      right: 20px;
      background-color: var(--info);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      transition: 0.3s;
    }

    .cloak-toggle:hover {
      transform: scale(1.1);
    }

    /* ===== GROUP CHAT MODAL ===== */
    .group-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .group-modal.open {
      display: flex;
    }

    .group-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 25px;
      width: 90%;
      max-width: 450px;
      border: 2px solid var(--accent);
    }

    .group-container h3 {
      color: var(--accent);
      margin: 0 0 20px 0;
      text-align: center;
    }

    .group-members {
      max-height: 250px;
      overflow-y: auto;
      margin: 15px 0;
    }

    .group-member {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .group-member img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }

    .group-member-check {
      margin-left: auto;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* ===== PAGE STYLES ===== */
    .page {
      padding: 20px;
      min-height: calc(100vh - 200px);
    }

    .page h1 {
      color: var(--text-primary);
      text-align: center;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .page h2 {
      color: var(--text-primary);
      text-align: center;
    }

    .page p {
      color: var(--text-secondary);
      text-align: center;
    }

    .favorites-section {
      margin-top: 30px;
    }

    .favorites-section h2 {
      color: var(--accent);
      text-align: center;
      font-size: 22px;
    }

    .no-favorites {
      color: var(--text-muted);
      text-align: center;
      font-size: 14px;
    }

    .owners-section {
      margin-top: 40px;
      text-align: center;
    }

    .owners-list {
      display: flex;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* ===== MINIGAMES PAGE ===== */
    .minigames-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .minigame-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .minigame-card:hover {
      border-color: var(--accent);
      transform: translateY(-5px);
    }

    .minigame-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .minigame-name {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
    }

    .minigame-desc {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 5px;
    }
  </style>
</head>
<body data-theme="dark">

    <!-- Particles Container -->
  <div id="particles-container"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loader"></div>
    <div class="loading-text">Loading The Gaming Hub...</div>
    <div class="loading-quote" id="loadingQuote">Get ready for epic gaming!</div>
  </div>

  <!-- Custom Background -->
  <div id="customBg" class="custom-bg"></div>

  <!-- Announcement Banner -->
  <div id="announcementBanner" class="announcement-banner"></div>



      <div class="cloak-actions">
        <button class="about-blank-btn" onclick="openInAboutBlank()"> Open in about:blank</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeCloakModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Welcome Popup -->
  <div id="welcomePopup" class="popup-overlay" style="display: none;">
    <div class="popup-box">
      <h2> Welcome to The Gaming Hub!</h2>
      <p>Choose a username to get started</p>
      <input type="text" id="newUsername" placeholder="Enter username...">
      <br>
      <button class="sidebar-btn sidebar-btn-orange" onclick="createProfile()" style="font-size: 18px; padding: 14px 35px;">Join</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal-overlay">
    <div class="profile-modal">
      <div id="modalProfileBanner" class="profile-modal-banner"></div>
      <div class="profile-modal-content">
        <button class="profile-modal-close" onclick="closeProfileModal()"></button>
        <img id="modalProfilePic" class="profile-modal-pic" src="" alt="Profile">
        <div id="modalProfileLevel" class="profile-modal-level">LVL 1</div>
        <h2 id="modalProfileName" class="profile-modal-name">Username</h2>
        <p id="modalProfileRole" class="profile-modal-role">Member</p>
        <div id="modalProfileStatus"></div>
        <p id="modalProfileBio" class="profile-modal-bio">No bio</p>
        <div id="modalProfileStats" class="profile-modal-stats"></div>
        <p id="modalProfileJoined" style="color: var(--text-muted); font-size: 12px;">Joined: Unknown</p>
        <div id="modalProfileActions" class="profile-modal-actions"></div>
      </div>
    </div>
  </div>

  <!-- Shop Modal -->
  <div id="shopModal" class="shop-modal">
    <div class="shop-container">
      <div class="shop-header">
        <h2> Shop</h2>
        <div class="shop-coins">
          <span></span>
          <span id="shopCoinsDisplay">0</span>
        </div>
        <button class="shop-close" onclick="closeShop()"></button>
      </div>
      <div class="shop-tabs">
        <button class="shop-tab active" onclick="showShopTab('banners', this)">Profile Banners</button>
        <button class="shop-tab" onclick="showShopTab('frames', this)">Profile Frames</button>
        <button class="shop-tab" onclick="showShopTab('badges', this)">Badges</button>
        <button class="shop-tab" onclick="showShopTab('effects', this)">Effects</button>
        <button class="shop-tab" onclick="showShopTab('titles', this)">Titles</button>
      </div>
      <div id="shopItems" class="shop-items"></div>
    </div>
  </div>

  <!-- Trading Modal -->
  <div id="tradeModal" class="trade-modal">
    <div class="trade-container">
      <div class="trade-header">
        <h3> Trade Items</h3>
        <button class="sidebar-close" onclick="closeTrade()"></button>
      </div>
      <div class="trade-content">
        <div class="trade-side">
          <h4>Your Items</h4>
          <div id="tradeYourItems" class="trade-items"></div>
        </div>
        <div class="trade-side">
          <h4>Their Items</h4>
          <div id="tradeTheirItems" class="trade-items"></div>
        </div>
      </div>
      <div class="trade-actions">
        <button class="sidebar-btn sidebar-btn-green" onclick="confirmTrade()">Confirm Trade</button>
        <button class="sidebar-btn sidebar-btn-red" onclick="closeTrade()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Group Chat Modal -->
  <div id="groupModal" class="group-modal">
    <div class="group-container">
      <h3> Create Group Chat</h3>
      <input type="text" id="groupName" class="sidebar-input" placeholder="Group name...">
      <div class="group-members" id="groupMembersList"></div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="sidebar-btn sidebar-btn-green" onclick="createGroup()">Create</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeGroupModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Mini-game Modal -->
  <div id="minigameModal" class="minigame-modal">
    <div class="minigame-container">
      <button class="minigame-close" onclick="closeMiniGame()"></button>
      <div id="minigameContent"></div>
    </div>
  </div>

  <!-- Casino Modal -->
  <div id="casinoModal" class="minigame-modal">
    <div class="minigame-container" style="max-width: 600px;">
      <button class="minigame-close" onclick="closeCasino()"></button>
      <div id="casinoContent"></div>
    </div>
  </div>

  <!-- Sound Toggle -->
  <button id="soundToggle" class="sound-toggle" onclick="toggleSound()"></button>


  <!-- Chat Toggle -->
  <button class="chat-toggle" onclick="toggleChat()">
     Chat
    <span id="chatBadge" class="chat-badge">0</span>
  </button>

  <!-- Chat Panel -->
  <div id="chatPanel" class="chat-panel">
    <div class="chat-header">
      <div class="chat-header-tabs">
        <button class="chat-header-tab active" onclick="showChatTab('global', this)"> Global</button>
        <button class="chat-header-tab" onclick="showChatTab('dms', this)"> DMs</button>
        <button class="chat-header-tab" onclick="showChatTab('groups', this)"> Groups</button>
      </div>
      <span id="onlineCount" style="font-size: 12px; color: var(--success);">0 online</span>
      <button class="chat-close" onclick="toggleChat()"></button>
    </div>
    
    <!-- Global Chat -->
    <div id="globalChatPanel" class="dm-panel active" style="display: flex;">
      <div id="chatMessages" class="chat-messages"></div>
      <div id="typingIndicator" class="typing-indicator">
        <span id="typingUser"></span>
        <span class="typing-dots"><span></span><span></span><span></span></span>
      </div>
      <div class="chat-input-area">
        <div id="mentionsDropdown" class="mentions-dropdown"></div>
        <input type="text" id="chatInput" class="chat-input" placeholder="Type a message... (@mention)" onkeypress="handleChatKeypress(event)" oninput="handleTyping(); checkMentions();">
        <button class="chat-send" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- DMs Panel -->
    <div id="dmsPanel" class="dm-panel">
      <div id="dmList" class="chat-messages" style="padding: 10px;"></div>
    </div>

    <!-- DM Conversation -->
    <div id="dmConversation" class="dm-panel">
      <button class="dm-back" onclick="closeDmConversation()" style="background: var(--bg-tertiary); padding: 10px; border: none; color: var(--text-primary); cursor: pointer; border-radius: 8px; margin-bottom: 10px;"> Back</button>
      <div id="dmMessages" class="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" id="dmInput" class="chat-input" placeholder="Type a message..." onkeypress="handleDmKeypress(event)">
        <button class="chat-send" onclick="sendDm()">Send</button>
      </div>
    </div>

    <!-- Groups Panel -->
    <div id="groupsPanel" class="dm-panel">
      <div style="padding: 15px;">
        <button class="sidebar-btn sidebar-btn-green" onclick="openGroupModal()" style="width: 100%; margin-bottom: 10px;">+ Create Group</button>
      </div>
      <div id="groupsList" class="chat-messages" style="padding: 10px;"></div>
    </div>

    <!-- Group Conversation -->
    <div id="groupConversation" class="dm-panel">
      <button class="dm-back" onclick="closeGroupConversation()" style="background: var(--bg-tertiary); padding: 10px; border: none; color: var(--text-primary); cursor: pointer; border-radius: 8px; margin-bottom: 10px;"> Back</button>
      <div id="groupMessages" class="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" id="groupInput" class="chat-input" placeholder="Type a message..." onkeypress="handleGroupKeypress(event)">
        <button class="chat-send" onclick="sendGroupMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()"></button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" onclick="toggleSidebar()"></button>
    <h2> Menu</h2>

    <div class="sidebar-tabs">
      <button class="sidebar-tab active" onclick="showSidebarTab('profileTab', this)" title="Profile"></button>
      <button class="sidebar-tab" onclick="showSidebarTab('friendsTab', this)" title="Friends"></button>
      <button class="sidebar-tab" onclick="showSidebarTab('activityTab', this)" title="Activity"></button>
      <button class="sidebar-tab" onclick="showSidebarTab('onlineTab', this)" title="Online"></button>
      <button class="sidebar-tab" onclick="showSidebarTab('inventoryTab', this)" title="Inventory"></button>
      <button class="sidebar-tab" onclick="showSidebarTab('settingsTab', this)" title="Settings"></button>
      <button id="adminTabBtn" class="sidebar-tab admin-tab" onclick="showSidebarTab('adminTab', this)" style="display: none;" title="Admin"></button>
    </div>

    <!-- Profile Tab -->
    <div id="profileTab" class="sidebar-panel active">
      <div id="myProfileCard" class="profile-card">
        <div id="myProfileBanner" class="profile-banner"></div>
        <div class="profile-card-content">
          <img id="myProfilePic" class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=RG" alt="Profile">
          <div id="myProfileLevel" class="profile-level">LVL 1</div>
          <p class="profile-name" id="myProfileName">Loading...</p>
          <p class="profile-role" id="myProfileRole"></p>
          <p class="profile-bio" id="myProfileBio"></p>
          <p class="profile-status" id="myProfileStatus" style="display: none;"></p>
          <div class="profile-stats">
            <div class="profile-stat">
              <div class="profile-stat-num" id="myStatGames">0</div>
              <div class="profile-stat-label">Games</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-num" id="myStatFriends">0</div>
              <div class="profile-stat-label">Friends</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-num" id="myStatMessages">0</div>
              <div class="profile-stat-label">Messages</div>
            </div>
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 8px; margin: 10px 0;">
        <input type="text" id="statusInput" class="sidebar-input" placeholder="Set your status..." maxlength="50" style="margin: 0;">
        <button class="sidebar-btn sidebar-btn-orange" onclick="updateStatus()">Set</button>
      </div>

      <hr class="sidebar-divider">

      <h3> Edit Profile</h3>
      <label>Username:</label>
      <input type="text" id="editUsername" class="sidebar-input" placeholder="Your username">
      <label>Bio:</label>
      <input type="text" id="editBio" class="sidebar-input" placeholder="Something about you">
      <label>Profile pic (URL or GIF):</label>
      <input type="text" id="editPic" class="sidebar-input" placeholder="https://example.com/pic.png">
      <button class="sidebar-btn sidebar-btn-orange" onclick="saveProfile()">Save Changes</button>

      <hr class="sidebar-divider">

      <h3> Search Users</h3>
      <input type="text" id="userSearch" class="sidebar-input" placeholder="Search username..." oninput="searchUsers()">
      <div id="userSearchResults"></div>
    </div>

    <!-- Friends Tab -->
    <div id="friendsTab" class="sidebar-panel">
      <h3> Your Friends</h3>
      <div id="friendsList"></div>

      <hr class="sidebar-divider">

      <h3> Friend Requests</h3>
      <div id="friendRequests"></div>
    </div>

    <!-- Activity Tab -->
    <div id="activityTab" class="sidebar-panel">
      <h3> Friend Activity</h3>
      <div id="activityFeed"></div>
    </div>

    <!-- Online Tab -->
    <div id="onlineTab" class="sidebar-panel">
      <h3> Online Users</h3>
      <p id="onlineCountSidebar" class="online-count">0 users online</p>
      <div id="onlineUsersList"></div>

      <hr class="sidebar-divider">

      <h3> Recently Active</h3>
      <div id="recentUsersList"></div>
    </div>

    <!-- Inventory Tab -->
    <div id="inventoryTab" class="sidebar-panel">
      <h3> Inventory</h3>
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <button class="sidebar-btn sidebar-btn-orange" onclick="openShop()"> Shop</button>
        <button class="sidebar-btn sidebar-btn-purple" onclick="openTrade()"> Trade</button>
      </div>
      
      <h4 style="color: var(--text-secondary); font-size: 14px; margin-top: 20px;">Owned Items:</h4>
      <div id="inventoryItems" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;"></div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="sidebar-panel">
      <h3> Appearance</h3>
      <label>Theme:</label>
      <select id="themeSelect" class="sidebar-input" onchange="changeTheme(this.value)">
        <option value="dark"> Dark</option>
        <option value="light"> Light</option>
        <option value="neon"> Neon</option>
        <option value="ocean"> Ocean</option>
        <option value="forest"> Forest</option>
        <option value="sunset"> Sunset</option>
      </select>

      <label>Font:</label>
      <select id="fontSelect" class="sidebar-input" onchange="changeFont(this.value)">
        <option value="poppins">Poppins</option>
        <option value="roboto">Roboto</option>
        <option value="montserrat">Montserrat</option>
        <option value="opensans">Open Sans</option>
        <option value="raleway">Raleway</option>
      </select>

      <label>Particle Effect:</label>
      <select id="particleSelect" class="sidebar-input" onchange="changeParticles(this.value)">
        <option value="none">None</option>
        <option value="snow"> Snow</option>
        <option value="stars"> Stars</option>
        <option value="rain"> Rain</option>
        <option value="confetti"> Confetti</option>
        <option value="hearts"> Hearts</option>
        <option value="bubbles"> Bubbles</option>
      </select>

      <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <input type="checkbox" id="compactMode" onchange="toggleCompactMode()">
        Compact Mode
      </label>

      <label>Custom Background (URL):</label>
      <input type="text" id="bgUrl" class="sidebar-input" placeholder="https://example.com/bg.jpg">
      <button class="sidebar-btn sidebar-btn-orange" onclick="setCustomBg()">Set</button>
      <button class="sidebar-btn sidebar-btn-gray" onclick="clearCustomBg()">Clear</button>

      <hr class="sidebar-divider">

      <h3> Sound Settings</h3>
      <label style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="soundEnabled" checked onchange="toggleSoundSetting()">
        Enable sound effects
      </label>
      <label style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
        <input type="checkbox" id="notifSound" checked onchange="saveSettings()">
        Notification sounds
      </label>

      <hr class="sidebar-divider">



      <h3> Tab Cloak</h3>
      <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Disguise this tab to look like something else!</p>
      
      <label>Quick Presets:</label>
      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('classroom')" style="font-size: 12px;"> Classroom</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('docs')" style="font-size: 12px;"> Docs</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('drive')" style="font-size: 12px;"> Drive</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('gmail')" style="font-size: 12px;"> Gmail</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('canvas')" style="font-size: 12px;"> Canvas</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('khan')" style="font-size: 12px;"> Khan Academy</button>
      </div>
      
      <label>Custom Tab Title:</label>
      <input type="text" id="customCloakTitle" class="sidebar-input" placeholder="Google Classroom">
      
      <label>Custom Favicon URL:</label>
      <input type="text" id="customCloakIcon" class="sidebar-input" placeholder="https://example.com/favicon.ico">
      
      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <button class="sidebar-btn sidebar-btn-orange" onclick="applyCustomCloak()">Apply Custom</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="resetCloak()">Reset</button>
      </div>
      
      <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <input type="checkbox" id="autoCloakEnabled" onchange="saveAutoCloak()">
        Auto-apply cloak on page load
      </label>
      
      <button class="sidebar-btn sidebar-btn-blue" onclick="openInAboutBlank()" style="width: 100%;"> Open in about:blank (Undetectable)</button>
      <p style="color: var(--text-muted); font-size: 11px; margin-top: 8px;">about:blank hides the URL completely!</p>

      <hr class="sidebar-divider">








      <h3> Panic Settings</h3>
      <label>Panic URL:</label>
      <input type="text" id="panicUrl" class="sidebar-input" placeholder="https://classroom.google.com" value="https://classroom.google.com">
      <button class="sidebar-btn sidebar-btn-green" onclick="savePanicUrl()">Save</button>
      <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">Press ` (backtick) to redirect</p>

      <hr class="sidebar-divider">

      <h3> Favorites</h3>
      <button class="sidebar-btn sidebar-btn-red" onclick="clearFavorites()">Clear All</button>

      <hr class="sidebar-divider">

      <h3> Reset Account</h3>
      <button class="sidebar-btn sidebar-btn-red" onclick="resetAccount()">Reset Account</button>
    </div>

    <!-- Admin Tab -->
    <div id="adminTab" class="sidebar-panel">
      <h3 style="color: #ff6666;"> Admin Panel</h3>

      <div class="admin-stats">
        <div class="admin-stat">
          <div id="adminUserCount" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Total Users</div>
        </div>
        <div class="admin-stat">
          <div id="adminOnlineCount" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Online Now</div>
        </div>
        <div class="admin-stat">
          <div id="adminMessageCount" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Messages</div>
        </div>
        <div class="admin-stat">
          <div id="adminCoins" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Total Coins</div>
        </div>
      </div>

      <div class="admin-section">
        <h4> Admin Commands</h4>
        <div class="admin-cmd-input">
          <input type="text" id="adminCmd" class="sidebar-input" placeholder="/help for commands" onkeypress="handleAdminCmd(event)" style="margin: 0;">
          <button class="sidebar-btn sidebar-btn-green" onclick="executeAdminCmd()">Run</button>
        </div>
        <div id="cmdOutput" style="background: var(--bg-primary); border-radius: 8px; padding: 10px; margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; font-family: monospace;"></div>
      </div>

      <div class="admin-section">
        <h4> Announcement</h4>
        <input type="text" id="announcementInput" class="sidebar-input" placeholder="Type announcement...">
        <button class="sidebar-btn sidebar-btn-orange" onclick="setAnnouncement()">Set</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="clearAnnouncement()">Clear</button>
      </div>

      <div class="admin-section">
        <h4> Audit Log</h4>
        <div id="auditLog" class="audit-log"></div>
      </div>

      <div class="admin-section">
        <h4> Users</h4>
        <div id="adminUsersList" style="max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Stats Banner -->
    <div class="stats-banner">
      <div class="stat-item">
        <div class="stat-number" id="statTotalUsers">0</div>
        <div class="stat-label">USERS</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="statTotalGames">0</div>
        <div class="stat-label">GAMES</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="statTotalMessages">0</div>
        <div class="stat-label">MESSAGES</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="statOnlineNow">0</div>
        <div class="stat-label">ONLINE</div>
      </div>
    </div>

    <!-- XP Bar -->
    <div class="xp-bar-container">
      <div class="level-badge" id="levelBadge">LVL 1</div>
      <div class="xp-bar">
        <div class="xp-bar-fill" id="xpBarFill" style="width: 0%"></div>
      </div>
      <div class="xp-text" id="xpText">0 / 100 XP</div>
      <div class="coins-display" onclick="openShop()">
        <span></span>
        <span id="coinsDisplay">0</span>
      </div>
    </div>

    <!-- Navbar -->
    <div class="navbar">
      <a onclick="showPage('home')">Home</a>
      <a onclick="showPage('allgames')">All Games</a>
      <a onclick="showPage('minigames')">Mini Games</a>
      <a onclick="showPage('casino')">Casino</a>
      <a onclick="showPage('page1')">More Sites</a>
      <span id="usernameDisplay"></span>
    </div>

    <!-- Home Page -->
    <div id="home" class="page">
      <h1> Welcome to The Gaming Hub</h1>
      <p>The Ultimate Gaming Platform</p>

      <button class="random-game-btn" onclick="playRandomGame()"> Play Random Game</button>

      <div class="owners-section">
        <h2> Team</h2>
        <div class="owners-list">
          <div class="profile-card" style="width: 160px; cursor: pointer;" onclick="viewTeamProfile('riley')">
            <div class="profile-banner" style="height: 60px;"></div>
            <div class="profile-card-content" style="padding: 10px; margin-top: -30px;">
              <img class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=R" alt="Riley" style="width: 60px; height: 60px;">
              <p class="profile-name">Riley</p>
              <p class="owner-badge"> OWNER</p>
            </div>
          </div>
          <div class="profile-card" style="width: 160px; cursor: pointer;" onclick="viewTeamProfile('garrett')">
            <div class="profile-banner" style="height: 60px;"></div>
            <div class="profile-card-content" style="padding: 10px; margin-top: -30px;">
              <img class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=G" alt="Garrett" style="width: 60px; height: 60px;">
              <p class="profile-name">Garrett</p>
              <p class="coowner-badge"> CO-OWNER</p>
            </div>
          </div>
          <div class="profile-card" style="width: 160px; cursor: pointer;" onclick="viewTeamProfile('john')">
            <div class="profile-banner" style="height: 60px;"></div>
            <div class="profile-card-content" style="padding: 10px; margin-top: -30px;">
              <img class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=J" alt="John" style="width: 60px; height: 60px;">
              <p class="profile-name">John</p>
              <p class="coowner-badge"> CO-OWNER</p>
            </div>
          </div>
        </div>
      </div>

      <div class="favorites-section">
        <h2> Favorites</h2>
        <div id="favoritesDisplay" class="games-list">
          <p class="no-favorites">No favorites yet. Click the  on any game to add it.</p>
        </div>
      </div>
    </div>

    <!-- All Games Page -->
    <div id="allgames" class="page" style="display: none;">
      <h2> All Games</h2>
      <button class="random-game-btn" onclick="playRandomGame()"> Play Random Game</button>
      <div id="allGamesList" class="games-list"></div>
    </div>

    <!-- Mini Games Page -->
    <div id="minigames" class="page" style="display: none;">
      <h2> Mini Games</h2>
      <p>Classic games built right into the site!</p>
      <div class="minigames-grid" id="minigamesGrid"></div>
    </div>

    <!-- Casino Page -->
    <div id="casino" class="page" style="display: none;">
      <h2> Casino</h2>
      <p style="color: var(--warning);"> Play responsibly! Coins have a 5min cooldown per game.</p>
      <div class="casino-section">
        <h2> Casino Games</h2>
        <div class="casino-games" id="casinoGames"></div>
      </div>
    </div>

    <!-- More Sites Page -->
    <div id="page1" class="page" style="display: none;">
      <h2> More Gaming Sites</h2>
      <div class="games-list" id="gamesPage1"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>

        // ===== FIREBASE SETUP =====
    const firebaseConfig = {
      apiKey: "AIzaSyDv3JRn08FStrEd6cF3x2AFDCgvbJOGtC8",
      authDomain: "riley-games-1544e.firebaseapp.com",
      projectId: "riley-games-1544e",
      storageBucket: "riley-games-1544e.firebasestorage.app",
      messagingSenderId: "501107166002",
      appId: "1:501107166002:web:b684a91dbc9d6fb9e7a52b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== GLOBAL VARIABLES =====
    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
      localStorage.setItem("userId", userId);
    }

    let myProfile = null;
    let isAdmin = false;
    let chatOpen = false;
    let lastMessageCount = 0;
    let soundEnabled = localStorage.getItem("soundEnabled") !== "false";
    let notifSound = localStorage.getItem("notifSound") !== "false";
    let currentDmUserId = null;
    let currentGroupId = null;
    let typingTimeout = null;
    let lastGamePlayTime = {};

    const SECRET_TAG = "_2024xAuth";
    const ADMIN_USERNAMES = {
      "riley": "riley_2024xauth",
      "garrett": "garrett_2024xauth",
      "john": "john_2024xauth"
    };

    // ===== XP SYSTEM =====
    const XP_PER_LEVEL = [
      100, 150, 225, 340, 510, 765, 1150, 1725, 2590, 3885,
      5828, 8742, 13113, 19670, 29505, 44258, 66387, 99581, 149372, 224058,
      336087, 504131, 756197, 1134296, 1701444
    ];

    function getDisplayName(username) {
      if (username && username.includes(SECRET_TAG)) {
        return username.replace(SECRET_TAG, "");
      }
      return username;
    }

    function isAdminUsername(username) {
      if (!username) return false;
      let lower = username.toLowerCase();
      return lower === ADMIN_USERNAMES.riley || 
             lower === ADMIN_USERNAMES.garrett || 
             lower === ADMIN_USERNAMES.john;
    }

    function getRole(username) {
      if (!username) return " Member";
      let lower = username.toLowerCase();
      if (lower === ADMIN_USERNAMES.riley) return " Owner";
      if (lower === ADMIN_USERNAMES.garrett || lower === ADMIN_USERNAMES.john) return " Co-Owner";
      return " Member";
    }

    function calculateLevel(xp) {
      let level = 1;
      let totalXp = 0;
      
      for (let i = 0; i < XP_PER_LEVEL.length; i++) {
        if (xp >= totalXp + XP_PER_LEVEL[i]) {
          level = i + 2;
          totalXp += XP_PER_LEVEL[i];
        } else {
          break;
        }
      }
      
      return { level, currentXp: xp - totalXp, requiredXp: XP_PER_LEVEL[level - 1] || 999999 };
    }

    async function addXP(amount, reason) {
      if (!myProfile) return;
      
      let oldLevel = calculateLevel(myProfile.xp || 0).level;
      myProfile.xp = (myProfile.xp || 0) + amount;
      let newLevel = calculateLevel(myProfile.xp).level;
      
      await db.collection("users").doc(userId).update({ xp: myProfile.xp });
      
      updateXPBar();
      
      if (newLevel > oldLevel) {
        levelUp(newLevel);
      }
      
      if (reason) {
        showNotification(`+${amount} XP: ${reason}`);
      }
    }

    function levelUp(newLevel) {
      playSound('notification');
      showNotification(` LEVEL UP! You're now level ${newLevel}!`, 'success');
      
      // Reward coins for leveling up
      let coinReward = newLevel * 50;
      addCoins(coinReward, `Level ${newLevel} reward`);
      
      // Confetti animation
      createConfetti();
    }

    function updateXPBar() {
      if (!myProfile) return;
      
      let { level, currentXp, requiredXp } = calculateLevel(myProfile.xp || 0);
      let percentage = (currentXp / requiredXp) * 100;
      
      document.getElementById("xpBarFill").style.width = percentage + "%";
      document.getElementById("xpText").textContent = `${currentXp} / ${requiredXp} XP`;
      document.getElementById("levelBadge").textContent = `LVL ${level}`;
      document.getElementById("myProfileLevel").textContent = `LVL ${level}`;
    }

    // ===== COINS SYSTEM =====
       async function addCoins(amount, reason) {
      if (!myProfile) return;
      
      let newTotal = (myProfile.coins || 0) + amount;
      
      // Cap at 10,000 for regular earning (not admin commands)
      if (newTotal > 10000) {
        newTotal = 10000;
        if (myProfile.coins >= 10000) {
          showNotification("You've hit the 10k coin cap! Spend some in the shop.", 'warning');
          return;
        }
      }
      
      myProfile.coins = newTotal;
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      document.getElementById("shopCoinsDisplay").textContent = myProfile.coins;
      
      if (reason && amount > 0) {
        showNotification(`+${amount} : ${reason}`, 'success');
      }
    }
  
  
  
  
  
    async function checkGameCooldown(gameName) {
      let now = Date.now();
      let lastPlayed = lastGamePlayTime[gameName] || 0;
      let cooldown = 5 * 60 * 1000; // 5 minutes
      
      if (now - lastPlayed < cooldown) {
        let remaining = Math.ceil((cooldown - (now - lastPlayed)) / 60000);
        showNotification(`Cooldown: Wait ${remaining} more minutes to earn coins from this game`, 'warning');
        return false;
      }
      
      return true;
    }

    async function earnCoinsFromGame(gameName) {
      if (!await checkGameCooldown(gameName)) return;
      
      let coins = Math.floor(Math.random() * 20) + 10; // 10-30 coins
      let xp = Math.floor(Math.random() * 15) + 5; // 5-20 XP
      
      lastGamePlayTime[gameName] = Date.now();
      
      await addCoins(coins, `Played ${gameName}`);
      await addXP(xp, `Played ${gameName}`);
      
      // Track play time
      if (myProfile.playTime) {
        myProfile.playTime[gameName] = (myProfile.playTime[gameName] || 0) + 1;
      } else {
        myProfile.playTime = { [gameName]: 1 };
      }
      
      myProfile.gamesPlayed = (myProfile.gamesPlayed || 0) + 1;
      
      await db.collection("users").doc(userId).update({
        playTime: myProfile.playTime,
        gamesPlayed: myProfile.gamesPlayed
      });
      
      document.getElementById("myStatGames").textContent = myProfile.gamesPlayed;
    }

    // ===== SOUNDS =====
    const sounds = {
      message: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE',
      click: 'data:audio/wav;base64,UklGRlwBAABXQVZFZm10IBAAAAABAAEAIlYAAIJYAAACABAAZGF0YTgBAADr/+v/6//r/+v/7v8MAQYBBQEFAQUBBQEFAQUBBQEEAQYBBQEFAQUBBQEEAQUBBQEFAQUBBQEEAQUBBQEFAQUBBQEFAQUBBQEFAQUBBQEFAQUBBQEFAQUBBQEEAQUBBQEEAQYBBQEFAQUBBQEEAQUBBQEFAQUBBQEFAQUBBQEEAQUBBQEEAQUBBQEFAQUBBQE',
      notification: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeS'
    };

    const audioCache = {};

    function playSound(type) {
      if (!soundEnabled) return;
      if ((type === 'message' || type === 'notification') && !notifSound) return;
      
      if (!audioCache[type]) {
        audioCache[type] = new Audio(sounds[type]);
        audioCache[type].volume = 0.3;
      }
      
      audioCache[type].play().catch(e => {});
    }

    // ===== LOADING QUOTES =====
    const loadingQuotes = [
      "Get ready for epic gaming!",
      "Preparing your adventure...",
      "Loading awesomeness...",
      "The game is afoot!",
      "May your FPS be high and your ping low",
      "Respawn in 3... 2... 1...",
      "Achievement unlocked: Patience",
      "Press F to pay respects... to loading screens",
      "404: Boredom not found",
      "Calculating your skill level...",
      "Buffing your characters...",
      "Spawning loot boxes...",
      "Initializing fun protocols...",
      "Downloading more RAM...",
      "Charging your gaming chair...",
      "Updating your gaming socks...",
      "Calibrating your winning streak...",
      "Summoning the gaming gods...",
      "Brewing energy drinks...",
      "Assembling the dream team...",
      "Rolling for initiative...",
      "Crafting legendary items...",
      "Installing skill implants...",
      "Optimizing your grind...",
      "Syncing with the matrix...",
      "Preparing boss battles...",
      "Loading Easter eggs...",
      "Generating random crits...",
      "Establishing dominance...",
      "Activating tryhard mode...",
      "Consulting the speedrun timer...",
      "Unleashing the chaos...",
      "Preparing your victory dance...",
      "Warming up the RGB lights...",
      "Tuning your mechanical keyboard...",
      "Adjusting your gaming headset...",
      "Powering up the gaming mouse...",
      "Setting up your triple monitor setup...",
      "Organizing your desktop icons...",
      "Clearing your browser history...",
      "Hiding evidence from teachers...",
      "Disguising as homework...",
      "Cloaking in stealth mode...",
      "Activating incognito protocol...",
      "Preparing your excuses...",
      "Loading plausible deniability...",
      "Generating alibi scenarios...",
      "Practicing your 'I'm studying' face...",
      "Minimizing suspicious tabs...",
      "Ready Player One...",
      "It's dangerous to go alone!"
    ];

    function getRandomQuote() {
      return loadingQuotes[Math.floor(Math.random() * loadingQuotes.length)];
    }

    // ===== NOTIFICATIONS =====
    function showNotification(message, type = 'info') {
      let notif = document.createElement('div');
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--accent)'};
        color: black;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideIn 0.3s, slideOut 0.3s 2.7s;
      `;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => notif.remove(), 3000);
    }

    // ===== CONFETTI =====
    function createConfetti() {
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          let confetti = document.createElement('div');
          confetti.className = 'particle confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          document.getElementById('particles-container').appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 4000);
        }, i * 30);
      }
    }

    // ===== CHECK FIRST VISIT =====
    async function checkFirstVisit() {
      let doc = await db.collection("users").doc(userId).get();
      if (!doc.exists) {
        document.getElementById("welcomePopup").style.display = "flex";
      } else {
        myProfile = doc.data();
        
        // Initialize new fields if missing
        if (!myProfile.xp) myProfile.xp = 0;
        if (!myProfile.coins) myProfile.coins = 0;
        if (!myProfile.level) myProfile.level = 1;
        if (!myProfile.inventory) myProfile.inventory = [];
        if (!myProfile.equippedBanner) myProfile.equippedBanner = null;
        if (!myProfile.playTime) myProfile.playTime = {};
        
        updateProfileDisplay();
        updateOnlineStatus();
        checkAdmin();
        updateXPBar();
        updateInventory();
      }
    }

    // ===== CREATE PROFILE =====
    async function createProfile() {
      let username = document.getElementById("newUsername").value.trim();
      if (username === "") {
        alert("Please enter a username");
        return;
      }

      let lowerUsername = username.toLowerCase();
      if ((lowerUsername === "riley" || lowerUsername === "garrett" || lowerUsername === "john") && 
          !username.toLowerCase().includes(SECRET_TAG.toLowerCase())) {
        alert("That username is reserved.");
        return;
      }

      myProfile = {
        username: username,
        bio: "",
        pic: "https://api.dicebear.com/7.x/initials/svg?seed=" + username,
        banner: null,
        color: "#ff8800",
        friends: [],
        friendRequests: [],
        status: "",
        xp: 0,
        coins: 100, // Starting coins
        level: 1,
        gamesPlayed: 0,
        messagesSent: 0,
        inventory: [],
        equippedBanner: null,
        equippedFrame: null,
        equippedBadge: null,
        equippedTitle: null,
        playTime: {},
        banned: false,
        muted: false,
        tempBanUntil: null,
        lastSeen: Date.now(),
        createdAt: Date.now()
      };

      await db.collection("users").doc(userId).set(myProfile);
      document.getElementById("welcomePopup").style.display = "none";
      updateProfileDisplay();
      updateOnlineStatus();
      checkAdmin();
      updateXPBar();
      
      showNotification("Welcome to The Gaming Hub! ", 'success');
      addXP(50, "Joined the Hub!");
    }

    // ===== SAVE PROFILE =====
    async function saveProfile() {
      let username = document.getElementById("editUsername").value.trim();
      let bio = document.getElementById("editBio").value.trim();
      let pic = document.getElementById("editPic").value.trim();

      if (username === "") {
        alert("Username can't be empty");
        return;
      }

      if (pic === "") {
        pic = "https://api.dicebear.com/7.x/initials/svg?seed=" + username;
      }

      myProfile.username = username;
      myProfile.bio = bio;
      myProfile.pic = pic;

      await db.collection("users").doc(userId).update({
        username: username,
        bio: bio,
        pic: pic
      });
      
      updateProfileDisplay();
      checkAdmin();
      playSound('click');
      showNotification("Profile saved!", 'success');
    }

    // ===== UPDATE PROFILE DISPLAY =====
    function updateProfileDisplay() {
      if (!myProfile) return;

      let displayName = getDisplayName(myProfile.username);
      let { level } = calculateLevel(myProfile.xp || 0);
      
      document.getElementById("myProfileName").textContent = displayName;
      document.getElementById("myProfileBio").textContent = myProfile.bio || "No bio yet";
      document.getElementById("myProfilePic").src = myProfile.pic;
      document.getElementById("myProfileRole").textContent = getRole(myProfile.username);
      document.getElementById("myProfileLevel").textContent = `LVL ${level}`;
      
      // Banner
      if (myProfile.equippedBanner) {
        document.getElementById("myProfileBanner").style.backgroundImage = `url(${myProfile.equippedBanner})`;
      }
      
      // Status
      if (myProfile.status) {
        document.getElementById("myProfileStatus").textContent = '"' + myProfile.status + '"';
        document.getElementById("myProfileStatus").style.display = "block";
      }
      
      // Stats
      document.getElementById("myStatGames").textContent = myProfile.gamesPlayed || 0;
      document.getElementById("myStatFriends").textContent = (myProfile.friends || []).length;
      document.getElementById("myStatMessages").textContent = myProfile.messagesSent || 0;
      
      // Coins
      document.getElementById("coinsDisplay").textContent = myProfile.coins || 0;
      document.getElementById("shopCoinsDisplay").textContent = myProfile.coins || 0;

      document.getElementById("editUsername").value = myProfile.username;
      document.getElementById("editBio").value = myProfile.bio || "";
      document.getElementById("editPic").value = myProfile.pic.includes("dicebear") ? "" : myProfile.pic;

      document.getElementById("usernameDisplay").textContent = " " + displayName;

      loadFriends();
      loadFriendRequests();
    }

    async function updateStatus() {
      let status = document.getElementById("statusInput").value.trim();
      myProfile.status = status;
      await db.collection("users").doc(userId).update({ status: status });
      updateProfileDisplay();
      document.getElementById("statusInput").value = "";
      showNotification("Status updated!", 'success');
    }

    // ===== ONLINE STATUS =====
    async function updateOnlineStatus() {
      if (!myProfile) return;
      await db.collection("users").doc(userId).update({ lastSeen: Date.now() });
    }

    setInterval(() => {
      if (myProfile) updateOnlineStatus();
    }, 30000);

    function isUserOnline(lastSeen) {
      if (!lastSeen) return false;
      return (Date.now() - lastSeen) < (2 * 60 * 1000);
    }

    function checkAdmin() {
      if (myProfile && isAdminUsername(myProfile.username)) {
        isAdmin = true;
        document.getElementById("adminTabBtn").style.display = "block";
      } else {
        isAdmin = false;
        document.getElementById("adminTabBtn").style.display = "none";
      }
    }

    // ===== CHECK IF BANNED =====
    async function checkIfBanned() {
      if (!myProfile) return false;
      
      if (myProfile.tempBanUntil && Date.now() < myProfile.tempBanUntil) {
        let hours = Math.ceil((myProfile.tempBanUntil - Date.now()) / (1000 * 60 * 60));
        document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:var(--bg-primary);color:var(--text-primary);text-align:center;padding:20px;"><h1 style="color:var(--danger);"> Temporarily Banned</h1><p>You are banned for ${hours} more hours.</p></div>`;
        return true;
      }
      
      if (myProfile.banned) {
        document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:var(--bg-primary);color:var(--text-primary);text-align:center;padding:20px;"><h1 style="color:var(--danger);"> Permanently Banned</h1><p>Contact an admin if you believe this is a mistake.</p></div>`;
        return true;
      }
      
      return false;
    }

        // ===== CHAT SYSTEM =====
    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById("chatPanel").classList.toggle("open", chatOpen);
      if (chatOpen) {
        document.getElementById("chatBadge").style.display = "none";
        document.getElementById("chatInput").focus();
      }
      playSound('click');
    }

    function showChatTab(tab, btn) {
      document.querySelectorAll('.chat-header-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      document.querySelectorAll('.dm-panel').forEach(p => p.style.display = 'none');
      
      if (tab === 'global') {
        document.getElementById('globalChatPanel').style.display = 'flex';
      } else if (tab === 'dms') {
        document.getElementById('dmsPanel').style.display = 'block';
        loadDmList();
      } else if (tab === 'groups') {
        document.getElementById('groupsPanel').style.display = 'block';
        loadGroupsList();
      }
      playSound('click');
    }

    function handleChatKeypress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }

    // ===== TYPING INDICATOR =====
    function handleTyping() {
      if (!myProfile) return;
      
      db.collection("typing").doc(userId).set({
        username: getDisplayName(myProfile.username),
        timestamp: Date.now()
      });
      
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        db.collection("typing").doc(userId).delete();
      }, 2000);
    }

    function loadTypingIndicators() {
      db.collection("typing").onSnapshot(snapshot => {
        let typingNames = [];
        let now = Date.now();
        
        snapshot.forEach(doc => {
          if (doc.id !== userId) {
            let data = doc.data();
            if (now - data.timestamp < 3000) {
              typingNames.push(data.username);
            }
          }
        });
        
        let indicator = document.getElementById("typingIndicator");
        if (typingNames.length > 0) {
          document.getElementById("typingUser").textContent = typingNames[0];
          indicator.classList.add("show");
        } else {
          indicator.classList.remove("show");
        }
      });
    }

    // ===== MENTIONS =====
    function checkMentions() {
      let input = document.getElementById("chatInput");
      let text = input.value;
      let cursorPos = input.selectionStart;
      
      // Check if @ is typed
      let lastAt = text.lastIndexOf('@', cursorPos);
      if (lastAt === -1 || lastAt < cursorPos - 20) {
        document.getElementById("mentionsDropdown").classList.remove("show");
        return;
      }
      
      let searchText = text.substring(lastAt + 1, cursorPos).toLowerCase();
      showMentionsDropdown(searchText, lastAt);
    }

    async function showMentionsDropdown(searchText, atPos) {
      let snapshot = await db.collection("users").limit(10).get();
      let dropdown = document.getElementById("mentionsDropdown");
      
      let html = "";
      snapshot.forEach(doc => {
        let user = doc.data();
        let displayName = getDisplayName(user.username);
        
        if (displayName.toLowerCase().includes(searchText)) {
          html += `<div class="mention-option" onclick="insertMention('${displayName}', ${atPos})">`;
          html += `<img src="${user.pic}" alt="pic">`;
          html += `<span>${displayName}</span>`;
          html += `</div>`;
        }
      });
      
      if (html) {
        dropdown.innerHTML = html;
        dropdown.classList.add("show");
      } else {
        dropdown.classList.remove("show");
      }
    }

    function insertMention(username, atPos) {
      let input = document.getElementById("chatInput");
      let text = input.value;
      let before = text.substring(0, atPos);
      let after = text.substring(input.selectionStart);
      
      input.value = before + '@' + username + ' ' + after;
      input.focus();
      
      document.getElementById("mentionsDropdown").classList.remove("show");
    }

    async function sendMessage() {
      let input = document.getElementById("chatInput");
      let text = input.value.trim();

      if (text === "" || !myProfile) return;
      
      if (myProfile.muted) {
        showNotification("You are muted and cannot send messages.", 'warning');
        return;
      }

      await db.collection("chat").add({
        userId: userId,
        username: myProfile.username,
        pic: myProfile.pic,
        level: calculateLevel(myProfile.xp || 0).level,
        text: text,
        reactions: {},
        timestamp: Date.now()
      });

      myProfile.messagesSent = (myProfile.messagesSent || 0) + 1;
      await db.collection("users").doc(userId).update({ messagesSent: myProfile.messagesSent });
      document.getElementById("myStatMessages").textContent = myProfile.messagesSent;

      input.value = "";
      db.collection("typing").doc(userId).delete();
      playSound('message');
      
      // XP for chatting
      if (Math.random() < 0.3) {
        addXP(2, "Chatting");
      }
    }

    function loadChat() {
      db.collection("chat")
        .orderBy("timestamp", "desc")
        .limit(50)
        .onSnapshot(snapshot => {
          let messages = [];
          snapshot.forEach(doc => {
            messages.push({ id: doc.id, data: doc.data() });
          });

          messages.reverse();

          let html = "";
          for (let msg of messages) {
            let data = msg.data;
            let isMine = data.userId === userId;
            let time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let displayName = getDisplayName(data.username);
            
            // Process mentions
            let processedText = data.text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');

            html += `<div class="chat-message${isMine ? ' mine' : ''}">`;
            html += `<div class="chat-message-header">`;
            html += `<img class="chat-message-pic" src="${data.pic}" onclick="viewProfileByUserId('${data.userId}')">`;
            html += `<span class="chat-message-name" onclick="viewProfileByUserId('${data.userId}')">${displayName}</span>`;
            html += `<span class="chat-message-level">LVL ${data.level || 1}</span>`;
            html += `<span class="chat-message-time">${time}</span>`;
            html += `</div>`;
            html += `<div class="chat-message-text">${processedText}</div>`;
            
            // Reactions
            html += `<div class="emoji-reactions">`;
            let reactions = data.reactions || {};
            for (let emoji in reactions) {
              let users = reactions[emoji] || [];
              let isActive = users.includes(userId);
              html += `<button class="emoji-btn${isActive ? ' active' : ''}" onclick="toggleReaction('${msg.id}', '${emoji}')">${emoji}<span class="reaction-count">${users.length}</span></button>`;
            }
            html += `<button class="add-reaction-btn" onclick="showEmojiPicker('${msg.id}', this)">+</button>`;
            html += `</div>`;
            
            if (isAdmin || isMine) {
              html += `<button class="chat-message-delete" onclick="deleteMessage('${msg.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:11px;margin-top:5px;"> Delete</button>`;
            }
            
            html += `</div>`;
          }

          document.getElementById("chatMessages").innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">No messages yet.</p>';

          let chatDiv = document.getElementById("chatMessages");
          chatDiv.scrollTop = chatDiv.scrollHeight;

          if (!chatOpen && messages.length > lastMessageCount && lastMessageCount > 0) {
            document.getElementById("chatBadge").textContent = messages.length - lastMessageCount;
            document.getElementById("chatBadge").style.display = "block";
            playSound('notification');
          }
          lastMessageCount = messages.length;
        });
    }

    async function viewProfileByUserId(uid) {
      let doc = await db.collection("users").doc(uid).get();
      if (doc.exists) {
        viewProfile(uid);
      }
    }

    // ===== EMOJI REACTIONS =====
    const emojiList = ['', '', '', '', '', '', '', '', '', ''];

    function showEmojiPicker(msgId, btn) {
      document.querySelectorAll('.emoji-picker').forEach(p => p.remove());
      
      let picker = document.createElement('div');
      picker.className = 'emoji-picker show';
      
      emojiList.forEach(emoji => {
        let emojiBtn = document.createElement('button');
        emojiBtn.textContent = emoji;
        emojiBtn.onclick = () => {
          toggleReaction(msgId, emoji);
          picker.remove();
        };
        picker.appendChild(emojiBtn);
      });
      
      btn.parentElement.appendChild(picker);
      
      setTimeout(() => {
        document.addEventListener('click', function closePicker(e) {
          if (!picker.contains(e.target) && e.target !== btn) {
            picker.remove();
            document.removeEventListener('click', closePicker);
          }
        });
      }, 100);
    }

    async function toggleReaction(msgId, emoji) {
      let msgRef = db.collection("chat").doc(msgId);
      let doc = await msgRef.get();
      if (!doc.exists) return;
      
      let reactions = doc.data().reactions || {};
      if (!reactions[emoji]) reactions[emoji] = [];
      
      let idx = reactions[emoji].indexOf(userId);
      if (idx === -1) {
        reactions[emoji].push(userId);
      } else {
        reactions[emoji].splice(idx, 1);
        if (reactions[emoji].length === 0) delete reactions[emoji];
      }
      
      await msgRef.update({ reactions });
      playSound('click');
    }

    async function deleteMessage(messageId) {
      if (confirm("Delete this message?")) {
        await db.collection("chat").doc(messageId).delete();
        playSound('click');
      }
    }

    // ===== DIRECT MESSAGES =====
    async function loadDmList() {
      let dmsSnapshot = await db.collection("dms")
        .where("participants", "array-contains", userId)
        .orderBy("lastMessage", "desc")
        .get();
      
      if (dmsSnapshot.empty) {
        document.getElementById("dmList").innerHTML = '<p style="color:var(--text-muted);text-align:center;">No conversations yet.</p>';
        return;
      }
      
      let html = "";
      for (let doc of dmsSnapshot.docs) {
        let dm = doc.data();
        let otherUserId = dm.participants.find(p => p !== userId);
        let userDoc = await db.collection("users").doc(otherUserId).get();
        
        if (userDoc.exists) {
          let user = userDoc.data();
          let online = isUserOnline(user.lastSeen);
          let statusDot = online ? '<span class="status-dot status-online"></span>' : '<span class="status-dot status-offline"></span>';
          
          html += `<div class="friend-card" onclick="openDmConversation('${doc.id}', '${otherUserId}')">`;
          html += `<img src="${user.pic}">`;
          html += `<div class="friend-card-info">`;
          html += `<div class="friend-card-name">${statusDot}${getDisplayName(user.username)}</div>`;
          html += `<div class="friend-card-status">${(dm.lastMessageText || 'No messages').substring(0, 30)}</div>`;
          html += `</div></div>`;
        }
      }
      
      document.getElementById("dmList").innerHTML = html;
    }

    async function openDmWith(otherUserId) {
      let existing = await db.collection("dms")
        .where("participants", "array-contains", userId)
        .get();
      
      let dmId = null;
      existing.forEach(doc => {
        if (doc.data().participants.includes(otherUserId)) {
          dmId = doc.id;
        }
      });
      
      if (!dmId) {
        let newDm = await db.collection("dms").add({
          participants: [userId, otherUserId],
          lastMessage: Date.now(),
          lastMessageText: ""
        });
        dmId = newDm.id;
      }
      
      openDmConversation(dmId, otherUserId);
      
      document.querySelectorAll('.chat-header-tab')[1].click();
      if (!chatOpen) toggleChat();
    }

    function openDmConversation(dmId, otherUserId) {
      currentDmUserId = otherUserId;
      
      document.querySelectorAll('.dm-panel').forEach(p => p.style.display = 'none');
      document.getElementById('dmConversation').style.display = 'flex';
      
      db.collection("dms").doc(dmId).collection("messages")
        .orderBy("timestamp", "asc")
        .onSnapshot(async snapshot => {
          let html = "";
          
          for (let doc of snapshot.docs) {
            let msg = doc.data();
            let isMine = msg.senderId === userId;
            let time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let senderDoc = await db.collection("users").doc(msg.senderId).get();
            let senderPic = senderDoc.exists ? senderDoc.data().pic : '';
            let senderName = senderDoc.exists ? getDisplayName(senderDoc.data().username) : 'Unknown';
            
            html += `<div class="chat-message${isMine ? ' mine' : ''}">`;
            html += `<div class="chat-message-header">`;
            html += `<img class="chat-message-pic" src="${senderPic}">`;
            html += `<span class="chat-message-name">${senderName}</span>`;
            html += `<span class="chat-message-time">${time}</span>`;
            html += `</div>`;
            html += `<div class="chat-message-text">${msg.text}</div>`;
            html += `</div>`;
          }
          
          document.getElementById("dmMessages").innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">Start your conversation!</p>';
          document.getElementById("dmMessages").scrollTop = document.getElementById("dmMessages").scrollHeight;
        });
      
      document.getElementById("dmInput").dataset.dmId = dmId;
    }

    function closeDmConversation() {
      document.getElementById('dmConversation').style.display = 'none';
      document.getElementById('dmsPanel').style.display = 'block';
      loadDmList();
    }

    function handleDmKeypress(event) {
      if (event.key === "Enter") sendDm();
    }

    async function sendDm() {
      let input = document.getElementById("dmInput");
      let text = input.value.trim();
      let dmId = input.dataset.dmId;
      
      if (text === "" || !dmId || !myProfile) return;
      
      if (myProfile.muted) {
        showNotification("You are muted.", 'warning');
        return;
      }
      
      await db.collection("dms").doc(dmId).collection("messages").add({
        senderId: userId,
        text: text,
        timestamp: Date.now()
      });
      
      await db.collection("dms").doc(dmId).update({
        lastMessage: Date.now(),
        lastMessageText: text
      });
      
      input.value = "";
      playSound('message');
    }

    // ===== GROUP CHATS =====
    function openGroupModal() {
      document.getElementById("groupModal").classList.add("open");
      loadGroupMembersList();
    }

    function closeGroupModal() {
      document.getElementById("groupModal").classList.remove("open");
    }

    async function loadGroupMembersList() {
      if (!myProfile || !myProfile.friends) return;
      
      let html = "";
      for (let friendId of myProfile.friends) {
        let doc = await db.collection("users").doc(friendId).get();
        if (doc.exists) {
          let friend = doc.data();
          html += `<div class="group-member">`;
          html += `<img src="${friend.pic}">`;
          html += `<span>${getDisplayName(friend.username)}</span>`;
          html += `<input type="checkbox" class="group-member-check" data-user-id="${friendId}">`;
          html += `</div>`;
        }
      }
      
      document.getElementById("groupMembersList").innerHTML = html || '<p style="color:var(--text-muted);">Add friends to create groups!</p>';
    }

    async function createGroup() {
      let groupName = document.getElementById("groupName").value.trim();
      if (!groupName) {
        alert("Enter a group name!");
        return;
      }
      
      let checkboxes = document.querySelectorAll('.group-member-check:checked');
      let members = [userId];
      checkboxes.forEach(cb => members.push(cb.dataset.userId));
      
      if (members.length < 2) {
        alert("Select at least 1 friend!");
        return;
      }
      
      await db.collection("groups").add({
        name: groupName,
        members: members,
        createdBy: userId,
        createdAt: Date.now(),
        lastMessage: Date.now(),
        lastMessageText: ""
      });
      
      closeGroupModal();
      showNotification("Group created!", 'success');
      loadGroupsList();
    }

    async function loadGroupsList() {
      let groupsSnapshot = await db.collection("groups")
        .where("members", "array-contains", userId)
        .orderBy("lastMessage", "desc")
        .get();
      
      if (groupsSnapshot.empty) {
        document.getElementById("groupsList").innerHTML = '<p style="color:var(--text-muted);text-align:center;">No groups yet.</p>';
        return;
      }
      
      let html = "";
      for (let doc of groupsSnapshot.docs) {
        let group = doc.data();
        html += `<div class="friend-card" onclick="openGroupConversation('${doc.id}')">`;
        html += `<div style="width:40px;height:40px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;"></div>`;
        html += `<div class="friend-card-info">`;
        html += `<div class="friend-card-name">${group.name}</div>`;
        html += `<div class="friend-card-status">${group.members.length} members</div>`;
        html += `</div></div>`;
      }
      
      document.getElementById("groupsList").innerHTML = html;
    }

    function openGroupConversation(groupId) {
      currentGroupId = groupId;
      
      document.querySelectorAll('.dm-panel').forEach(p => p.style.display = 'none');
      document.getElementById('groupConversation').style.display = 'flex';
      
      db.collection("groups").doc(groupId).collection("messages")
        .orderBy("timestamp", "asc")
        .limit(50)
        .onSnapshot(async snapshot => {
          let html = "";
          
          for (let doc of snapshot.docs) {
            let msg = doc.data();
            let isMine = msg.senderId === userId;
            let time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let senderDoc = await db.collection("users").doc(msg.senderId).get();
            let senderPic = senderDoc.exists ? senderDoc.data().pic : '';
            let senderName = senderDoc.exists ? getDisplayName(senderDoc.data().username) : 'Unknown';
            
            html += `<div class="chat-message${isMine ? ' mine' : ''}">`;
            html += `<div class="chat-message-header">`;
            html += `<img class="chat-message-pic" src="${senderPic}">`;
            html += `<span class="chat-message-name">${senderName}</span>`;
            html += `<span class="chat-message-time">${time}</span>`;
            html += `</div>`;
            html += `<div class="chat-message-text">${msg.text}</div>`;
            html += `</div>`;
          }
          
          document.getElementById("groupMessages").innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">Start chatting!</p>';
          document.getElementById("groupMessages").scrollTop = document.getElementById("groupMessages").scrollHeight;
        });
      
      document.getElementById("groupInput").dataset.groupId = groupId;
    }

    function closeGroupConversation() {
      document.getElementById('groupConversation').style.display = 'none';
      document.getElementById('groupsPanel').style.display = 'block';
      loadGroupsList();
    }

    function handleGroupKeypress(event) {
      if (event.key === "Enter") sendGroupMessage();
    }

    async function sendGroupMessage() {
      let input = document.getElementById("groupInput");
      let text = input.value.trim();
      let groupId = input.dataset.groupId;
      
      if (text === "" || !groupId || !myProfile) return;
      
      if (myProfile.muted) {
        showNotification("You are muted.", 'warning');
        return;
      }
      
      await db.collection("groups").doc(groupId).collection("messages").add({
        senderId: userId,
        text: text,
        timestamp: Date.now()
      });
      
      await db.collection("groups").doc(groupId).update({
        lastMessage: Date.now(),
        lastMessageText: text
      });
      
      input.value = "";
      playSound('message');
    }

    // ===== TRADING SYSTEM =====
    let tradePartner = null;
    let tradeMyItems = [];
    let tradeTheirItems = [];

    async function openTrade() {
      if (!myProfile || !myProfile.friends || myProfile.friends.length === 0) {
        alert("Add friends to trade with!");
        return;
      }
      
      let friendId = prompt("Enter friend's user ID to trade with (check their profile):");
      if (!friendId) return;
      
      tradePartner = friendId;
      tradeMyItems = [];
      tradeTheirItems = [];
      
      document.getElementById("tradeModal").classList.add("open");
      loadTradeItems();
    }

    function closeTrade() {
      document.getElementById("tradeModal").classList.remove("open");
      tradePartner = null;
      tradeMyItems = [];
      tradeTheirItems = [];
    }

    async function loadTradeItems() {
      let myItemsHtml = "";
      (myProfile.inventory || []).forEach((item, idx) => {
        let selected = tradeMyItems.includes(idx) ? 'selected' : '';
        myItemsHtml += `<div class="trade-item ${selected}" onclick="toggleTradeItem(${idx}, true)">`;
        myItemsHtml += `<div style="font-size:30px;">${shopItems.find(i => i.id === item)?.icon || ''}</div>`;
        myItemsHtml += `<div style="font-size:10px;">${shopItems.find(i => i.id === item)?.name || 'Item'}</div>`;
        myItemsHtml += `</div>`;
      });
      
      document.getElementById("tradeYourItems").innerHTML = myItemsHtml || '<p style="color:var(--text-muted);font-size:12px;">No items</p>';
      
      // Load partner's items (simplified - in real app you'd fetch from their profile)
      document.getElementById("tradeTheirItems").innerHTML = '<p style="color:var(--text-muted);font-size:12px;">Partner items...</p>';
    }

    function toggleTradeItem(idx, isMine) {
      if (isMine) {
        let pos = tradeMyItems.indexOf(idx);
        if (pos === -1) {
          tradeMyItems.push(idx);
        } else {
          tradeMyItems.splice(pos, 1);
        }
        loadTradeItems();
      }
    }

    async function confirmTrade() {
      if (tradeMyItems.length === 0) {
        alert("Select items to trade!");
        return;
      }
      
      // Simple gift system - remove items from your inventory
      tradeMyItems.sort((a, b) => b - a); // Reverse to remove from end first
      tradeMyItems.forEach(idx => {
        myProfile.inventory.splice(idx, 1);
      });
      
      await db.collection("users").doc(userId).update({ inventory: myProfile.inventory });
      updateInventory();
      closeTrade();
      showNotification("Items gifted!", 'success');
    }

        // ===== MINI-GAMES DATA =====
    const miniGamesData = [
      { id: 'snake', name: 'Snake', icon: '', desc: 'Classic snake game!' },
      { id: 'minesweeper', name: 'Minesweeper', icon: '', desc: 'Find all mines!' },
      { id: 'tetris', name: 'Tetris', icon: '', desc: 'Stack the blocks!' },
      { id: 'pong', name: 'Pong', icon: '', desc: 'Classic ping pong!' },
      { id: 'breakout', name: 'Breakout', icon: '', desc: 'Break all bricks!' },
      { id: 'flappy', name: 'Flappy Bird', icon: '', desc: 'Fly through pipes!' },
      { id: 'memory', name: 'Memory Match', icon: '', desc: 'Match the cards!' },
      { id: 'tictactoe', name: 'Tic Tac Toe', icon: '', desc: 'X vs O!' },
      { id: 'clicker', name: 'Cookie Clicker', icon: '', desc: 'Click for cookies!' },
      { id: '2048', name: '2048', icon: '', desc: 'Merge to 2048!' }
    ];

    function renderMiniGames() {
      let html = "";
      miniGamesData.forEach(game => {
        html += `<div class="minigame-card" onclick="openMiniGame('${game.id}')">`;
        html += `<div class="minigame-icon">${game.icon}</div>`;
        html += `<div class="minigame-name">${game.name}</div>`;
        html += `<div class="minigame-desc">${game.desc}</div>`;
        html += `</div>`;
      });
      document.getElementById("minigamesGrid").innerHTML = html;
    }

    function openMiniGame(gameId) {
      document.getElementById("minigameModal").classList.add("open");
      
      let content = document.getElementById("minigameContent");
      
      switch(gameId) {
        case 'snake':
          initSnakeGame(content);
          break;
        case 'minesweeper':
          initMinesweeperGame(content);
          break;
        case 'tetris':
          initTetrisGame(content);
          break;
        case 'pong':
          initPongGame(content);
          break;
        case 'breakout':
          initBreakoutGame(content);
          break;
        case 'flappy':
          initFlappyGame(content);
          break;
        case 'memory':
          initMemoryGame(content);
          break;
        case 'tictactoe':
          initTicTacToeGame(content);
          break;
        case 'clicker':
          initClickerGame(content);
          break;
        case '2048':
          init2048Game(content);
          break;
        default:
          content.innerHTML = '<p>Game not found!</p>';
      }
      
      playSound('click');
    }

    function closeMiniGame() {
      document.getElementById("minigameModal").classList.remove("open");
      document.getElementById("minigameContent").innerHTML = "";
      
      // Clear any game intervals
      if (window.gameInterval) {
        clearInterval(window.gameInterval);
        window.gameInterval = null;
      }
    }

    // ===== SNAKE GAME =====
    function initSnakeGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Snake</h2>
        <div class="minigame-score">Score: <span id="snakeScore">0</span></div>
        <canvas id="snakeCanvas" class="minigame-canvas" width="400" height="400"></canvas>
        <div class="minigame-controls">
          <p>Use Arrow Keys or WASD to move</p>
          <button class="sidebar-btn sidebar-btn-green" onclick="startSnake()">Start</button>
        </div>
      `;
    }

    function startSnake() {
      let canvas = document.getElementById("snakeCanvas");
      let ctx = canvas.getContext("2d");
      let gridSize = 20;
      let snake = [{ x: 10, y: 10 }];
      let food = { x: 15, y: 15 };
      let direction = { x: 0, y: 0 };
      let score = 0;
      let gameRunning = true;

      function draw() {
        // Background
        ctx.fillStyle = "#1a1a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Grid
        ctx.strokeStyle = "#2a2a2a";
        for (let i = 0; i < canvas.width; i += gridSize) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(canvas.width, i);
          ctx.stroke();
        }
        
        // Food
        ctx.fillStyle = "#ff0000";
        ctx.beginPath();
        ctx.arc(food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2, gridSize/2 - 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Snake
        snake.forEach((segment, i) => {
          ctx.fillStyle = i === 0 ? "#00ff00" : "#00cc00";
          ctx.fillRect(segment.x * gridSize + 1, segment.y * gridSize + 1, gridSize - 2, gridSize - 2);
        });
      }

      function update() {
        if (!gameRunning) return;
        
        let head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };
        
        // Wall collision
        if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20) {
          gameOver();
          return;
        }
        
        // Self collision
        for (let segment of snake) {
          if (head.x === segment.x && head.y === segment.y) {
            gameOver();
            return;
          }
        }
        
        snake.unshift(head);
        
        // Eat food
        if (head.x === food.x && head.y === food.y) {
          score += 10;
          document.getElementById("snakeScore").textContent = score;
          food = {
            x: Math.floor(Math.random() * 20),
            y: Math.floor(Math.random() * 20)
          };
          playSound('click');
        } else {
          snake.pop();
        }
        
        draw();
      }

      function gameOver() {
        gameRunning = false;
        clearInterval(window.gameInterval);
        
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#ff0000";
        ctx.font = "30px Poppins";
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2 - 20);
        ctx.fillStyle = "#ffffff";
        ctx.font = "20px Poppins";
        ctx.fillText("Score: " + score, canvas.width/2, canvas.height/2 + 20);
        
        // Award coins based on score
        let coins = Math.floor(score / 5);
        if (coins > 0) {
          addCoins(coins, "Snake - Score: " + score);
          addXP(Math.floor(score / 2), "Snake");
        }
      }

      document.onkeydown = function(e) {
        switch(e.key) {
          case 'ArrowUp': case 'w': case 'W':
            if (direction.y !== 1) { direction = { x: 0, y: -1 }; }
            break;
          case 'ArrowDown': case 's': case 'S':
            if (direction.y !== -1) { direction = { x: 0, y: 1 }; }
            break;
          case 'ArrowLeft': case 'a': case 'A':
            if (direction.x !== 1) { direction = { x: -1, y: 0 }; }
            break;
          case 'ArrowRight': case 'd': case 'D':
            if (direction.x !== -1) { direction = { x: 1, y: 0 }; }
            break;
        }
      };

      direction = { x: 1, y: 0 };
      window.gameInterval = setInterval(update, 100);
      draw();
    }

    // ===== MINESWEEPER GAME =====
    function initMinesweeperGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Minesweeper</h2>
        <div class="minigame-score">Mines: <span id="mineCount">10</span> | Flags: <span id="flagCount">0</span></div>
        <div id="mineGrid" style="display: grid; grid-template-columns: repeat(10, 35px); gap: 2px; justify-content: center; margin: 20px 0;"></div>
        <div class="minigame-controls">
          <p>Left click to reveal, Right click to flag</p>
          <button class="sidebar-btn sidebar-btn-green" onclick="startMinesweeper()">New Game</button>
        </div>
      `;
      startMinesweeper();
    }

    function startMinesweeper() {
      let gridSize = 10;
      let mineCount = 10;
      let grid = [];
      let revealed = [];
      let flagged = [];
      let gameOver = false;
      let firstClick = true;

      // Initialize grid
      for (let i = 0; i < gridSize; i++) {
        grid[i] = [];
        revealed[i] = [];
        flagged[i] = [];
        for (let j = 0; j < gridSize; j++) {
          grid[i][j] = 0;
          revealed[i][j] = false;
          flagged[i][j] = false;
        }
      }

      function placeMines(avoidX, avoidY) {
        let placed = 0;
        while (placed < mineCount) {
          let x = Math.floor(Math.random() * gridSize);
          let y = Math.floor(Math.random() * gridSize);
          
          if (grid[x][y] !== -1 && !(Math.abs(x - avoidX) <= 1 && Math.abs(y - avoidY) <= 1)) {
            grid[x][y] = -1;
            placed++;
          }
        }
        
        // Calculate numbers
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            if (grid[i][j] !== -1) {
              let count = 0;
              for (let di = -1; di <= 1; di++) {
                for (let dj = -1; dj <= 1; dj++) {
                  let ni = i + di;
                  let nj = j + dj;
                  if (ni >= 0 && ni < gridSize && nj >= 0 && nj < gridSize && grid[ni][nj] === -1) {
                    count++;
                  }
                }
              }
              grid[i][j] = count;
            }
          }
        }
      }

      function reveal(x, y) {
        if (x < 0 || x >= gridSize || y < 0 || y >= gridSize) return;
        if (revealed[x][y] || flagged[x][y]) return;
        
        revealed[x][y] = true;
        
        if (grid[x][y] === 0) {
          for (let di = -1; di <= 1; di++) {
            for (let dj = -1; dj <= 1; dj++) {
              reveal(x + di, y + dj);
            }
          }
        }
      }

      function render() {
        let container = document.getElementById("mineGrid");
        container.innerHTML = "";
        
        let flags = 0;
        let unrevealedSafe = 0;
        
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            let cell = document.createElement("div");
            cell.style.cssText = `
              width: 35px;
              height: 35px;
              background: ${revealed[i][j] ? 'var(--bg-tertiary)' : 'var(--bg-secondary)'};
              border: 2px solid var(--bg-primary);
              border-radius: 5px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-weight: bold;
              font-size: 16px;
            `;
            
            if (flagged[i][j]) {
              cell.textContent = "";
              flags++;
            } else if (revealed[i][j]) {
              if (grid[i][j] === -1) {
                cell.textContent = "";
                cell.style.background = "#cc0000";
              } else if (grid[i][j] > 0) {
                cell.textContent = grid[i][j];
                let colors = ['', '#0000ff', '#008000', '#ff0000', '#000080', '#800000', '#008080', '#000000', '#808080'];
                cell.style.color = colors[grid[i][j]];
              }
            } else {
              unrevealedSafe++;
            }
            
            let x = i, y = j;
            cell.onclick = function(e) {
              if (gameOver || flagged[x][y]) return;
              
              if (firstClick) {
                placeMines(x, y);
                firstClick = false;
              }
              
              if (grid[x][y] === -1) {
                // Game over - reveal all
                for (let a = 0; a < gridSize; a++) {
                  for (let b = 0; b < gridSize; b++) {
                    revealed[a][b] = true;
                  }
                }
                gameOver = true;
                render();
                showNotification(" BOOM! Game Over!", 'warning');
              } else {
                reveal(x, y);
                render();
                checkWin();
              }
            };
            
            cell.oncontextmenu = function(e) {
              e.preventDefault();
              if (gameOver || revealed[x][y]) return;
              flagged[x][y] = !flagged[x][y];
              render();
            };
            
            container.appendChild(cell);
          }
        }
        
        document.getElementById("flagCount").textContent = flags;
        
        // Check win (all non-mine cells revealed)
        if (!firstClick && unrevealedSafe === mineCount && !gameOver) {
          checkWin();
        }
      }

      function checkWin() {
        let unrevealed = 0;
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            if (!revealed[i][j] && grid[i][j] !== -1) unrevealed++;
          }
        }
        
        if (unrevealed === 0) {
          gameOver = true;
          showNotification(" You Win!", 'success');
          addCoins(50, "Minesweeper Win");
          addXP(30, "Minesweeper");
        }
      }

      render();
    }

    // ===== MEMORY MATCH GAME =====
    function initMemoryGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Memory Match</h2>
        <div class="minigame-score">Moves: <span id="memoryMoves">0</span> | Pairs: <span id="memoryPairs">0</span>/8</div>
        <div id="memoryGrid" style="display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; justify-content: center; margin: 20px 0;"></div>
        <button class="sidebar-btn sidebar-btn-green" onclick="startMemoryGame()">New Game</button>
      `;
      startMemoryGame();
    }

    function startMemoryGame() {
      let emojis = ['', '', '', '', '', '', '', ''];
      let cards = [...emojis, ...emojis];
      let shuffled = cards.sort(() => Math.random() - 0.5);
      
      let flipped = [];
      let matched = [];
      let moves = 0;
      let pairs = 0;
      let canClick = true;

      function render() {
        let container = document.getElementById("memoryGrid");
        container.innerHTML = "";
        
        shuffled.forEach((emoji, idx) => {
          let card = document.createElement("div");
          card.style.cssText = `
            width: 80px;
            height: 80px;
            background: ${matched.includes(idx) ? 'var(--success)' : flipped.includes(idx) ? 'var(--accent)' : 'var(--bg-tertiary)'};
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            cursor: pointer;
            transition: 0.3s;
          `;
          
          if (flipped.includes(idx) || matched.includes(idx)) {
            card.textContent = emoji;
          } else {
            card.textContent = "";
          }
          
          card.onclick = function() {
            if (!canClick || flipped.includes(idx) || matched.includes(idx)) return;
            
            flipped.push(idx);
            playSound('click');
            render();
            
            if (flipped.length === 2) {
              moves++;
              document.getElementById("memoryMoves").textContent = moves;
              canClick = false;
              
              setTimeout(() => {
                if (shuffled[flipped[0]] === shuffled[flipped[1]]) {
                  matched.push(flipped[0], flipped[1]);
                  pairs++;
                  document.getElementById("memoryPairs").textContent = pairs;
                  
                  if (pairs === 8) {
                    showNotification(" You Win in " + moves + " moves!", 'success');
                    let bonus = Math.max(100 - moves * 2, 20);
                    addCoins(bonus, "Memory Match Win");
                    addXP(20, "Memory Match");
                  }
                }
                
                flipped = [];
                canClick = true;
                render();
              }, 1000);
            }
          };
          
          container.appendChild(card);
        });
      }

      render();
    }

    // ===== TIC TAC TOE =====
    function initTicTacToeGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Tic Tac Toe</h2>
        <div class="minigame-score" id="tttStatus">Your turn (X)</div>
        <div id="tttGrid" style="display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; justify-content: center; margin: 20px 0;"></div>
        <button class="sidebar-btn sidebar-btn-green" onclick="startTicTacToe()">New Game</button>
      `;
      startTicTacToe();
    }

    function startTicTacToe() {
      let board = ['', '', '', '', '', '', '', '', ''];
      let currentPlayer = 'X';
      let gameActive = true;

      const winPatterns = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
      ];

      function checkWin(player) {
        return winPatterns.some(pattern => 
          pattern.every(idx => board[idx] === player)
        );
      }

      function aiMove() {
        // Simple AI - random empty cell
        let emptyCells = board.map((c, i) => c === '' ? i : -1).filter(i => i !== -1);
        if (emptyCells.length === 0) return;
        
        let move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        board[move] = 'O';
        
        if (checkWin('O')) {
          gameActive = false;
          document.getElementById("tttStatus").textContent = "AI Wins! ";
        } else if (!board.includes('')) {
          gameActive = false;
          document.getElementById("tttStatus").textContent = "Draw!";
          addCoins(5, "Tic Tac Toe Draw");
        } else {
          currentPlayer = 'X';
          document.getElementById("tttStatus").textContent = "Your turn (X)";
        }
        
        render();
      }

      function render() {
        let container = document.getElementById("tttGrid");
        container.innerHTML = "";
        
        board.forEach((cell, idx) => {
          let div = document.createElement("div");
          div.style.cssText = `
            width: 100px;
            height: 100px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            cursor: pointer;
            color: ${cell === 'X' ? 'var(--accent)' : 'var(--info)'};
          `;
          div.textContent = cell;
          
          div.onclick = function() {
            if (!gameActive || board[idx] !== '' || currentPlayer !== 'X') return;
            
            board[idx] = 'X';
            playSound('click');
            
            if (checkWin('X')) {
              gameActive = false;
              document.getElementById("tttStatus").textContent = "You Win! ";
              addCoins(20, "Tic Tac Toe Win");
              addXP(10, "Tic Tac Toe");
              render();
              return;
            }
            
            if (!board.includes('')) {
              gameActive = false;
              document.getElementById("tttStatus").textContent = "Draw!";
              addCoins(5, "Tic Tac Toe Draw");
              render();
              return;
            }
            
            currentPlayer = 'O';
            document.getElementById("tttStatus").textContent = "AI thinking...";
            render();
            
            setTimeout(aiMove, 500);
          };
          
          container.appendChild(div);
        });
      }

      render();
    }

    // ===== COOKIE CLICKER =====
    function initClickerGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Cookie Clicker</h2>
        <div class="minigame-score">Cookies: <span id="cookieCount">0</span></div>
        <div id="bigCookie" style="font-size: 150px; text-align: center; cursor: pointer; transition: 0.1s; user-select: none;"></div>
        <div style="text-align: center; margin-top: 20px;">
          <p style="color: var(--text-secondary);">CPS: <span id="cookieCps">0</span></p>
          <button class="sidebar-btn sidebar-btn-orange" id="buyAutoClicker" onclick="buyAutoClicker()">Buy Auto-Clicker (10 )</button>
        </div>
        <p style="color: var(--text-muted); font-size: 12px; text-align: center; margin-top: 15px;">Get 100 cookies to earn coins!</p>
      `;
      
      let cookies = 0;
      let cps = 0;
      let autoClickerCost = 10;

      let cookie = document.getElementById("bigCookie");
      cookie.onclick = function() {
        cookies++;
        document.getElementById("cookieCount").textContent = cookies;
        
        cookie.style.transform = "scale(0.9)";
        setTimeout(() => cookie.style.transform = "scale(1)", 100);
        
        // Spawn floating +1
        let float = document.createElement("div");
        float.textContent = "+1";
        float.style.cssText = `
          position: fixed;
          color: var(--accent);
          font-weight: bold;
          pointer-events: none;
          animation: floatUp 1s forwards;
          z-index: 1000;
          left: ${event.clientX}px;
          top: ${event.clientY}px;
        `;
        document.body.appendChild(float);
        setTimeout(() => float.remove(), 1000);
      };

      window.buyAutoClicker = function() {
        if (cookies >= autoClickerCost) {
          cookies -= autoClickerCost;
          cps++;
          autoClickerCost = Math.floor(autoClickerCost * 1.5);
          document.getElementById("cookieCount").textContent = cookies;
          document.getElementById("cookieCps").textContent = cps;
          document.getElementById("buyAutoClicker").textContent = `Buy Auto-Clicker (${autoClickerCost} )`;
          playSound('click');
        }
      };

      // Auto clicker interval
      window.gameInterval = setInterval(() => {
        if (cps > 0) {
          cookies += cps;
          document.getElementById("cookieCount").textContent = cookies;
        }
        
        // Check for rewards
        if (cookies >= 100 && cookies % 100 < cps + 1) {
          addCoins(5, "Cookie Clicker - 100 cookies");
        }
      }, 1000);
    }

    // ===== 2048 GAME =====
    function init2048Game(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> 2048</h2>
        <div class="minigame-score">Score: <span id="score2048">0</span></div>
        <div id="grid2048" style="display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; justify-content: center; margin: 20px 0; background: var(--bg-primary); padding: 15px; border-radius: 10px;"></div>
        <div class="minigame-controls">
          <p>Use Arrow Keys to move</p>
          <button class="sidebar-btn sidebar-btn-green" onclick="start2048()">New Game</button>
        </div>
      `;
      start2048();
    }

    function start2048() {
      let grid = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
      let score = 0;

      function addRandom() {
        let empty = [];
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            if (grid[i][j] === 0) empty.push({i, j});
          }
        }
        if (empty.length === 0) return false;
        
        let {i, j} = empty[Math.floor(Math.random() * empty.length)];
        grid[i][j] = Math.random() < 0.9 ? 2 : 4;
        return true;
      }

      function getColor(val) {
        const colors = {
          0: '#3a3a3a', 2: '#eee4da', 4: '#ede0c8', 8: '#f2b179',
          16: '#f59563', 32: '#f67c5f', 64: '#f65e3b', 128: '#edcf72',
          256: '#edcc61', 512: '#edc850', 1024: '#edc53f', 2048: '#edc22e'
        };
        return colors[val] || '#3c3a32';
      }

      function getTextColor(val) {
        return val <= 4 ? '#776e65' : '#f9f6f2';
      }

      function render() {
        let container = document.getElementById("grid2048");
        container.innerHTML = "";
        
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            let cell = document.createElement("div");
            cell.style.cssText = `
              width: 80px;
              height: 80px;
              background: ${getColor(grid[i][j])};
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: ${grid[i][j] >= 1000 ? '20px' : '28px'};
              font-weight: bold;
              color: ${getTextColor(grid[i][j])};
            `;
            cell.textContent = grid[i][j] || '';
            container.appendChild(cell);
          }
        }
        
        document.getElementById("score2048").textContent = score;
      }

      function slide(row) {
        let arr = row.filter(x => x !== 0);
        for (let i = 0; i < arr.length - 1; i++) {
          if (arr[i] === arr[i + 1]) {
            arr[i] *= 2;
            score += arr[i];
            arr.splice(i + 1, 1);
          }
        }
        while (arr.length < 4) arr.push(0);
        return arr;
      }

      function move(dir) {
        let oldGrid = JSON.stringify(grid);
        
        if (dir === 'left') {
          for (let i = 0; i < 4; i++) grid[i] = slide(grid[i]);
        } else if (dir === 'right') {
          for (let i = 0; i < 4; i++) grid[i] = slide(grid[i].reverse()).reverse();
        } else if (dir === 'up') {
          for (let j = 0; j < 4; j++) {
            let col = [grid[0][j], grid[1][j], grid[2][j], grid[3][j]];
            col = slide(col);
            for (let i = 0; i < 4; i++) grid[i][j] = col[i];
          }
        } else if (dir === 'down') {
          for (let j = 0; j < 4; j++) {
            let col = [grid[0][j], grid[1][j], grid[2][j], grid[3][j]].reverse();
            col = slide(col).reverse();
            for (let i = 0; i < 4; i++) grid[i][j] = col[i];
          }
        }
        
        if (JSON.stringify(grid) !== oldGrid) {
          addRandom();
          render();
          playSound('click');
          
          // Check for 2048
          for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
              if (grid[i][j] === 2048) {
                showNotification(" You reached 2048!", 'success');
                addCoins(100, "2048 Win");
                addXP(50, "2048");
              }
            }
          }
        }
      }

      document.onkeydown = function(e) {
        if (e.key === 'ArrowLeft') move('left');
        else if (e.key === 'ArrowRight') move('right');
        else if (e.key === 'ArrowUp') move('up');
        else if (e.key === 'ArrowDown') move('down');
      };

      addRandom();
      addRandom();
      render();
    }

    // ===== SIMPLE VERSIONS OF OTHER GAMES =====
    function initTetrisGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Tetris</h2>
        <p style="text-align: center; color: var(--text-secondary);">Coming soon! Play Snake or 2048 for now.</p>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeMiniGame()">Close</button>
      `;
    }

    function initPongGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Pong</h2>
        <p style="text-align: center; color: var(--text-secondary);">Coming soon! Play Snake or Memory Match for now.</p>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeMiniGame()">Close</button>
      `;
    }

    function initBreakoutGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Breakout</h2>
        <p style="text-align: center; color: var(--text-secondary);">Coming soon! Try Tic Tac Toe or Cookie Clicker!</p>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeMiniGame()">Close</button>
      `;
    }

    function initFlappyGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Flappy Bird</h2>
        <p style="text-align: center; color: var(--text-secondary);">Coming soon! Play 2048 or Memory Match for now.</p>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeMiniGame()">Close</button>
      `;
    }

        // ===== SHOP DATA =====
    const shopItems = [
      // Banners
      { id: 'banner_sunset', name: 'Sunset Banner', type: 'banners', icon: '', price: 500, rarity: 'uncommon', image: 'https://images.unsplash.com/photo-1507400492013-162706c8c05e?w=400' },
      { id: 'banner_space', name: 'Space Banner', type: 'banners', icon: '', price: 1000, rarity: 'rare', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=400' },
      { id: 'banner_neon', name: 'Neon City', type: 'banners', icon: '', price: 2000, rarity: 'epic', image: 'https://images.unsplash.com/photo-1545486332-9e0999c535b2?w=400' },
      { id: 'banner_fire', name: 'Fire Banner', type: 'banners', icon: '', price: 5000, rarity: 'legendary', image: 'https://images.unsplash.com/photo-1518972559570-7cc1309f3229?w=400' },
      { id: 'banner_ocean', name: 'Ocean Waves', type: 'banners', icon: '', price: 750, rarity: 'uncommon', image: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=400' },
      
      // Frames
      { id: 'frame_gold', name: 'Gold Frame', type: 'frames', icon: '', price: 1500, rarity: 'rare' },
      { id: 'frame_diamond', name: 'Diamond Frame', type: 'frames', icon: '', price: 5000, rarity: 'legendary' },
      { id: 'frame_fire', name: 'Fire Frame', type: 'frames', icon: '', price: 2500, rarity: 'epic' },
      { id: 'frame_rainbow', name: 'Rainbow Frame', type: 'frames', icon: '', price: 3000, rarity: 'epic' },
      
      // Badges
      { id: 'badge_star', name: 'Star Badge', type: 'badges', icon: '', price: 200, rarity: 'common' },
      { id: 'badge_crown', name: 'Crown Badge', type: 'badges', icon: '', price: 1000, rarity: 'rare' },
      { id: 'badge_vip', name: 'VIP Badge', type: 'badges', icon: '', price: 2500, rarity: 'epic' },
      { id: 'badge_legend', name: 'Legend Badge', type: 'badges', icon: '', price: 7500, rarity: 'legendary' },
      { id: 'badge_og', name: 'OG Badge', type: 'badges', icon: '', price: 500, rarity: 'uncommon' },
      { id: 'badge_gamer', name: 'Gamer Badge', type: 'badges', icon: '', price: 300, rarity: 'common' },
      
      // Effects
      { id: 'effect_sparkle', name: 'Sparkle Effect', type: 'effects', icon: '', price: 1500, rarity: 'rare' },
      { id: 'effect_flame', name: 'Flame Effect', type: 'effects', icon: '', price: 2000, rarity: 'epic' },
      { id: 'effect_hearts', name: 'Hearts Effect', type: 'effects', icon: '', price: 1000, rarity: 'uncommon' },
      { id: 'effect_money', name: 'Money Effect', type: 'effects', icon: '', price: 3000, rarity: 'epic' },
      
      // Titles
      { id: 'title_champion', name: 'Champion', type: 'titles', icon: '', price: 1000, rarity: 'rare' },
      { id: 'title_legend', name: 'Legend', type: 'titles', icon: '', price: 5000, rarity: 'legendary' },
      { id: 'title_pro', name: 'Pro Gamer', type: 'titles', icon: '', price: 500, rarity: 'uncommon' },
      { id: 'title_noob', name: 'Noob', type: 'titles', icon: '', price: 100, rarity: 'common' },
      { id: 'title_rich', name: 'Rich Kid', type: 'titles', icon: '', price: 10000, rarity: 'legendary' }
    ];

    let currentShopTab = 'banners';

    function openShop() {
      document.getElementById("shopModal").classList.add("open");
      document.getElementById("shopCoinsDisplay").textContent = myProfile?.coins || 0;
      renderShopItems();
    }

    function closeShop() {
      document.getElementById("shopModal").classList.remove("open");
    }

    function showShopTab(tab, btn) {
      document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      currentShopTab = tab;
      renderShopItems();
    }

    function renderShopItems() {
      let container = document.getElementById("shopItems");
      let items = shopItems.filter(i => i.type === currentShopTab);
      let owned = myProfile?.inventory || [];
      
      let html = "";
      items.forEach(item => {
        let isOwned = owned.includes(item.id);
        
        html += `<div class="shop-item ${isOwned ? 'owned' : ''}" onclick="${isOwned ? '' : `buyItem('${item.id}')`}">`;
        html += `<div class="shop-item-icon">${item.icon}</div>`;
        html += `<div class="shop-item-name">${item.name}</div>`;
        
        if (isOwned) {
          html += `<div class="shop-item-owned"> Owned</div>`;
        } else {
          html += `<div class="shop-item-price"> ${item.price}</div>`;
        }
        
        html += `<div class="shop-item-rarity rarity-${item.rarity}">${item.rarity.toUpperCase()}</div>`;
        html += `</div>`;
      });
      
      container.innerHTML = html;
    }

    async function buyItem(itemId) {
      let item = shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      if ((myProfile?.coins || 0) < item.price) {
        showNotification("Not enough coins!", 'warning');
        return;
      }
      
      myProfile.coins -= item.price;
      myProfile.inventory = myProfile.inventory || [];
      myProfile.inventory.push(item.id);
      
      await db.collection("users").doc(userId).update({
        coins: myProfile.coins,
        inventory: myProfile.inventory
      });
      
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      document.getElementById("shopCoinsDisplay").textContent = myProfile.coins;
      
      playSound('notification');
      showNotification(`Purchased ${item.name}!`, 'success');
      createConfetti();
      renderShopItems();
      updateInventory();
    }

    function updateInventory() {
      let container = document.getElementById("inventoryItems");
      if (!container) return;
      
      let owned = myProfile?.inventory || [];
      
      if (owned.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); grid-column: span 3; text-align: center;">No items yet. Visit the shop!</p>';
        return;
      }
      
      let html = "";
      owned.forEach(itemId => {
        let item = shopItems.find(i => i.id === itemId);
        if (item) {
          html += `<div style="background: var(--bg-tertiary); padding: 10px; border-radius: 8px; text-align: center; cursor: pointer;" onclick="equipItem('${item.id}')" title="Click to equip">`;
          html += `<div style="font-size: 25px;">${item.icon}</div>`;
          html += `<div style="font-size: 10px; color: var(--text-secondary);">${item.name}</div>`;
          html += `</div>`;
        }
      });
      
      container.innerHTML = html;
    }

    async function equipItem(itemId) {
      let item = shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      let updateData = {};
      
      if (item.type === 'banners' && item.image) {
        myProfile.equippedBanner = item.image;
        updateData.equippedBanner = item.image;
        document.getElementById("myProfileBanner").style.backgroundImage = `url(${item.image})`;
      } else if (item.type === 'badges') {
        myProfile.equippedBadge = item.icon;
        updateData.equippedBadge = item.icon;
      } else if (item.type === 'titles') {
        myProfile.equippedTitle = item.name;
        updateData.equippedTitle = item.name;
      }
      
      await db.collection("users").doc(userId).update(updateData);
      showNotification(`Equipped ${item.name}!`, 'success');
      playSound('click');
    }

    // ===== CASINO =====
    const casinoGames = [
      { id: 'slots', name: 'Slots', icon: '', desc: 'Spin to win!' },
      { id: 'coinflip', name: 'Coin Flip', icon: '', desc: '50/50 chance!' },
      { id: 'dice', name: 'Dice Roll', icon: '', desc: 'Roll the dice!' },
      { id: 'roulette', name: 'Roulette', icon: '', desc: 'Red or black?' }
    ];

    function renderCasinoGames() {
      let html = "";
      casinoGames.forEach(game => {
        html += `<div class="casino-game" onclick="openCasinoGame('${game.id}')">`;
        html += `<div class="casino-game-icon">${game.icon}</div>`;
        html += `<div class="casino-game-name">${game.name}</div>`;
        html += `<div class="casino-game-desc">${game.desc}</div>`;
        html += `</div>`;
      });
      document.getElementById("casinoGames").innerHTML = html;
    }

    function openCasinoGame(gameId) {
      document.getElementById("casinoModal").classList.add("open");
      
      let content = document.getElementById("casinoContent");
      
      switch(gameId) {
        case 'slots':
          initSlotsGame(content);
          break;
        case 'coinflip':
          initCoinFlipGame(content);
          break;
        case 'dice':
          initDiceGame(content);
          break;
        case 'roulette':
          initRouletteGame(content);
          break;
      }
    }

    function closeCasino() {
      document.getElementById("casinoModal").classList.remove("open");
    }

    // ===== SLOTS GAME =====
    function initSlotsGame(container) {
      container.innerHTML = `
        <div class="slots-container">
          <h2 style="color: var(--accent);"> Slots</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="slotsCoins">${myProfile?.coins || 0}</span></p>
          
          <div class="slots-display">
            <div class="slot-reel" id="reel1"></div>
            <div class="slot-reel" id="reel2"></div>
            <div class="slot-reel" id="reel3"></div>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="slotsBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="spinBtn" onclick="spinSlots()"> SPIN</button>
          
          <div id="slotsResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
          
          <p style="color: var(--text-muted); font-size: 12px; margin-top: 15px;">
            3x Same = 10x bet | 2x Same = 2x bet | 3x 7 = JACKPOT (50x)
          </p>
        </div>
      `;
    }

    const slotSymbols = ['', '', '', '', '', '7', ''];

    async function spinSlots() {
      let bet = parseInt(document.getElementById("slotsBet").value);
      
      if (bet < 10) {
        showNotification("Minimum bet is 10 coins!", 'warning');
        return;
      }
      
      if (bet > (myProfile?.coins || 0)) {
        showNotification("Not enough coins!", 'warning');
        return;
      }
      
      // Deduct bet
      myProfile.coins -= bet;
      document.getElementById("slotsCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      // Disable button
      let btn = document.getElementById("spinBtn");
      btn.disabled = true;
      document.getElementById("slotsResult").textContent = "";
      
      // Spin animation
      let reels = [
        document.getElementById("reel1"),
        document.getElementById("reel2"),
        document.getElementById("reel3")
      ];
      
      reels.forEach(r => r.classList.add("spinning"));
      
      let results = [];
      
      // Stop reels one by one
      for (let i = 0; i < 3; i++) {
        await new Promise(resolve => setTimeout(resolve, 500 + i * 300));
        
        results[i] = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        reels[i].classList.remove("spinning");
        reels[i].textContent = results[i];
        playSound('click');
      }
      
      // Calculate winnings
      let winnings = 0;
      let message = "";
      
      if (results[0] === results[1] && results[1] === results[2]) {
        if (results[0] === '7') {
          winnings = bet * 50;
          message = " JACKPOT!!! ";
          createConfetti();
        } else {
          winnings = bet * 10;
          message = " TRIPLE MATCH!";
        }
      } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
        winnings = bet * 2;
        message = "Nice! Double match!";
      } else {
        message = "No match. Try again!";
      }
      
      if (winnings > 0) {
        myProfile.coins += winnings;
        document.getElementById("slotsResult").innerHTML = `<span style="color: var(--success);">${message} Won ${winnings} </span>`;
        addXP(Math.floor(winnings / 10), "Slots");
      } else {
        document.getElementById("slotsResult").innerHTML = `<span style="color: var(--danger);">${message}</span>`;
      }
      
      document.getElementById("slotsCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      btn.disabled = false;
    }

    // ===== COIN FLIP GAME =====
    function initCoinFlipGame(container) {
      container.innerHTML = `
        <div class="coinflip-container">
          <h2 style="color: var(--accent);"> Coin Flip</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="flipCoins">${myProfile?.coins || 0}</span></p>
          
          <div class="coin" id="coin">
            <div class="coin-side coin-heads"></div>
            <div class="coin-side coin-tails"></div>
          </div>
          
          <div class="coinflip-choice">
            <button class="choice-btn heads" id="choiceHeads" onclick="selectCoinChoice('heads')"> Heads</button>
            <button class="choice-btn tails" id="choiceTails" onclick="selectCoinChoice('tails')"> Tails</button>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="flipBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="flipBtn" onclick="flipCoin()" disabled> FLIP</button>
          
          <div id="flipResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
        </div>
      `;
    }

    let coinChoice = null;

    function selectCoinChoice(choice) {
      coinChoice = choice;
      document.getElementById("choiceHeads").classList.toggle("selected", choice === 'heads');
      document.getElementById("choiceTails").classList.toggle("selected", choice === 'tails');
      document.getElementById("flipBtn").disabled = false;
    }

    async function flipCoin() {
      if (!coinChoice) return;
      
      let bet = parseInt(document.getElementById("flipBet").value);
      
      if (bet < 10 || bet > (myProfile?.coins || 0)) {
        showNotification("Invalid bet!", 'warning');
        return;
      }
      
      myProfile.coins -= bet;
      document.getElementById("flipCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      let coin = document.getElementById("coin");
      coin.classList.add("flipping");
      document.getElementById("flipBtn").disabled = true;
      document.getElementById("flipResult").textContent = "";
      
      let result = Math.random() < 0.5 ? 'heads' : 'tails';
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      coin.classList.remove("flipping");
      coin.style.transform = result === 'heads' ? 'rotateY(0deg)' : 'rotateY(180deg)';
      
      if (result === coinChoice) {
        let winnings = bet * 2;
        myProfile.coins += winnings;
        document.getElementById("flipResult").innerHTML = `<span style="color: var(--success);"> You won ${winnings} coins!</span>`;
        addXP(Math.floor(winnings / 5), "Coin Flip");
        playSound('notification');
      } else {
        document.getElementById("flipResult").innerHTML = `<span style="color: var(--danger);"> You lost! It was ${result}</span>`;
      }
      
      document.getElementById("flipCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      coinChoice = null;
      document.getElementById("choiceHeads").classList.remove("selected");
      document.getElementById("choiceTails").classList.remove("selected");
    }

    // ===== DICE GAME =====
    function initDiceGame(container) {
      container.innerHTML = `
        <div class="slots-container">
          <h2 style="color: var(--accent);"> Dice Roll</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="diceCoins">${myProfile?.coins || 0}</span></p>
          
          <div style="font-size: 100px; text-align: center; margin: 30px 0;" id="diceDisplay"></div>
          
          <p style="color: var(--text-primary);">Guess: Higher or Lower than 3.5?</p>
          
          <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
            <button class="sidebar-btn sidebar-btn-green" id="guessHigh" onclick="selectDiceGuess('high')"> High (4-6)</button>
            <button class="sidebar-btn sidebar-btn-red" id="guessLow" onclick="selectDiceGuess('low')"> Low (1-3)</button>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="diceBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="rollBtn" onclick="rollDice()" disabled> ROLL</button>
          
          <div id="diceResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
        </div>
      `;
    }

    let diceGuess = null;
    const diceEmojis = ['', '', '', '', '', ''];

    function selectDiceGuess(guess) {
      diceGuess = guess;
      document.getElementById("guessHigh").style.opacity = guess === 'high' ? 1 : 0.5;
      document.getElementById("guessLow").style.opacity = guess === 'low' ? 1 : 0.5;
      document.getElementById("rollBtn").disabled = false;
    }

    async function rollDice() {
      if (!diceGuess) return;
      
      let bet = parseInt(document.getElementById("diceBet").value);
      
      if (bet < 10 || bet > (myProfile?.coins || 0)) {
        showNotification("Invalid bet!", 'warning');
        return;
      }
      
      myProfile.coins -= bet;
      document.getElementById("diceCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      document.getElementById("rollBtn").disabled = true;
      document.getElementById("diceResult").textContent = "";
      
      let display = document.getElementById("diceDisplay");
      
      // Animation
      for (let i = 0; i < 10; i++) {
        await new Promise(r => setTimeout(r, 100));
        display.textContent = diceEmojis[Math.floor(Math.random() * 6)];
      }
      
      let roll = Math.floor(Math.random() * 6) + 1;
      display.textContent = diceEmojis[roll - 1];
      
      let isHigh = roll > 3;
      let won = (diceGuess === 'high' && isHigh) || (diceGuess === 'low' && !isHigh);
      
      if (won) {
        let winnings = bet * 2;
        myProfile.coins += winnings;
        document.getElementById("diceResult").innerHTML = `<span style="color: var(--success);"> Rolled ${roll}! You won ${winnings} coins!</span>`;
        addXP(Math.floor(winnings / 5), "Dice");
        playSound('notification');
      } else {
        document.getElementById("diceResult").innerHTML = `<span style="color: var(--danger);"> Rolled ${roll}. You lost!</span>`;
      }
      
      document.getElementById("diceCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      diceGuess = null;
      document.getElementById("guessHigh").style.opacity = 1;
      document.getElementById("guessLow").style.opacity = 1;
    }

    // ===== ROULETTE =====
    function initRouletteGame(container) {
      container.innerHTML = `
        <div class="slots-container">
          <h2 style="color: var(--accent);"> Roulette</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="rouletteCoins">${myProfile?.coins || 0}</span></p>
          
          <div style="font-size: 80px; text-align: center; margin: 30px 0; padding: 20px; border-radius: 50%; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin: 20px auto;" id="rouletteDisplay"></div>
          
          <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
            <button class="sidebar-btn" style="background: red; color: white;" id="pickRed" onclick="selectRoulette('red')"> Red</button>
            <button class="sidebar-btn" style="background: black; color: white;" id="pickBlack" onclick="selectRoulette('black')"> Black</button>
            <button class="sidebar-btn" style="background: green; color: white;" id="pickGreen" onclick="selectRoulette('green')"> Green (14x)</button>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="rouletteBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="rouletteBtn" onclick="spinRoulette()" disabled> SPIN</button>
          
          <div id="rouletteResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
        </div>
      `;
    }

    let rouletteChoice = null;

    function selectRoulette(choice) {
      rouletteChoice = choice;
      document.getElementById("pickRed").style.opacity = choice === 'red' ? 1 : 0.5;
      document.getElementById("pickBlack").style.opacity = choice === 'black' ? 1 : 0.5;
      document.getElementById("pickGreen").style.opacity = choice === 'green' ? 1 : 0.5;
      document.getElementById("rouletteBtn").disabled = false;
    }

    async function spinRoulette() {
      if (!rouletteChoice) return;
      
      let bet = parseInt(document.getElementById("rouletteBet").value);
      
      if (bet < 10 || bet > (myProfile?.coins || 0)) {
        showNotification("Invalid bet!", 'warning');
        return;
      }
      
      myProfile.coins -= bet;
      document.getElementById("rouletteCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      document.getElementById("rouletteBtn").disabled = true;
      document.getElementById("rouletteResult").textContent = "";
      
      let display = document.getElementById("rouletteDisplay");
      let colors = ['', '', '', '', '', '', '', '', ''];
      
      // Animation
      for (let i = 0; i < 20; i++) {
        await new Promise(r => setTimeout(r, 50 + i * 10));
        display.textContent = colors[Math.floor(Math.random() * colors.length)];
      }
      
      // Result (green is rare)
      let rand = Math.random();
      let result;
      if (rand < 0.07) {
        result = 'green';
        display.textContent = '';
      } else if (rand < 0.535) {
        result = 'red';
        display.textContent = '';
      } else {
        result = 'black';
        display.textContent = '';
      }
      
      let won = result === rouletteChoice;
      let multiplier = result === 'green' ? 14 : 2;
      
      if (won) {
        let winnings = bet * multiplier;
        myProfile.coins += winnings;
        document.getElementById("rouletteResult").innerHTML = `<span style="color: var(--success);"> ${result.toUpperCase()}! You won ${winnings} coins!</span>`;
        addXP(Math.floor(winnings / 5), "Roulette");
        playSound('notification');
        if (result === 'green') createConfetti();
      } else {
        document.getElementById("rouletteResult").innerHTML = `<span style="color: var(--danger);"> It was ${result}. You lost!</span>`;
      }
      
      document.getElementById("rouletteCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      rouletteChoice = null;
      document.getElementById("pickRed").style.opacity = 1;
      document.getElementById("pickBlack").style.opacity = 1;
      document.getElementById("pickGreen").style.opacity = 1;
    }


        // ===== ADMIN COMMANDS =====
    const adminCommands = {
      '/help': 'Show all commands',
      '/givexp [user] [amount]': 'Give XP to user',
      '/givecoins [user] [amount]': 'Give coins to user',
      '/giveitem [user] [itemid]': 'Give item to user',
      '/giveall': 'Give yourself all items',
      '/ban [user]': 'Permanent ban',
      '/tempban [user] [hours]': 'Temporary ban',
      '/unban [user]': 'Unban user',
      '/mute [user]': 'Mute user',
      '/unmute [user]': 'Unmute user',
      '/announce [message]': 'Set announcement',
      '/clearchat': 'Clear all chat messages',
      '/stats': 'Show site stats',
      '/items': 'List all shop items'
    };

    function handleAdminCmd(event) {
      if (event.key === 'Enter') {
        executeAdminCmd();
      }
    }

    async function executeAdminCmd() {
      if (!isAdmin) {
        showNotification("You're not an admin!", 'warning');
        return;
      }
      
      let input = document.getElementById("adminCmd").value.trim();
      let output = document.getElementById("cmdOutput");
      
      if (!input) return;
      
      let parts = input.split(' ');
      let cmd = parts[0].toLowerCase();
      let args = parts.slice(1);
      
      let result = "";
      
      try {
        switch(cmd) {
          case '/help':
            result = "<strong>Admin Commands:</strong><br>";
            for (let c in adminCommands) {
              result += `${c} - ${adminCommands[c]}<br>`;
            }
            break;
            
                      case '/givexp':
            if (args.length < 2) {
              result = "Usage: /givexp [username] [amount]";
            } else {
              let targetName = args[0];
              let amount = parseInt(args[1]);
              let targetUser = await findUserByName(targetName);
              
              if (targetUser) {
                let newXp = (targetUser.data.xp || 0) + amount;
                await db.collection("users").doc(targetUser.id).update({ xp: newXp });
                
                // If giving to yourself, update local profile and XP bar
                if (targetUser.id === userId) {
                  myProfile.xp = newXp;
                  updateXPBar();
                  updateProfileDisplay();
                  
                  // Check for level ups
                  let oldLevel = calculateLevel(targetUser.data.xp || 0).level;
                  let newLevel = calculateLevel(newXp).level;
                  
                  if (newLevel > oldLevel) {
                    showNotification(` LEVEL UP! You're now level ${newLevel}!`, 'success');
                    createConfetti();
                  }
                }
                
                result = `<span style="color:var(--success)">Gave ${amount} XP to ${targetName} (Now Level ${calculateLevel(newXp).level})</span>`;
                logAdminAction(`Gave ${amount} XP to ${targetName}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
                       case '/givecoins':
            if (args.length < 2) {
              result = "Usage: /givecoins [username] [amount]";
            } else {
              let targetName = args[0];
              let amount = parseInt(args[1]);
              
              // No limit for admin commands!
              let targetUser = await findUserByName(targetName);
              
              if (targetUser) {
                let newCoins = (targetUser.data.coins || 0) + amount;
                await db.collection("users").doc(targetUser.id).update({ coins: newCoins });
                
                // If giving to yourself, update local profile too
                if (targetUser.id === userId) {
                  myProfile.coins = newCoins;
                  document.getElementById("coinsDisplay").textContent = newCoins;
                  document.getElementById("shopCoinsDisplay").textContent = newCoins;
                }
                
                result = `<span style="color:var(--success)">Gave ${amount} coins to ${targetName}</span>`;
                logAdminAction(`Gave ${amount} coins to ${targetName}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
         
         
            case '/giveitem':
            if (args.length < 2) {
              result = "Usage: /giveitem [username] [itemid]<br>Use /items to see item IDs";
            } else {
              let targetName = args[0];
              let itemId = args[1];
              let item = shopItems.find(i => i.id === itemId);
              
              if (!item) {
                result = `<span style="color:var(--danger)">Item not found. Use /items to see IDs</span>`;
                break;
              }
              
              let targetUser = await findUserByName(targetName);
              
              if (targetUser) {
                let inv = targetUser.data.inventory || [];
                if (!inv.includes(itemId)) {
                  inv.push(itemId);
                  await db.collection("users").doc(targetUser.id).update({ inventory: inv });
                  result = `<span style="color:var(--success)">Gave ${item.name} to ${targetName}</span>`;
                  logAdminAction(`Gave ${item.name} to ${targetName}`);
                } else {
                  result = `<span style="color:var(--warning)">User already owns this item</span>`;
                }
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/giveall':
            let allItemIds = shopItems.map(i => i.id);
            myProfile.inventory = allItemIds;
            await db.collection("users").doc(userId).update({ inventory: allItemIds });
            updateInventory();
            result = `<span style="color:var(--success)">Gave yourself all ${allItemIds.length} items!</span>`;
            logAdminAction(`Gave themselves all items`);
            break;
            
          case '/ban':
            if (args.length < 1) {
              result = "Usage: /ban [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ banned: true });
                result = `<span style="color:var(--success)">Banned ${args[0]}</span>`;
                logAdminAction(`Banned ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/tempban':
            if (args.length < 2) {
              result = "Usage: /tempban [username] [hours]";
            } else {
              let hours = parseInt(args[1]);
              let until = Date.now() + (hours * 60 * 60 * 1000);
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ tempBanUntil: until });
                result = `<span style="color:var(--success)">Temp banned ${args[0]} for ${hours} hours</span>`;
                logAdminAction(`Temp banned ${args[0]} for ${hours} hours`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/unban':
            if (args.length < 1) {
              result = "Usage: /unban [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ banned: false, tempBanUntil: null });
                result = `<span style="color:var(--success)">Unbanned ${args[0]}</span>`;
                logAdminAction(`Unbanned ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/mute':
            if (args.length < 1) {
              result = "Usage: /mute [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ muted: true });
                result = `<span style="color:var(--success)">Muted ${args[0]}</span>`;
                logAdminAction(`Muted ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/unmute':
            if (args.length < 1) {
              result = "Usage: /unmute [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ muted: false });
                result = `<span style="color:var(--success)">Unmuted ${args[0]}</span>`;
                logAdminAction(`Unmuted ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/announce':
            if (args.length < 1) {
              result = "Usage: /announce [message]";
            } else {
              let msg = args.join(' ');
              await db.collection("settings").doc("announcement").set({ text: msg, timestamp: Date.now() });
              result = `<span style="color:var(--success)">Announcement set!</span>`;
              logAdminAction(`Set announcement: ${msg}`);
            }
            break;
            
          case '/clearchat':
            let chats = await db.collection("chat").get();
            let batch = db.batch();
            chats.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            result = `<span style="color:var(--success)">Chat cleared!</span>`;
            logAdminAction(`Cleared all chat`);
            break;
            
          case '/stats':
            let users = await db.collection("users").get();
            let messages = await db.collection("chat").get();
            let totalCoins = 0;
            users.forEach(doc => totalCoins += (doc.data().coins || 0));
            result = `<strong>Site Stats:</strong><br>`;
            result += `Users: ${users.size}<br>`;
            result += `Messages: ${messages.size}<br>`;
            result += `Total Coins: ${totalCoins}`;
            break;
            
          case '/items':
            result = "<strong>Shop Items:</strong><br>";
            shopItems.forEach(item => {
              result += `${item.icon} ${item.id} - ${item.name}<br>`;
            });
            break;
            
          default:
            result = `<span style="color:var(--danger)">Unknown command. Use /help</span>`;
        }
      } catch (error) {
        result = `<span style="color:var(--danger)">Error: ${error.message}</span>`;
      }
      
      output.innerHTML = result;
      document.getElementById("adminCmd").value = "";
    }

    async function findUserByName(username) {
      let snapshot = await db.collection("users").get();
      let found = null;
      
      snapshot.forEach(doc => {
        let displayName = getDisplayName(doc.data().username);
        if (displayName.toLowerCase() === username.toLowerCase()) {
          found = { id: doc.id, data: doc.data() };
        }
      });
      
      return found;
    }

    async function logAdminAction(action) {
      await db.collection("auditLog").add({
        adminId: userId,
        adminName: getDisplayName(myProfile.username),
        action: action,
        timestamp: Date.now()
      });
      
      loadAuditLog();
    }

    async function loadAuditLog() {
      if (!isAdmin) return;
      
      let logs = await db.collection("auditLog")
        .orderBy("timestamp", "desc")
        .limit(20)
        .get();
      
      let html = "";
      logs.forEach(doc => {
        let log = doc.data();
        let time = new Date(log.timestamp).toLocaleString();
        html += `<div class="audit-item">`;
        html += `<span class="audit-admin">${log.adminName}</span>: `;
        html += `<span class="audit-action">${log.action}</span><br>`;
        html += `<span class="audit-time">${time}</span>`;
        html += `</div>`;
      });
      
      document.getElementById("auditLog").innerHTML = html || '<p style="color:var(--text-muted);">No actions yet.</p>';
    }

       // ===== TAB CLOAK =====
    const cloakPresets = {
      classroom: { title: 'Google Classroom', icon: 'https://www.google.com/s2/favicons?domain=classroom.google.com&sz=64' },
      docs: { title: 'Google Docs', icon: 'https://www.google.com/s2/favicons?domain=docs.google.com&sz=64' },
      drive: { title: 'Google Drive', icon: 'https://www.google.com/s2/favicons?domain=drive.google.com&sz=64' },
      gmail: { title: 'Gmail', icon: 'https://www.google.com/s2/favicons?domain=gmail.com&sz=64' },
      canvas: { title: 'Canvas', icon: 'https://www.google.com/s2/favicons?domain=instructure.com&sz=64' },
      khan: { title: 'Khan Academy', icon: 'https://www.google.com/s2/favicons?domain=khanacademy.org&sz=64' }
    };

    function setCloakPreset(preset) {
      let p = cloakPresets[preset];
      if (p) {
        applyCloak(p.title, p.icon);
        
        // Fill in the custom fields too
        document.getElementById("customCloakTitle").value = p.title;
        document.getElementById("customCloakIcon").value = p.icon;
        
        showNotification(`Tab disguised as ${p.title}`, 'success');
        playSound('click');
      }
    }

    function applyCustomCloak() {
      let title = document.getElementById("customCloakTitle").value.trim();
      let icon = document.getElementById("customCloakIcon").value.trim();
      
      if (!title) {
        showNotification("Enter a title!", 'warning');
        return;
      }
      
      // Default icon if none provided
      if (!icon) {
        icon = 'https://www.google.com/s2/favicons?domain=google.com&sz=64';
      }
      
      applyCloak(title, icon);
      showNotification(`Tab disguised as "${title}"`, 'success');
      playSound('click');
    }

    function applyCloak(title, icon) {
      document.title = title;
      document.getElementById("favicon").href = icon;
      
      // Save for auto-apply
      localStorage.setItem("cloakTitle", title);
      localStorage.setItem("cloakIcon", icon);
    }

    function resetCloak() {
      document.title = "The Gaming Hub";
      document.getElementById("favicon").href = "";
      
      document.getElementById("customCloakTitle").value = "";
      document.getElementById("customCloakIcon").value = "";
      
      localStorage.removeItem("cloakTitle");
      localStorage.removeItem("cloakIcon");
      
      showNotification("Tab cloak removed", 'success');
      playSound('click');
    }

    function saveAutoCloak() {
      let enabled = document.getElementById("autoCloakEnabled").checked;
      localStorage.setItem("autoCloakEnabled", enabled);
    }

    function loadCloak() {
      let autoEnabled = localStorage.getItem("autoCloakEnabled") === 'true';
      
      if (document.getElementById("autoCloakEnabled")) {
        document.getElementById("autoCloakEnabled").checked = autoEnabled;
      }
      
      if (autoEnabled) {
        let savedTitle = localStorage.getItem("cloakTitle");
        let savedIcon = localStorage.getItem("cloakIcon");
        
        if (savedTitle) {
          document.title = savedTitle;
          if (document.getElementById("customCloakTitle")) {
            document.getElementById("customCloakTitle").value = savedTitle;
          }
        }
        if (savedIcon) {
          document.getElementById("favicon").href = savedIcon;
          if (document.getElementById("customCloakIcon")) {
            document.getElementById("customCloakIcon").value = savedIcon;
          }
        }
      }
    }

    function openInAboutBlank() {
      let win = window.open('about:blank', '_blank');
      
      if (!win) {
        showNotification("Pop-up blocked! Allow pop-ups for this site.", 'warning');
        return;
      }
      
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${document.getElementById("customCloakTitle").value || 'Google Classroom'}</title>
          <link rel="icon" href="${document.getElementById("customCloakIcon").value || 'https://www.google.com/s2/favicons?domain=classroom.google.com&sz=64'}">
          <style>
            body { margin: 0; overflow: hidden; }
            iframe { width: 100vw; height: 100vh; border: none; }
          </style>
        </head>
        <body>
          <iframe src="${window.location.href}"></iframe>
       
        
        
        <!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Achievement Popup -->
<div class="achievement-popup" id="achievementPopup">
    <div class="achievement-icon"></div>
    <h2 id="achievementTitle">Achievement Unlocked!</h2>
    <p id="achievementDesc">You're awesome!</p>
</div>

<!-- Virtual Pet -->
<div class="virtual-pet-container" id="virtualPetContainer">
    <div class="virtual-pet" id="virtualPet"></div>
    <div class="pet-stats" id="petStats">
        <h4>Your Pet: <span id="petName">Blob</span></h4>
        <div class="pet-stat">
            <span>Health:</span>
            <div class="pet-stat-bar">
                <div class="pet-stat-fill health" id="petHealth" style="width: 100%"></div>
            </div>
        </div>
        <div class="pet-stat">
            <span>Happiness:</span>
            <div class="pet-stat-bar">
                <div class="pet-stat-fill happiness" id="petHappiness" style="width: 80%"></div>
            </div>
        </div>
        <div class="pet-stat">
            <span>Hunger:</span>
            <div class="pet-stat-bar">
                <div class="pet-stat-fill hunger" id="petHunger" style="width: 60%"></div>
            </div>
        </div>
        <button onclick="feedPet()"> Feed</button>
        <button onclick="playWithPet()"> Play</button>
        <button id="godModeBtn" style="display:none" onclick="toggleGodMode()"> God Mode</button>
    </div>
</div>

<!-- Theme Builder Modal -->
<div class="theme-builder" id="themeBuilder">
    <h2>Custom Theme Builder</h2>
    <div class="color-picker-group">
        <label>Background Color:</label>
        <input type="color" id="customBgColor" value="#1a1a2e">
    </div>
    <div class="color-picker-group">
        <label>Text Color:</label>
        <input type="color" id="customTextColor" value="#ffffff">
    </div>
    <div class="color-picker-group">
        <label>Accent Color:</label>
        <input type="color" id="customAccentColor" value="#667eea">
    </div>
    <div class="color-picker-group">
        <label>Card Background:</label>
        <input type="color" id="customCardBg" value="#2a2a3e">
    </div>
    <button onclick="applyCustomTheme()">Apply Theme</button>
    <button onclick="saveCustomTheme()">Save Theme</button>
    <button onclick="closeThemeBuilder()">Close</button>
</div>

<!-- Enhanced Ban Modal -->
<div class="ban-modal" id="banModal">
    <h2>Ban User</h2>
    <div class="ban-form-group">
        <label>Ban Duration:</label>
        <select id="banDuration">
            <option value="1h">1 Hour</option>
            <option value="24h">24 Hours</option>
            <option value="7d">7 Days</option>
            <option value="30d">30 Days</option>
            <option value="permanent">Permanent</option>
        </select>
    </div>
    <div class="ban-form-group">
        <label>Reason:</label>
        <textarea id="banReason" rows="3" placeholder="Enter ban reason..."></textarea>
    </div>
    <div class="ban-form-group">
        <label>
            <input type="checkbox" id="deleteContent"> Delete all user's content
        </label>
    </div>
    <button onclick="confirmBan()">Confirm Ban</button>
    <button onclick="closeBanModal()">Cancel</button>
</div>

<!-- Matrix Rain Canvas (Hidden by default) -->
<div class="matrix-rain" id="matrixRain" style="display:none;">
    <canvas id="matrixCanvas"></canvas>
</div>

<!-- Infinite Scroll Loader -->
<div class="infinite-scroll-loader" id="infiniteLoader">
    <div class="skeleton skeleton-post">
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
        <div class="skeleton skeleton-text"></div>
    </div>
</div>
<div class="infinite-scroll-end" id="infiniteEnd">
    <p> You've reached the end! </p>
</div>
        
        
        
        
        
        
        
        
        </body>
        </html>
      `);
      win.document.close();
      
      // Optionally close this tab or redirect
      showNotification("Opened in about:blank! You can close this tab.", 'success');
    }

    // Remove or comment out these old functions if they exist:
    // function openCloakModal() { ... }
    // function closeCloakModal() { ... }
    // ===== PARTICLES =====
   
   
    function changeParticles(type) {
      let container = document.getElementById("particles-container");
      container.innerHTML = "";
      
      localStorage.setItem("particles", type);
      
      if (type === 'none') return;
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          let particle = document.createElement("div");
          particle.className = `particle ${type}`;
          particle.style.left = Math.random() * 100 + 'vw';
          particle.style.animationDuration = (Math.random() * 5 + 5) + 's';
          particle.style.animationDelay = (Math.random() * 5) + 's';
          
          if (type === 'confetti') {
            particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
          } else if (type === 'hearts') {
            particle.textContent = '';
          }
          
          container.appendChild(particle);
        }, i * 100);
      }
    }

    // ===== THEMES =====
    function changeTheme(theme) {
      document.body.dataset.theme = theme;
      localStorage.setItem("theme", theme);
    }

    function changeFont(font) {
      document.body.className = `font-${font}`;
      localStorage.setItem("font", font);
    }

    function toggleCompactMode() {
      let compact = document.getElementById("compactMode").checked;
      document.body.classList.toggle("compact-mode", compact);
      localStorage.setItem("compactMode", compact);
    }

    // ===== SETTINGS =====
    function setCustomBg() {
      let url = document.getElementById("bgUrl").value.trim();
      if (url) {
        document.getElementById("customBg").style.backgroundImage = `url(${url})`;
        localStorage.setItem("customBg", url);
        showNotification("Background set!", 'success');
      }
    }

    function clearCustomBg() {
      document.getElementById("customBg").style.backgroundImage = '';
      document.getElementById("bgUrl").value = '';
      localStorage.removeItem("customBg");
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      localStorage.setItem("soundEnabled", soundEnabled);
      document.getElementById("soundToggle").textContent = soundEnabled ? '' : '';
      document.getElementById("soundToggle").classList.toggle("muted", !soundEnabled);
      document.getElementById("soundEnabled").checked = soundEnabled;
    }

    function toggleSoundSetting() {
      soundEnabled = document.getElementById("soundEnabled").checked;
      localStorage.setItem("soundEnabled", soundEnabled);
      document.getElementById("soundToggle").textContent = soundEnabled ? '' : '';
    }

    function saveSettings() {
      notifSound = document.getElementById("notifSound").checked;
      localStorage.setItem("notifSound", notifSound);
    }

    let panicUrl = localStorage.getItem("panicUrl") || "https://classroom.google.com";

    function savePanicUrl() {
      panicUrl = document.getElementById("panicUrl").value;
      localStorage.setItem("panicUrl", panicUrl);
      showNotification("Panic URL saved!", 'success');
    }

    // Panic button
    document.addEventListener("keydown", function(e) {
      if (e.key === "`") {
        e.preventDefault();
        window.location.href = panicUrl;
      }
    });

    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      document.getElementById(pageId).style.display = "block";
      playSound('click');
      window.scrollTo(0, 0);
    }

    // ===== SIDEBAR =====
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("open");
      document.querySelector(".sidebar-toggle").textContent = document.getElementById("sidebar").classList.contains("open") ? "" : "";
      playSound('click');
    }

    function showSidebarTab(tabId, btn) {
      document.querySelectorAll(".sidebar-panel").forEach(p => p.classList.remove("active"));
      document.querySelectorAll(".sidebar-tab").forEach(t => t.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
      btn.classList.add("active");
      
      if (tabId === "adminTab") loadAuditLog();
      if (tabId === "onlineTab") loadOnlineUsers();
      
      playSound('click');
    }

    // ===== PROFILE MODAL =====
    async function viewProfile(uid) {
      let doc = await db.collection("users").doc(uid).get();
      if (!doc.exists) return;
      
      let user = doc.data();
      let { level } = calculateLevel(user.xp || 0);
      
      document.getElementById("modalProfilePic").src = user.pic;
      document.getElementById("modalProfileName").textContent = getDisplayName(user.username);
      document.getElementById("modalProfileRole").textContent = getRole(user.username);
      document.getElementById("modalProfileLevel").textContent = `LVL ${level}`;
      document.getElementById("modalProfileBio").textContent = user.bio || "No bio";
      
      if (user.equippedBanner) {
        document.getElementById("modalProfileBanner").style.backgroundImage = `url(${user.equippedBanner})`;
      }
      
      document.getElementById("modalProfileStats").innerHTML = `
        <div class="profile-modal-stat">
          <div class="profile-modal-stat-num">${user.gamesPlayed || 0}</div>
          <div class="profile-modal-stat-label">Games</div>
        </div>
        <div class="profile-modal-stat">
          <div class="profile-modal-stat-num">${(user.friends || []).length}</div>
          <div class="profile-modal-stat-label">Friends</div>
        </div>
        <div class="profile-modal-stat">
          <div class="profile-modal-stat-num">${user.messagesSent || 0}</div>
          <div class="profile-modal-stat-label">Messages</div>
        </div>
      `;
      
      let actions = "";
      if (uid !== userId) {
        let isFriend = (myProfile?.friends || []).includes(uid);
        actions += `<button class="sidebar-btn sidebar-btn-blue" onclick="openDmWith('${uid}'); closeProfileModal();"> Message</button>`;
        actions += isFriend 
          ? `<button class="sidebar-btn sidebar-btn-red" onclick="removeFriend('${uid}'); closeProfileModal();">Remove</button>`
          : `<button class="sidebar-btn sidebar-btn-green" onclick="sendFriendRequest('${uid}'); closeProfileModal();">Add Friend</button>`;
      }
      document.getElementById("modalProfileActions").innerHTML = actions;
      
      document.getElementById("profileModal").classList.add("open");
    }

    function closeProfileModal() {
      document.getElementById("profileModal").classList.remove("open");
    }

    function viewTeamProfile(name) {
      db.collection("users").get().then(snapshot => {
        snapshot.forEach(doc => {
          if (getDisplayName(doc.data().username).toLowerCase() === name.toLowerCase()) {
            viewProfile(doc.id);
          }
        });
      });
    }

    // ===== FRIENDS =====
    async function sendFriendRequest(targetId) {
      let targetDoc = await db.collection("users").doc(targetId).get();
      if (!targetDoc.exists) return;
      
      let requests = targetDoc.data().friendRequests || [];
      if (!requests.includes(userId)) {
        requests.push(userId);
        await db.collection("users").doc(targetId).update({ friendRequests: requests });
        showNotification("Friend request sent!", 'success');
      }
    }

    async function loadFriendRequests() {
      if (!myProfile?.friendRequests?.length) {
        document.getElementById("friendRequests").innerHTML = '<p style="color:var(--text-muted);">No pending requests.</p>';
        return;
      }
      
      let html = "";
      for (let reqId of myProfile.friendRequests) {
        let doc = await db.collection("users").doc(reqId).get();
        if (doc.exists) {
          let user = doc.data();
          html += `<div class="friend-card">
            <img src="${user.pic}">
            <div class="friend-card-info">
              <div class="friend-card-name">${getDisplayName(user.username)}</div>
            </div>
            <button class="friend-btn sidebar-btn-green" onclick="acceptFriend('${reqId}')"></button>
            <button class="friend-btn sidebar-btn-red" onclick="declineFriend('${reqId}')"></button>
          </div>`;
        }
      }
      document.getElementById("friendRequests").innerHTML = html;
    }

    async function acceptFriend(reqId) {
      let myFriends = myProfile.friends || [];
      myFriends.push(reqId);
      
      let myRequests = myProfile.friendRequests || [];
      myRequests = myRequests.filter(r => r !== reqId);
      
      myProfile.friends = myFriends;
      myProfile.friendRequests = myRequests;
      
      await db.collection("users").doc(userId).update({ friends: myFriends, friendRequests: myRequests });
      
      let reqDoc = await db.collection("users").doc(reqId).get();
      if (reqDoc.exists) {
        let theirFriends = reqDoc.data().friends || [];
        theirFriends.push(userId);
        await db.collection("users").doc(reqId).update({ friends: theirFriends });
      }
      
      showNotification("Friend added!", 'success');
      updateProfileDisplay();
    }

    async function declineFriend(reqId) {
      let myRequests = myProfile.friendRequests.filter(r => r !== reqId);
      myProfile.friendRequests = myRequests;
      await db.collection("users").doc(userId).update({ friendRequests: myRequests });
      updateProfileDisplay();
    }

    async function loadFriends() {
      if (!myProfile?.friends?.length) {
        document.getElementById("friendsList").innerHTML = '<p style="color:var(--text-muted);">No friends yet.</p>';
        return;
      }
      
      let html = "";
      for (let friendId of myProfile.friends) {
        let doc = await db.collection("users").doc(friendId).get();
        if (doc.exists) {
          let friend = doc.data();
          let online = isUserOnline(friend.lastSeen);
          html += `<div class="friend-card" onclick="viewProfile('${friendId}')">
            <img src="${friend.pic}">
            <div class="friend-card-info">
              <div class="friend-card-name">${online ? '<span class="status-dot status-online"></span>' : '<span class="status-dot status-offline"></span>'}${getDisplayName(friend.username)}</div>
              <div class="friend-card-status">${friend.status || ''}</div>
            </div>
            <button class="friend-btn sidebar-btn-blue" onclick="event.stopPropagation(); openDmWith('${friendId}')"></button>
          </div>`;
        }
      }
      document.getElementById("friendsList").innerHTML = html;
    }

    async function removeFriend(friendId) {
      myProfile.friends = myProfile.friends.filter(f => f !== friendId);
      await db.collection("users").doc(userId).update({ friends: myProfile.friends });
      
      let friendDoc = await db.collection("users").doc(friendId).get();
      if (friendDoc.exists) {
        let theirFriends = friendDoc.data().friends.filter(f => f !== userId);
        await db.collection("users").doc(friendId).update({ friends: theirFriends });
      }
      
      updateProfileDisplay();
    }

    // ===== ONLINE USERS =====
    async function loadOnlineUsers() {
      let snapshot = await db.collection("users").get();
      let online = [], offline = [];
      
      snapshot.forEach(doc => {
        let user = { id: doc.id, ...doc.data() };
        if (isUserOnline(user.lastSeen)) online.push(user);
        else offline.push(user);
      });
      
      let html = "";
      online.forEach(user => {
        html += `<div class="friend-card" onclick="viewProfile('${user.id}')">
          <img src="${user.pic}">
          <div class="friend-card-info">
            <div class="friend-card-name"><span class="status-dot status-online"></span>${getDisplayName(user.username)}</div>
          </div>
        </div>`;
      });
      document.getElementById("onlineUsersList").innerHTML = html || '<p style="color:var(--text-muted);">No one online</p>';
      document.getElementById("onlineCountSidebar").textContent = `${online.length} online`;
      document.getElementById("onlineCount").textContent = `${online.length} online`;
      document.getElementById("statOnlineNow").textContent = online.length;
    }

    // ===== SEARCH =====
    async function searchUsers() {
      let query = document.getElementById("userSearch").value.toLowerCase().trim();
      if (!query) {
        document.getElementById("userSearchResults").innerHTML = "";
        return;
      }
      
      let snapshot = await db.collection("users").limit(10).get();
      let html = "";
      
      snapshot.forEach(doc => {
        let user = doc.data();
        let name = getDisplayName(user.username);
        if (name.toLowerCase().includes(query) && doc.id !== userId) {
          html += `<div class="friend-card" onclick="viewProfile('${doc.id}')">
            <img src="${user.pic}">
            <div class="friend-card-info">
              <div class="friend-card-name">${name}</div>
            </div>
          </div>`;
        }
      });
      
      document.getElementById("userSearchResults").innerHTML = html || '<p style="color:var(--text-muted);">No users found.</p>';
    }

    // ===== FAVORITES =====
    let favorites = JSON.parse(localStorage.getItem("favorites")) || [];

    function toggleFavorite(starEl) {
      let card = starEl.closest('.game-card');
      let name = card.dataset.game;
      let link = card.closest('.game-link').href;
      
      let idx = favorites.findIndex(f => f.name === name);
      if (idx === -1) {
        favorites.push({ name, url: link });
        starEl.textContent = "";
        starEl.classList.add("favorited");
      } else {
        favorites.splice(idx, 1);
        starEl.textContent = "";
        starEl.classList.remove("favorited");
      }
      
      localStorage.setItem("favorites", JSON.stringify(favorites));
      playSound('click');
    }

    function clearFavorites() {
      favorites = [];
      localStorage.removeItem("favorites");
      showNotification("Favorites cleared!", 'success');
    }

    function playRandomGame() {
      let allGames = document.querySelectorAll('.game-link');
      let random = allGames[Math.floor(Math.random() * allGames.length)];
      if (random) {
        window.open(random.href, '_blank');
        earnCoinsFromGame('Random Game');
      }
    }

    // ===== GAME DATA =====
    const gameData = [
      { name: "Classroom Resources", url: "https://sites.google.com/view/drive-u-7-home/home", icon: "" },
      { name: "Game Compilation", url: "https://sites.google.com/site/thegamecompilation/home", icon: "" },
      { name: "Unblocked Games Top", url: "https://sites.google.com/site/unblockedgamestop", icon: "" },
      { name: "WatchDocumentaries Games", url: "https://watchdocumentaries.com/games", icon: "" },
      { name: "MSN Play", url: "https://www.msn.com/en-us/play", icon: "" },
      { name: "Unblocked Games Mix", url: "https://www.symbaloo.com/mix/newunblockedgames", icon: "" },
      { name: "Unblocked Games 77", url: "https://sites.google.com/site/unblockedgames77", icon: "7" },
      { name: "Unblocked Games 76", url: "https://www.symbaloo.com/mix/agariounblockedschool", icon: "" },
      { name: "Hooda Math Games", url: "https://www.hoodamath.com/Games", icon: "" },
      { name: "Cool Math Games", url: "https://www.coolmathgames.com", icon: "" },
      { name: "Friv Games", url: "https://www.friv.com", icon: "" }
    ];

    function renderGameCards() {
      let container = document.getElementById("gamesPage1");
      let allContainer = document.getElementById("allGamesList");
      
      let html = "";
      gameData.forEach(game => {
        let isFav = favorites.some(f => f.name === game.name);
        html += `<a href="${game.url}" target="_blank" class="game-link" onclick="earnCoinsFromGame('${game.name}')">
          <div class="game-card" data-game="${game.name}">
            <span class="fav-star ${isFav ? 'favorited' : ''}" onclick="event.preventDefault(); event.stopPropagation(); toggleFavorite(this);">${isFav ? '' : ''}</span>
            <div class="game-thumbnail">${game.icon}</div>
            <div class="game-info"><h3>${game.name}</h3></div>
          </div>
        </a>`;
      });
      
      if (container) container.innerHTML = html;
      if (allContainer) allContainer.innerHTML = html;
      document.getElementById("statTotalGames").textContent = gameData.length;
    }

    // ===== RESET ACCOUNT =====
    async function resetAccount() {
      if (!confirm("Delete your account? This cannot be undone!")) return;
      if (!confirm("LAST CHANCE! Are you sure?")) return;
      
      await db.collection("users").doc(userId).delete();
      localStorage.clear();
      location.reload();
    }

    // ===== ANNOUNCEMENTS =====
    function loadAnnouncement() {
      db.collection("settings").doc("announcement").onSnapshot(doc => {
        let banner = document.getElementById("announcementBanner");
        if (doc.exists && doc.data().text) {
          banner.textContent = " " + doc.data().text;
          banner.classList.add("show");
        } else {
          banner.classList.remove("show");
        }
      });
    }

    async function setAnnouncement() {
      if (!isAdmin) return;
      let text = document.getElementById("announcementInput").value.trim();
      if (!text) return;
      await db.collection("settings").doc("announcement").set({ text, timestamp: Date.now() });
      document.getElementById("announcementInput").value = "";
      logAdminAction(`Set announcement: ${text}`);
    }

    async function clearAnnouncement() {
      if (!isAdmin) return;
      await db.collection("settings").doc("announcement").delete();
      logAdminAction("Cleared announcement");
    }

    // ===== INITIALIZATION =====
    async function init() {
      // Loading quote
      document.getElementById("loadingQuote").textContent = getRandomQuote();
      
      // Load saved settings
      let savedTheme = localStorage.getItem("theme");
      if (savedTheme) {
        document.body.dataset.theme = savedTheme;
        document.getElementById("themeSelect").value = savedTheme;
      }
      
      let savedFont = localStorage.getItem("font");
      if (savedFont) {
        document.body.className = `font-${savedFont}`;
        document.getElementById("fontSelect").value = savedFont;
      }
      
      let savedParticles = localStorage.getItem("particles");
      if (savedParticles && savedParticles !== 'none') {
        changeParticles(savedParticles);
        document.getElementById("particleSelect").value = savedParticles;
      }
      
      let savedCompact = localStorage.getItem("compactMode") === 'true';
      if (savedCompact) {
        document.body.classList.add("compact-mode");
        document.getElementById("compactMode").checked = true;
      }
      
      let savedBg = localStorage.getItem("customBg");
      if (savedBg) {
        document.getElementById("customBg").style.backgroundImage = `url(${savedBg})`;
        document.getElementById("bgUrl").value = savedBg;
      }
      
      let savedPanic = localStorage.getItem("panicUrl");
      if (savedPanic) {
        document.getElementById("panicUrl").value = savedPanic;
        panicUrl = savedPanic;
      }
      
      document.getElementById("soundEnabled").checked = soundEnabled;
      document.getElementById("notifSound").checked = notifSound;
      document.getElementById("soundToggle").textContent = soundEnabled ? '' : '';
      
      loadCloak();
      
      // Render content
      renderGameCards();
      renderMiniGames();
      renderCasinoGames();
      
      // Check user
      await checkFirstVisit();
      
      if (await checkIfBanned()) return;
      
      // Load real-time data
      loadChat();
      loadTypingIndicators();
      loadAnnouncement();
      loadOnlineUsers();
      
      // Update stats
      let users = await db.collection("users").get();
      document.getElementById("statTotalUsers").textContent = users.size;
      
      let msgs = await db.collection("chat").get();
      document.getElementById("statTotalMessages").textContent = msgs.size;
      
      // Hide loading screen
      setTimeout(() => {
        document.getElementById("loadingScreen").classList.add("hidden");
      }, 1500);
      
      // Periodic updates
      setInterval(loadOnlineUsers, 30000);
    }

    init();
  </script>
</body>
</html>
