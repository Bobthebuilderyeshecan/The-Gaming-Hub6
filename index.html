<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The Gaming Hub</title>
  <link id="favicon" rel="icon" href="https://www.google.com/s2/favicons?domain=classroom.google.com&sz=64" type="image/x-icon">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Roboto:wght@400;500&family=Montserrat:wght@400;600&family=Open+Sans:wght@400;600&family=Raleway:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Dark Theme (Default) */
      --bg-primary: #0a0a0a;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #2a2a2a;
      --text-primary: #ffffff;
      --text-secondary: #aaaaaa;
      --text-muted: #666666;
      --accent: #ff8800;
      --accent-hover: #ff6600;
      --success: #00ff00;
      --danger: #cc0000;
      --warning: #ffcc00;
      --info: #0066cc;
    }

    [data-theme="light"] {
      --bg-primary: #f5f5f5;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e0e0e0;
      --text-primary: #1a1a1a;
      --text-secondary: #555555;
      --text-muted: #888888;
      --accent: #ff6600;
      --accent-hover: #ff4400;
    }

    [data-theme="neon"] {
      --bg-primary: #0a0a1a;
      --bg-secondary: #1a1a3a;
      --bg-tertiary: #2a2a4a;
      --text-primary: #ffffff;
      --text-secondary: #bb99ff;
      --text-muted: #7755aa;
      --accent: #ff00ff;
      --accent-hover: #cc00cc;
      --success: #00ffff;
      --danger: #ff0066;
      --warning: #ffff00;
      --info: #00ccff;
    }

    [data-theme="ocean"] {
      --bg-primary: #0a1628;
      --bg-secondary: #152238;
      --bg-tertiary: #1e3a5f;
      --text-primary: #e0f0ff;
      --text-secondary: #8ab4d4;
      --text-muted: #5588aa;
      --accent: #00bfff;
      --accent-hover: #0099cc;
      --success: #00ff88;
      --danger: #ff4466;
    }

    [data-theme="forest"] {
      --bg-primary: #0a1a0a;
      --bg-secondary: #1a2a1a;
      --bg-tertiary: #2a3a2a;
      --text-primary: #e0ffe0;
      --text-secondary: #88bb88;
      --text-muted: #558855;
      --accent: #44ff44;
      --accent-hover: #22cc22;
      --success: #88ff88;
      --danger: #ff6644;
    }

    [data-theme="sunset"] {
      --bg-primary: #1a0a0a;
      --bg-secondary: #2a1515;
      --bg-tertiary: #3a2020;
      --text-primary: #ffe0d0;
      --text-secondary: #dd9988;
      --text-muted: #aa6655;
      --accent: #ff6644;
      --accent-hover: #ff4422;
      --success: #ffaa44;
      --danger: #ff2222;
    }

    * {
      box-sizing: border-box;
      transition: background-color 0.3s, color 0.3s;
    }

    html, body {
      margin: 0 !important;
      padding: 0 !important;
      background-color: var(--bg-primary) !important;
      font-family: 'Poppins', sans-serif;
      color: var(--text-primary);
      width: 100% !important;
      height: 100% !important;
      overflow-x: hidden;
    }

    /* Font Classes */
    .font-poppins { font-family: 'Poppins', sans-serif; }
    .font-roboto { font-family: 'Roboto', sans-serif; }
    .font-montserrat { font-family: 'Montserrat', sans-serif; }
    .font-opensans { font-family: 'Open Sans', sans-serif; }
    .font-raleway { font-family: 'Raleway', sans-serif; }

    /* Compact Mode */
    .compact-mode .game-card { width: 160px; padding: 10px; }
    .compact-mode .game-thumbnail { height: 80px; font-size: 30px; }
    .compact-mode .game-info h3 { font-size: 12px; }
    .compact-mode .sidebar { width: 300px; }
    .compact-mode .chat-panel { width: 300px; height: 400px; }
    .compact-mode .profile-pic-large { width: 60px; height: 60px; }
    .compact-mode .friend-card { padding: 8px; }
    .compact-mode .sidebar-btn { padding: 6px 12px; font-size: 12px; }

    /* ===== PARTICLES ===== */
    #particles-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }

    .particle {
      position: absolute;
      pointer-events: none;
      animation: fall linear infinite;
    }

    .particle.snow {
      width: 8px;
      height: 8px;
      background: white;
      border-radius: 50%;
      opacity: 0.8;
      box-shadow: 0 0 10px white;
    }

    .particle.star {
      width: 3px;
      height: 3px;
      background: gold;
      border-radius: 50%;
      box-shadow: 0 0 6px gold;
      animation: twinkle 2s ease-in-out infinite, fall linear infinite;
    }

    .particle.rain {
      width: 2px;
      height: 15px;
      background: linear-gradient(to bottom, transparent, #88ccff);
      border-radius: 2px;
    }

    .particle.confetti {
      width: 10px;
      height: 10px;
      animation: confettiFall linear infinite;
    }

    .particle.hearts {
      font-size: 16px;
      animation: floatUp 4s ease-in-out infinite;
    }

    .particle.bubbles {
      width: 15px;
      height: 15px;
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 50%;
      animation: floatUp 5s ease-in-out infinite;
    }

    @keyframes fall {
      0% { transform: translateY(-10px) rotate(0deg); opacity: 1; }
      100% { transform: translateY(100vh) rotate(360deg); opacity: 0.3; }
    }

    @keyframes twinkle {
      0%, 100% { opacity: 0.3; }
      50% { opacity: 1; }
    }

    @keyframes confettiFall {
      0% { transform: translateY(-10px) rotate(0deg) scale(1); }
      100% { transform: translateY(100vh) rotate(720deg) scale(0.5); }
    }

    @keyframes floatUp {
      0% { transform: translateY(100vh) scale(0); opacity: 0; }
      10% { opacity: 1; }
      90% { opacity: 1; }
      100% { transform: translateY(-10px) scale(1); opacity: 0; }
    }

    /* ===== LOADING SCREEN ===== */
    .loading-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      transition: opacity 0.5s, visibility 0.5s;
    }

    .loading-screen.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loader {
      width: 60px;
      height: 60px;
      border: 4px solid var(--bg-tertiary);
      border-top: 4px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: var(--accent);
      margin-top: 20px;
      font-size: 18px;
      animation: pulse 1.5s ease-in-out infinite;
    }

    .loading-quote {
      color: var(--text-secondary);
      margin-top: 15px;
      font-size: 14px;
      font-style: italic;
      max-width: 400px;
      text-align: center;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* ===== CUSTOM BACKGROUND ===== */
    .custom-bg {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-size: cover;
      background-position: center;
      z-index: -1;
      opacity: 0.3;
    }

    /* ===== TAB CLOAK MODAL ===== */
    .cloak-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 3000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .cloak-modal.open {
      display: flex;
    }

    .cloak-box {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 30px;
      max-width: 500px;
      width: 90%;
      border: 2px solid var(--accent);
    }

    .cloak-box h2 {
      color: var(--accent);
      margin: 0 0 20px 0;
      text-align: center;
    }

    .cloak-options {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .cloak-option {
      background: var(--bg-tertiary);
      border: 2px solid transparent;
      border-radius: 12px;
      padding: 15px;
      cursor: pointer;
      transition: 0.3s;
      text-align: center;
    }

    .cloak-option:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
    }

    .cloak-option img {
      width: 40px;
      height: 40px;
      margin-bottom: 8px;
    }

    .cloak-option span {
      display: block;
      color: var(--text-primary);
      font-size: 13px;
    }

    .cloak-actions {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .about-blank-btn {
      background: linear-gradient(135deg, var(--info), #0044aa);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 25px;
      cursor: pointer;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
      transition: 0.3s;
    }

    .about-blank-btn:hover {
      transform: scale(1.05);
    }

    /* ===== MAIN CONTENT ===== */
    .main-content {
      width: 100%;
      margin: 0;
      padding: 0;
      background-color: transparent;
      min-height: 100vh;
      position: relative;
      z-index: 1;
    }

    /* ===== STATS BANNER ===== */
    .stats-banner {
      background: linear-gradient(90deg, var(--bg-secondary), var(--bg-tertiary));
      padding: 12px 20px;
      display: flex;
      justify-content: center;
      gap: 40px;
      border-bottom: 1px solid var(--bg-tertiary);
      flex-wrap: wrap;
    }

    .stat-item {
      text-align: center;
    }

    .stat-number {
      color: var(--accent);
      font-size: 20px;
      font-weight: bold;
    }

    .stat-label {
      color: var(--text-muted);
      font-size: 11px;
    }

    /* ===== NAVBAR ===== */
    .navbar {
      background-color: var(--bg-secondary);
      padding: 15px;
      text-align: center;
      width: 100%;
      position: sticky;
      top: 0;
      z-index: 100;
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--bg-tertiary);
      display: flex;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .navbar a {
      color: var(--text-primary);
      text-decoration: none;
      margin: 0 10px;
      font-size: 16px;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
    }

    .navbar a:hover {
      color: var(--accent);
    }

    .navbar a::after {
      content: '';
      position: absolute;
      bottom: -5px;
      left: 0;
      width: 0;
      height: 2px;
      background: var(--accent);
      transition: width 0.3s;
    }

    .navbar a:hover::after {
      width: 100%;
    }

    #usernameDisplay {
      color: var(--success);
      font-size: 14px;
      margin-left: 10px;
    }

    /* ===== XP BAR ===== */
    .xp-bar-container {
      background: var(--bg-primary);
      padding: 8px 20px;
      display: flex;
      align-items: center;
      gap: 15px;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .level-badge {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 5px 12px;
      border-radius: 20px;
      font-weight: bold;
      font-size: 14px;
    }

    .xp-bar {
      flex: 1;
      height: 20px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }

    .xp-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--success));
      border-radius: 10px;
      transition: width 0.5s ease-out;
      position: relative;
    }

    .xp-bar-fill::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      animation: shimmer 2s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-100%); }
      100% { transform: translateX(100%); }
    }

    .xp-text {
      color: var(--text-secondary);
      font-size: 12px;
      min-width: 120px;
      text-align: right;
    }

    .coins-display {
      display: flex;
      align-items: center;
      gap: 5px;
      background: var(--bg-tertiary);
      padding: 5px 12px;
      border-radius: 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .coins-display:hover {
      background: var(--bg-secondary);
    }

    .coins-display span {
      color: gold;
      font-weight: bold;
    }

    /* ===== SIDEBAR ===== */
    .sidebar-toggle {
      position: fixed;
      top: 150px;
      right: 0;
      background-color: var(--success);
      color: black;
      border: none;
      padding: 10px 8px;
      font-size: 20px;
      cursor: pointer;
      border-radius: 5px 0 0 5px;
      z-index: 1000;
      transition: 0.3s;
    }

    .sidebar-toggle:hover {
      background-color: #00cc00;
      transform: translateX(-3px);
    }

    .sidebar {
      position: fixed;
      top: 0;
      right: -400px;
      width: 400px;
      height: 100vh;
      background-color: var(--bg-secondary);
      transition: 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 999;
      overflow-y: auto;
      padding: 20px;
      border-left: 2px solid var(--success);
    }

    .sidebar.open {
      right: 0;
    }

    .sidebar h2 {
      color: var(--text-primary);
      text-align: center;
      margin-top: 10px;
    }

    .sidebar h3 {
      color: var(--accent);
      margin: 20px 0 10px 0;
      font-size: 18px;
    }

    .sidebar label {
      color: var(--text-secondary);
      font-size: 13px;
      display: block;
      margin-bottom: 5px;
    }

    .sidebar-input {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      margin-bottom: 10px;
      transition: 0.3s;
    }

    .sidebar-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .sidebar-input::placeholder {
      color: var(--text-muted);
    }

    .sidebar-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s;
      font-family: inherit;
      margin-right: 5px;
      margin-bottom: 5px;
    }

    .sidebar-btn:hover {
      transform: translateY(-2px);
    }

    .sidebar-btn-green { background-color: var(--success); color: black; }
    .sidebar-btn-green:hover { box-shadow: 0 4px 15px rgba(0, 255, 0, 0.3); }

    .sidebar-btn-orange { background-color: var(--accent); color: black; }
    .sidebar-btn-orange:hover { box-shadow: 0 4px 15px rgba(255, 136, 0, 0.3); }

    .sidebar-btn-gray { background-color: var(--bg-tertiary); color: var(--text-primary); }
    .sidebar-btn-gray:hover { background-color: #444; }

    .sidebar-btn-red { background-color: var(--danger); color: white; }
    .sidebar-btn-red:hover { box-shadow: 0 4px 15px rgba(204, 0, 0, 0.3); }

    .sidebar-btn-blue { background-color: var(--info); color: white; }
    .sidebar-btn-blue:hover { box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3); }

    .sidebar-btn-purple { background-color: #9b59b6; color: white; }
    .sidebar-btn-purple:hover { box-shadow: 0 4px 15px rgba(155, 89, 182, 0.3); }

    .sidebar-divider {
      border: none;
      border-top: 1px solid var(--bg-tertiary);
      margin: 15px 0;
    }

    .sidebar-close {
      position: absolute;
      top: 10px;
      right: 15px;
      color: var(--text-primary);
      font-size: 24px;
      cursor: pointer;
      background: none;
      border: none;
      transition: 0.3s;
    }

    .sidebar-close:hover {
      color: var(--accent);
      transform: rotate(90deg);
    }

    /* ===== SIDEBAR TABS ===== */
    .sidebar-tabs {
      display: flex;
      gap: 5px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .sidebar-tab {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
      font-family: inherit;
      transition: 0.3s;
      min-width: 45px;
    }

    .sidebar-tab.active {
      background-color: var(--accent);
      color: black;
    }

    .sidebar-tab.admin-tab {
      background-color: #660000;
      color: #ff6666;
    }

    .sidebar-tab.admin-tab.active {
      background-color: var(--danger);
      color: white;
    }

    .sidebar-panel {
      display: none;
      animation: fadeIn 0.3s;
    }

    .sidebar-panel.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ===== PROFILE STYLES ===== */
    .profile-card {
      background: linear-gradient(135deg, var(--bg-tertiary) 0%, var(--bg-secondary) 100%);
      border-radius: 15px;
      padding: 0;
      margin-bottom: 15px;
      text-align: center;
      border: 1px solid var(--bg-tertiary);
      transition: 0.3s;
      overflow: hidden;
    }

    .profile-card:hover {
      border-color: var(--accent);
    }

    .profile-banner {
      width: 100%;
      height: 80px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      background-size: cover;
      background-position: center;
    }

    .profile-card-content {
      padding: 15px;
      margin-top: -40px;
    }

    .profile-pic-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-secondary);
      display: block;
      margin: 0 auto 10px auto;
      transition: 0.3s;
      background: var(--bg-tertiary);
    }

    .profile-pic-large:hover {
      transform: scale(1.1);
    }

    .profile-name {
      color: var(--text-primary);
      font-size: 18px;
      margin: 5px 0;
      font-weight: 600;
    }

    .profile-level {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 3px 10px;
      border-radius: 15px;
      font-size: 11px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .profile-role {
      color: var(--accent);
      font-size: 13px;
    }

    .profile-bio {
      color: var(--text-secondary);
      font-size: 13px;
      margin-top: 5px;
    }

    .profile-status {
      color: var(--success);
      font-size: 12px;
      margin-top: 8px;
      padding: 5px 10px;
      background-color: rgba(0, 255, 0, 0.1);
      border-radius: 15px;
      display: inline-block;
    }

    .profile-stats {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid var(--bg-tertiary);
    }

    .profile-stat {
      text-align: center;
    }

    .profile-stat-num {
      color: var(--accent);
      font-size: 18px;
      font-weight: bold;
    }

    .profile-stat-label {
      color: var(--text-muted);
      font-size: 11px;
    }

    .owner-badge { color: var(--success); font-size: 11px; font-weight: bold; }
    .coowner-badge { color: var(--accent); font-size: 11px; font-weight: bold; }

    /* ===== FRIEND CARDS ===== */
    .friend-card {
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      transition: 0.3s;
      cursor: pointer;
    }

    .friend-card:hover {
      background-color: #3a3a3a;
      transform: translateX(5px);
    }

    .friend-card img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    .friend-card-info { flex: 1; }

    .friend-card-name {
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
    }

    .friend-card-status {
      color: var(--text-muted);
      font-size: 11px;
    }

    .friend-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      cursor: pointer;
      font-family: inherit;
      transition: 0.3s;
    }

    /* ===== STATUS DOT ===== */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .status-online {
      background-color: var(--success);
      box-shadow: 0 0 8px var(--success);
    }

    .status-offline {
      background-color: var(--text-muted);
    }

/* ===== MUSIC PLAYER (SIDEBAR) ===== */
.music-sidebar-now-playing {
  background: var(--bg-tertiary);
  border-radius: 10px;
  padding: 12px;
  text-align: center;
  margin-bottom: 12px;
}

.music-sidebar-title {
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 600;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.music-sidebar-status {
  color: var(--text-muted);
  font-size: 11px;
  margin-top: 3px;
}

.music-sidebar-progress {
  margin-bottom: 12px;
}

.music-sidebar-progress-bar {
  width: 100%;
  height: 6px;
  background: var(--bg-tertiary);
  border-radius: 3px;
  cursor: pointer;
  overflow: hidden;
}

.music-sidebar-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #1db954, #1ed760);
  border-radius: 3px;
  transition: width 0.1s;
}

.music-sidebar-time {
  display: flex;
  justify-content: space-between;
  font-size: 10px;
  color: var(--text-muted);
  margin-top: 4px;
}

.music-sidebar-controls {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
}

.music-sidebar-btn {
  background: var(--bg-tertiary);
  border: none;
  color: var(--text-primary);
  width: 36px;
  height: 36px;
  border-radius: 50%;
  cursor: pointer;
  font-size: 16px;
  transition: 0.2s;
  display: flex;
  align-items: center;
  justify-content: center;
}

.music-sidebar-btn:hover {
  background: var(--bg-primary);
  color: #1db954;
}

.music-sidebar-btn.active {
  color: #1db954;
}

.music-sidebar-play {
  background: #1db954 !important;
  color: white !important;
  width: 44px;
  height: 44px;
  font-size: 18px;
}

.music-sidebar-play:hover {
  background: #1ed760 !important;
  transform: scale(1.05);
}

.music-sidebar-volume {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 10px;
}

.music-sidebar-volume span {
  color: var(--text-secondary);
}

.music-sidebar-volume-slider {
  flex: 1;
  -webkit-appearance: none;
  height: 5px;
  background: var(--bg-tertiary);
  border-radius: 3px;
  outline: none;
}

.music-sidebar-volume-slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  width: 14px;
  height: 14px;
  background: #1db954;
  border-radius: 50%;
  cursor: pointer;
}

.music-sidebar-playlist {
  max-height: 200px;
  overflow-y: auto;
}

.music-sidebar-playlist-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
  margin-bottom: 4px;
}

.music-sidebar-playlist-item:hover {
  background: var(--bg-tertiary);
}

.music-sidebar-playlist-item.playing {
  background: rgba(29, 185, 84, 0.2);
  border-left: 3px solid #1db954;
}

.music-sidebar-playlist-item-num {
  color: var(--text-muted);
  font-size: 11px;
  width: 18px;
  text-align: center;
}

.music-sidebar-playlist-item-name {
  flex: 1;
  color: var(--text-primary);
  font-size: 12px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.music-sidebar-playlist-item-remove {
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  font-size: 12px;
  opacity: 0;
  transition: 0.2s;
}

.music-sidebar-playlist-item:hover .music-sidebar-playlist-item-remove {
  opacity: 1;
}

.music-sidebar-playlist-item-remove:hover {
  color: var(--danger);
}

/* ===== ACHIEVEMENTS (SIDEBAR) ===== */
.achievements-sidebar-stats {
  display: flex;
  justify-content: space-around;
  background: var(--bg-tertiary);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
}

.achievements-sidebar-stat {
  text-align: center;
}

.achievements-sidebar-stat-num {
  color: #f39c12;
  font-size: 20px;
  font-weight: bold;
}

.achievements-sidebar-stat-label {
  color: var(--text-muted);
  font-size: 10px;
}

.achievements-sidebar-tabs {
  display: flex;
  gap: 5px;
  margin-bottom: 12px;
  flex-wrap: wrap;
}

.achievements-sidebar-tab {
  flex: 1;
  min-width: 40px;
  padding: 6px 8px;
  border: none;
  border-radius: 6px;
  background: var(--bg-tertiary);
  color: var(--text-primary);
  cursor: pointer;
  font-size: 11px;
  font-family: inherit;
  transition: 0.2s;
}

.achievements-sidebar-tab.active {
  background: #f39c12;
  color: black;
}

.achievements-sidebar-tab:hover:not(.active) {
  background: var(--bg-primary);
}

.achievements-sidebar-list {
  max-height: 400px;
  overflow-y: auto;
}

.achievement-sidebar-card {
  background: var(--bg-tertiary);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 8px;
  display: flex;
  align-items: flex-start;
  gap: 10px;
  border: 2px solid transparent;
  transition: 0.2s;
}

.achievement-sidebar-card:hover {
  border-color: var(--bg-primary);
}

.achievement-sidebar-card.unlocked {
  border-color: #f39c12;
  background: linear-gradient(135deg, var(--bg-tertiary), rgba(243, 156, 18, 0.1));
}

.achievement-sidebar-card.locked {
  opacity: 0.6;
}

.achievement-sidebar-icon {
  font-size: 28px;
  flex-shrink: 0;
}

.achievement-sidebar-card.locked .achievement-sidebar-icon {
  filter: grayscale(100%);
}

.achievement-sidebar-content {
  flex: 1;
  min-width: 0;
}

.achievement-sidebar-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 3px;
}

.achievement-sidebar-name {
  color: var(--text-primary);
  font-size: 13px;
  font-weight: 600;
}

.achievement-sidebar-rarity {
  font-size: 8px;
  padding: 2px 6px;
  border-radius: 8px;
  font-weight: bold;
  flex-shrink: 0;
}

.achievement-sidebar-desc {
  color: var(--text-muted);
  font-size: 11px;
  margin-bottom: 6px;
}

.achievement-sidebar-progress {
  width: 100%;
  height: 4px;
  background: var(--bg-secondary);
  border-radius: 2px;
  overflow: hidden;
  margin-bottom: 4px;
}

.achievement-sidebar-progress-fill {
  height: 100%;
  background: linear-gradient(90deg, #f39c12, #e67e22);
  border-radius: 2px;
}

.achievement-sidebar-progress-text {
  color: var(--text-muted);
  font-size: 10px;
}

.achievement-sidebar-reward {
  color: #f39c12;
  font-size: 10px;
  margin-top: 4px;
}

.achievement-sidebar-unlocked {
  color: #2ecc71;
  font-size: 10px;
}

/* Achievement notification popup (keep this) */
.achievement-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
  border: 2px solid #f39c12;
  border-radius: 15px;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 10001;
  animation: achievementSlideIn 0.5s ease, achievementSlideOut 0.5s ease 4.5s forwards;
  box-shadow: 0 10px 40px rgba(243, 156, 18, 0.3);
  max-width: 350px;
}

@keyframes achievementSlideIn {
  from { transform: translateX(400px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

@keyframes achievementSlideOut {
  from { transform: translateX(0); opacity: 1; }
  to { transform: translateX(400px); opacity: 0; }
}

.achievement-notification-icon {
  font-size: 40px;
}

.achievement-notification-content {
  flex: 1;
}

.achievement-notification-title {
  color: #f39c12;
  font-size: 11px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.achievement-notification-name {
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 600;
  margin: 2px 0;
}

.achievement-notification-reward {
  color: var(--text-secondary);
  font-size: 11px;
}

/* Rarity colors */
.rarity-bronze { background: linear-gradient(135deg, #cd7f32, #8b4513); color: white; }
.rarity-silver { background: linear-gradient(135deg, #c0c0c0, #808080); color: black; }
.rarity-gold { background: linear-gradient(135deg, #ffd700, #ffaa00); color: black; }
.rarity-platinum { background: linear-gradient(135deg, #e5e4e2, #a0b2c6); color: black; }
.rarity-diamond { background: linear-gradient(135deg, #b9f2ff, #4fc3f7); color: black; }

    
    /* ===== CHAT STYLES ===== */
    .chat-toggle {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      border: none;
      padding: 15px 25px;
      font-size: 16px;
      cursor: pointer;
      border-radius: 50px;
      z-index: 1000;
      transition: all 0.3s;
      font-family: inherit;
      font-weight: 600;
      box-shadow: 0 4px 20px rgba(255, 136, 0, 0.4);
    }

    .chat-toggle:hover {
      transform: scale(1.05) translateY(-2px);
    }

    .chat-badge {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: var(--danger);
      color: white;
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 50%;
      display: none;
      animation: pulse 1s infinite;
    }

   .chat-panel {
  position: fixed;
  bottom: 90px;
  left: 20px;
  width: 400px;
  height: 520px;
  background-color: var(--bg-secondary);
  border-radius: 20px;
  border: 2px solid var(--accent);
  z-index: 999;
  display: none;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
}

.chat-panel.open {
  display: flex;
}

    @keyframes scaleIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .chat-header {
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
      padding: 15px 20px;
      color: var(--text-primary);
      font-size: 16px;
      font-weight: bold;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .chat-header-tabs {
      display: flex;
      gap: 8px;
    }

    .chat-header-tab {
      padding: 6px 14px;
      border: none;
      border-radius: 15px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
      transition: 0.3s;
      font-family: inherit;
    }

    .chat-header-tab.active {
      background-color: var(--accent);
      color: black;
    }

    .chat-close {
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 20px;
      cursor: pointer;
      transition: 0.3s;
    }

    .chat-close:hover {
      color: var(--accent);
      transform: rotate(90deg);
    }

  .chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 15px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  width: 100%;
}
 .chat-message {
  background-color: var(--bg-tertiary);
  border-radius: 15px;
  padding: 12px;
  max-width: 85%;
  min-width: 150px;
  position: relative;
  word-wrap: break-word;
}
    .chat-message.mine {
  align-self: flex-end;
  background: linear-gradient(135deg, #3a3a00, #2a2a00);
  border: 1px solid var(--accent);
}
    .chat-message-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .chat-message-pic {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      object-fit: cover;
      cursor: pointer;
      transition: 0.3s;
    }

    .chat-message-pic:hover {
      transform: scale(1.1);
    }

    .chat-message-name {
      color: var(--accent);
      font-size: 12px;
      font-weight: bold;
      cursor: pointer;
    }

    .chat-message-name:hover {
      text-decoration: underline;
    }

    .chat-message-level {
      background: var(--bg-secondary);
      color: var(--text-secondary);
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
    }

    .chat-message-time {
      color: var(--text-muted);
      font-size: 10px;
      margin-left: auto;
    }

   .chat-message-text {
  color: var(--text-primary);
  font-size: 14px;
  word-wrap: break-word;
  line-height: 1.4;
  width: 100%;
  white-space: normal;
}

    .chat-message-text .mention {
      color: var(--info);
      background: rgba(0, 102, 204, 0.2);
      padding: 1px 4px;
      border-radius: 4px;
      cursor: pointer;
    }

   .chat-input-area {
  padding: 15px;
  background-color: var(--bg-tertiary);
  display: flex;
  flex-direction: row;
  gap: 10px;
  align-items: center;
  width: 100%;
}

    .chat-input {
      flex: 1;
      padding: 12px 18px;
      border: none;
      border-radius: 25px;
      background-color: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: inherit;
      outline: none;
      transition: 0.3s;
    }

    .chat-input:focus {
      box-shadow: 0 0 0 2px var(--accent);
    }

    .chat-send {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      border: none;
      padding: 12px 20px;
      border-radius: 25px;
      cursor: pointer;
      font-family: inherit;
      font-weight: bold;
      transition: 0.3s;
    }

    .chat-send:hover {
      transform: scale(1.05);
    }

    /* ===== TYPING INDICATOR ===== */
    .typing-indicator {
      padding: 10px 15px;
      color: var(--text-muted);
      font-size: 12px;
      font-style: italic;
      display: none;
    }

    .typing-indicator.show {
      display: block;
    }

    .typing-dots {
      display: inline-flex;
      gap: 3px;
    }

    .typing-dots span {
      width: 6px;
      height: 6px;
      background-color: var(--text-muted);
      border-radius: 50%;
      animation: typingBounce 1.4s infinite;
    }

    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typingBounce {
      0%, 60%, 100% { transform: translateY(0); }
      30% { transform: translateY(-5px); }
    }

    /* ===== EMOJI REACTIONS ===== */
    .emoji-reactions {
      display: flex;
      gap: 5px;
      margin-top: 8px;
      flex-wrap: wrap;
    }

    .emoji-btn {
      background-color: var(--bg-secondary);
      border: none;
      padding: 4px 8px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 14px;
      transition: 0.3s;
    }

    .emoji-btn:hover {
      background-color: var(--bg-tertiary);
      transform: scale(1.1);
    }

    .emoji-btn.active {
      background-color: var(--accent);
    }

    .reaction-count {
      font-size: 11px;
      color: var(--text-primary);
      margin-left: 3px;
    }

    .add-reaction-btn {
      background-color: var(--bg-secondary);
      border: none;
      padding: 4px 10px;
      border-radius: 15px;
      cursor: pointer;
      font-size: 12px;
      color: var(--text-muted);
      transition: 0.3s;
    }

    .add-reaction-btn:hover {
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .emoji-picker {
      position: absolute;
      bottom: 100%;
      left: 0;
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 10px;
      display: none;
      gap: 5px;
      flex-wrap: wrap;
      width: 220px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      z-index: 10;
    }

    .emoji-picker.show {
      display: flex;
    }

    .emoji-picker button {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      padding: 5px;
      border-radius: 5px;
      transition: 0.2s;
    }

    .emoji-picker button:hover {
      background-color: var(--bg-secondary);
      transform: scale(1.2);
    }

    /* ===== MENTIONS DROPDOWN ===== */
    .mentions-dropdown {
      position: absolute;
      bottom: 100%;
      left: 15px;
      right: 15px;
      background: var(--bg-tertiary);
      border-radius: 10px;
      max-height: 150px;
      overflow-y: auto;
      display: none;
      box-shadow: 0 -4px 15px rgba(0,0,0,0.3);
    }

    .mentions-dropdown.show {
      display: block;
    }

    .mention-option {
      padding: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      transition: 0.2s;
    }

    .mention-option:hover {
      background: var(--bg-secondary);
    }

    .mention-option img {
      width: 25px;
      height: 25px;
      border-radius: 50%;
    }

    .mention-option span {
      color: var(--text-primary);
      font-size: 13px;
    }

    /* ===== GAME CARDS ===== */
    .games-list {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
      padding: 20px;
    }

    .game-link {
      text-decoration: none;
      color: inherit;
    }

    .game-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 15px;
      padding: 0;
      width: 220px;
      text-align: center;
      transition: all 0.3s;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      border: 1px solid var(--bg-tertiary);
    }

    .game-card:hover {
      transform: translateY(-8px);
      border-color: var(--accent);
      box-shadow: 0 10px 30px rgba(255, 136, 0, 0.2);
    }

    .game-thumbnail {
      width: 100%;
      height: 120px;
      object-fit: cover;
      background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
    }

    .game-thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .game-info {
      padding: 15px;
    }

    .game-card h3 {
      color: var(--accent);
      margin: 0 0 8px 0;
      font-size: 14px;
    }

    .game-rating {
      display: flex;
      justify-content: center;
      gap: 3px;
      margin-bottom: 5px;
    }

    .game-rating .star {
      color: var(--bg-tertiary);
      font-size: 14px;
      cursor: pointer;
      transition: 0.2s;
    }

    .game-rating .star.filled {
      color: gold;
    }

    .game-rating .star:hover {
      transform: scale(1.2);
    }

    .game-rating-count {
      color: var(--text-muted);
      font-size: 11px;
    }

    .game-playtime {
      color: var(--text-muted);
      font-size: 10px;
      margin-top: 5px;
    }

    .fav-star {
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 24px;
      cursor: pointer;
      z-index: 10;
      transition: 0.3s;
      color: white;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }

    .fav-star:hover {
      transform: scale(1.3);
      color: var(--accent);
    }

    .fav-star.favorited {
      color: var(--accent);
    }

    /* ===== RANDOM GAME BUTTON ===== */
    .random-game-btn {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 18px;
      border-radius: 50px;
      cursor: pointer;
      font-family: inherit;
      font-weight: 600;
      margin: 20px auto;
      display: block;
      transition: 0.3s;
      box-shadow: 0 4px 15px rgba(155, 89, 182, 0.4);
    }

    .random-game-btn:hover {
      transform: scale(1.05);
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px) rotate(-5deg); }
      75% { transform: translateX(10px) rotate(5deg); }
    }

    /* ===== MINI GAMES MODAL ===== */
    .minigame-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.95);
      z-index: 2500;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .minigame-modal.open {
      display: flex;
    }

    .minigame-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 20px;
      max-width: 90%;
      max-height: 90%;
      overflow: auto;
      position: relative;
    }

    .minigame-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: none;
      border: none;
      color: var(--text-primary);
      font-size: 30px;
      cursor: pointer;
    }

    .minigame-canvas {
      border: 2px solid var(--accent);
      border-radius: 10px;
      display: block;
      margin: 0 auto;
    }

    .minigame-controls {
      text-align: center;
      margin-top: 15px;
      color: var(--text-secondary);
    }

    .minigame-score {
      color: var(--accent);
      font-size: 24px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 10px;
    }

    /* ===== SHOP MODAL ===== */
    .shop-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .shop-modal.open {
      display: flex;
    }

    .shop-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 800px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      border: 2px solid var(--accent);
    }

    .shop-header {
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .shop-header h2 {
      margin: 0;
      font-size: 24px;
    }

    .shop-coins {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 20px;
      font-weight: bold;
    }

    .shop-close {
      background: none;
      border: none;
      font-size: 30px;
      cursor: pointer;
      color: black;
    }

    .shop-tabs {
      display: flex;
      background: var(--bg-tertiary);
      padding: 10px;
      gap: 10px;
      overflow-x: auto;
    }

    .shop-tab {
      padding: 10px 20px;
      border: none;
      border-radius: 10px;
      background: var(--bg-secondary);
      color: var(--text-primary);
      cursor: pointer;
      font-family: inherit;
      white-space: nowrap;
      transition: 0.3s;
    }

    .shop-tab.active {
      background: var(--accent);
      color: black;
    }

    .shop-items {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 15px;
    }

    .shop-item {
      background: var(--bg-tertiary);
      border-radius: 12px;
      padding: 15px;
      text-align: center;
      border: 2px solid transparent;
      transition: 0.3s;
      cursor: pointer;
    }

    .shop-item:hover {
      border-color: var(--accent);
      transform: translateY(-3px);
    }

    .shop-item.owned {
      border-color: var(--success);
      opacity: 0.7;
    }

    .shop-item-icon {
      font-size: 40px;
      margin-bottom: 10px;
    }

    .shop-item-name {
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 5px;
    }

    .shop-item-price {
      color: gold;
      font-size: 16px;
      font-weight: bold;
    }

    .shop-item-owned {
      color: var(--success);
      font-size: 12px;
    }

    .shop-item-rarity {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-top: 5px;
      display: inline-block;
    }

    .rarity-common { background: #888; color: white; }
    .rarity-uncommon { background: #2ecc71; color: white; }
    .rarity-rare { background: #3498db; color: white; }
    .rarity-epic { background: #9b59b6; color: white; }
    .rarity-legendary { background: linear-gradient(135deg, #f39c12, #e74c3c); color: white; }

    /* ===== TRADING MODAL ===== */
    .trade-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .trade-modal.open {
      display: flex;
    }

    .trade-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      width: 90%;
      max-width: 700px;
      max-height: 80vh;
      overflow: hidden;
      border: 2px solid var(--accent);
    }

    .trade-header {
      background: var(--bg-tertiary);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .trade-header h3 {
      margin: 0;
      color: var(--text-primary);
    }

    .trade-content {
      padding: 20px;
      display: flex;
      gap: 20px;
    }

    .trade-side {
      flex: 1;
      background: var(--bg-tertiary);
      border-radius: 10px;
      padding: 15px;
    }

    .trade-side h4 {
      color: var(--accent);
      margin: 0 0 10px 0;
      text-align: center;
    }

    .trade-items {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      max-height: 200px;
      overflow-y: auto;
    }

    .trade-item {
      background: var(--bg-secondary);
      border-radius: 8px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .trade-item:hover {
      border-color: var(--accent);
    }

    .trade-item.selected {
      border-color: var(--success);
      background: rgba(0, 255, 0, 0.1);
    }

    .trade-actions {
      padding: 15px 20px;
      background: var(--bg-tertiary);
      display: flex;
      justify-content: center;
      gap: 10px;
    }

    /* ===== CASINO ===== */
    .casino-section {
      background: linear-gradient(135deg, #1a0a2e, #2a1a3e);
      border-radius: 15px;
      padding: 20px;
      margin: 20px;
      border: 2px solid #9b59b6;
    }

    .casino-section h2 {
      color: #9b59b6;
      text-align: center;
      margin-bottom: 20px;
    }

    .casino-games {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: center;
    }

    .casino-game {
      background: var(--bg-tertiary);
      border-radius: 15px;
      padding: 20px;
      width: 200px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .casino-game:hover {
      border-color: #9b59b6;
      transform: translateY(-5px);
    }

    .casino-game-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .casino-game-name {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
    }

    .casino-game-desc {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 5px;
    }

    /* ===== SLOTS GAME ===== */
    .slots-container {
      text-align: center;
      padding: 20px;
    }

    .slots-display {
      display: flex;
      justify-content: center;
      gap: 10px;
      margin: 20px 0;
    }

    .slot-reel {
      background: var(--bg-primary);
      width: 80px;
      height: 100px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 50px;
      border: 3px solid var(--accent);
      overflow: hidden;
    }

    .slot-reel.spinning {
      animation: slotSpin 0.1s linear infinite;
    }

    @keyframes slotSpin {
      0% { transform: translateY(-10px); }
      100% { transform: translateY(10px); }
    }

    .slots-bet {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      margin: 15px 0;
    }

    .slots-bet input {
      width: 100px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      text-align: center;
      font-size: 16px;
    }

    .spin-btn {
      background: linear-gradient(135deg, #9b59b6, #8e44ad);
      color: white;
      border: none;
      padding: 15px 40px;
      border-radius: 25px;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    .spin-btn:hover {
      transform: scale(1.05);
    }

    .spin-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ===== COIN FLIP ===== */
    .coinflip-container {
      text-align: center;
      padding: 20px;
    }

    .coin {
      width: 150px;
      height: 150px;
      margin: 30px auto;
      position: relative;
      transform-style: preserve-3d;
      transition: transform 0.1s;
    }

    .coin.flipping {
      animation: coinFlip 2s ease-out forwards;
    }

    @keyframes coinFlip {
      0% { transform: rotateY(0); }
      100% { transform: rotateY(1800deg); }
    }

    .coin-side {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 60px;
      backface-visibility: hidden;
    }

    .coin-heads {
      background: linear-gradient(135deg, gold, #ffa500);
    }

    .coin-tails {
      background: linear-gradient(135deg, silver, #888);
      transform: rotateY(180deg);
    }

    .coinflip-choice {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 20px 0;
    }

    .choice-btn {
      padding: 15px 30px;
      border: 3px solid transparent;
      border-radius: 15px;
      font-size: 18px;
      cursor: pointer;
      transition: 0.3s;
    }

    .choice-btn.heads {
      background: linear-gradient(135deg, gold, #ffa500);
      color: black;
    }

    .choice-btn.tails {
      background: linear-gradient(135deg, silver, #888);
      color: black;
    }

    .choice-btn.selected {
      border-color: var(--success);
      transform: scale(1.1);
    }

    /* ===== ADMIN PANEL ===== */
    .admin-section {
      background: linear-gradient(135deg, #2a1a1a, #1a1020);
      border: 1px solid #660000;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .admin-section h4 {
      color: #ff6666;
      margin: 0 0 12px 0;
      font-size: 14px;
    }

    .admin-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 15px;
    }

    .admin-stat {
      background-color: var(--bg-tertiary);
      border-radius: 10px;
      padding: 18px;
      text-align: center;
    }

    .admin-stat-number {
      color: var(--accent);
      font-size: 28px;
      font-weight: bold;
    }

    .admin-stat-label {
      color: var(--text-muted);
      font-size: 12px;
    }

    .admin-cmd-input {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }

    .admin-cmd-input input {
      flex: 1;
    }

    .audit-log {
      max-height: 200px;
      overflow-y: auto;
      background: var(--bg-primary);
      border-radius: 8px;
      padding: 10px;
    }

    .audit-item {
      padding: 8px;
      border-bottom: 1px solid var(--bg-tertiary);
      font-size: 12px;
    }

    .audit-item:last-child {
      border-bottom: none;
    }

    .audit-admin {
      color: var(--accent);
      font-weight: bold;
    }

    .audit-action {
      color: var(--text-primary);
    }

    .audit-time {
      color: var(--text-muted);
      font-size: 10px;
    }

    /* ===== PROFILE MODAL ===== */
    .profile-modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.85);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .profile-modal-overlay.open {
      display: flex;
    }

    .profile-modal {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 20px;
      max-width: 450px;
      width: 90%;
      text-align: center;
      border: 2px solid var(--accent);
      position: relative;
      overflow: hidden;
    }

    .profile-modal-banner {
      width: 100%;
      height: 100px;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      background-size: cover;
      background-position: center;
    }

    .profile-modal-content {
      padding: 20px;
      margin-top: -50px;
    }

    .profile-modal-close {
      position: absolute;
      top: 10px;
      right: 15px;
      background: rgba(0,0,0,0.5);
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      width: 35px;
      height: 35px;
      border-radius: 50%;
      transition: 0.3s;
    }

    .profile-modal-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid var(--bg-secondary);
      margin-bottom: 10px;
    }

    .profile-modal-name {
      color: var(--text-primary);
      font-size: 24px;
      margin: 0 0 5px 0;
      font-weight: 600;
    }

    .profile-modal-level {
      display: inline-block;
      background: linear-gradient(135deg, var(--accent), var(--accent-hover));
      color: black;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .profile-modal-role {
      color: var(--accent);
      font-size: 14px;
      margin-bottom: 10px;
    }

    .profile-modal-stats {
      display: flex;
      justify-content: center;
      gap: 30px;
      margin: 20px 0;
      padding: 15px 0;
      border-top: 1px solid var(--bg-tertiary);
      border-bottom: 1px solid var(--bg-tertiary);
    }

    .profile-modal-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 15px;
    }

    /* ===== POPUP ===== */
    .popup-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
      backdrop-filter: blur(5px);
    }

    .popup-box {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 20px;
      padding: 40px;
      max-width: 420px;
      width: 90%;
      text-align: center;
      border: 2px solid var(--accent);
    }

    .popup-box h2 {
      color: var(--accent);
      margin: 0 0 15px 0;
      font-size: 26px;
    }

    .popup-box p {
      color: var(--text-secondary);
      font-size: 14px;
    }

    .popup-box input {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 10px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      font-size: 16px;
      font-family: inherit;
      outline: none;
      margin-bottom: 15px;
      text-align: center;
    }

    /* ===== ANNOUNCEMENT BANNER ===== */
    .announcement-banner {
      background: linear-gradient(90deg, var(--accent-hover), var(--accent));
      color: black;
      text-align: center;
      padding: 12px;
      font-weight: bold;
      display: none;
    }

    .announcement-banner.show {
      display: block;
    }

    /* ===== SOUND TOGGLE ===== */
    .sound-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background-color: var(--bg-tertiary);
      color: var(--text-primary);
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      transition: 0.3s;
    }

    .sound-toggle:hover {
      background-color: var(--bg-secondary);
      transform: scale(1.1);
    }

    .sound-toggle.muted {
      color: var(--text-muted);
    }

    /* ===== CLOAK BUTTON ===== */
    .cloak-toggle {
      position: fixed;
      bottom: 75px;
      right: 20px;
      background-color: var(--info);
      color: white;
      border: none;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      z-index: 1000;
      transition: 0.3s;
    }

    .cloak-toggle:hover {
      transform: scale(1.1);
    }

    /* ===== GROUP CHAT MODAL ===== */
    .group-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.9);
      z-index: 2000;
      display: none;
      justify-content: center;
      align-items: center;
    }

    .group-modal.open {
      display: flex;
    }

    .group-container {
      background: var(--bg-secondary);
      border-radius: 20px;
      padding: 25px;
      width: 90%;
      max-width: 450px;
      border: 2px solid var(--accent);
    }

    .group-container h3 {
      color: var(--accent);
      margin: 0 0 20px 0;
      text-align: center;
    }

    .group-members {
      max-height: 250px;
      overflow-y: auto;
      margin: 15px 0;
    }

    .group-member {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: var(--bg-tertiary);
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .group-member img {
      width: 35px;
      height: 35px;
      border-radius: 50%;
    }

    .group-member-check {
      margin-left: auto;
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    /* ===== SCROLLBAR ===== */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-primary);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-tertiary);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }

    /* ===== PAGE STYLES ===== */
    .page {
      padding: 20px;
      min-height: calc(100vh - 200px);
    }

    .page h1 {
      color: var(--text-primary);
      text-align: center;
      font-size: 32px;
      margin-bottom: 10px;
    }

    .page h2 {
      color: var(--text-primary);
      text-align: center;
    }

    .page p {
      color: var(--text-secondary);
      text-align: center;
    }

    .favorites-section {
      margin-top: 30px;
    }

    .favorites-section h2 {
      color: var(--accent);
      text-align: center;
      font-size: 22px;
    }

    .no-favorites {
      color: var(--text-muted);
      text-align: center;
      font-size: 14px;
    }

    .owners-section {
      margin-top: 40px;
      text-align: center;
    }

    .owners-list {
      display: flex;
      justify-content: center;
      gap: 25px;
      flex-wrap: wrap;
      margin-top: 20px;
    }

    /* ===== MINIGAMES PAGE ===== */
    .minigames-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 20px;
      padding: 20px;
    }

    .minigame-card {
      background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
      border-radius: 15px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: 0.3s;
      border: 2px solid transparent;
    }

    .minigame-card:hover {
      border-color: var(--accent);
      transform: translateY(-5px);
    }

    .minigame-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .minigame-name {
      color: var(--text-primary);
      font-size: 16px;
      font-weight: 600;
    }

    .minigame-desc {
      color: var(--text-muted);
      font-size: 12px;
      margin-top: 5px;
    }

/* Achievement unlock notification */
.achievement-notification {
  position: fixed;
  top: 80px;
  right: 20px;
  background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
  border: 2px solid #f39c12;
  border-radius: 15px;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  gap: 15px;
  z-index: 10001;
  animation: achievementSlideIn 0.5s ease, achievementSlideOut 0.5s ease 4.5s forwards;
  box-shadow: 0 10px 40px rgba(243, 156, 18, 0.3);
  max-width: 350px;
}

@keyframes achievementSlideIn {
  from {
    transform: translateX(400px);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes achievementSlideOut {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(400px);
    opacity: 0;
  }
}

.achievement-notification-icon {
  font-size: 45px;
  animation: achievementBounce 0.5s ease 0.3s;
}

.achievement-notification-content {
  flex: 1;
}

.achievement-notification-title {
  color: #f39c12;
  font-size: 12px;
  font-weight: bold;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.achievement-notification-name {
  color: var(--text-primary);
  font-size: 16px;
  font-weight: 600;
  margin: 3px 0;
}

.achievement-notification-reward {
  color: var(--text-secondary);
  font-size: 12px;
}
    
  
  </style>
</head>
<body data-theme="dark">

    <!-- Particles Container -->
  <div id="particles-container"></div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading-screen">
    <div class="loader"></div>
    <div class="loading-text">Loading The Gaming Hub...</div>
    <div class="loading-quote" id="loadingQuote">Get ready for epic gaming!</div>
  </div>

  <!-- Custom Background -->
  <div id="customBg" class="custom-bg"></div>

  <!-- Announcement Banner -->
  <div id="announcementBanner" class="announcement-banner"></div>



  <!-- Welcome Popup -->
  <div id="welcomePopup" class="popup-overlay" style="display: none;">
    <div class="popup-box">
      <h2> Welcome to The Gaming Hub!</h2>
      <p>Choose a username to get started</p>
      <input type="text" id="newUsername" placeholder="Enter username...">
      <br>
      <button class="sidebar-btn sidebar-btn-orange" onclick="createProfile()" style="font-size: 18px; padding: 14px 35px;">Join</button>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="profile-modal-overlay">
    <div class="profile-modal">
      <div id="modalProfileBanner" class="profile-modal-banner"></div>
      <div class="profile-modal-content">
        <button class="profile-modal-close" onclick="closeProfileModal()"></button>
        <img id="modalProfilePic" class="profile-modal-pic" src="" alt="Profile">
        <div id="modalProfileLevel" class="profile-modal-level">LVL 1</div>
        <h2 id="modalProfileName" class="profile-modal-name">Username</h2>
        <p id="modalProfileRole" class="profile-modal-role">Member</p>
        <div id="modalProfileStatus"></div>
        <p id="modalProfileBio" class="profile-modal-bio">No bio</p>
        <div id="modalProfileStats" class="profile-modal-stats"></div>
        <p id="modalProfileJoined" style="color: var(--text-muted); font-size: 12px;">Joined: Unknown</p>
        <div id="modalProfileActions" class="profile-modal-actions"></div>
      </div>
    </div>
  </div>

  <!-- Shop Modal -->
  <div id="shopModal" class="shop-modal">
    <div class="shop-container">
      <div class="shop-header">
        <h2> Shop</h2>
        <div class="shop-coins">
          <span></span>
          <span id="shopCoinsDisplay">0</span>
        </div>
        <button class="shop-close" onclick="closeShop()"></button>
      </div>
      <div class="shop-tabs">
        <button class="shop-tab active" onclick="showShopTab('banners', this)">Profile Banners</button>
        <button class="shop-tab" onclick="showShopTab('frames', this)">Profile Frames</button>
        <button class="shop-tab" onclick="showShopTab('badges', this)">Badges</button>
        <button class="shop-tab" onclick="showShopTab('effects', this)">Effects</button>
        <button class="shop-tab" onclick="showShopTab('titles', this)">Titles</button>
      </div>
      <div id="shopItems" class="shop-items"></div>
    </div>
  </div>

  <!-- Trading Modal -->
  <div id="tradeModal" class="trade-modal">
    <div class="trade-container">
      <div class="trade-header">
        <h3> Trade Items</h3>
        <button class="sidebar-close" onclick="closeTrade()"></button>
      </div>
      <div class="trade-content">
        <div class="trade-side">
          <h4>Your Items</h4>
          <div id="tradeYourItems" class="trade-items"></div>
        </div>
        <div class="trade-side">
          <h4>Their Items</h4>
          <div id="tradeTheirItems" class="trade-items"></div>
        </div>
      </div>
      <div class="trade-actions">
        <button class="sidebar-btn sidebar-btn-green" onclick="confirmTrade()">Confirm Trade</button>
        <button class="sidebar-btn sidebar-btn-red" onclick="closeTrade()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Group Chat Modal -->
  <div id="groupModal" class="group-modal">
    <div class="group-container">
      <h3> Create Group Chat</h3>
      <input type="text" id="groupName" class="sidebar-input" placeholder="Group name...">
      <div class="group-members" id="groupMembersList"></div>
      <div style="display: flex; gap: 10px; margin-top: 15px;">
        <button class="sidebar-btn sidebar-btn-green" onclick="createGroup()">Create</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="closeGroupModal()">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Mini-game Modal -->
  <div id="minigameModal" class="minigame-modal">
    <div class="minigame-container">
      <button class="minigame-close" onclick="closeMiniGame()"></button>
      <div id="minigameContent"></div>
    </div>
  </div>

  <!-- Casino Modal -->
  <div id="casinoModal" class="minigame-modal">
    <div class="minigame-container" style="max-width: 600px;">
      <button class="minigame-close" onclick="closeCasino()"></button>
      <div id="casinoContent"></div>
    </div>
  </div>






  
  
  <!-- Sound Toggle -->
  <button id="soundToggle" class="sound-toggle" onclick="toggleSound()"></button>


  <!-- Chat Toggle -->
  <button class="chat-toggle" onclick="toggleChat()">
     Chat
    <span id="chatBadge" class="chat-badge">0</span>
  </button>

  <!-- Chat Panel -->
  <div id="chatPanel" class="chat-panel">
    <div class="chat-header">
      <div class="chat-header-tabs">
        <button class="chat-header-tab active" onclick="showChatTab('global', this)"> Global</button>
        <button class="chat-header-tab" onclick="showChatTab('dms', this)"> DMs</button>
        <button class="chat-header-tab" onclick="showChatTab('groups', this)"> Groups</button>
      </div>
      <span id="onlineCount" style="font-size: 12px; color: var(--success);">0 online</span>
      <button class="chat-close" onclick="toggleChat()"></button>
    </div>
    
    <!-- Global Chat -->
    <div id="globalChatPanel" class="dm-panel active" style="display: flex;">
      <div id="chatMessages" class="chat-messages"></div>
      <div id="typingIndicator" class="typing-indicator">
        <span id="typingUser"></span>
        <span class="typing-dots"><span></span><span></span><span></span></span>
      </div>
      <div class="chat-input-area">
        <div id="mentionsDropdown" class="mentions-dropdown"></div>
        <input type="text" id="chatInput" class="chat-input" placeholder="Type a message... (@mention)" onkeypress="handleChatKeypress(event)" oninput="handleTyping(); checkMentions();">
        <button class="chat-send" onclick="sendMessage()">Send</button>
      </div>
    </div>

    <!-- DMs Panel -->
    <div id="dmsPanel" class="dm-panel">
      <div id="dmList" class="chat-messages" style="padding: 10px;"></div>
    </div>

    <!-- DM Conversation -->
    <div id="dmConversation" class="dm-panel">
      <button class="dm-back" onclick="closeDmConversation()" style="background: var(--bg-tertiary); padding: 10px; border: none; color: var(--text-primary); cursor: pointer; border-radius: 8px; margin-bottom: 10px;"> Back</button>
      <div id="dmMessages" class="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" id="dmInput" class="chat-input" placeholder="Type a message..." onkeypress="handleDmKeypress(event)">
        <button class="chat-send" onclick="sendDm()">Send</button>
      </div>
    </div>

    <!-- Groups Panel -->
    <div id="groupsPanel" class="dm-panel">
      <div style="padding: 15px;">
        <button class="sidebar-btn sidebar-btn-green" onclick="openGroupModal()" style="width: 100%; margin-bottom: 10px;">+ Create Group</button>
      </div>
      <div id="groupsList" class="chat-messages" style="padding: 10px;"></div>
    </div>

    <!-- Group Conversation -->
    <div id="groupConversation" class="dm-panel">
      <button class="dm-back" onclick="closeGroupConversation()" style="background: var(--bg-tertiary); padding: 10px; border: none; color: var(--text-primary); cursor: pointer; border-radius: 8px; margin-bottom: 10px;"> Back</button>
      <div id="groupMessages" class="chat-messages"></div>
      <div class="chat-input-area">
        <input type="text" id="groupInput" class="chat-input" placeholder="Type a message..." onkeypress="handleGroupKeypress(event)">
        <button class="chat-send" onclick="sendGroupMessage()">Send</button>
      </div>
    </div>
  </div>

  <!-- Sidebar Toggle -->
  <button class="sidebar-toggle" onclick="toggleSidebar()"></button>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <button class="sidebar-close" onclick="toggleSidebar()"></button>
    <h2> Menu</h2>

   <div class="sidebar-tabs">
  <button class="sidebar-tab active" onclick="showSidebarTab('profileTab', this)" title="Profile"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('friendsTab', this)" title="Friends"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('activityTab', this)" title="Activity"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('onlineTab', this)" title="Online"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('inventoryTab', this)" title="Inventory"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('musicTab', this)" title="Music"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('achievementsTab', this)" title="Achievements"></button>
  <button class="sidebar-tab" onclick="showSidebarTab('settingsTab', this)" title="Settings"></button>
  <button id="adminTabBtn" class="sidebar-tab admin-tab" onclick="showSidebarTab('adminTab', this)" style="display: none;" title="Admin"></button>
</div>

    <!-- Profile Tab -->
    <div id="profileTab" class="sidebar-panel active">
      <div id="myProfileCard" class="profile-card">
        <div id="myProfileBanner" class="profile-banner"></div>
        <div class="profile-card-content">
          <img id="myProfilePic" class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=RG" alt="Profile">
          <div id="myProfileLevel" class="profile-level">LVL 1</div>
          <p class="profile-name" id="myProfileName">Loading...</p>
          <p class="profile-role" id="myProfileRole"></p>
          <p class="profile-bio" id="myProfileBio"></p>
          <p class="profile-status" id="myProfileStatus" style="display: none;"></p>
          <div class="profile-stats">
            <div class="profile-stat">
              <div class="profile-stat-num" id="myStatGames">0</div>
              <div class="profile-stat-label">Games</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-num" id="myStatFriends">0</div>
              <div class="profile-stat-label">Friends</div>
            </div>
            <div class="profile-stat">
              <div class="profile-stat-num" id="myStatMessages">0</div>
              <div class="profile-stat-label">Messages</div>
            </div>
          </div>
        </div>
      </div>

      <div style="display: flex; gap: 8px; margin: 10px 0;">
        <input type="text" id="statusInput" class="sidebar-input" placeholder="Set your status..." maxlength="50" style="margin: 0;">
        <button class="sidebar-btn sidebar-btn-orange" onclick="updateStatus()">Set</button>
      </div>

      <hr class="sidebar-divider">

      <h3> Edit Profile</h3>
      <label>Username:</label>
      <input type="text" id="editUsername" class="sidebar-input" placeholder="Your username">
      <label>Bio:</label>
      <input type="text" id="editBio" class="sidebar-input" placeholder="Something about you">
      <label>Profile pic (URL or GIF):</label>
      <input type="text" id="editPic" class="sidebar-input" placeholder="https://example.com/pic.png">
      <button class="sidebar-btn sidebar-btn-orange" onclick="saveProfile()">Save Changes</button>

      <hr class="sidebar-divider">

      <h3> Search Users</h3>
      <input type="text" id="userSearch" class="sidebar-input" placeholder="Search username..." oninput="searchUsers()">
      <div id="userSearchResults"></div>
    </div>

    <!-- Friends Tab -->
    <div id="friendsTab" class="sidebar-panel">
      <h3> Your Friends</h3>
      <div id="friendsList"></div>

      <hr class="sidebar-divider">

      <h3> Friend Requests</h3>
      <div id="friendRequests"></div>
    </div>

    <!-- Activity Tab -->
    <div id="activityTab" class="sidebar-panel">
      <h3> Friend Activity</h3>
      <div id="activityFeed"></div>
    </div>

    <!-- Online Tab -->
    <div id="onlineTab" class="sidebar-panel">
      <h3> Online Users</h3>
      <p id="onlineCountSidebar" class="online-count">0 users online</p>
      <div id="onlineUsersList"></div>

      <hr class="sidebar-divider">

      <h3> Recently Active</h3>
      <div id="recentUsersList"></div>
    </div>

    <!-- Inventory Tab -->
    <div id="inventoryTab" class="sidebar-panel">
      <h3> Inventory</h3>
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <button class="sidebar-btn sidebar-btn-orange" onclick="openShop()"> Shop</button>
        <button class="sidebar-btn sidebar-btn-purple" onclick="openTrade()"> Trade</button>
      </div>
      
      <h4 style="color: var(--text-secondary); font-size: 14px; margin-top: 20px;">Owned Items:</h4>
      <div id="inventoryItems" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 10px;"></div>
    </div>

    <!-- Settings Tab -->
    <div id="settingsTab" class="sidebar-panel">
      <h3> Appearance</h3>
      <label>Theme:</label>
      <select id="themeSelect" class="sidebar-input" onchange="changeTheme(this.value)">
        <option value="dark"> Dark</option>
        <option value="light"> Light</option>
        <option value="neon"> Neon</option>
        <option value="ocean"> Ocean</option>
        <option value="forest"> Forest</option>
        <option value="sunset"> Sunset</option>
      </select>

      <label>Font:</label>
      <select id="fontSelect" class="sidebar-input" onchange="changeFont(this.value)">
        <option value="poppins">Poppins</option>
        <option value="roboto">Roboto</option>
        <option value="montserrat">Montserrat</option>
        <option value="opensans">Open Sans</option>
        <option value="raleway">Raleway</option>
      </select>

      <label>Particle Effect:</label>
      <select id="particleSelect" class="sidebar-input" onchange="changeParticles(this.value)">
        <option value="none">None</option>
        <option value="snow"> Snow</option>
        <option value="stars"> Stars</option>
        <option value="rain"> Rain</option>
        <option value="confetti"> Confetti</option>
        <option value="hearts"> Hearts</option>
        <option value="bubbles"> Bubbles</option>
      </select>

      <label style="display: flex; align-items: center; gap: 10px; margin-top: 10px;">
        <input type="checkbox" id="compactMode" onchange="toggleCompactMode()">
        Compact Mode
      </label>

      <label>Custom Background (URL):</label>
      <input type="text" id="bgUrl" class="sidebar-input" placeholder="https://example.com/bg.jpg">
      <button class="sidebar-btn sidebar-btn-orange" onclick="setCustomBg()">Set</button>
      <button class="sidebar-btn sidebar-btn-gray" onclick="clearCustomBg()">Clear</button>

      <hr class="sidebar-divider">

      <h3> Sound Settings</h3>
      <label style="display: flex; align-items: center; gap: 10px;">
        <input type="checkbox" id="soundEnabled" checked onchange="toggleSoundSetting()">
        Enable sound effects
      </label>
      <label style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
        <input type="checkbox" id="notifSound" checked onchange="saveSettings()">
        Notification sounds
      </label>

      <hr class="sidebar-divider">



      <h3> Tab Cloak</h3>
      <p style="color: var(--text-secondary); font-size: 12px; margin-bottom: 10px;">Disguise this tab to look like something else!</p>
      
      <label>Quick Presets:</label>
      <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 15px;">
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('classroom')" style="font-size: 12px;"> Classroom</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('docs')" style="font-size: 12px;"> Docs</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('drive')" style="font-size: 12px;"> Drive</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('gmail')" style="font-size: 12px;"> Gmail</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('canvas')" style="font-size: 12px;"> Canvas</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="setCloakPreset('khan')" style="font-size: 12px;"> Khan Academy</button>
      </div>
      
      <label>Custom Tab Title:</label>
      <input type="text" id="customCloakTitle" class="sidebar-input" placeholder="Google Classroom">
      
      <label>Custom Favicon URL:</label>
      <input type="text" id="customCloakIcon" class="sidebar-input" placeholder="https://example.com/favicon.ico">
      
      <div style="display: flex; gap: 8px; margin-bottom: 10px;">
        <button class="sidebar-btn sidebar-btn-orange" onclick="applyCustomCloak()">Apply Custom</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="resetCloak()">Reset</button>
      </div>
      
      <label style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
        <input type="checkbox" id="autoCloakEnabled" onchange="saveAutoCloak()">
        Auto-apply cloak on page load
      </label>
      
      <button class="sidebar-btn sidebar-btn-blue" onclick="openInAboutBlank()" style="width: 100%;"> Open in about:blank (Undetectable)</button>
      <p style="color: var(--text-muted); font-size: 11px; margin-top: 8px;">about:blank hides the URL completely!</p>

      <hr class="sidebar-divider">








      <h3> Panic Settings</h3>
      <label>Panic URL:</label>
      <input type="text" id="panicUrl" class="sidebar-input" placeholder="https://classroom.google.com" value="https://classroom.google.com">
      <button class="sidebar-btn sidebar-btn-green" onclick="savePanicUrl()">Save</button>
      <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;">Press ` (backtick) to redirect</p>

      <hr class="sidebar-divider">

      <h3> Favorites</h3>
      <button class="sidebar-btn sidebar-btn-red" onclick="clearFavorites()">Clear All</button>

      <hr class="sidebar-divider">

      <h3> Reset Account</h3>
      <button class="sidebar-btn sidebar-btn-red" onclick="resetAccount()">Reset Account</button>
    </div>


<!-- Music Tab -->
<div id="musicTab" class="sidebar-panel">
  <h3> Music Player</h3>
  
  <div class="music-sidebar-now-playing">
    <div class="music-sidebar-title" id="musicSongTitle">No song playing</div>
    <div class="music-sidebar-status" id="musicSongStatus">Add songs below</div>
  </div>
  
  <div class="music-sidebar-progress">
    <div class="music-sidebar-progress-bar" id="musicProgressBar" onclick="seekMusic(event)">
      <div class="music-sidebar-progress-fill" id="musicProgressFill" style="width: 0%"></div>
    </div>
    <div class="music-sidebar-time">
      <span id="musicCurrentTime">0:00</span>
      <span id="musicDuration">0:00</span>
    </div>
  </div>
  
  <div class="music-sidebar-controls">
    <button class="music-sidebar-btn" id="shuffleBtn" onclick="toggleShuffle()" title="Shuffle"></button>
    <button class="music-sidebar-btn" onclick="prevSong()" title="Previous"></button>
    <button class="music-sidebar-btn music-sidebar-play" id="musicPlayBtn" onclick="togglePlayPause()" title="Play"></button>
    <button class="music-sidebar-btn" onclick="nextSong()" title="Next"></button>
    <button class="music-sidebar-btn" id="repeatBtn" onclick="toggleRepeat()" title="Repeat"></button>
  </div>
  
  <div class="music-sidebar-volume">
    <span></span>
    <input type="range" class="music-sidebar-volume-slider" id="musicVolume" min="0" max="100" value="50" oninput="changeVolume(this.value)">
  </div>
  
  <hr class="sidebar-divider">
  
  <h3> Playlist</h3>
  <div class="music-sidebar-playlist" id="musicPlaylist">
    <p style="color: var(--text-muted); font-size: 12px; text-align: center;">No songs yet</p>
  </div>
  
  <hr class="sidebar-divider">
  
  <h3> Add Song</h3>
  <input type="text" class="sidebar-input" id="musicSongName" placeholder="Song name (optional)">
  <input type="text" class="sidebar-input" id="musicUrlInput" placeholder="Audio URL (.mp3, .wav, etc.)">
  <button class="sidebar-btn sidebar-btn-green" onclick="addSong()" style="width: 100%;">Add Song</button>
</div>

<!-- Achievements Tab -->
<div id="achievementsTab" class="sidebar-panel">
  <h3> Achievements</h3>
  
  <div class="achievements-sidebar-stats">
    <div class="achievements-sidebar-stat">
      <div class="achievements-sidebar-stat-num" id="achievementsUnlocked">0</div>
      <div class="achievements-sidebar-stat-label">Unlocked</div>
    </div>
    <div class="achievements-sidebar-stat">
      <div class="achievements-sidebar-stat-num" id="achievementsTotal">0</div>
      <div class="achievements-sidebar-stat-label">Total</div>
    </div>
    <div class="achievements-sidebar-stat">
      <div class="achievements-sidebar-stat-num" id="achievementsPercent">0%</div>
      <div class="achievements-sidebar-stat-label">Complete</div>
    </div>
  </div>
  
  <hr class="sidebar-divider">
  
  <div class="achievements-sidebar-tabs">
    <button class="achievements-sidebar-tab active" onclick="showAchievementCategory('all', this)">All</button>
    <button class="achievements-sidebar-tab" onclick="showAchievementCategory('gaming', this)"></button>
    <button class="achievements-sidebar-tab" onclick="showAchievementCategory('social', this)"></button>
    <button class="achievements-sidebar-tab" onclick="showAchievementCategory('wealth', this)"></button>
    <button class="achievements-sidebar-tab" onclick="showAchievementCategory('dedication', this)"></button>
  </div>
  
  <div class="achievements-sidebar-list" id="achievementsList"></div>
</div>


    
    <!-- Admin Tab -->
    <div id="adminTab" class="sidebar-panel">
      <h3 style="color: #ff6666;"> Admin Panel</h3>

      <div class="admin-stats">
        <div class="admin-stat">
          <div id="adminUserCount" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Total Users</div>
        </div>
        <div class="admin-stat">
          <div id="adminOnlineCount" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Online Now</div>
        </div>
        <div class="admin-stat">
          <div id="adminMessageCount" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Messages</div>
        </div>
        <div class="admin-stat">
          <div id="adminCoins" class="admin-stat-number">0</div>
          <div class="admin-stat-label">Total Coins</div>
        </div>
      </div>

      <div class="admin-section">
        <h4> Admin Commands</h4>
        <div class="admin-cmd-input">
          <input type="text" id="adminCmd" class="sidebar-input" placeholder="/help for commands" onkeypress="handleAdminCmd(event)" style="margin: 0;">
          <button class="sidebar-btn sidebar-btn-green" onclick="executeAdminCmd()">Run</button>
        </div>
        <div id="cmdOutput" style="background: var(--bg-primary); border-radius: 8px; padding: 10px; margin-top: 10px; max-height: 150px; overflow-y: auto; font-size: 12px; font-family: monospace;"></div>
      </div>

      <div class="admin-section">
        <h4> Announcement</h4>
        <input type="text" id="announcementInput" class="sidebar-input" placeholder="Type announcement...">
        <button class="sidebar-btn sidebar-btn-orange" onclick="setAnnouncement()">Set</button>
        <button class="sidebar-btn sidebar-btn-gray" onclick="clearAnnouncement()">Clear</button>
      </div>

      <div class="admin-section">
        <h4> Audit Log</h4>
        <div id="auditLog" class="audit-log"></div>
      </div>

      <div class="admin-section">
        <h4> Users</h4>
        <div id="adminUsersList" style="max-height: 200px; overflow-y: auto;"></div>
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <!-- Stats Banner -->
    <div class="stats-banner">
      <div class="stat-item">
        <div class="stat-number" id="statTotalUsers">0</div>
        <div class="stat-label">USERS</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="statTotalGames">0</div>
        <div class="stat-label">GAMES</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="statTotalMessages">0</div>
        <div class="stat-label">MESSAGES</div>
      </div>
      <div class="stat-item">
        <div class="stat-number" id="statOnlineNow">0</div>
        <div class="stat-label">ONLINE</div>
      </div>
    </div>

    <!-- XP Bar -->
    <div class="xp-bar-container">
      <div class="level-badge" id="levelBadge">LVL 1</div>
      <div class="xp-bar">
        <div class="xp-bar-fill" id="xpBarFill" style="width: 0%"></div>
      </div>
      <div class="xp-text" id="xpText">0 / 100 XP</div>
      <div class="coins-display" onclick="openShop()">
        <span></span>
        <span id="coinsDisplay">0</span>
      </div>
    </div>

    <!-- Navbar -->
    <div class="navbar">
      <a onclick="showPage('home')">Home</a>
      <a onclick="showPage('allgames')">All Games</a>
      <a onclick="showPage('minigames')">Mini Games</a>
      <a onclick="showPage('casino')">Casino</a>
      <a onclick="showPage('page1')">More Sites</a>
      <span id="usernameDisplay"></span>
    </div>

    <!-- Home Page -->
    <div id="home" class="page">
      <h1> Welcome to The Gaming Hub</h1>
      <p>The Ultimate Gaming Platform</p>

      <button class="random-game-btn" onclick="playRandomGame()"> Play Random Game</button>

      <div class="owners-section">
        <h2> Team</h2>
        <div class="owners-list">
          <div class="profile-card" style="width: 160px; cursor: pointer;" onclick="viewTeamProfile('riley')">
            <div class="profile-banner" style="height: 60px;"></div>
            <div class="profile-card-content" style="padding: 10px; margin-top: -30px;">
              <img class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=R" alt="Riley" style="width: 60px; height: 60px;">
              <p class="profile-name">Riley</p>
              <p class="owner-badge"> OWNER</p>
            </div>
          </div>
          <div class="profile-card" style="width: 160px; cursor: pointer;" onclick="viewTeamProfile('garrett')">
            <div class="profile-banner" style="height: 60px;"></div>
            <div class="profile-card-content" style="padding: 10px; margin-top: -30px;">
              <img class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=G" alt="Garrett" style="width: 60px; height: 60px;">
              <p class="profile-name">Garrett</p>
              <p class="coowner-badge"> CO-OWNER</p>
            </div>
          </div>
          <div class="profile-card" style="width: 160px; cursor: pointer;" onclick="viewTeamProfile('john')">
            <div class="profile-banner" style="height: 60px;"></div>
            <div class="profile-card-content" style="padding: 10px; margin-top: -30px;">
              <img class="profile-pic-large" src="https://api.dicebear.com/7.x/initials/svg?seed=J" alt="John" style="width: 60px; height: 60px;">
              <p class="profile-name">John</p>
              <p class="coowner-badge"> CO-OWNER</p>
            </div>
          </div>
        </div>
      </div>

      <div class="favorites-section">
        <h2> Favorites</h2>
        <div id="favoritesDisplay" class="games-list">
          <p class="no-favorites">No favorites yet. Click the  on any game to add it.</p>
        </div>
      </div>
    </div>

    <!-- All Games Page -->
    <div id="allgames" class="page" style="display: none;">
      <h2> All Games</h2>
      <button class="random-game-btn" onclick="playRandomGame()"> Play Random Game</button>
      <div id="allGamesList" class="games-list"></div>
    </div>

    <!-- Mini Games Page -->
    <div id="minigames" class="page" style="display: none;">
      <h2> Mini Games</h2>
      <p>Classic games built right into the site!</p>
      <div class="minigames-grid" id="minigamesGrid"></div>
    </div>

    <!-- Casino Page -->
    <div id="casino" class="page" style="display: none;">
      <h2> Casino</h2>
      <p style="color: var(--warning);"> Play responsibly! Coins have a 5min cooldown per game.</p>
      <div class="casino-section">
        <h2> Casino Games</h2>
        <div class="casino-games" id="casinoGames"></div>
      </div>
    </div>

    <!-- More Sites Page -->
    <div id="page1" class="page" style="display: none;">
      <h2> More Gaming Sites</h2>
      <div class="games-list" id="gamesPage1"></div>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <script>

        // ===== FIREBASE SETUP =====
    const firebaseConfig = {
      apiKey: "AIzaSyDv3JRn08FStrEd6cF3x2AFDCgvbJOGtC8",
      authDomain: "riley-games-1544e.firebaseapp.com",
      projectId: "riley-games-1544e",
      storageBucket: "riley-games-1544e.firebasestorage.app",
      messagingSenderId: "501107166002",
      appId: "1:501107166002:web:b684a91dbc9d6fb9e7a52b"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // ===== GLOBAL VARIABLES =====
    let userId = localStorage.getItem("userId");
    if (!userId) {
      userId = "user_" + Date.now() + "_" + Math.floor(Math.random() * 10000);
      localStorage.setItem("userId", userId);
    }

    let myProfile = null;
    let isAdmin = false;
    let chatOpen = false;
    let lastMessageCount = 0;
    let soundEnabled = localStorage.getItem("soundEnabled") !== "false";
    let notifSound = localStorage.getItem("notifSound") !== "false";
    let currentDmUserId = null;
    let currentGroupId = null;
    let typingTimeout = null;
    let lastGamePlayTime = {};

    const SECRET_TAG = "_2024xAuth";
    const ADMIN_USERNAMES = {
      "riley": "riley_2024xauth",
      "garrett": "garrett_2024xauth",
      "john": "john_2024xauth"
    };

    // ===== XP SYSTEM =====
    const XP_PER_LEVEL = [
      100, 150, 225, 340, 510, 765, 1150, 1725, 2590, 3885,
      5828, 8742, 13113, 19670, 29505, 44258, 66387, 99581, 149372, 224058,
      336087, 504131, 756197, 1134296, 1701444
    ];

    function getDisplayName(username) {
      if (username && username.includes(SECRET_TAG)) {
        return username.replace(SECRET_TAG, "");
      }
      return username;
    }

    function isAdminUsername(username) {
      if (!username) return false;
      let lower = username.toLowerCase();
      return lower === ADMIN_USERNAMES.riley || 
             lower === ADMIN_USERNAMES.garrett || 
             lower === ADMIN_USERNAMES.john;
    }

    function getRole(username) {
      if (!username) return " Member";
      let lower = username.toLowerCase();
      if (lower === ADMIN_USERNAMES.riley) return " Owner";
      if (lower === ADMIN_USERNAMES.garrett || lower === ADMIN_USERNAMES.john) return " Co-Owner";
      return " Member";
    }

    function calculateLevel(xp) {
      let level = 1;
      let totalXp = 0;
      
      for (let i = 0; i < XP_PER_LEVEL.length; i++) {
        if (xp >= totalXp + XP_PER_LEVEL[i]) {
          level = i + 2;
          totalXp += XP_PER_LEVEL[i];
        } else {
          break;
        }
      }
      
      return { level, currentXp: xp - totalXp, requiredXp: XP_PER_LEVEL[level - 1] || 999999 };
    }

    async function addXP(amount, reason) {
      if (!myProfile) return;
      
      let oldLevel = calculateLevel(myProfile.xp || 0).level;
      myProfile.xp = (myProfile.xp || 0) + amount;
      let newLevel = calculateLevel(myProfile.xp).level;
      
      await db.collection("users").doc(userId).update({ xp: myProfile.xp });
      
      updateXPBar();
      
      if (newLevel > oldLevel) {
        levelUp(newLevel);
      }
      
      if (reason) {
        showNotification(`+${amount} XP: ${reason}`);
   
     trackXpEarned(amount); 
      }
    }

    function levelUp(newLevel) {
      playSound('notification');
      showNotification(` LEVEL UP! You're now level ${newLevel}!`, 'success');
      
      // Reward coins for leveling up
      let coinReward = newLevel * 50;
      addCoins(coinReward, `Level ${newLevel} reward`);
      
      // Confetti animation
      createConfetti();
  
    trackLevelUp(newLevel);
    }

    function updateXPBar() {
      if (!myProfile) return;
      
      let { level, currentXp, requiredXp } = calculateLevel(myProfile.xp || 0);
      let percentage = (currentXp / requiredXp) * 100;
      
      document.getElementById("xpBarFill").style.width = percentage + "%";
      document.getElementById("xpText").textContent = `${currentXp} / ${requiredXp} XP`;
      document.getElementById("levelBadge").textContent = `LVL ${level}`;
      document.getElementById("myProfileLevel").textContent = `LVL ${level}`;
    }

    // ===== COINS SYSTEM =====
       async function addCoins(amount, reason) {
      if (!myProfile) return;
      
      let newTotal = (myProfile.coins || 0) + amount;
      
      // Cap at 10,000 for regular earning (not admin commands)
      if (newTotal > 10000) {
        newTotal = 10000;
        if (myProfile.coins >= 10000) {
          showNotification("You've hit the 10k coin cap! Spend some in the shop.", 'warning');
          return;
        }
      }
      
      myProfile.coins = newTotal;
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      document.getElementById("shopCoinsDisplay").textContent = myProfile.coins;
      
      if (reason && amount > 0) {
        showNotification(`+${amount} : ${reason}`, 'success');
   
      trackCoinsEarned(amount);
      }
    }
  
  
  
  
  
    async function checkGameCooldown(gameName) {
      let now = Date.now();
      let lastPlayed = lastGamePlayTime[gameName] || 0;
      let cooldown = 5 * 60 * 1000; // 5 minutes
      
      if (now - lastPlayed < cooldown) {
        let remaining = Math.ceil((cooldown - (now - lastPlayed)) / 60000);
        showNotification(`Cooldown: Wait ${remaining} more minutes to earn coins from this game`, 'warning');
        return false;
      }
      
      return true;
    }

    async function earnCoinsFromGame(gameName) {
      if (!await checkGameCooldown(gameName)) return;
      
      let coins = Math.floor(Math.random() * 20) + 10; // 10-30 coins
      let xp = Math.floor(Math.random() * 15) + 5; // 5-20 XP
      
      lastGamePlayTime[gameName] = Date.now();
      
      await addCoins(coins, `Played ${gameName}`);
      await addXP(xp, `Played ${gameName}`);
      
      // Track play time
      if (myProfile.playTime) {
        myProfile.playTime[gameName] = (myProfile.playTime[gameName] || 0) + 1;
      } else {
        myProfile.playTime = { [gameName]: 1 };
      }
      
      myProfile.gamesPlayed = (myProfile.gamesPlayed || 0) + 1;
      
      await db.collection("users").doc(userId).update({
        playTime: myProfile.playTime,
        gamesPlayed: myProfile.gamesPlayed
      });
      
      document.getElementById("myStatGames").textContent = myProfile.gamesPlayed;

    trackGamePlayed(gameName);
    }

    // ===== SOUNDS =====
    const sounds = {
      message: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZURE',
      click: 'data:audio/wav;base64,UklGRlwBAABXQVZFZm10IBAAAAABAAEAIlYAAIJYAAACABAAZGF0YTgBAADr/+v/6//r/+v/7v8MAQYBBQEFAQUBBQEFAQUBBQEEAQYBBQEFAQUBBQEEAQUBBQEFAQUBBQEEAQUBBQEFAQUBBQEFAQUBBQEFAQUBBQEFAQUBBQEFAQUBBQEEAQUBBQEEAQYBBQEFAQUBBQEEAQUBBQEFAQUBBQEFAQUBBQEEAQUBBQEEAQUBBQEFAQUBBQE',
      notification: 'data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeS'
    };

    const audioCache = {};

    function playSound(type) {
      if (!soundEnabled) return;
      if ((type === 'message' || type === 'notification') && !notifSound) return;
      
      if (!audioCache[type]) {
        audioCache[type] = new Audio(sounds[type]);
        audioCache[type].volume = 0.3;
      }
      
      audioCache[type].play().catch(e => {});
    }

    // ===== LOADING QUOTES =====
    const loadingQuotes = [
      "Get ready for epic gaming!",
      "Preparing your adventure...",
      "Loading awesomeness...",
      "The game is afoot!",
      "May your FPS be high and your ping low",
      "Respawn in 3... 2... 1...",
      "Achievement unlocked: Patience",
      "Press F to pay respects... to loading screens",
      "404: Boredom not found",
      "Calculating your skill level...",
      "Buffing your characters...",
      "Spawning loot boxes...",
      "Initializing fun protocols...",
      "Downloading more RAM...",
      "Charging your gaming chair...",
      "Updating your gaming socks...",
      "Calibrating your winning streak...",
      "Summoning the gaming gods...",
      "Brewing energy drinks...",
      "Assembling the dream team...",
      "Rolling for initiative...",
      "Crafting legendary items...",
      "Installing skill implants...",
      "Optimizing your grind...",
      "Syncing with the matrix...",
      "Preparing boss battles...",
      "Loading Easter eggs...",
      "Generating random crits...",
      "Establishing dominance...",
      "Activating tryhard mode...",
      "Consulting the speedrun timer...",
      "Unleashing the chaos...",
      "Preparing your victory dance...",
      "Warming up the RGB lights...",
      "Tuning your mechanical keyboard...",
      "Adjusting your gaming headset...",
      "Powering up the gaming mouse...",
      "Setting up your triple monitor setup...",
      "Organizing your desktop icons...",
      "Clearing your browser history...",
      "Hiding evidence from teachers...",
      "Disguising as homework...",
      "Cloaking in stealth mode...",
      "Activating incognito protocol...",
      "Preparing your excuses...",
      "Loading plausible deniability...",
      "Generating alibi scenarios...",
      "Practicing your 'I'm studying' face...",
      "Minimizing suspicious tabs...",
      "Ready Player One...",
      "It's dangerous to go alone!"
    ];

    function getRandomQuote() {
      return loadingQuotes[Math.floor(Math.random() * loadingQuotes.length)];
    }

    // ===== NOTIFICATIONS =====
    function showNotification(message, type = 'info') {
      let notif = document.createElement('div');
      notif.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--accent)'};
        color: black;
        padding: 15px 25px;
        border-radius: 10px;
        z-index: 10000;
        font-weight: 600;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        animation: slideIn 0.3s, slideOut 0.3s 2.7s;
      `;
      notif.textContent = message;
      document.body.appendChild(notif);
      
      setTimeout(() => notif.remove(), 3000);
    }

    // ===== CONFETTI =====
    function createConfetti() {
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          let confetti = document.createElement('div');
          confetti.className = 'particle confetti';
          confetti.style.left = Math.random() * 100 + 'vw';
          confetti.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
          confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
          document.getElementById('particles-container').appendChild(confetti);
          
          setTimeout(() => confetti.remove(), 4000);
        }, i * 30);
      }
    }

    // ===== CHECK FIRST VISIT =====
    async function checkFirstVisit() {
      let doc = await db.collection("users").doc(userId).get();
      if (!doc.exists) {
        document.getElementById("welcomePopup").style.display = "flex";
      } else {
        myProfile = doc.data();
        
        // Initialize new fields if missing
        if (!myProfile.xp) myProfile.xp = 0;
        if (!myProfile.coins) myProfile.coins = 0;
        if (!myProfile.level) myProfile.level = 1;
        if (!myProfile.inventory) myProfile.inventory = [];
        if (!myProfile.equippedBanner) myProfile.equippedBanner = null;
        if (!myProfile.playTime) myProfile.playTime = {};
        
        updateProfileDisplay();
        updateOnlineStatus();
        checkAdmin();
        updateXPBar();
        updateInventory();
        try {
  loadAchievements();
} catch(e) {
  console.error("Achievements error:", e);
}
      }
    }

    // ===== CREATE PROFILE =====
    async function createProfile() {
      let username = document.getElementById("newUsername").value.trim();
      if (username === "") {
        alert("Please enter a username");
        return;
      }

      let lowerUsername = username.toLowerCase();
      if ((lowerUsername === "riley" || lowerUsername === "garrett" || lowerUsername === "john") && 
          !username.toLowerCase().includes(SECRET_TAG.toLowerCase())) {
        alert("That username is reserved.");
        return;
      }

      myProfile = {
        username: username,
        bio: "",
        pic: "https://api.dicebear.com/7.x/initials/svg?seed=" + username,
        banner: null,
        color: "#ff8800",
        friends: [],
        friendRequests: [],
        status: "",
        xp: 0,
        coins: 100, // Starting coins
        level: 1,
        gamesPlayed: 0,
        messagesSent: 0,
        inventory: [],
        equippedBanner: null,
        equippedFrame: null,
        equippedBadge: null,
        equippedTitle: null,
        playTime: {},
        banned: false,
        muted: false,
        tempBanUntil: null,
        lastSeen: Date.now(),
        createdAt: Date.now()
      };

      await db.collection("users").doc(userId).set(myProfile);
      document.getElementById("welcomePopup").style.display = "none";
      updateProfileDisplay();
      updateOnlineStatus();
      checkAdmin();
      updateXPBar();
      
      showNotification("Welcome to The Gaming Hub! ", 'success');
      addXP(50, "Joined the Hub!");
    }

    // ===== SAVE PROFILE =====
    async function saveProfile() {
      let username = document.getElementById("editUsername").value.trim();
      let bio = document.getElementById("editBio").value.trim();
      let pic = document.getElementById("editPic").value.trim();

      if (username === "") {
        alert("Username can't be empty");
        return;
      }

      if (pic === "") {
        pic = "https://api.dicebear.com/7.x/initials/svg?seed=" + username;
      }

      myProfile.username = username;
      myProfile.bio = bio;
      myProfile.pic = pic;

      await db.collection("users").doc(userId).update({
        username: username,
        bio: bio,
        pic: pic
      });
      
      updateProfileDisplay();
      checkAdmin();
      playSound('click');
      showNotification("Profile saved!", 'success');
  
    if (bio) trackProfileUpdated('bio');
if (pic && !pic.includes('dicebear')) trackProfileUpdated('pic');
    }

    // ===== UPDATE PROFILE DISPLAY =====
    function updateProfileDisplay() {
      if (!myProfile) return;

      let displayName = getDisplayName(myProfile.username);
      let { level } = calculateLevel(myProfile.xp || 0);
      
      document.getElementById("myProfileName").textContent = displayName;
      document.getElementById("myProfileBio").textContent = myProfile.bio || "No bio yet";
      document.getElementById("myProfilePic").src = myProfile.pic;
      document.getElementById("myProfileRole").textContent = getRole(myProfile.username);
      document.getElementById("myProfileLevel").textContent = `LVL ${level}`;
      
      // Banner
      if (myProfile.equippedBanner) {
        document.getElementById("myProfileBanner").style.backgroundImage = `url(${myProfile.equippedBanner})`;
      }
      
      // Status
      if (myProfile.status) {
        document.getElementById("myProfileStatus").textContent = '"' + myProfile.status + '"';
        document.getElementById("myProfileStatus").style.display = "block";
      }
      
      // Stats
      document.getElementById("myStatGames").textContent = myProfile.gamesPlayed || 0;
      document.getElementById("myStatFriends").textContent = (myProfile.friends || []).length;
      document.getElementById("myStatMessages").textContent = myProfile.messagesSent || 0;
      
      // Coins
      document.getElementById("coinsDisplay").textContent = myProfile.coins || 0;
      document.getElementById("shopCoinsDisplay").textContent = myProfile.coins || 0;

      document.getElementById("editUsername").value = myProfile.username;
      document.getElementById("editBio").value = myProfile.bio || "";
      document.getElementById("editPic").value = myProfile.pic.includes("dicebear") ? "" : myProfile.pic;

      document.getElementById("usernameDisplay").textContent = " " + displayName;

      loadFriends();
      loadFriendRequests();
    }

    async function updateStatus() {
      let status = document.getElementById("statusInput").value.trim();
      myProfile.status = status;
      await db.collection("users").doc(userId).update({ status: status });
      updateProfileDisplay();
      document.getElementById("statusInput").value = "";
      showNotification("Status updated!", 'success');
  
    trackProfileUpdated('status');
    }

    // ===== ONLINE STATUS =====
    async function updateOnlineStatus() {
      if (!myProfile) return;
      await db.collection("users").doc(userId).update({ lastSeen: Date.now() });
    }

    setInterval(() => {
      if (myProfile) updateOnlineStatus();
    }, 30000);

    function isUserOnline(lastSeen) {
      if (!lastSeen) return false;
      return (Date.now() - lastSeen) < (2 * 60 * 1000);
    }

    function checkAdmin() {
      if (myProfile && isAdminUsername(myProfile.username)) {
        isAdmin = true;
        document.getElementById("adminTabBtn").style.display = "block";
      } else {
        isAdmin = false;
        document.getElementById("adminTabBtn").style.display = "none";
      }
    }

    // ===== CHECK IF BANNED =====
    async function checkIfBanned() {
      if (!myProfile) return false;
      
      if (myProfile.tempBanUntil && Date.now() < myProfile.tempBanUntil) {
        let hours = Math.ceil((myProfile.tempBanUntil - Date.now()) / (1000 * 60 * 60));
        document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:var(--bg-primary);color:var(--text-primary);text-align:center;padding:20px;"><h1 style="color:var(--danger);"> Temporarily Banned</h1><p>You are banned for ${hours} more hours.</p></div>`;
        return true;
      }
      
      if (myProfile.banned) {
        document.body.innerHTML = `<div style="display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;background:var(--bg-primary);color:var(--text-primary);text-align:center;padding:20px;"><h1 style="color:var(--danger);"> Permanently Banned</h1><p>Contact an admin if you believe this is a mistake.</p></div>`;
        return true;
      }
      
      return false;
    }

        // ===== CHAT SYSTEM =====
    function toggleChat() {
      chatOpen = !chatOpen;
      document.getElementById("chatPanel").classList.toggle("open", chatOpen);
      if (chatOpen) {
        document.getElementById("chatBadge").style.display = "none";
        document.getElementById("chatInput").focus();
      }
      playSound('click');
    }

    function showChatTab(tab, btn) {
      document.querySelectorAll('.chat-header-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      
      document.querySelectorAll('.dm-panel').forEach(p => p.style.display = 'none');
      
      if (tab === 'global') {
        document.getElementById('globalChatPanel').style.display = 'flex';
      } else if (tab === 'dms') {
        document.getElementById('dmsPanel').style.display = 'block';
        loadDmList();
      } else if (tab === 'groups') {
        document.getElementById('groupsPanel').style.display = 'block';
        loadGroupsList();
      }
      playSound('click');
    }

    function handleChatKeypress(event) {
      if (event.key === "Enter") {
        sendMessage();
      }
    }

    // ===== TYPING INDICATOR =====
    function handleTyping() {
      if (!myProfile) return;
      
      db.collection("typing").doc(userId).set({
        username: getDisplayName(myProfile.username),
        timestamp: Date.now()
      });
      
      if (typingTimeout) clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        db.collection("typing").doc(userId).delete();
      }, 2000);
    }

    function loadTypingIndicators() {
      db.collection("typing").onSnapshot(snapshot => {
        let typingNames = [];
        let now = Date.now();
        
        snapshot.forEach(doc => {
          if (doc.id !== userId) {
            let data = doc.data();
            if (now - data.timestamp < 3000) {
              typingNames.push(data.username);
            }
          }
        });
        
        let indicator = document.getElementById("typingIndicator");
        if (typingNames.length > 0) {
          document.getElementById("typingUser").textContent = typingNames[0];
          indicator.classList.add("show");
        } else {
          indicator.classList.remove("show");
        }
      });
    }

    // ===== MENTIONS =====
    function checkMentions() {
      let input = document.getElementById("chatInput");
      let text = input.value;
      let cursorPos = input.selectionStart;
      
      // Check if @ is typed
      let lastAt = text.lastIndexOf('@', cursorPos);
      if (lastAt === -1 || lastAt < cursorPos - 20) {
        document.getElementById("mentionsDropdown").classList.remove("show");
        return;
      }
      
      let searchText = text.substring(lastAt + 1, cursorPos).toLowerCase();
      showMentionsDropdown(searchText, lastAt);
    }

    async function showMentionsDropdown(searchText, atPos) {
      let snapshot = await db.collection("users").limit(10).get();
      let dropdown = document.getElementById("mentionsDropdown");
      
      let html = "";
      snapshot.forEach(doc => {
        let user = doc.data();
        let displayName = getDisplayName(user.username);
        
        if (displayName.toLowerCase().includes(searchText)) {
          html += `<div class="mention-option" onclick="insertMention('${displayName}', ${atPos})">`;
          html += `<img src="${user.pic}" alt="pic">`;
          html += `<span>${displayName}</span>`;
          html += `</div>`;
        }
      });
      
      if (html) {
        dropdown.innerHTML = html;
        dropdown.classList.add("show");
      } else {
        dropdown.classList.remove("show");
      }
    }

    function insertMention(username, atPos) {
      let input = document.getElementById("chatInput");
      let text = input.value;
      let before = text.substring(0, atPos);
      let after = text.substring(input.selectionStart);
      
      input.value = before + '@' + username + ' ' + after;
      input.focus();
      
      document.getElementById("mentionsDropdown").classList.remove("show");
    }

    async function sendMessage() {
      let input = document.getElementById("chatInput");
      let text = input.value.trim();

      if (text === "" || !myProfile) return;
      
      if (myProfile.muted) {
        showNotification("You are muted and cannot send messages.", 'warning');
        return;
      }

      await db.collection("chat").add({
        userId: userId,
        username: myProfile.username,
        pic: myProfile.pic,
        level: calculateLevel(myProfile.xp || 0).level,
        text: text,
        reactions: {},
        timestamp: Date.now()
      });

      myProfile.messagesSent = (myProfile.messagesSent || 0) + 1;
      await db.collection("users").doc(userId).update({ messagesSent: myProfile.messagesSent });
      document.getElementById("myStatMessages").textContent = myProfile.messagesSent;

      input.value = "";
      db.collection("typing").doc(userId).delete();
      playSound('message');
      
      // XP for chatting
      if (Math.random() < 0.3) {
        addXP(2, "Chatting");
  
      trackMessageSent();
      }
    }

    function loadChat() {
      db.collection("chat")
        .orderBy("timestamp", "desc")
        .limit(50)
        .onSnapshot(snapshot => {
          let messages = [];
          snapshot.forEach(doc => {
            messages.push({ id: doc.id, data: doc.data() });
          });

          messages.reverse();

          let html = "";
          for (let msg of messages) {
            let data = msg.data;
            let isMine = data.userId === userId;
            let time = new Date(data.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            let displayName = getDisplayName(data.username);
            
            // Process mentions
            let processedText = data.text.replace(/@(\w+)/g, '<span class="mention">@$1</span>');

            html += `<div class="chat-message${isMine ? ' mine' : ''}">`;
            html += `<div class="chat-message-header">`;
            html += `<img class="chat-message-pic" src="${data.pic}" onclick="viewProfileByUserId('${data.userId}')">`;
            html += `<span class="chat-message-name" onclick="viewProfileByUserId('${data.userId}')">${displayName}</span>`;
            html += `<span class="chat-message-level">LVL ${data.level || 1}</span>`;
            html += `<span class="chat-message-time">${time}</span>`;
            html += `</div>`;
            html += `<div class="chat-message-text">${processedText}</div>`;
            
            // Reactions
            html += `<div class="emoji-reactions">`;
            let reactions = data.reactions || {};
            for (let emoji in reactions) {
              let users = reactions[emoji] || [];
              let isActive = users.includes(userId);
              html += `<button class="emoji-btn${isActive ? ' active' : ''}" onclick="toggleReaction('${msg.id}', '${emoji}')">${emoji}<span class="reaction-count">${users.length}</span></button>`;
            }
            html += `<button class="add-reaction-btn" onclick="showEmojiPicker('${msg.id}', this)">+</button>`;
            html += `</div>`;
            
            if (isAdmin || isMine) {
              html += `<button class="chat-message-delete" onclick="deleteMessage('${msg.id}')" style="background:none;border:none;color:var(--danger);cursor:pointer;font-size:11px;margin-top:5px;"> Delete</button>`;
            }
            
            html += `</div>`;
          }

          document.getElementById("chatMessages").innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">No messages yet.</p>';

          let chatDiv = document.getElementById("chatMessages");
          chatDiv.scrollTop = chatDiv.scrollHeight;

          if (!chatOpen && messages.length > lastMessageCount && lastMessageCount > 0) {
            document.getElementById("chatBadge").textContent = messages.length - lastMessageCount;
            document.getElementById("chatBadge").style.display = "block";
            playSound('notification');
          }
          lastMessageCount = messages.length;
        });
    }

    async function viewProfileByUserId(uid) {
      let doc = await db.collection("users").doc(uid).get();
      if (doc.exists) {
        viewProfile(uid);
      }
    }

    // ===== EMOJI REACTIONS =====
    const emojiList = ['', '', '', '', '', '', '', '', '', ''];

    function showEmojiPicker(msgId, btn) {
      document.querySelectorAll('.emoji-picker').forEach(p => p.remove());
      
      let picker = document.createElement('div');
      picker.className = 'emoji-picker show';
      
      emojiList.forEach(emoji => {
        let emojiBtn = document.createElement('button');
        emojiBtn.textContent = emoji;
        emojiBtn.onclick = () => {
          toggleReaction(msgId, emoji);
          picker.remove();
        };
        picker.appendChild(emojiBtn);
      });
      
      btn.parentElement.appendChild(picker);
      
      setTimeout(() => {
        document.addEventListener('click', function closePicker(e) {
          if (!picker.contains(e.target) && e.target !== btn) {
            picker.remove();
            document.removeEventListener('click', closePicker);
          }
        });
      }, 100);
    }

    async function toggleReaction(msgId, emoji) {
      let msgRef = db.collection("chat").doc(msgId);
      let doc = await msgRef.get();
      if (!doc.exists) return;
      
      let reactions = doc.data().reactions || {};
      if (!reactions[emoji]) reactions[emoji] = [];
      
      let idx = reactions[emoji].indexOf(userId);
      if (idx === -1) {
        reactions[emoji].push(userId);
      } else {
        reactions[emoji].splice(idx, 1);
        if (reactions[emoji].length === 0) delete reactions[emoji];
      }
      
      await msgRef.update({ reactions });
      playSound('click');
    }

    async function deleteMessage(messageId) {
      if (confirm("Delete this message?")) {
        await db.collection("chat").doc(messageId).delete();
        playSound('click');
      }
    }

    // ===== DIRECT MESSAGES =====
    async function loadDmList() {
      let dmsSnapshot = await db.collection("dms")
        .where("participants", "array-contains", userId)
        .orderBy("lastMessage", "desc")
        .get();
      
      if (dmsSnapshot.empty) {
        document.getElementById("dmList").innerHTML = '<p style="color:var(--text-muted);text-align:center;">No conversations yet.</p>';
        return;
      }
      
      let html = "";
      for (let doc of dmsSnapshot.docs) {
        let dm = doc.data();
        let otherUserId = dm.participants.find(p => p !== userId);
        let userDoc = await db.collection("users").doc(otherUserId).get();
        
        if (userDoc.exists) {
          let user = userDoc.data();
          let online = isUserOnline(user.lastSeen);
          let statusDot = online ? '<span class="status-dot status-online"></span>' : '<span class="status-dot status-offline"></span>';
          
          html += `<div class="friend-card" onclick="openDmConversation('${doc.id}', '${otherUserId}')">`;
          html += `<img src="${user.pic}">`;
          html += `<div class="friend-card-info">`;
          html += `<div class="friend-card-name">${statusDot}${getDisplayName(user.username)}</div>`;
          html += `<div class="friend-card-status">${(dm.lastMessageText || 'No messages').substring(0, 30)}</div>`;
          html += `</div></div>`;
        }
      }
      
      document.getElementById("dmList").innerHTML = html;
    }

    async function openDmWith(otherUserId) {
      let existing = await db.collection("dms")
        .where("participants", "array-contains", userId)
        .get();
      
      let dmId = null;
      existing.forEach(doc => {
        if (doc.data().participants.includes(otherUserId)) {
          dmId = doc.id;
        }
      });
      
      if (!dmId) {
        let newDm = await db.collection("dms").add({
          participants: [userId, otherUserId],
          lastMessage: Date.now(),
          lastMessageText: ""
        });
        dmId = newDm.id;
      }
      
      openDmConversation(dmId, otherUserId);
      
      document.querySelectorAll('.chat-header-tab')[1].click();
      if (!chatOpen) toggleChat();
    }

    function openDmConversation(dmId, otherUserId) {
      currentDmUserId = otherUserId;
      
      document.querySelectorAll('.dm-panel').forEach(p => p.style.display = 'none');
      document.getElementById('dmConversation').style.display = 'flex';
      
      db.collection("dms").doc(dmId).collection("messages")
        .orderBy("timestamp", "asc")
        .onSnapshot(async snapshot => {
          let html = "";
          
          for (let doc of snapshot.docs) {
            let msg = doc.data();
            let isMine = msg.senderId === userId;
            let time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let senderDoc = await db.collection("users").doc(msg.senderId).get();
            let senderPic = senderDoc.exists ? senderDoc.data().pic : '';
            let senderName = senderDoc.exists ? getDisplayName(senderDoc.data().username) : 'Unknown';
            
            html += `<div class="chat-message${isMine ? ' mine' : ''}">`;
            html += `<div class="chat-message-header">`;
            html += `<img class="chat-message-pic" src="${senderPic}">`;
            html += `<span class="chat-message-name">${senderName}</span>`;
            html += `<span class="chat-message-time">${time}</span>`;
            html += `</div>`;
            html += `<div class="chat-message-text">${msg.text}</div>`;
            html += `</div>`;
          }
          
          document.getElementById("dmMessages").innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">Start your conversation!</p>';
          document.getElementById("dmMessages").scrollTop = document.getElementById("dmMessages").scrollHeight;
        });
      
      document.getElementById("dmInput").dataset.dmId = dmId;
    }

    function closeDmConversation() {
      document.getElementById('dmConversation').style.display = 'none';
      document.getElementById('dmsPanel').style.display = 'block';
      loadDmList();
    }

    function handleDmKeypress(event) {
      if (event.key === "Enter") sendDm();
    }

    async function sendDm() {
      let input = document.getElementById("dmInput");
      let text = input.value.trim();
      let dmId = input.dataset.dmId;
      
      if (text === "" || !dmId || !myProfile) return;
      
      if (myProfile.muted) {
        showNotification("You are muted.", 'warning');
        return;
      }
      
      await db.collection("dms").doc(dmId).collection("messages").add({
        senderId: userId,
        text: text,
        timestamp: Date.now()
      });
      
      await db.collection("dms").doc(dmId).update({
        lastMessage: Date.now(),
        lastMessageText: text
      });
      
      input.value = "";
      playSound('message');
    }

    // ===== GROUP CHATS =====
    function openGroupModal() {
      document.getElementById("groupModal").classList.add("open");
      loadGroupMembersList();
    }

    function closeGroupModal() {
      document.getElementById("groupModal").classList.remove("open");
    }

    async function loadGroupMembersList() {
      if (!myProfile || !myProfile.friends) return;
      
      let html = "";
      for (let friendId of myProfile.friends) {
        let doc = await db.collection("users").doc(friendId).get();
        if (doc.exists) {
          let friend = doc.data();
          html += `<div class="group-member">`;
          html += `<img src="${friend.pic}">`;
          html += `<span>${getDisplayName(friend.username)}</span>`;
          html += `<input type="checkbox" class="group-member-check" data-user-id="${friendId}">`;
          html += `</div>`;
        }
      }
      
      document.getElementById("groupMembersList").innerHTML = html || '<p style="color:var(--text-muted);">Add friends to create groups!</p>';
    }

    async function createGroup() {
      let groupName = document.getElementById("groupName").value.trim();
      if (!groupName) {
        alert("Enter a group name!");
        return;
      }
      
      let checkboxes = document.querySelectorAll('.group-member-check:checked');
      let members = [userId];
      checkboxes.forEach(cb => members.push(cb.dataset.userId));
      
      if (members.length < 2) {
        alert("Select at least 1 friend!");
        return;
      }
      
      await db.collection("groups").add({
        name: groupName,
        members: members,
        createdBy: userId,
        createdAt: Date.now(),
        lastMessage: Date.now(),
        lastMessageText: ""
      });
      
      closeGroupModal();
      showNotification("Group created!", 'success');
      loadGroupsList();
    }

    async function loadGroupsList() {
      let groupsSnapshot = await db.collection("groups")
        .where("members", "array-contains", userId)
        .orderBy("lastMessage", "desc")
        .get();
      
      if (groupsSnapshot.empty) {
        document.getElementById("groupsList").innerHTML = '<p style="color:var(--text-muted);text-align:center;">No groups yet.</p>';
        return;
      }
      
      let html = "";
      for (let doc of groupsSnapshot.docs) {
        let group = doc.data();
        html += `<div class="friend-card" onclick="openGroupConversation('${doc.id}')">`;
        html += `<div style="width:40px;height:40px;background:var(--accent);border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:20px;"></div>`;
        html += `<div class="friend-card-info">`;
        html += `<div class="friend-card-name">${group.name}</div>`;
        html += `<div class="friend-card-status">${group.members.length} members</div>`;
        html += `</div></div>`;
      }
      
      document.getElementById("groupsList").innerHTML = html;
    }

    function openGroupConversation(groupId) {
      currentGroupId = groupId;
      
      document.querySelectorAll('.dm-panel').forEach(p => p.style.display = 'none');
      document.getElementById('groupConversation').style.display = 'flex';
      
      db.collection("groups").doc(groupId).collection("messages")
        .orderBy("timestamp", "asc")
        .limit(50)
        .onSnapshot(async snapshot => {
          let html = "";
          
          for (let doc of snapshot.docs) {
            let msg = doc.data();
            let isMine = msg.senderId === userId;
            let time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            
            let senderDoc = await db.collection("users").doc(msg.senderId).get();
            let senderPic = senderDoc.exists ? senderDoc.data().pic : '';
            let senderName = senderDoc.exists ? getDisplayName(senderDoc.data().username) : 'Unknown';
            
            html += `<div class="chat-message${isMine ? ' mine' : ''}">`;
            html += `<div class="chat-message-header">`;
            html += `<img class="chat-message-pic" src="${senderPic}">`;
            html += `<span class="chat-message-name">${senderName}</span>`;
            html += `<span class="chat-message-time">${time}</span>`;
            html += `</div>`;
            html += `<div class="chat-message-text">${msg.text}</div>`;
            html += `</div>`;
          }
          
          document.getElementById("groupMessages").innerHTML = html || '<p style="color:var(--text-muted);text-align:center;">Start chatting!</p>';
          document.getElementById("groupMessages").scrollTop = document.getElementById("groupMessages").scrollHeight;
        });
      
      document.getElementById("groupInput").dataset.groupId = groupId;
    }

    function closeGroupConversation() {
      document.getElementById('groupConversation').style.display = 'none';
      document.getElementById('groupsPanel').style.display = 'block';
      loadGroupsList();
    }

    function handleGroupKeypress(event) {
      if (event.key === "Enter") sendGroupMessage();
    }

    async function sendGroupMessage() {
      let input = document.getElementById("groupInput");
      let text = input.value.trim();
      let groupId = input.dataset.groupId;
      
      if (text === "" || !groupId || !myProfile) return;
      
      if (myProfile.muted) {
        showNotification("You are muted.", 'warning');
        return;
      }
      
      await db.collection("groups").doc(groupId).collection("messages").add({
        senderId: userId,
        text: text,
        timestamp: Date.now()
      });
      
      await db.collection("groups").doc(groupId).update({
        lastMessage: Date.now(),
        lastMessageText: text
      });
      
      input.value = "";
      playSound('message');
    }

    // ===== TRADING SYSTEM =====
    let tradePartner = null;
    let tradeMyItems = [];
    let tradeTheirItems = [];

    async function openTrade() {
      if (!myProfile || !myProfile.friends || myProfile.friends.length === 0) {
        alert("Add friends to trade with!");
        return;
      }
      
      let friendId = prompt("Enter friend's user ID to trade with (check their profile):");
      if (!friendId) return;
      
      tradePartner = friendId;
      tradeMyItems = [];
      tradeTheirItems = [];
      
      document.getElementById("tradeModal").classList.add("open");
      loadTradeItems();
    }

    function closeTrade() {
      document.getElementById("tradeModal").classList.remove("open");
      tradePartner = null;
      tradeMyItems = [];
      tradeTheirItems = [];
    }

    async function loadTradeItems() {
      let myItemsHtml = "";
      (myProfile.inventory || []).forEach((item, idx) => {
        let selected = tradeMyItems.includes(idx) ? 'selected' : '';
        myItemsHtml += `<div class="trade-item ${selected}" onclick="toggleTradeItem(${idx}, true)">`;
        myItemsHtml += `<div style="font-size:30px;">${shopItems.find(i => i.id === item)?.icon || ''}</div>`;
        myItemsHtml += `<div style="font-size:10px;">${shopItems.find(i => i.id === item)?.name || 'Item'}</div>`;
        myItemsHtml += `</div>`;
      });
      
      document.getElementById("tradeYourItems").innerHTML = myItemsHtml || '<p style="color:var(--text-muted);font-size:12px;">No items</p>';
      
      // Load partner's items (simplified - in real app you'd fetch from their profile)
      document.getElementById("tradeTheirItems").innerHTML = '<p style="color:var(--text-muted);font-size:12px;">Partner items...</p>';
    }

    function toggleTradeItem(idx, isMine) {
      if (isMine) {
        let pos = tradeMyItems.indexOf(idx);
        if (pos === -1) {
          tradeMyItems.push(idx);
        } else {
          tradeMyItems.splice(pos, 1);
        }
        loadTradeItems();
      }
    }

    async function confirmTrade() {
      if (tradeMyItems.length === 0) {
        alert("Select items to trade!");
        return;
      }
      
      // Simple gift system - remove items from your inventory
      tradeMyItems.sort((a, b) => b - a); // Reverse to remove from end first
      tradeMyItems.forEach(idx => {
        myProfile.inventory.splice(idx, 1);
      });
      
      await db.collection("users").doc(userId).update({ inventory: myProfile.inventory });
      updateInventory();
      closeTrade();
      showNotification("Items gifted!", 'success');
    }

        // ===== MINI-GAMES DATA =====
    const miniGamesData = [
      { id: 'snake', name: 'Snake', icon: '', desc: 'Classic snake game!' },
      { id: 'minesweeper', name: 'Minesweeper', icon: '', desc: 'Find all mines!' },
      { id: 'tetris', name: 'Tetris', icon: '', desc: 'Stack the blocks!' },
      { id: 'pong', name: 'Pong', icon: '', desc: 'Classic ping pong!' },
      { id: 'breakout', name: 'Breakout', icon: '', desc: 'Break all bricks!' },
      { id: 'flappy', name: 'Flappy Bird', icon: '', desc: 'Fly through pipes!' },
      { id: 'memory', name: 'Memory Match', icon: '', desc: 'Match the cards!' },
      { id: 'tictactoe', name: 'Tic Tac Toe', icon: '', desc: 'X vs O!' },
      { id: 'clicker', name: 'Cookie Clicker', icon: '', desc: 'Click for cookies!' },
      { id: '2048', name: '2048', icon: '', desc: 'Merge to 2048!' }
    ];

    function renderMiniGames() {
      let html = "";
      miniGamesData.forEach(game => {
        html += `<div class="minigame-card" onclick="openMiniGame('${game.id}')">`;
        html += `<div class="minigame-icon">${game.icon}</div>`;
        html += `<div class="minigame-name">${game.name}</div>`;
        html += `<div class="minigame-desc">${game.desc}</div>`;
        html += `</div>`;
      });
      document.getElementById("minigamesGrid").innerHTML = html;
    }

    function openMiniGame(gameId) {
      document.getElementById("minigameModal").classList.add("open");
      
      let content = document.getElementById("minigameContent");
      
      switch(gameId) {
        case 'snake':
          initSnakeGame(content);
          break;
        case 'minesweeper':
          initMinesweeperGame(content);
          break;
        case 'tetris':
          initTetrisGame(content);
          break;
        case 'pong':
          initPongGame(content);
          break;
        case 'breakout':
          initBreakoutGame(content);
          break;
        case 'flappy':
          initFlappyGame(content);
          break;
        case 'memory':
          initMemoryGame(content);
          break;
        case 'tictactoe':
          initTicTacToeGame(content);
          break;
        case 'clicker':
          initClickerGame(content);
          break;
        case '2048':
          init2048Game(content);
          break;
        default:
          content.innerHTML = '<p>Game not found!</p>';
      }
      
      playSound('click');
    }

    function closeMiniGame() {
      document.getElementById("minigameModal").classList.remove("open");
      document.getElementById("minigameContent").innerHTML = "";
      
      // Clear any game intervals
      if (window.gameInterval) {
        clearInterval(window.gameInterval);
        window.gameInterval = null;
      }
    }

    // ===== SNAKE GAME =====
    function initSnakeGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Snake</h2>
        <div class="minigame-score">Score: <span id="snakeScore">0</span></div>
        <canvas id="snakeCanvas" class="minigame-canvas" width="400" height="400"></canvas>
        <div class="minigame-controls">
          <p>Use Arrow Keys or WASD to move</p>
          <button class="sidebar-btn sidebar-btn-green" onclick="startSnake()">Start</button>
        </div>
      `;
    }

    function startSnake() {
      let canvas = document.getElementById("snakeCanvas");
      let ctx = canvas.getContext("2d");
      let gridSize = 20;
      let snake = [{ x: 10, y: 10 }];
      let food = { x: 15, y: 15 };
      let direction = { x: 0, y: 0 };
      let score = 0;
      let gameRunning = true;

      function draw() {
        // Background
        ctx.fillStyle = "#1a1a1a";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Grid
        ctx.strokeStyle = "#2a2a2a";
        for (let i = 0; i < canvas.width; i += gridSize) {
          ctx.beginPath();
          ctx.moveTo(i, 0);
          ctx.lineTo(i, canvas.height);
          ctx.stroke();
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(canvas.width, i);
          ctx.stroke();
        }
        
        // Food
        ctx.fillStyle = "#ff0000";
        ctx.beginPath();
        ctx.arc(food.x * gridSize + gridSize/2, food.y * gridSize + gridSize/2, gridSize/2 - 2, 0, Math.PI * 2);
        ctx.fill();
        
        // Snake
        snake.forEach((segment, i) => {
          ctx.fillStyle = i === 0 ? "#00ff00" : "#00cc00";
          ctx.fillRect(segment.x * gridSize + 1, segment.y * gridSize + 1, gridSize - 2, gridSize - 2);
        });
      }

      function update() {
        if (!gameRunning) return;
        
        let head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };
        
        // Wall collision
        if (head.x < 0 || head.x >= 20 || head.y < 0 || head.y >= 20) {
          gameOver();
          return;
        }
        
        // Self collision
        for (let segment of snake) {
          if (head.x === segment.x && head.y === segment.y) {
            gameOver();
            return;
          }
        }
        
        snake.unshift(head);
        
        // Eat food
        if (head.x === food.x && head.y === food.y) {
          score += 10;
          document.getElementById("snakeScore").textContent = score;
          food = {
            x: Math.floor(Math.random() * 20),
            y: Math.floor(Math.random() * 20)
          };
          playSound('click');
        } else {
          snake.pop();
        }
        
        draw();
      }

      function gameOver() {
        gameRunning = false;
        clearInterval(window.gameInterval);
        
        ctx.fillStyle = "rgba(0,0,0,0.7)";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#ff0000";
        ctx.font = "30px Poppins";
        ctx.textAlign = "center";
        ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2 - 20);
        ctx.fillStyle = "#ffffff";
        ctx.font = "20px Poppins";
        ctx.fillText("Score: " + score, canvas.width/2, canvas.height/2 + 20);
        
        // Award coins based on score
        let coins = Math.floor(score / 5);
        if (coins > 0) {
          addCoins(coins, "Snake - Score: " + score);
          addXP(Math.floor(score / 2), "Snake");
        }
      }

      document.onkeydown = function(e) {
        switch(e.key) {
          case 'ArrowUp': case 'w': case 'W':
            if (direction.y !== 1) { direction = { x: 0, y: -1 }; }
            break;
          case 'ArrowDown': case 's': case 'S':
            if (direction.y !== -1) { direction = { x: 0, y: 1 }; }
            break;
          case 'ArrowLeft': case 'a': case 'A':
            if (direction.x !== 1) { direction = { x: -1, y: 0 }; }
            break;
          case 'ArrowRight': case 'd': case 'D':
            if (direction.x !== -1) { direction = { x: 1, y: 0 }; }
            break;
        }
      };

      direction = { x: 1, y: 0 };
      window.gameInterval = setInterval(update, 100);
      draw();
    }

    // ===== MINESWEEPER GAME =====
    function initMinesweeperGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Minesweeper</h2>
        <div class="minigame-score">Mines: <span id="mineCount">10</span> | Flags: <span id="flagCount">0</span></div>
        <div id="mineGrid" style="display: grid; grid-template-columns: repeat(10, 35px); gap: 2px; justify-content: center; margin: 20px 0;"></div>
        <div class="minigame-controls">
          <p>Left click to reveal, Right click to flag</p>
          <button class="sidebar-btn sidebar-btn-green" onclick="startMinesweeper()">New Game</button>
        </div>
      `;
      startMinesweeper();
    }

    function startMinesweeper() {
      let gridSize = 10;
      let mineCount = 10;
      let grid = [];
      let revealed = [];
      let flagged = [];
      let gameOver = false;
      let firstClick = true;

      // Initialize grid
      for (let i = 0; i < gridSize; i++) {
        grid[i] = [];
        revealed[i] = [];
        flagged[i] = [];
        for (let j = 0; j < gridSize; j++) {
          grid[i][j] = 0;
          revealed[i][j] = false;
          flagged[i][j] = false;
        }
      }

      function placeMines(avoidX, avoidY) {
        let placed = 0;
        while (placed < mineCount) {
          let x = Math.floor(Math.random() * gridSize);
          let y = Math.floor(Math.random() * gridSize);
          
          if (grid[x][y] !== -1 && !(Math.abs(x - avoidX) <= 1 && Math.abs(y - avoidY) <= 1)) {
            grid[x][y] = -1;
            placed++;
          }
        }
        
        // Calculate numbers
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            if (grid[i][j] !== -1) {
              let count = 0;
              for (let di = -1; di <= 1; di++) {
                for (let dj = -1; dj <= 1; dj++) {
                  let ni = i + di;
                  let nj = j + dj;
                  if (ni >= 0 && ni < gridSize && nj >= 0 && nj < gridSize && grid[ni][nj] === -1) {
                    count++;
                  }
                }
              }
              grid[i][j] = count;
            }
          }
        }
      }

      function reveal(x, y) {
        if (x < 0 || x >= gridSize || y < 0 || y >= gridSize) return;
        if (revealed[x][y] || flagged[x][y]) return;
        
        revealed[x][y] = true;
        
        if (grid[x][y] === 0) {
          for (let di = -1; di <= 1; di++) {
            for (let dj = -1; dj <= 1; dj++) {
              reveal(x + di, y + dj);
            }
          }
        }
      }

      function render() {
        let container = document.getElementById("mineGrid");
        container.innerHTML = "";
        
        let flags = 0;
        let unrevealedSafe = 0;
        
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            let cell = document.createElement("div");
            cell.style.cssText = `
              width: 35px;
              height: 35px;
              background: ${revealed[i][j] ? 'var(--bg-tertiary)' : 'var(--bg-secondary)'};
              border: 2px solid var(--bg-primary);
              border-radius: 5px;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-weight: bold;
              font-size: 16px;
            `;
            
            if (flagged[i][j]) {
              cell.textContent = "";
              flags++;
            } else if (revealed[i][j]) {
              if (grid[i][j] === -1) {
                cell.textContent = "";
                cell.style.background = "#cc0000";
              } else if (grid[i][j] > 0) {
                cell.textContent = grid[i][j];
                let colors = ['', '#0000ff', '#008000', '#ff0000', '#000080', '#800000', '#008080', '#000000', '#808080'];
                cell.style.color = colors[grid[i][j]];
              }
            } else {
              unrevealedSafe++;
            }
            
            let x = i, y = j;
            cell.onclick = function(e) {
              if (gameOver || flagged[x][y]) return;
              
              if (firstClick) {
                placeMines(x, y);
                firstClick = false;
              }
              
              if (grid[x][y] === -1) {
                // Game over - reveal all
                for (let a = 0; a < gridSize; a++) {
                  for (let b = 0; b < gridSize; b++) {
                    revealed[a][b] = true;
                  }
                }
                gameOver = true;
                render();
                showNotification(" BOOM! Game Over!", 'warning');
              } else {
                reveal(x, y);
                render();
                checkWin();
              }
            };
            
            cell.oncontextmenu = function(e) {
              e.preventDefault();
              if (gameOver || revealed[x][y]) return;
              flagged[x][y] = !flagged[x][y];
              render();
            };
            
            container.appendChild(cell);
          }
        }
        
        document.getElementById("flagCount").textContent = flags;
        
        // Check win (all non-mine cells revealed)
        if (!firstClick && unrevealedSafe === mineCount && !gameOver) {
          checkWin();
        }
      }

      function checkWin() {
        let unrevealed = 0;
        for (let i = 0; i < gridSize; i++) {
          for (let j = 0; j < gridSize; j++) {
            if (!revealed[i][j] && grid[i][j] !== -1) unrevealed++;
          }
        }
        
        if (unrevealed === 0) {
          gameOver = true;
          showNotification(" You Win!", 'success');
          addCoins(50, "Minesweeper Win");
          addXP(30, "Minesweeper");
        }
      }

      render();
    }

    // ===== MEMORY MATCH GAME =====
    function initMemoryGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Memory Match</h2>
        <div class="minigame-score">Moves: <span id="memoryMoves">0</span> | Pairs: <span id="memoryPairs">0</span>/8</div>
        <div id="memoryGrid" style="display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; justify-content: center; margin: 20px 0;"></div>
        <button class="sidebar-btn sidebar-btn-green" onclick="startMemoryGame()">New Game</button>
      `;
      startMemoryGame();
    }

    function startMemoryGame() {
      let emojis = ['', '', '', '', '', '', '', ''];
      let cards = [...emojis, ...emojis];
      let shuffled = cards.sort(() => Math.random() - 0.5);
      
      let flipped = [];
      let matched = [];
      let moves = 0;
      let pairs = 0;
      let canClick = true;

      function render() {
        let container = document.getElementById("memoryGrid");
        container.innerHTML = "";
        
        shuffled.forEach((emoji, idx) => {
          let card = document.createElement("div");
          card.style.cssText = `
            width: 80px;
            height: 80px;
            background: ${matched.includes(idx) ? 'var(--success)' : flipped.includes(idx) ? 'var(--accent)' : 'var(--bg-tertiary)'};
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 35px;
            cursor: pointer;
            transition: 0.3s;
          `;
          
          if (flipped.includes(idx) || matched.includes(idx)) {
            card.textContent = emoji;
          } else {
            card.textContent = "";
          }
          
          card.onclick = function() {
            if (!canClick || flipped.includes(idx) || matched.includes(idx)) return;
            
            flipped.push(idx);
            playSound('click');
            render();
            
            if (flipped.length === 2) {
              moves++;
              document.getElementById("memoryMoves").textContent = moves;
              canClick = false;
              
              setTimeout(() => {
                if (shuffled[flipped[0]] === shuffled[flipped[1]]) {
                  matched.push(flipped[0], flipped[1]);
                  pairs++;
                  document.getElementById("memoryPairs").textContent = pairs;
                  
                  if (pairs === 8) {
                    showNotification(" You Win in " + moves + " moves!", 'success');
                    let bonus = Math.max(100 - moves * 2, 20);
                    addCoins(bonus, "Memory Match Win");
                    addXP(20, "Memory Match");
                  }
                }
                
                flipped = [];
                canClick = true;
                render();
              }, 1000);
            }
          };
          
          container.appendChild(card);
        });
      }

      render();
    }

    // ===== TIC TAC TOE =====
    function initTicTacToeGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Tic Tac Toe</h2>
        <div class="minigame-score" id="tttStatus">Your turn (X)</div>
        <div id="tttGrid" style="display: grid; grid-template-columns: repeat(3, 100px); gap: 10px; justify-content: center; margin: 20px 0;"></div>
        <button class="sidebar-btn sidebar-btn-green" onclick="startTicTacToe()">New Game</button>
      `;
      startTicTacToe();
    }

    function startTicTacToe() {
      let board = ['', '', '', '', '', '', '', '', ''];
      let currentPlayer = 'X';
      let gameActive = true;

      const winPatterns = [
        [0, 1, 2], [3, 4, 5], [6, 7, 8],
        [0, 3, 6], [1, 4, 7], [2, 5, 8],
        [0, 4, 8], [2, 4, 6]
      ];

      function checkWin(player) {
        return winPatterns.some(pattern => 
          pattern.every(idx => board[idx] === player)
        );
      }

      function aiMove() {
        // Simple AI - random empty cell
        let emptyCells = board.map((c, i) => c === '' ? i : -1).filter(i => i !== -1);
        if (emptyCells.length === 0) return;
        
        let move = emptyCells[Math.floor(Math.random() * emptyCells.length)];
        board[move] = 'O';
        
        if (checkWin('O')) {
          gameActive = false;
          document.getElementById("tttStatus").textContent = "AI Wins! ";
        } else if (!board.includes('')) {
          gameActive = false;
          document.getElementById("tttStatus").textContent = "Draw!";
          addCoins(5, "Tic Tac Toe Draw");
        } else {
          currentPlayer = 'X';
          document.getElementById("tttStatus").textContent = "Your turn (X)";
        }
        
        render();
      }

      function render() {
        let container = document.getElementById("tttGrid");
        container.innerHTML = "";
        
        board.forEach((cell, idx) => {
          let div = document.createElement("div");
          div.style.cssText = `
            width: 100px;
            height: 100px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 50px;
            cursor: pointer;
            color: ${cell === 'X' ? 'var(--accent)' : 'var(--info)'};
          `;
          div.textContent = cell;
          
          div.onclick = function() {
            if (!gameActive || board[idx] !== '' || currentPlayer !== 'X') return;
            
            board[idx] = 'X';
            playSound('click');
            
            if (checkWin('X')) {
              gameActive = false;
              document.getElementById("tttStatus").textContent = "You Win! ";
              addCoins(20, "Tic Tac Toe Win");
              addXP(10, "Tic Tac Toe");
              render();
              return;
            }
            
            if (!board.includes('')) {
              gameActive = false;
              document.getElementById("tttStatus").textContent = "Draw!";
              addCoins(5, "Tic Tac Toe Draw");
              render();
              return;
            }
            
            currentPlayer = 'O';
            document.getElementById("tttStatus").textContent = "AI thinking...";
            render();
            
            setTimeout(aiMove, 500);
          };
          
          container.appendChild(div);
        });
      }

      render();
    }

    // ===== COOKIE CLICKER =====
    function initClickerGame(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> Cookie Clicker</h2>
        <div class="minigame-score">Cookies: <span id="cookieCount">0</span></div>
        <div id="bigCookie" style="font-size: 150px; text-align: center; cursor: pointer; transition: 0.1s; user-select: none;"></div>
        <div style="text-align: center; margin-top: 20px;">
          <p style="color: var(--text-secondary);">CPS: <span id="cookieCps">0</span></p>
          <button class="sidebar-btn sidebar-btn-orange" id="buyAutoClicker" onclick="buyAutoClicker()">Buy Auto-Clicker (10 )</button>
        </div>
        <p style="color: var(--text-muted); font-size: 12px; text-align: center; margin-top: 15px;">Get 100 cookies to earn coins!</p>
      `;
      
      let cookies = 0;
      let cps = 0;
      let autoClickerCost = 10;

      let cookie = document.getElementById("bigCookie");
      cookie.onclick = function() {
        cookies++;
        document.getElementById("cookieCount").textContent = cookies;
        
        cookie.style.transform = "scale(0.9)";
        setTimeout(() => cookie.style.transform = "scale(1)", 100);
        
        // Spawn floating +1
        let float = document.createElement("div");
        float.textContent = "+1";
        float.style.cssText = `
          position: fixed;
          color: var(--accent);
          font-weight: bold;
          pointer-events: none;
          animation: floatUp 1s forwards;
          z-index: 1000;
          left: ${event.clientX}px;
          top: ${event.clientY}px;
        `;
        document.body.appendChild(float);
        setTimeout(() => float.remove(), 1000);
      };

      window.buyAutoClicker = function() {
        if (cookies >= autoClickerCost) {
          cookies -= autoClickerCost;
          cps++;
          autoClickerCost = Math.floor(autoClickerCost * 1.5);
          document.getElementById("cookieCount").textContent = cookies;
          document.getElementById("cookieCps").textContent = cps;
          document.getElementById("buyAutoClicker").textContent = `Buy Auto-Clicker (${autoClickerCost} )`;
          playSound('click');
        }
      };

      // Auto clicker interval
      window.gameInterval = setInterval(() => {
        if (cps > 0) {
          cookies += cps;
          document.getElementById("cookieCount").textContent = cookies;
        }
        
        // Check for rewards
        if (cookies >= 100 && cookies % 100 < cps + 1) {
          addCoins(5, "Cookie Clicker - 100 cookies");
        }
      }, 1000);
    }

    // ===== 2048 GAME =====
    function init2048Game(container) {
      container.innerHTML = `
        <h2 style="color: var(--accent); text-align: center;"> 2048</h2>
        <div class="minigame-score">Score: <span id="score2048">0</span></div>
        <div id="grid2048" style="display: grid; grid-template-columns: repeat(4, 80px); gap: 10px; justify-content: center; margin: 20px 0; background: var(--bg-primary); padding: 15px; border-radius: 10px;"></div>
        <div class="minigame-controls">
          <p>Use Arrow Keys to move</p>
          <button class="sidebar-btn sidebar-btn-green" onclick="start2048()">New Game</button>
        </div>
      `;
      start2048();
    }

    function start2048() {
      let grid = [[0,0,0,0],[0,0,0,0],[0,0,0,0],[0,0,0,0]];
      let score = 0;

      function addRandom() {
        let empty = [];
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            if (grid[i][j] === 0) empty.push({i, j});
          }
        }
        if (empty.length === 0) return false;
        
        let {i, j} = empty[Math.floor(Math.random() * empty.length)];
        grid[i][j] = Math.random() < 0.9 ? 2 : 4;
        return true;
      }

      function getColor(val) {
        const colors = {
          0: '#3a3a3a', 2: '#eee4da', 4: '#ede0c8', 8: '#f2b179',
          16: '#f59563', 32: '#f67c5f', 64: '#f65e3b', 128: '#edcf72',
          256: '#edcc61', 512: '#edc850', 1024: '#edc53f', 2048: '#edc22e'
        };
        return colors[val] || '#3c3a32';
      }

      function getTextColor(val) {
        return val <= 4 ? '#776e65' : '#f9f6f2';
      }

      function render() {
        let container = document.getElementById("grid2048");
        container.innerHTML = "";
        
        for (let i = 0; i < 4; i++) {
          for (let j = 0; j < 4; j++) {
            let cell = document.createElement("div");
            cell.style.cssText = `
              width: 80px;
              height: 80px;
              background: ${getColor(grid[i][j])};
              border-radius: 8px;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: ${grid[i][j] >= 1000 ? '20px' : '28px'};
              font-weight: bold;
              color: ${getTextColor(grid[i][j])};
            `;
            cell.textContent = grid[i][j] || '';
            container.appendChild(cell);
          }
        }
        
        document.getElementById("score2048").textContent = score;
      }

      function slide(row) {
        let arr = row.filter(x => x !== 0);
        for (let i = 0; i < arr.length - 1; i++) {
          if (arr[i] === arr[i + 1]) {
            arr[i] *= 2;
            score += arr[i];
            arr.splice(i + 1, 1);
          }
        }
        while (arr.length < 4) arr.push(0);
        return arr;
      }

      function move(dir) {
        let oldGrid = JSON.stringify(grid);
        
        if (dir === 'left') {
          for (let i = 0; i < 4; i++) grid[i] = slide(grid[i]);
        } else if (dir === 'right') {
          for (let i = 0; i < 4; i++) grid[i] = slide(grid[i].reverse()).reverse();
        } else if (dir === 'up') {
          for (let j = 0; j < 4; j++) {
            let col = [grid[0][j], grid[1][j], grid[2][j], grid[3][j]];
            col = slide(col);
            for (let i = 0; i < 4; i++) grid[i][j] = col[i];
          }
        } else if (dir === 'down') {
          for (let j = 0; j < 4; j++) {
            let col = [grid[0][j], grid[1][j], grid[2][j], grid[3][j]].reverse();
            col = slide(col).reverse();
            for (let i = 0; i < 4; i++) grid[i][j] = col[i];
          }
        }
        
        if (JSON.stringify(grid) !== oldGrid) {
          addRandom();
          render();
          playSound('click');
          
          // Check for 2048
          for (let i = 0; i < 4; i++) {
            for (let j = 0; j < 4; j++) {
              if (grid[i][j] === 2048) {
                showNotification(" You reached 2048!", 'success');
                addCoins(100, "2048 Win");
                addXP(50, "2048");
              }
            }
          }
        }
      }

      document.onkeydown = function(e) {
        if (e.key === 'ArrowLeft') move('left');
        else if (e.key === 'ArrowRight') move('right');
        else if (e.key === 'ArrowUp') move('up');
        else if (e.key === 'ArrowDown') move('down');
      };

      addRandom();
      addRandom();
      render();
    }

    // ===== SIMPLE VERSIONS OF OTHER GAMES =====
   function initTetrisGame(container) {
  container.innerHTML = `
    <h2 style="color: var(--accent); text-align: center;"> Tetris</h2>
    <div style="display: flex; justify-content: center; gap: 20px; flex-wrap: wrap;">
      <div>
        <canvas id="tetrisCanvas" class="minigame-canvas" width="300" height="600" style="border: 3px solid var(--accent);"></canvas>
      </div>
      <div style="text-align: center;">
        <div class="minigame-score" style="margin-bottom: 20px;">
          <div>Score: <span id="tetrisScore">0</span></div>
          <div>Lines: <span id="tetrisLines">0</span></div>
          <div>Level: <span id="tetrisLevel">1</span></div>
        </div>
        <div style="background: var(--bg-tertiary); padding: 15px; border-radius: 10px; margin-bottom: 15px;">
          <div style="color: var(--text-secondary); font-size: 12px; margin-bottom: 8px;">Next Piece:</div>
          <canvas id="tetrisNextCanvas" width="120" height="120" style="background: var(--bg-secondary); border-radius: 5px;"></canvas>
        </div>
        <div class="minigame-controls">
          <p style="font-size: 12px; color: var(--text-secondary);">
             Move<br>
             Drop<br>
             Rotate<br>
            SPACE Hard Drop
          </p>
          <button class="sidebar-btn sidebar-btn-green" onclick="startTetris()" id="tetrisStartBtn">Start Game</button>
        </div>
      </div>
    </div>
  `;
  
  let canvas = document.getElementById("tetrisCanvas");
  let ctx = canvas.getContext("2d");
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
}

function startTetris() {
  let canvas = document.getElementById("tetrisCanvas");
  let ctx = canvas.getContext("2d");
  let nextCanvas = document.getElementById("tetrisNextCanvas");
  let nextCtx = nextCanvas.getContext("2d");
  
  const COLS = 10;
  const ROWS = 20;
  const BLOCK_SIZE = 30;
  
  let board = Array.from({ length: ROWS }, () => Array(COLS).fill(0));
  let score = 0;
  let lines = 0;
  let level = 1;
  let gameRunning = true;
  let dropCounter = 0;
  let dropInterval = 1000;
  let lastTime = 0;
  
  // Tetromino shapes
  const SHAPES = {
    I: [[1,1,1,1]],
    J: [[1,0,0],[1,1,1]],
    L: [[0,0,1],[1,1,1]],
    O: [[1,1],[1,1]],
    S: [[0,1,1],[1,1,0]],
    T: [[0,1,0],[1,1,1]],
    Z: [[1,1,0],[0,1,1]]
  };
  
  const COLORS = {
    I: '#00f0f0',
    J: '#0000f0',
    L: '#f0a000',
    O: '#f0f000',
    S: '#00f000',
    T: '#a000f0',
    Z: '#f00000',
    0: '#000000'
  };
  
  let currentPiece = null;
  let nextPiece = null;
  
  function createPiece() {
    const pieces = 'IJLOSTZ';
    const type = pieces[Math.floor(Math.random() * pieces.length)];
    return {
      shape: SHAPES[type],
      color: type,
      x: Math.floor(COLS / 2) - Math.floor(SHAPES[type][0].length / 2),
      y: 0
    };
  }
  
  function drawBlock(x, y, color, context = ctx) {
    context.fillStyle = COLORS[color];
    context.fillRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
    context.strokeStyle = '#222';
    context.lineWidth = 2;
    context.strokeRect(x * BLOCK_SIZE, y * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
    
    // Shine effect
    context.fillStyle = 'rgba(255,255,255,0.2)';
    context.fillRect(x * BLOCK_SIZE + 2, y * BLOCK_SIZE + 2, BLOCK_SIZE - 4, BLOCK_SIZE / 3);
  }
  
  function drawBoard() {
    // Background
    ctx.fillStyle = '#000';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Grid
    ctx.strokeStyle = '#111';
    ctx.lineWidth = 1;
    for (let row = 0; row < ROWS; row++) {
      for (let col = 0; col < COLS; col++) {
        ctx.strokeRect(col * BLOCK_SIZE, row * BLOCK_SIZE, BLOCK_SIZE, BLOCK_SIZE);
        
        if (board[row][col]) {
          drawBlock(col, row, board[row][col]);
        }
      }
    }
  }
  
  function drawPiece(piece) {
    piece.shape.forEach((row, y) => {
      row.forEach((value, x) => {
        if (value) {
          drawBlock(piece.x + x, piece.y + y, piece.color);
        }
      });
    });
  }
  
  function drawNextPiece() {
    nextCtx.fillStyle = '#1a1a1a';
    nextCtx.fillRect(0, 0, nextCanvas.width, nextCanvas.height);
    
    if (!nextPiece) return;
    
    const blockSize = 25;
    const offsetX = (nextCanvas.width - nextPiece.shape[0].length * blockSize) / 2;
    const offsetY = (nextCanvas.height - nextPiece.shape.length * blockSize) / 2;
    
    nextPiece.shape.forEach((row, y) => {
      row.forEach((value, x) => {
        if (value) {
          nextCtx.fillStyle = COLORS[nextPiece.color];
          nextCtx.fillRect(
            offsetX + x * blockSize,
            offsetY + y * blockSize,
            blockSize,
            blockSize
          );
          nextCtx.strokeStyle = '#222';
          nextCtx.lineWidth = 2;
          nextCtx.strokeRect(
            offsetX + x * blockSize,
            offsetY + y * blockSize,
            blockSize,
            blockSize
          );
        }
      });
    });
  }
  
  function collide(piece) {
    return piece.shape.some((row, dy) => {
      return row.some((value, dx) => {
        if (value) {
          let newX = piece.x + dx;
          let newY = piece.y + dy;
          return (
            newX < 0 ||
            newX >= COLS ||
            newY >= ROWS ||
            (newY >= 0 && board[newY][newX])
          );
        }
        return false;
      });
    });
  }
  
  function merge(piece) {
    piece.shape.forEach((row, y) => {
      row.forEach((value, x) => {
        if (value) {
          if (piece.y + y >= 0) {
            board[piece.y + y][piece.x + x] = piece.color;
          }
        }
      });
    });
  }
  
  function rotate(piece) {
    let rotated = piece.shape[0].map((_, i) =>
      piece.shape.map(row => row[i]).reverse()
    );
    
    let previousShape = piece.shape;
    piece.shape = rotated;
    
    // Wall kick
    let offset = 0;
    while (collide(piece)) {
      piece.x += offset;
      offset = -(offset + (offset > 0 ? 1 : -1));
      if (offset > piece.shape[0].length) {
        piece.shape = previousShape;
        piece.x -= offset;
        return;
      }
    }
  }
  
  function clearLines() {
    let linesCleared = 0;
    
    outer: for (let row = ROWS - 1; row >= 0; row--) {
      for (let col = 0; col < COLS; col++) {
        if (!board[row][col]) continue outer;
      }
      
      // Line is full
      board.splice(row, 1);
      board.unshift(Array(COLS).fill(0));
      row++;
      linesCleared++;
    }
    
    if (linesCleared > 0) {
      lines += linesCleared;
      
      // Scoring
      const points = [0, 100, 300, 500, 800];
      score += points[linesCleared] * level;
      
      // Level up every 10 lines
      level = Math.floor(lines / 10) + 1;
      dropInterval = Math.max(100, 1000 - (level - 1) * 100);
      
      document.getElementById("tetrisScore").textContent = score;
      document.getElementById("tetrisLines").textContent = lines;
      document.getElementById("tetrisLevel").textContent = level;
      
      playSound('notification');
    }
  }
  
  function drop() {
    currentPiece.y++;
    if (collide(currentPiece)) {
      currentPiece.y--;
      merge(currentPiece);
      clearLines();
      
      // Get next piece
      currentPiece = nextPiece;
      nextPiece = createPiece();
      drawNextPiece();
      
      if (collide(currentPiece)) {
        gameOver();
      }
    }
    dropCounter = 0;
  }
  
  function hardDrop() {
    while (!collide(currentPiece)) {
      currentPiece.y++;
      score += 2;
    }
    currentPiece.y--;
    document.getElementById("tetrisScore").textContent = score;
    drop();
  }
  
  function move(dir) {
    currentPiece.x += dir;
    if (collide(currentPiece)) {
      currentPiece.x -= dir;
    }
  }
  
  function gameOver() {
    gameRunning = false;
    
    ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = '#ff4444';
    ctx.font = 'bold 40px Poppins';
    ctx.textAlign = 'center';
    ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 40);
    
    ctx.fillStyle = 'white';
    ctx.font = '24px Poppins';
    ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height / 2 + 10);
    ctx.fillText(`Lines: ${lines}`, canvas.width / 2, canvas.height / 2 + 45);
    
    ctx.font = '16px Poppins';
    ctx.fillStyle = '#aaa';
    ctx.fillText('Click START to play again', canvas.width / 2, canvas.height / 2 + 90);
    
    // Award coins & XP
    if (score > 0) {
      let coins = Math.floor(score / 10);
      let xp = Math.floor(lines * 5);
      addCoins(coins, `Tetris - ${lines} lines`);
      addXP(xp, "Tetris");
    }
    
    document.getElementById("tetrisStartBtn").textContent = "Play Again";
  }
  
  function update(time = 0) {
    if (!gameRunning) return;
    
    const deltaTime = time - lastTime;
    lastTime = time;
    dropCounter += deltaTime;
    
    if (dropCounter > dropInterval) {
      drop();
    }
    
    drawBoard();
    drawPiece(currentPiece);
    
    window.gameInterval = requestAnimationFrame(update);
  }
  
  // Keyboard controls
  function handleKeyDown(e) {
    if (!gameRunning) return;
    
    if (e.key === 'ArrowLeft') {
      move(-1);
    } else if (e.key === 'ArrowRight') {
      move(1);
    } else if (e.key === 'ArrowDown') {
      drop();
    } else if (e.key === 'ArrowUp') {
      rotate(currentPiece);
    } else if (e.key === ' ') {
      e.preventDefault();
      hardDrop();
    }
  }
  
  window.tetrisKeydown = handleKeyDown;
  document.addEventListener('keydown', handleKeyDown);
  
  // Cleanup on close
  let originalClose = window.closeMiniGame;
  window.closeMiniGame = function() {
    document.removeEventListener('keydown', window.tetrisKeydown);
    if (window.gameInterval) cancelAnimationFrame(window.gameInterval);
    window.closeMiniGame = originalClose;
    originalClose();
  };
  
  // Initialize
  currentPiece = createPiece();
  nextPiece = createPiece();
  drawNextPiece();
  document.getElementById("tetrisStartBtn").textContent = "Pause";
  update();
}
    function initPongGame(container) {
  container.innerHTML = `
    <h2 style="color: var(--accent); text-align: center;"> Pong</h2>
    <div class="minigame-score">
      <span id="pongPlayerScore" style="color: #00ff00; font-size: 24px;">0</span>
      <span style="color: var(--text-muted);"> - </span>
      <span id="pongAiScore" style="color: #ff4444; font-size: 24px;">0</span>
    </div>
    <p style="text-align: center; color: var(--text-secondary); font-size: 12px;">First to 7 wins!</p>
    <canvas id="pongCanvas" class="minigame-canvas" width="600" height="400"></canvas>
    <div class="minigame-controls">
      <p>Use   Arrow Keys or W/S to move</p>
      <button class="sidebar-btn sidebar-btn-green" onclick="startPong()">Start Game</button>
    </div>
  `;
  
  // Draw initial state
  let canvas = document.getElementById("pongCanvas");
  let ctx = canvas.getContext("2d");
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  
  // Draw center line
  ctx.setLineDash([10, 10]);
  ctx.strokeStyle = "#333";
  ctx.lineWidth = 4;
  ctx.beginPath();
  ctx.moveTo(canvas.width / 2, 0);
  ctx.lineTo(canvas.width / 2, canvas.height);
  ctx.stroke();
  ctx.setLineDash([]);
  
  ctx.fillStyle = "white";
  ctx.font = "24px Poppins";
  ctx.textAlign = "center";
  ctx.fillText("Press Start to Play!", canvas.width / 2, canvas.height / 2);
}

function startPong() {
  let canvas = document.getElementById("pongCanvas");
  let ctx = canvas.getContext("2d");
  
  // Game objects
  const paddleWidth = 15;
  const paddleHeight = 100;
  const ballSize = 15;
  
  let player = {
    x: 20,
    y: canvas.height / 2 - paddleHeight / 2,
    width: paddleWidth,
    height: paddleHeight,
    speed: 8,
    score: 0,
    dy: 0
  };
  
  let ai = {
    x: canvas.width - 20 - paddleWidth,
    y: canvas.height / 2 - paddleHeight / 2,
    width: paddleWidth,
    height: paddleHeight,
    speed: 5,
    score: 0
  };
  
  let ball = {
    x: canvas.width / 2,
    y: canvas.height / 2,
    size: ballSize,
    speedX: 6,
    speedY: 4,
    dx: 6,
    dy: 4
  };
  
  let gameRunning = true;
  let winScore = 7;
  let particles = [];
  
  // Particle effect on score
  function createParticles(x, y, color) {
    for (let i = 0; i < 20; i++) {
      particles.push({
        x: x,
        y: y,
        dx: (Math.random() - 0.5) * 10,
        dy: (Math.random() - 0.5) * 10,
        size: Math.random() * 5 + 2,
        color: color,
        life: 1
      });
    }
  }
  
  function updateParticles() {
    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => {
      p.x += p.dx;
      p.y += p.dy;
      p.life -= 0.02;
      p.dx *= 0.98;
      p.dy *= 0.98;
    });
  }
  
  function drawParticles() {
    particles.forEach(p => {
      ctx.globalAlpha = p.life;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
      ctx.fill();
    });
    ctx.globalAlpha = 1;
  }
  
  function drawBackground() {
    // Black background
    ctx.fillStyle = "#000";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Center line
    ctx.setLineDash([15, 15]);
    ctx.strokeStyle = "#333";
    ctx.lineWidth = 4;
    ctx.beginPath();
    ctx.moveTo(canvas.width / 2, 0);
    ctx.lineTo(canvas.width / 2, canvas.height);
    ctx.stroke();
    ctx.setLineDash([]);
    
    // Score
    ctx.font = "bold 60px Poppins";
    ctx.fillStyle = "rgba(255, 255, 255, 0.1)";
    ctx.textAlign = "center";
    ctx.fillText(player.score, canvas.width / 4, 80);
    ctx.fillText(ai.score, canvas.width * 3 / 4, 80);
  }
  
  function drawPaddle(paddle, color) {
    // Glow effect
    ctx.shadowColor = color;
    ctx.shadowBlur = 20;
    
    // Paddle
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.roundRect(paddle.x, paddle.y, paddle.width, paddle.height, 5);
    ctx.fill();
    
    ctx.shadowBlur = 0;
  }
  
  function drawBall() {
    // Trail effect
    ctx.fillStyle = "rgba(255, 255, 255, 0.3)";
    ctx.beginPath();
    ctx.arc(ball.x - ball.dx, ball.y - ball.dy, ball.size * 0.8, 0, Math.PI * 2);
    ctx.fill();
    
    // Glow
    ctx.shadowColor = "#fff";
    ctx.shadowBlur = 15;
    
    // Ball
    ctx.fillStyle = "#fff";
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.size, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.shadowBlur = 0;
  }
  
  function resetBall(scorer) {
    ball.x = canvas.width / 2;
    ball.y = canvas.height / 2;
    ball.dx = scorer === 'player' ? 6 : -6;
    ball.dy = (Math.random() - 0.5) * 8;
    
    // Increase speed slightly each point
    ball.speedX = Math.min(12, 6 + (player.score + ai.score) * 0.3);
  }
  
  function update() {
    if (!gameRunning) return;
    
    // Move player paddle
    player.y += player.dy;
    
    // Keep player in bounds
    player.y = Math.max(0, Math.min(canvas.height - player.height, player.y));
        // AI movement (dumber AI - only reacts when ball is on its side)
    if (ball.dx > 0 && ball.x > canvas.width / 3) {
      // Only track ball when it's coming toward AI and past the first third
      let aiTarget = ball.y - ai.height / 2;
      let aiDiff = aiTarget - ai.y;
      
      // Add some randomness to make AI miss sometimes
      let randomError = (Math.random() - 0.5) * 30;
      aiDiff += randomError;
      
      // Slower base speed
      let aiSpeed = 3.5;
      
      // AI only gets slightly better when losing badly
      if (player.score > ai.score + 2) {
        aiSpeed = 4.5;
      }
      
      if (Math.abs(aiDiff) > aiSpeed) {
        ai.y += aiDiff > 0 ? aiSpeed : -aiSpeed;
      }
    } else {
      // When ball going away, slowly drift toward center
      let centerDiff = (canvas.height / 2 - ai.height / 2) - ai.y;
      if (Math.abs(centerDiff) > 2) {
        ai.y += centerDiff > 0 ? 1.5 : -1.5;
      }
    } 
  
    
    // Keep AI in bounds
    ai.y = Math.max(0, Math.min(canvas.height - ai.height, ai.y));
    
    // Move ball
    ball.x += ball.dx;
    ball.y += ball.dy;
    
    // Ball collision with top/bottom
    if (ball.y - ball.size < 0 || ball.y + ball.size > canvas.height) {
      ball.dy *= -1;
      ball.y = ball.y - ball.size < 0 ? ball.size : canvas.height - ball.size;
      playSound('click');
    }
    
    // Ball collision with player paddle
    if (
      ball.x - ball.size < player.x + player.width &&
      ball.x + ball.size > player.x &&
      ball.y > player.y &&
      ball.y < player.y + player.height
    ) {
      ball.dx = Math.abs(ball.dx) * 1.05;
      ball.dx = Math.min(ball.dx, 15);
      
      // Add spin based on where ball hits paddle
      let hitPos = (ball.y - player.y) / player.height;
      ball.dy = (hitPos - 0.5) * 12;
      
      ball.x = player.x + player.width + ball.size;
      playSound('click');
      createParticles(ball.x, ball.y, "#00ff00");
    }
    
    // Ball collision with AI paddle
    if (
      ball.x + ball.size > ai.x &&
      ball.x - ball.size < ai.x + ai.width &&
      ball.y > ai.y &&
      ball.y < ai.y + ai.height
    ) {
      ball.dx = -Math.abs(ball.dx) * 1.05;
      ball.dx = Math.max(ball.dx, -15);
      
      let hitPos = (ball.y - ai.y) / ai.height;
      ball.dy = (hitPos - 0.5) * 12;
      
      ball.x = ai.x - ball.size;
      playSound('click');
      createParticles(ball.x, ball.y, "#ff4444");
    }
    
    // Score
    if (ball.x < 0) {
      ai.score++;
      document.getElementById("pongAiScore").textContent = ai.score;
      createParticles(50, canvas.height / 2, "#ff4444");
      playSound('notification');
      
      if (ai.score >= winScore) {
        gameOver(false);
      } else {
        resetBall('ai');
      }
    }
    
    if (ball.x > canvas.width) {
      player.score++;
      document.getElementById("pongPlayerScore").textContent = player.score;
      createParticles(canvas.width - 50, canvas.height / 2, "#00ff00");
      playSound('notification');
      
      if (player.score >= winScore) {
        gameOver(true);
      } else {
        resetBall('player');
      }
    }
    
    updateParticles();
  }
  
  function draw() {
    drawBackground();
    drawParticles();
    drawPaddle(player, "#00ff00");
    drawPaddle(ai, "#ff4444");
    drawBall();
  }
  
  function gameLoop() {
    if (!gameRunning) return;
    
    update();
    draw();
    
    window.gameInterval = requestAnimationFrame(gameLoop);
  }
  
  function gameOver(playerWon) {
    gameRunning = false;
    
    ctx.fillStyle = "rgba(0, 0, 0, 0.8)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.textAlign = "center";
    
    if (playerWon) {
      ctx.fillStyle = "#00ff00";
      ctx.font = "bold 50px Poppins";
      ctx.fillText("YOU WIN!", canvas.width / 2, canvas.height / 2 - 30);
      
      let coins = 50 + (7 - ai.score) * 10;
      let xp = 30 + (7 - ai.score) * 5;
      addCoins(coins, "Pong Victory!");
      addXP(xp, "Pong");
      
      createConfetti();
    } else {
      ctx.fillStyle = "#ff4444";
      ctx.font = "bold 50px Poppins";
      ctx.fillText("GAME OVER", canvas.width / 2, canvas.height / 2 - 30);
      
      if (player.score > 0) {
        let coins = player.score * 5;
        let xp = player.score * 3;
        addCoins(coins, `Pong - Scored ${player.score}`);
        addXP(xp, "Pong");
      }
    }
    
    ctx.fillStyle = "white";
    ctx.font = "24px Poppins";
    ctx.fillText(`${player.score} - ${ai.score}`, canvas.width / 2, canvas.height / 2 + 20);
    
    ctx.fillStyle = "#aaa";
    ctx.font = "16px Poppins";
    ctx.fillText("Click START to play again", canvas.width / 2, canvas.height / 2 + 70);
  }
  
  // Keyboard controls
  function handleKeyDown(e) {
    if (e.key === "ArrowUp" || e.key === "w" || e.key === "W") {
      e.preventDefault();
      player.dy = -player.speed;
    } else if (e.key === "ArrowDown" || e.key === "s" || e.key === "S") {
      e.preventDefault();
      player.dy = player.speed;
    }
  }
  
  function handleKeyUp(e) {
    if (
      e.key === "ArrowUp" || e.key === "w" || e.key === "W" ||
      e.key === "ArrowDown" || e.key === "s" || e.key === "S"
    ) {
      player.dy = 0;
    }
  }
  
  window.pongKeydown = handleKeyDown;
  window.pongKeyup = handleKeyUp;
  
  document.addEventListener("keydown", handleKeyDown);
  document.addEventListener("keyup", handleKeyUp);
  
  // Cleanup on close
  let originalClose = window.closeMiniGame;
  window.closeMiniGame = function() {
    document.removeEventListener("keydown", window.pongKeydown);
    document.removeEventListener("keyup", window.pongKeyup);
    if (window.gameInterval) cancelAnimationFrame(window.gameInterval);
    window.closeMiniGame = originalClose;
    originalClose();
  };
  
  // Start the game
  resetBall('player');
  gameLoop();
}

   function initBreakoutGame(container) {
  container.innerHTML = `
    <h2 style="color: var(--accent); text-align: center;"> Breakout</h2>
    <div class="minigame-score">
      Score: <span id="breakoutScore">0</span> | 
      Lives: <span id="breakoutLives">3</span> |
      Level: <span id="breakoutLevel">1</span>
    </div>
    <canvas id="breakoutCanvas" class="minigame-canvas" width="600" height="500"></canvas>
    <div class="minigame-controls">
      <p>Use   Arrow Keys or A/D to move | SPACE to launch</p>
      <button class="sidebar-btn sidebar-btn-green" onclick="startBreakout()" id="breakoutStartBtn">Start Game</button>
    </div>
  `;
  
  // Draw initial state
  let canvas = document.getElementById("breakoutCanvas");
  let ctx = canvas.getContext("2d");
  ctx.fillStyle = "#000";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "white";
  ctx.font = "24px Poppins";
  ctx.textAlign = "center";
  ctx.fillText("Press Start to Play!", canvas.width / 2, canvas.height / 2);
}

function startBreakout() {
  let canvas = document.getElementById("breakoutCanvas");
  let ctx = canvas.getContext("2d");
  
  // Game settings
  const BRICK_ROWS = 5;
  const BRICK_COLS = 10;
  const BRICK_WIDTH = 54;
  const BRICK_HEIGHT = 20;
  const BRICK_PADDING = 4;
  const BRICK_OFFSET_TOP = 50;
  const BRICK_OFFSET_LEFT = 15;
  
  // Colors for each row
  const ROW_COLORS = [
    { fill: '#ff4444', glow: '#ff0000', points: 50 },  // Red - top
    { fill: '#ff8844', glow: '#ff4400', points: 40 },  // Orange
    { fill: '#ffcc00', glow: '#ffaa00', points: 30 },  // Yellow
    { fill: '#44ff44', glow: '#00ff00', points: 20 },  // Green
    { fill: '#4488ff', glow: '#0044ff', points: 10 }   // Blue - bottom
  ];
  
  // Paddle
  let paddle = {
    width: 100,
    height: 15,
    x: 0,
    speed: 8,
    dx: 0
  };
  paddle.x = (canvas.width - paddle.width) / 2;
  
  // Ball
  let ball = {
    x: canvas.width / 2,
    y: canvas.height - 50,
    radius: 8,
    speed: 5,
    dx: 0,
    dy: 0,
    launched: false
  };
  
  // Game state
  let bricks = [];
  let score = 0;
  let lives = 3;
  let level = 1;
  let gameRunning = true;
  let particles = [];
  
  // Initialize bricks
  function createBricks() {
    bricks = [];
    for (let row = 0; row < BRICK_ROWS; row++) {
      for (let col = 0; col < BRICK_COLS; col++) {
        bricks.push({
          x: BRICK_OFFSET_LEFT + col * (BRICK_WIDTH + BRICK_PADDING),
          y: BRICK_OFFSET_TOP + row * (BRICK_HEIGHT + BRICK_PADDING),
          width: BRICK_WIDTH,
          height: BRICK_HEIGHT,
          color: ROW_COLORS[row].fill,
          glow: ROW_COLORS[row].glow,
          points: ROW_COLORS[row].points,
          alive: true,
          hits: row < 2 && level > 1 ? 2 : 1 // Top rows need 2 hits on higher levels
        });
      }
    }
  }
  
  // Particle effects
  function createParticles(x, y, color, count = 10) {
    for (let i = 0; i < count; i++) {
      particles.push({
        x: x,
        y: y,
        dx: (Math.random() - 0.5) * 8,
        dy: (Math.random() - 0.5) * 8,
        radius: Math.random() * 4 + 2,
        color: color,
        life: 1
      });
    }
  }
  
  function updateParticles() {
    particles = particles.filter(p => p.life > 0);
    particles.forEach(p => {
      p.x += p.dx;
      p.y += p.dy;
      p.dy += 0.1; // Gravity
      p.life -= 0.02;
    });
  }
  
  function drawParticles() {
    particles.forEach(p => {
      ctx.globalAlpha = p.life;
      ctx.fillStyle = p.color;
      ctx.beginPath();
      ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
      ctx.fill();
    });
    ctx.globalAlpha = 1;
  }
  
  // Draw functions
  function drawBackground() {
    // Gradient background
    let gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
    gradient.addColorStop(0, '#1a1a2e');
    gradient.addColorStop(1, '#000');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Stars
    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
    for (let i = 0; i < 50; i++) {
      let x = (i * 137) % canvas.width;
      let y = (i * 97) % (canvas.height - 150);
      ctx.beginPath();
      ctx.arc(x, y, Math.random() * 1.5, 0, Math.PI * 2);
      ctx.fill();
    }
  }
  
  function drawPaddle() {
    // Glow
    ctx.shadowColor = '#00ffff';
    ctx.shadowBlur = 20;
    
    // Paddle gradient
    let gradient = ctx.createLinearGradient(paddle.x, 0, paddle.x + paddle.width, 0);
    gradient.addColorStop(0, '#0088ff');
    gradient.addColorStop(0.5, '#00ffff');
    gradient.addColorStop(1, '#0088ff');
    
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.roundRect(paddle.x, canvas.height - 30, paddle.width, paddle.height, 5);
    ctx.fill();
    
    ctx.shadowBlur = 0;
  }
  
  function drawBall() {
    if (!ball.launched) {
      // Ball sits on paddle before launch
      ball.x = paddle.x + paddle.width / 2;
      ball.y = canvas.height - 30 - ball.radius;
    }
    
    // Trail
    if (ball.launched) {
      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.beginPath();
      ctx.arc(ball.x - ball.dx * 0.5, ball.y - ball.dy * 0.5, ball.radius * 0.7, 0, Math.PI * 2);
      ctx.fill();
    }
    
    // Glow
    ctx.shadowColor = '#fff';
    ctx.shadowBlur = 15;
    
    // Ball
    ctx.fillStyle = '#fff';
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ball.radius, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.shadowBlur = 0;
  }
  
  function drawBricks() {
    bricks.forEach(brick => {
      if (!brick.alive) return;
      
      // Glow
      ctx.shadowColor = brick.glow;
      ctx.shadowBlur = 10;
      
      // Brick
      ctx.fillStyle = brick.color;
      ctx.beginPath();
      ctx.roundRect(brick.x, brick.y, brick.width, brick.height, 3);
      ctx.fill();
      
      // Highlight
      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.fillRect(brick.x + 2, brick.y + 2, brick.width - 4, brick.height / 3);
      
      // Show crack if brick has 2 hits (needs another hit)
      if (brick.hits === 1 && level > 1) {
        ctx.strokeStyle = 'rgba(0, 0, 0, 0.5)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(brick.x + brick.width * 0.3, brick.y);
        ctx.lineTo(brick.x + brick.width * 0.5, brick.y + brick.height);
        ctx.stroke();
      }
      
      ctx.shadowBlur = 0;
    });
  }
  
  function drawUI() {
    // Launch hint
    if (!ball.launched) {
      ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
      ctx.font = '16px Poppins';
      ctx.textAlign = 'center';
      ctx.fillText('Press SPACE to launch!', canvas.width / 2, canvas.height - 60);
    }
  }
  
  // Update functions
  function update() {
    if (!gameRunning) return;
    
    // Move paddle
    paddle.x += paddle.dx;
    
    // Keep paddle in bounds
    if (paddle.x < 0) paddle.x = 0;
    if (paddle.x + paddle.width > canvas.width) paddle.x = canvas.width - paddle.width;
    
    // Ball movement
    if (ball.launched) {
      ball.x += ball.dx;
      ball.y += ball.dy;
      
      // Wall collisions
      if (ball.x - ball.radius < 0 || ball.x + ball.radius > canvas.width) {
        ball.dx *= -1;
        ball.x = ball.x - ball.radius < 0 ? ball.radius : canvas.width - ball.radius;
        playSound('click');
      }
      
      // Ceiling collision
      if (ball.y - ball.radius < 0) {
        ball.dy *= -1;
        ball.y = ball.radius;
        playSound('click');
      }
      
      // Paddle collision
      if (
        ball.y + ball.radius > canvas.height - 30 &&
        ball.y - ball.radius < canvas.height - 30 + paddle.height &&
        ball.x > paddle.x &&
        ball.x < paddle.x + paddle.width
      ) {
        // Bounce angle based on where ball hits paddle
        let hitPos = (ball.x - paddle.x) / paddle.width;
        let angle = (hitPos - 0.5) * Math.PI * 0.7; // -70 to +70 degrees
        
        let speed = Math.sqrt(ball.dx * ball.dx + ball.dy * ball.dy);
        speed = Math.min(speed * 1.02, 12); // Slight speed increase, max 12
        
        ball.dx = Math.sin(angle) * speed;
        ball.dy = -Math.cos(angle) * speed;
        
        ball.y = canvas.height - 30 - ball.radius;
        
        playSound('click');
        createParticles(ball.x, ball.y, '#00ffff', 5);
      }
      
      // Ball lost
      if (ball.y > canvas.height) {
        lives--;
        document.getElementById("breakoutLives").textContent = lives;
        
        if (lives <= 0) {
          gameOver(false);
        } else {
          // Reset ball
          ball.launched = false;
          ball.dx = 0;
          ball.dy = 0;
          playSound('notification');
        }
      }
      
      // Brick collisions
      bricks.forEach(brick => {
        if (!brick.alive) return;
        
        if (
          ball.x + ball.radius > brick.x &&
          ball.x - ball.radius < brick.x + brick.width &&
          ball.y + ball.radius > brick.y &&
          ball.y - ball.radius < brick.y + brick.height
        ) {
          brick.hits--;
          
          if (brick.hits <= 0) {
            brick.alive = false;
            score += brick.points * level;
            document.getElementById("breakoutScore").textContent = score;
            createParticles(brick.x + brick.width / 2, brick.y + brick.height / 2, brick.color, 15);
            playSound('click');
          } else {
            // Brick cracked but not destroyed
            brick.color = shadeColor(brick.color, -30);
            playSound('click');
          }
          
          // Determine bounce direction
          let overlapLeft = ball.x + ball.radius - brick.x;
          let overlapRight = brick.x + brick.width - (ball.x - ball.radius);
          let overlapTop = ball.y + ball.radius - brick.y;
          let overlapBottom = brick.y + brick.height - (ball.y - ball.radius);
          
          let minOverlapX = Math.min(overlapLeft, overlapRight);
          let minOverlapY = Math.min(overlapTop, overlapBottom);
          
          if (minOverlapX < minOverlapY) {
            ball.dx *= -1;
          } else {
            ball.dy *= -1;
          }
        }
      });
      
      // Check win condition
      if (bricks.every(b => !b.alive)) {
        levelUp();
      }
    }
    
    updateParticles();
  }
  
  function shadeColor(color, percent) {
    let num = parseInt(color.replace('#', ''), 16);
    let amt = Math.round(2.55 * percent);
    let R = (num >> 16) + amt;
    let G = (num >> 8 & 0x00FF) + amt;
    let B = (num & 0x0000FF) + amt;
    
    R = Math.max(Math.min(255, R), 0);
    G = Math.max(Math.min(255, G), 0);
    B = Math.max(Math.min(255, B), 0);
    
    return '#' + (0x1000000 + R * 0x10000 + G * 0x100 + B).toString(16).slice(1);
  }
  
  function levelUp() {
    level++;
    document.getElementById("breakoutLevel").textContent = level;
    
    // Bonus points
    score += 100 * level;
    document.getElementById("breakoutScore").textContent = score;
    
    // Reset ball
    ball.launched = false;
    ball.dx = 0;
    ball.dy = 0;
    ball.speed = Math.min(5 + level * 0.5, 10);
    
    // Recreate bricks
    createBricks();
    
    // Add a life every 3 levels
    if (level % 3 === 0 && lives < 5) {
      lives++;
      document.getElementById("breakoutLives").textContent = lives;
    }
    
    showNotification(`Level ${level}!`, 'success');
    playSound('notification');
  }
  
  function launchBall() {
    if (!ball.launched && gameRunning) {
      ball.launched = true;
      let angle = (Math.random() - 0.5) * Math.PI * 0.5; // Random angle
      ball.dx = Math.sin(angle) * ball.speed;
      ball.dy = -ball.speed;
      playSound('click');
    }
  }
  
  function draw() {
    drawBackground();
    drawBricks();
    drawParticles();
    drawPaddle();
    drawBall();
    drawUI();
  }
  
  function gameLoop() {
    if (!gameRunning) return;
    
    update();
    draw();
    
    window.gameInterval = requestAnimationFrame(gameLoop);
  }
  
  function gameOver(won) {
    gameRunning = false;
    
    ctx.fillStyle = 'rgba(0, 0, 0, 0.85)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.textAlign = 'center';
    
    if (won) {
      ctx.fillStyle = '#00ff00';
      ctx.font = 'bold 50px Poppins';
      ctx.fillText('YOU WIN!', canvas.width / 2, canvas.height / 2 - 50);
    } else {
      ctx.fillStyle = '#ff4444';
      ctx.font = 'bold 50px Poppins';
      ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 50);
    }
    
    ctx.fillStyle = 'white';
    ctx.font = '28px Poppins';
    ctx.fillText(`Score: ${score}`, canvas.width / 2, canvas.height / 2 + 10);
    ctx.fillText(`Level: ${level}`, canvas.width / 2, canvas.height / 2 + 50);
    
    ctx.fillStyle = '#aaa';
    ctx.font = '16px Poppins';
    ctx.fillText('Click START to play again', canvas.width / 2, canvas.height / 2 + 100);
    
    // Rewards
    let coins = Math.floor(score / 20);
    let xp = Math.floor(score / 10);
    if (coins > 0) {
      addCoins(coins, `Breakout - Level ${level}`);
      addXP(xp, "Breakout");
    }
    
    document.getElementById("breakoutStartBtn").textContent = "Play Again";
  }
  
  // Keyboard controls
  function handleKeyDown(e) {
    if (e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A') {
      e.preventDefault();
      paddle.dx = -paddle.speed;
    } else if (e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D') {
      e.preventDefault();
      paddle.dx = paddle.speed;
    } else if (e.key === ' ') {
      e.preventDefault();
      launchBall();
    }
  }
  
  function handleKeyUp(e) {
    if (
      e.key === 'ArrowLeft' || e.key === 'a' || e.key === 'A' ||
      e.key === 'ArrowRight' || e.key === 'd' || e.key === 'D'
    ) {
      paddle.dx = 0;
    }
  }
  
  window.breakoutKeydown = handleKeyDown;
  window.breakoutKeyup = handleKeyUp;
  
  document.addEventListener('keydown', handleKeyDown);
  document.addEventListener('keyup', handleKeyUp);
  
  // Cleanup on close
  let originalClose = window.closeMiniGame;
  window.closeMiniGame = function() {
    document.removeEventListener('keydown', window.breakoutKeydown);
    document.removeEventListener('keyup', window.breakoutKeyup);
    if (window.gameInterval) cancelAnimationFrame(window.gameInterval);
    window.closeMiniGame = originalClose;
    originalClose();
  };
  
  // Initialize and start
  createBricks();
  document.getElementById("breakoutStartBtn").textContent = "Restart";
  gameLoop();
}

   function initFlappyGame(container) {
  container.innerHTML = `
    <h2 style="color: var(--accent); text-align: center;"> Flappy Bird</h2>
    <div class="minigame-score">Score: <span id="flappyScore">0</span> | Best: <span id="flappyBest">${localStorage.getItem('flappyBest') || 0}</span></div>
    <canvas id="flappyCanvas" class="minigame-canvas" width="400" height="500"></canvas>
    <div class="minigame-controls">
      <p>Press SPACE or CLICK to flap!</p>
      <button class="sidebar-btn sidebar-btn-green" onclick="startFlappy()">Start Game</button>
    </div>
  `;
  
  // Draw initial state
  let canvas = document.getElementById("flappyCanvas");
  let ctx = canvas.getContext("2d");
  ctx.fillStyle = "#87CEEB";
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = "#228B22";
  ctx.fillRect(0, canvas.height - 50, canvas.width, 50);
  ctx.font = "20px Poppins";
  ctx.fillStyle = "white";
  ctx.textAlign = "center";
  ctx.fillText("Press Start to Play!", canvas.width/2, canvas.height/2);
}

function startFlappy() {
  let canvas = document.getElementById("flappyCanvas");
  let ctx = canvas.getContext("2d");
  
  // Game variables
  let bird = {
    x: 80,
    y: 250,
    width: 35,
    height: 25,
    velocity: 0,
    gravity: 0.5,
    jump: -8,
    rotation: 0
  };
  
  let pipes = [];
  let pipeWidth = 60;
  let pipeGap = 150;
  let pipeSpeed = 3;
  let pipeSpawnRate = 90;
  let frameCount = 0;
  let score = 0;
  let gameRunning = true;
  let gameStarted = false;
  
  // Colors
  let skyColor = "#87CEEB";
  let groundColor = "#228B22";
  let groundHeight = 50;
  let pipeColor = "#2ECC71";
  let pipeBorderColor = "#27AE60";
  
  function drawBird() {
    ctx.save();
    ctx.translate(bird.x + bird.width/2, bird.y + bird.height/2);
    
    // Rotate based on velocity
    let rotation = Math.min(Math.max(bird.velocity * 3, -30), 90) * Math.PI / 180;
    ctx.rotate(rotation);
    
    // Body (yellow)
    ctx.fillStyle = "#FFD700";
    ctx.beginPath();
    ctx.ellipse(0, 0, bird.width/2, bird.height/2, 0, 0, Math.PI * 2);
    ctx.fill();
    ctx.strokeStyle = "#FFA500";
    ctx.lineWidth = 2;
    ctx.stroke();
    
    // Wing
    ctx.fillStyle = "#FFA500";
    ctx.beginPath();
    ctx.ellipse(-5, 5, 10, 6, -0.3, 0, Math.PI * 2);
    ctx.fill();
    
    // Eye
    ctx.fillStyle = "white";
    ctx.beginPath();
    ctx.arc(8, -5, 8, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = "black";
    ctx.beginPath();
    ctx.arc(10, -5, 4, 0, Math.PI * 2);
    ctx.fill();
    
    // Beak
    ctx.fillStyle = "#FF6B35";
    ctx.beginPath();
    ctx.moveTo(15, 0);
    ctx.lineTo(25, 3);
    ctx.lineTo(15, 6);
    ctx.closePath();
    ctx.fill();
    
    ctx.restore();
  }
  
  function drawPipe(pipe) {
    // Top pipe
    ctx.fillStyle = pipeColor;
    ctx.fillRect(pipe.x, 0, pipeWidth, pipe.topHeight);
    ctx.fillStyle = pipeBorderColor;
    ctx.fillRect(pipe.x - 3, pipe.topHeight - 30, pipeWidth + 6, 30);
    
    // Pipe highlight
    ctx.fillStyle = "#58D68D";
    ctx.fillRect(pipe.x + 5, 0, 8, pipe.topHeight - 30);
    
    // Bottom pipe
    let bottomY = pipe.topHeight + pipeGap;
    ctx.fillStyle = pipeColor;
    ctx.fillRect(pipe.x, bottomY, pipeWidth, canvas.height - bottomY - groundHeight);
    ctx.fillStyle = pipeBorderColor;
    ctx.fillRect(pipe.x - 3, bottomY, pipeWidth + 6, 30);
    
    // Pipe highlight
    ctx.fillStyle = "#58D68D";
    ctx.fillRect(pipe.x + 5, bottomY + 30, 8, canvas.height - bottomY - groundHeight - 30);
  }
  
  function drawGround() {
    ctx.fillStyle = groundColor;
    ctx.fillRect(0, canvas.height - groundHeight, canvas.width, groundHeight);
    
    // Grass detail
    ctx.fillStyle = "#1D8348";
    for (let i = 0; i < canvas.width; i += 20) {
      ctx.fillRect(i, canvas.height - groundHeight, 10, 5);
    }
    
    // Dirt
    ctx.fillStyle = "#8B4513";
    ctx.fillRect(0, canvas.height - groundHeight + 15, canvas.width, groundHeight - 15);
  }
  
  function drawClouds() {
    ctx.fillStyle = "rgba(255, 255, 255, 0.8)";
    
    // Cloud 1
    ctx.beginPath();
    ctx.arc(100, 80, 25, 0, Math.PI * 2);
    ctx.arc(130, 70, 30, 0, Math.PI * 2);
    ctx.arc(160, 80, 25, 0, Math.PI * 2);
    ctx.fill();
    
    // Cloud 2
    ctx.beginPath();
    ctx.arc(300, 120, 20, 0, Math.PI * 2);
    ctx.arc(325, 110, 25, 0, Math.PI * 2);
    ctx.arc(350, 120, 20, 0, Math.PI * 2);
    ctx.fill();
  }
  
  function draw() {
    // Sky
    ctx.fillStyle = skyColor;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // Clouds
    drawClouds();
    
    // Pipes
    pipes.forEach(pipe => drawPipe(pipe));
    
    // Ground
    drawGround();
    
    // Bird
    drawBird();
    
    // Score
    ctx.fillStyle = "white";
    ctx.strokeStyle = "black";
    ctx.lineWidth = 3;
    ctx.font = "bold 40px Poppins";
    ctx.textAlign = "center";
    ctx.strokeText(score, canvas.width/2, 60);
    ctx.fillText(score, canvas.width/2, 60);
  }
  
  function update() {
    if (!gameRunning) return;
    
    frameCount++;
    
    // Bird physics
    bird.velocity += bird.gravity;
    bird.y += bird.velocity;
    
    // Spawn pipes
    if (frameCount % pipeSpawnRate === 0) {
      let minHeight = 50;
      let maxHeight = canvas.height - groundHeight - pipeGap - 50;
      let topHeight = Math.random() * (maxHeight - minHeight) + minHeight;
      
      pipes.push({
        x: canvas.width,
        topHeight: topHeight,
        passed: false
      });
    }
    
    // Update pipes
    pipes.forEach((pipe, index) => {
      pipe.x -= pipeSpeed;
      
      // Score
      if (!pipe.passed && pipe.x + pipeWidth < bird.x) {
        pipe.passed = true;
        score++;
        document.getElementById("flappyScore").textContent = score;
        playSound('click');
      }
      
      // Remove off-screen pipes
      if (pipe.x + pipeWidth < 0) {
        pipes.splice(index, 1);
      }
      
      // Collision detection
      if (bird.x + bird.width > pipe.x && bird.x < pipe.x + pipeWidth) {
        if (bird.y < pipe.topHeight || bird.y + bird.height > pipe.topHeight + pipeGap) {
          gameOver();
        }
      }
    });
    
    // Ground collision
    if (bird.y + bird.height > canvas.height - groundHeight) {
      bird.y = canvas.height - groundHeight - bird.height;
      gameOver();
    }
    
    // Ceiling collision
    if (bird.y < 0) {
      bird.y = 0;
      bird.velocity = 0;
    }
    
    draw();
    
    if (gameRunning) {
      window.gameInterval = requestAnimationFrame(update);
    }
  }
  
  function flap() {
    if (!gameRunning) return;
    
    if (!gameStarted) {
      gameStarted = true;
    }
    
    bird.velocity = bird.jump;
    playSound('click');
  }
  
  function gameOver() {
    gameRunning = false;
    
    // Update best score
    let best = parseInt(localStorage.getItem('flappyBest') || 0);
    if (score > best) {
      localStorage.setItem('flappyBest', score);
      document.getElementById("flappyBest").textContent = score;
    }
    
    // Draw game over screen
    ctx.fillStyle = "rgba(0, 0, 0, 0.7)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    ctx.fillStyle = "#FF6B6B";
    ctx.font = "bold 40px Poppins";
    ctx.textAlign = "center";
    ctx.fillText("GAME OVER", canvas.width/2, canvas.height/2 - 40);
    
    ctx.fillStyle = "white";
    ctx.font = "24px Poppins";
    ctx.fillText(`Score: ${score}`, canvas.width/2, canvas.height/2 + 10);
    
    ctx.font = "18px Poppins";
    ctx.fillStyle = "#FFD700";
    ctx.fillText(`Best: ${localStorage.getItem('flappyBest') || score}`, canvas.width/2, canvas.height/2 + 45);
    
    ctx.font = "16px Poppins";
    ctx.fillStyle = "#aaa";
    ctx.fillText("Click START to play again", canvas.width/2, canvas.height/2 + 90);
    
    // Award coins
    if (score > 0) {
      let coins = Math.floor(score * 2);
      let xp = Math.floor(score * 1.5);
      addCoins(coins, `Flappy Bird - Score: ${score}`);
      addXP(xp, "Flappy Bird");
    }
  }
  
  // Event listeners
  function handleKeydown(e) {
    if (e.code === "Space") {
      e.preventDefault();
      flap();
    }
  }
  
  function handleClick(e) {
    if (e.target === canvas) {
      flap();
    }
  }
  
  // Store old listeners to remove later
  window.flappyKeydown = handleKeydown;
  window.flappyClick = handleClick;
  
  document.addEventListener("keydown", handleKeydown);
  canvas.addEventListener("click", handleClick);
  
  // Override closeMiniGame to clean up
  let originalClose = window.closeMiniGame;
  window.closeMiniGame = function() {
    document.removeEventListener("keydown", window.flappyKeydown);
    if (canvas) canvas.removeEventListener("click", window.flappyClick);
    if (window.gameInterval) cancelAnimationFrame(window.gameInterval);
    window.closeMiniGame = originalClose;
    originalClose();
  };
  
  // Start the game
  draw();
  update();
}

        // ===== SHOP DATA =====
    const shopItems = [
      // Banners
      { id: 'banner_sunset', name: 'Sunset Banner', type: 'banners', icon: '', price: 500, rarity: 'uncommon', image: 'https://images.unsplash.com/photo-1507400492013-162706c8c05e?w=400' },
      { id: 'banner_space', name: 'Space Banner', type: 'banners', icon: '', price: 1000, rarity: 'rare', image: 'https://images.unsplash.com/photo-1462331940025-496dfbfc7564?w=400' },
      { id: 'banner_neon', name: 'Neon City', type: 'banners', icon: '', price: 2000, rarity: 'epic', image: 'https://images.unsplash.com/photo-1545486332-9e0999c535b2?w=400' },
      { id: 'banner_fire', name: 'Fire Banner', type: 'banners', icon: '', price: 5000, rarity: 'legendary', image: 'https://images.unsplash.com/photo-1518972559570-7cc1309f3229?w=400' },
      { id: 'banner_ocean', name: 'Ocean Waves', type: 'banners', icon: '', price: 750, rarity: 'uncommon', image: 'https://images.unsplash.com/photo-1505142468610-359e7d316be0?w=400' },
      
      // Frames
      { id: 'frame_gold', name: 'Gold Frame', type: 'frames', icon: '', price: 1500, rarity: 'rare' },
      { id: 'frame_diamond', name: 'Diamond Frame', type: 'frames', icon: '', price: 5000, rarity: 'legendary' },
      { id: 'frame_fire', name: 'Fire Frame', type: 'frames', icon: '', price: 2500, rarity: 'epic' },
      { id: 'frame_rainbow', name: 'Rainbow Frame', type: 'frames', icon: '', price: 3000, rarity: 'epic' },
      
      // Badges
      { id: 'badge_star', name: 'Star Badge', type: 'badges', icon: '', price: 200, rarity: 'common' },
      { id: 'badge_crown', name: 'Crown Badge', type: 'badges', icon: '', price: 1000, rarity: 'rare' },
      { id: 'badge_vip', name: 'VIP Badge', type: 'badges', icon: '', price: 2500, rarity: 'epic' },
      { id: 'badge_legend', name: 'Legend Badge', type: 'badges', icon: '', price: 7500, rarity: 'legendary' },
      { id: 'badge_og', name: 'OG Badge', type: 'badges', icon: '', price: 500, rarity: 'uncommon' },
      { id: 'badge_gamer', name: 'Gamer Badge', type: 'badges', icon: '', price: 300, rarity: 'common' },
      
      // Effects
      { id: 'effect_sparkle', name: 'Sparkle Effect', type: 'effects', icon: '', price: 1500, rarity: 'rare' },
      { id: 'effect_flame', name: 'Flame Effect', type: 'effects', icon: '', price: 2000, rarity: 'epic' },
      { id: 'effect_hearts', name: 'Hearts Effect', type: 'effects', icon: '', price: 1000, rarity: 'uncommon' },
      { id: 'effect_money', name: 'Money Effect', type: 'effects', icon: '', price: 3000, rarity: 'epic' },
      
      // Titles
      { id: 'title_champion', name: 'Champion', type: 'titles', icon: '', price: 1000, rarity: 'rare' },
      { id: 'title_legend', name: 'Legend', type: 'titles', icon: '', price: 5000, rarity: 'legendary' },
      { id: 'title_pro', name: 'Pro Gamer', type: 'titles', icon: '', price: 500, rarity: 'uncommon' },
      { id: 'title_noob', name: 'Noob', type: 'titles', icon: '', price: 100, rarity: 'common' },
      { id: 'title_rich', name: 'Rich Kid', type: 'titles', icon: '', price: 10000, rarity: 'legendary' }
    ];

    let currentShopTab = 'banners';

    function openShop() {
      document.getElementById("shopModal").classList.add("open");
      document.getElementById("shopCoinsDisplay").textContent = myProfile?.coins || 0;
      renderShopItems();
    }

    function closeShop() {
      document.getElementById("shopModal").classList.remove("open");
    }

    function showShopTab(tab, btn) {
      document.querySelectorAll('.shop-tab').forEach(t => t.classList.remove('active'));
      btn.classList.add('active');
      currentShopTab = tab;
      renderShopItems();
    }

    function renderShopItems() {
      let container = document.getElementById("shopItems");
      let items = shopItems.filter(i => i.type === currentShopTab);
      let owned = myProfile?.inventory || [];
      
      let html = "";
      items.forEach(item => {
        let isOwned = owned.includes(item.id);
        
        html += `<div class="shop-item ${isOwned ? 'owned' : ''}" onclick="${isOwned ? '' : `buyItem('${item.id}')`}">`;
        html += `<div class="shop-item-icon">${item.icon}</div>`;
        html += `<div class="shop-item-name">${item.name}</div>`;
        
        if (isOwned) {
          html += `<div class="shop-item-owned"> Owned</div>`;
        } else {
          html += `<div class="shop-item-price"> ${item.price}</div>`;
        }
        
        html += `<div class="shop-item-rarity rarity-${item.rarity}">${item.rarity.toUpperCase()}</div>`;
        html += `</div>`;
      });
      
      
    }

    async function buyItem(itemId) {
      let item = shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      if ((myProfile?.coins || 0) < item.price) {
        showNotification("Not enough coins!", 'warning');
        return;
      }
      
      myProfile.coins -= item.price;
      myProfile.inventory = myProfile.inventory || [];
      myProfile.inventory.push(item.id);
      
      await db.collection("users").doc(userId).update({
        coins: myProfile.coins,
        inventory: myProfile.inventory
      });
      
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      document.getElementById("shopCoinsDisplay").textContent = myProfile.coins;
      
      playSound('notification');
      showNotification(`Purchased ${item.name}!`, 'success');
      createConfetti();
      renderShopItems();
      updateInventory();
   
    trackPurchase();
    }

    function updateInventory() {
      let container = document.getElementById("inventoryItems");
      if (!container) return;
      
      let owned = myProfile?.inventory || [];
      
      if (owned.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); grid-column: span 3; text-align: center;">No items yet. Visit the shop!</p>';
        return;
      }
      
      let html = "";
      owned.forEach(itemId => {
        let item = shopItems.find(i => i.id === itemId);
        if (item) {
          html += `<div style="background: var(--bg-tertiary); padding: 10px; border-radius: 8px; text-align: center; cursor: pointer;" onclick="equipItem('${item.id}')" title="Click to equip">`;
          html += `<div style="font-size: 25px;">${item.icon}</div>`;
          html += `<div style="font-size: 10px; color: var(--text-secondary);">${item.name}</div>`;
          html += `</div>`;
        }
      });
      
      container.innerHTML = html;
    }

    async function equipItem(itemId) {
      let item = shopItems.find(i => i.id === itemId);
      if (!item) return;
      
      let updateData = {};
      
      if (item.type === 'banners' && item.image) {
        myProfile.equippedBanner = item.image;
        updateData.equippedBanner = item.image;
        document.getElementById("myProfileBanner").style.backgroundImage = `url(${item.image})`;
      } else if (item.type === 'badges') {
        myProfile.equippedBadge = item.icon;
        updateData.equippedBadge = item.icon;
      } else if (item.type === 'titles') {
        myProfile.equippedTitle = item.name;
        updateData.equippedTitle = item.name;
      }
      
      await db.collection("users").doc(userId).update(updateData);
      showNotification(`Equipped ${item.name}!`, 'success');
      playSound('click');
    }

    // ===== CASINO =====
    const casinoGames = [
      { id: 'slots', name: 'Slots', icon: '', desc: 'Spin to win!' },
      { id: 'coinflip', name: 'Coin Flip', icon: '', desc: '50/50 chance!' },
      { id: 'dice', name: 'Dice Roll', icon: '', desc: 'Roll the dice!' },
      { id: 'roulette', name: 'Roulette', icon: '', desc: 'Red or black?' }
    ];

    function renderCasinoGames() {
      let html = "";
      casinoGames.forEach(game => {
        html += `<div class="casino-game" onclick="openCasinoGame('${game.id}')">`;
        html += `<div class="casino-game-icon">${game.icon}</div>`;
        html += `<div class="casino-game-name">${game.name}</div>`;
        html += `<div class="casino-game-desc">${game.desc}</div>`;
        html += `</div>`;
      });
      document.getElementById("casinoGames").innerHTML = html;
    }

    function openCasinoGame(gameId) {
      document.getElementById("casinoModal").classList.add("open");
      
      let content = document.getElementById("casinoContent");
      
      switch(gameId) {
        case 'slots':
          initSlotsGame(content);
          break;
        case 'coinflip':
          initCoinFlipGame(content);
          break;
        case 'dice':
          initDiceGame(content);
          break;
        case 'roulette':
          initRouletteGame(content);
          break;
      }
    }

    function closeCasino() {
      document.getElementById("casinoModal").classList.remove("open");
    }

    // ===== SLOTS GAME =====
    function initSlotsGame(container) {
      container.innerHTML = `
        <div class="slots-container">
          <h2 style="color: var(--accent);"> Slots</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="slotsCoins">${myProfile?.coins || 0}</span></p>
          
          <div class="slots-display">
            <div class="slot-reel" id="reel1"></div>
            <div class="slot-reel" id="reel2"></div>
            <div class="slot-reel" id="reel3"></div>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="slotsBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="spinBtn" onclick="spinSlots()"> SPIN</button>
          
          <div id="slotsResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
          
          <p style="color: var(--text-muted); font-size: 12px; margin-top: 15px;">
            3x Same = 10x bet | 2x Same = 2x bet | 3x 7 = JACKPOT (50x)
          </p>
        </div>
      `;
    }

    const slotSymbols = ['', '', '', '', '', '7', ''];

    async function spinSlots() {
      let bet = parseInt(document.getElementById("slotsBet").value);
      
      if (bet < 10) {
        showNotification("Minimum bet is 10 coins!", 'warning');
        return;
      }
      
      if (bet > (myProfile?.coins || 0)) {
        showNotification("Not enough coins!", 'warning');
        return;
      }
      
      // Deduct bet
      myProfile.coins -= bet;
      document.getElementById("slotsCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      // Disable button
      let btn = document.getElementById("spinBtn");
      btn.disabled = true;
      document.getElementById("slotsResult").textContent = "";
      
      // Spin animation
      let reels = [
        document.getElementById("reel1"),
        document.getElementById("reel2"),
        document.getElementById("reel3")
      ];
      
      reels.forEach(r => r.classList.add("spinning"));
      
      let results = [];
      
      // Stop reels one by one
      for (let i = 0; i < 3; i++) {
        await new Promise(resolve => setTimeout(resolve, 500 + i * 300));
        
        results[i] = slotSymbols[Math.floor(Math.random() * slotSymbols.length)];
        reels[i].classList.remove("spinning");
        reels[i].textContent = results[i];
        playSound('click');
      }
      
      // Calculate winnings
      let winnings = 0;
      let message = "";
      
      if (results[0] === results[1] && results[1] === results[2]) {
        if (results[0] === '7') {
          winnings = bet * 50;
          message = " JACKPOT!!! ";
          createConfetti();
        } else {
          winnings = bet * 10;
          message = " TRIPLE MATCH!";
        }
      } else if (results[0] === results[1] || results[1] === results[2] || results[0] === results[2]) {
        winnings = bet * 2;
        message = "Nice! Double match!";
      } else {
        message = "No match. Try again!";
      }
      
      if (winnings > 0) {
        myProfile.coins += winnings;
        document.getElementById("slotsResult").innerHTML = `<span style="color: var(--success);">${message} Won ${winnings} </span>`;
        addXP(Math.floor(winnings / 10), "Slots");
      } else {
        document.getElementById("slotsResult").innerHTML = `<span style="color: var(--danger);">${message}</span>`;
      }
      
      document.getElementById("slotsCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      btn.disabled = false;
    }

    // ===== COIN FLIP GAME =====
    function initCoinFlipGame(container) {
      container.innerHTML = `
        <div class="coinflip-container">
          <h2 style="color: var(--accent);"> Coin Flip</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="flipCoins">${myProfile?.coins || 0}</span></p>
          
          <div class="coin" id="coin">
            <div class="coin-side coin-heads"></div>
            <div class="coin-side coin-tails"></div>
          </div>
          
          <div class="coinflip-choice">
            <button class="choice-btn heads" id="choiceHeads" onclick="selectCoinChoice('heads')"> Heads</button>
            <button class="choice-btn tails" id="choiceTails" onclick="selectCoinChoice('tails')"> Tails</button>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="flipBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="flipBtn" onclick="flipCoin()" disabled> FLIP</button>
          
          <div id="flipResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
        </div>
      `;
    }

    let coinChoice = null;

    function selectCoinChoice(choice) {
      coinChoice = choice;
      document.getElementById("choiceHeads").classList.toggle("selected", choice === 'heads');
      document.getElementById("choiceTails").classList.toggle("selected", choice === 'tails');
      document.getElementById("flipBtn").disabled = false;
    }

    async function flipCoin() {
      if (!coinChoice) return;
      
      let bet = parseInt(document.getElementById("flipBet").value);
      
      if (bet < 10 || bet > (myProfile?.coins || 0)) {
        showNotification("Invalid bet!", 'warning');
        return;
      }
      
      myProfile.coins -= bet;
      document.getElementById("flipCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      let coin = document.getElementById("coin");
      coin.classList.add("flipping");
      document.getElementById("flipBtn").disabled = true;
      document.getElementById("flipResult").textContent = "";
      
      let result = Math.random() < 0.5 ? 'heads' : 'tails';
      
      await new Promise(resolve => setTimeout(resolve, 2000));
      
      coin.classList.remove("flipping");
      coin.style.transform = result === 'heads' ? 'rotateY(0deg)' : 'rotateY(180deg)';
      
      if (result === coinChoice) {
        let winnings = bet * 2;
        myProfile.coins += winnings;
        document.getElementById("flipResult").innerHTML = `<span style="color: var(--success);"> You won ${winnings} coins!</span>`;
        addXP(Math.floor(winnings / 5), "Coin Flip");
        playSound('notification');
      } else {
        document.getElementById("flipResult").innerHTML = `<span style="color: var(--danger);"> You lost! It was ${result}</span>`;
      }
      
      document.getElementById("flipCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      coinChoice = null;
      document.getElementById("choiceHeads").classList.remove("selected");
      document.getElementById("choiceTails").classList.remove("selected");
    }

    // ===== DICE GAME =====
    function initDiceGame(container) {
      container.innerHTML = `
        <div class="slots-container">
          <h2 style="color: var(--accent);"> Dice Roll</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="diceCoins">${myProfile?.coins || 0}</span></p>
          
          <div style="font-size: 100px; text-align: center; margin: 30px 0;" id="diceDisplay"></div>
          
          <p style="color: var(--text-primary);">Guess: Higher or Lower than 3.5?</p>
          
          <div style="display: flex; gap: 20px; justify-content: center; margin: 20px 0;">
            <button class="sidebar-btn sidebar-btn-green" id="guessHigh" onclick="selectDiceGuess('high')"> High (4-6)</button>
            <button class="sidebar-btn sidebar-btn-red" id="guessLow" onclick="selectDiceGuess('low')"> Low (1-3)</button>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="diceBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="rollBtn" onclick="rollDice()" disabled> ROLL</button>
          
          <div id="diceResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
        </div>
      `;
    }

    let diceGuess = null;
    const diceEmojis = ['', '', '', '', '', ''];

    function selectDiceGuess(guess) {
      diceGuess = guess;
      document.getElementById("guessHigh").style.opacity = guess === 'high' ? 1 : 0.5;
      document.getElementById("guessLow").style.opacity = guess === 'low' ? 1 : 0.5;
      document.getElementById("rollBtn").disabled = false;
    }

    async function rollDice() {
      if (!diceGuess) return;
      
      let bet = parseInt(document.getElementById("diceBet").value);
      
      if (bet < 10 || bet > (myProfile?.coins || 0)) {
        showNotification("Invalid bet!", 'warning');
        return;
      }
      
      myProfile.coins -= bet;
      document.getElementById("diceCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      document.getElementById("rollBtn").disabled = true;
      document.getElementById("diceResult").textContent = "";
      
      let display = document.getElementById("diceDisplay");
      
      // Animation
      for (let i = 0; i < 10; i++) {
        await new Promise(r => setTimeout(r, 100));
        display.textContent = diceEmojis[Math.floor(Math.random() * 6)];
      }
      
      let roll = Math.floor(Math.random() * 6) + 1;
      display.textContent = diceEmojis[roll - 1];
      
      let isHigh = roll > 3;
      let won = (diceGuess === 'high' && isHigh) || (diceGuess === 'low' && !isHigh);
      
      if (won) {
        let winnings = bet * 2;
        myProfile.coins += winnings;
        document.getElementById("diceResult").innerHTML = `<span style="color: var(--success);"> Rolled ${roll}! You won ${winnings} coins!</span>`;
        addXP(Math.floor(winnings / 5), "Dice");
        playSound('notification');
      } else {
        document.getElementById("diceResult").innerHTML = `<span style="color: var(--danger);"> Rolled ${roll}. You lost!</span>`;
      }
      
      document.getElementById("diceCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      diceGuess = null;
      document.getElementById("guessHigh").style.opacity = 1;
      document.getElementById("guessLow").style.opacity = 1;
    }

    // ===== ROULETTE =====
    function initRouletteGame(container) {
      container.innerHTML = `
        <div class="slots-container">
          <h2 style="color: var(--accent);"> Roulette</h2>
          <p style="color: var(--text-secondary);">Your Coins: <span id="rouletteCoins">${myProfile?.coins || 0}</span></p>
          
          <div style="font-size: 80px; text-align: center; margin: 30px 0; padding: 20px; border-radius: 50%; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; margin: 20px auto;" id="rouletteDisplay"></div>
          
          <div style="display: flex; gap: 15px; justify-content: center; margin: 20px 0;">
            <button class="sidebar-btn" style="background: red; color: white;" id="pickRed" onclick="selectRoulette('red')"> Red</button>
            <button class="sidebar-btn" style="background: black; color: white;" id="pickBlack" onclick="selectRoulette('black')"> Black</button>
            <button class="sidebar-btn" style="background: green; color: white;" id="pickGreen" onclick="selectRoulette('green')"> Green (14x)</button>
          </div>
          
          <div class="slots-bet">
            <label style="color: var(--text-primary);">Bet:</label>
            <input type="number" id="rouletteBet" value="10" min="10" max="1000">
          </div>
          
          <button class="spin-btn" id="rouletteBtn" onclick="spinRoulette()" disabled> SPIN</button>
          
          <div id="rouletteResult" style="margin-top: 15px; font-size: 18px; min-height: 30px;"></div>
        </div>
      `;
    }

    let rouletteChoice = null;

    function selectRoulette(choice) {
      rouletteChoice = choice;
      document.getElementById("pickRed").style.opacity = choice === 'red' ? 1 : 0.5;
      document.getElementById("pickBlack").style.opacity = choice === 'black' ? 1 : 0.5;
      document.getElementById("pickGreen").style.opacity = choice === 'green' ? 1 : 0.5;
      document.getElementById("rouletteBtn").disabled = false;
    }

    async function spinRoulette() {
      if (!rouletteChoice) return;
      
      let bet = parseInt(document.getElementById("rouletteBet").value);
      
      if (bet < 10 || bet > (myProfile?.coins || 0)) {
        showNotification("Invalid bet!", 'warning');
        return;
      }
      
      myProfile.coins -= bet;
      document.getElementById("rouletteCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      document.getElementById("rouletteBtn").disabled = true;
      document.getElementById("rouletteResult").textContent = "";
      
      let display = document.getElementById("rouletteDisplay");
      let colors = ['', '', '', '', '', '', '', '', ''];
      
      // Animation
      for (let i = 0; i < 20; i++) {
        await new Promise(r => setTimeout(r, 50 + i * 10));
        display.textContent = colors[Math.floor(Math.random() * colors.length)];
      }
      
      // Result (green is rare)
      let rand = Math.random();
      let result;
      if (rand < 0.07) {
        result = 'green';
        display.textContent = '';
      } else if (rand < 0.535) {
        result = 'red';
        display.textContent = '';
      } else {
        result = 'black';
        display.textContent = '';
      }
      
      let won = result === rouletteChoice;
      let multiplier = result === 'green' ? 14 : 2;
      
      if (won) {
        let winnings = bet * multiplier;
        myProfile.coins += winnings;
        document.getElementById("rouletteResult").innerHTML = `<span style="color: var(--success);"> ${result.toUpperCase()}! You won ${winnings} coins!</span>`;
        addXP(Math.floor(winnings / 5), "Roulette");
        playSound('notification');
        if (result === 'green') createConfetti();
      } else {
        document.getElementById("rouletteResult").innerHTML = `<span style="color: var(--danger);"> It was ${result}. You lost!</span>`;
      }
      
      document.getElementById("rouletteCoins").textContent = myProfile.coins;
      document.getElementById("coinsDisplay").textContent = myProfile.coins;
      
      await db.collection("users").doc(userId).update({ coins: myProfile.coins });
      
      rouletteChoice = null;
      document.getElementById("pickRed").style.opacity = 1;
      document.getElementById("pickBlack").style.opacity = 1;
      document.getElementById("pickGreen").style.opacity = 1;
    }


        // ===== ADMIN COMMANDS =====
    const adminCommands = {
      '/help': 'Show all commands',
      '/givexp [user] [amount]': 'Give XP to user',
      '/givecoins [user] [amount]': 'Give coins to user',
      '/giveitem [user] [itemid]': 'Give item to user',
      '/giveall': 'Give yourself all items',
      '/ban [user]': 'Permanent ban',
      '/tempban [user] [hours]': 'Temporary ban',
      '/unban [user]': 'Unban user',
      '/mute [user]': 'Mute user',
      '/unmute [user]': 'Unmute user',
      '/announce [message]': 'Set announcement',
      '/clearchat': 'Clear all chat messages',
      '/stats': 'Show site stats',
      '/items': 'List all shop items'
    };

    function handleAdminCmd(event) {
      if (event.key === 'Enter') {
        executeAdminCmd();
      }
    }

    async function executeAdminCmd() {
      if (!isAdmin) {
        showNotification("You're not an admin!", 'warning');
        return;
      }
      
      let input = document.getElementById("adminCmd").value.trim();
      let output = document.getElementById("cmdOutput");
      
      if (!input) return;
      
      let parts = input.split(' ');
      let cmd = parts[0].toLowerCase();
      let args = parts.slice(1);
      
      let result = "";
      
      try {
        switch(cmd) {
          case '/help':
            result = "<strong>Admin Commands:</strong><br>";
            for (let c in adminCommands) {
              result += `${c} - ${adminCommands[c]}<br>`;
            }
            break;
            
                      case '/givexp':
            if (args.length < 2) {
              result = "Usage: /givexp [username] [amount]";
            } else {
              let targetName = args[0];
              let amount = parseInt(args[1]);
              let targetUser = await findUserByName(targetName);
              
              if (targetUser) {
                let newXp = (targetUser.data.xp || 0) + amount;
                await db.collection("users").doc(targetUser.id).update({ xp: newXp });
                
                // If giving to yourself, update local profile and XP bar
                if (targetUser.id === userId) {
                  myProfile.xp = newXp;
                  updateXPBar();
                  updateProfileDisplay();
                  
                  // Check for level ups
                  let oldLevel = calculateLevel(targetUser.data.xp || 0).level;
                  let newLevel = calculateLevel(newXp).level;
                  
                  if (newLevel > oldLevel) {
                    showNotification(` LEVEL UP! You're now level ${newLevel}!`, 'success');
                    createConfetti();
                  }
                }
                
                result = `<span style="color:var(--success)">Gave ${amount} XP to ${targetName} (Now Level ${calculateLevel(newXp).level})</span>`;
                logAdminAction(`Gave ${amount} XP to ${targetName}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
                       case '/givecoins':
            if (args.length < 2) {
              result = "Usage: /givecoins [username] [amount]";
            } else {
              let targetName = args[0];
              let amount = parseInt(args[1]);
              
              // No limit for admin commands!
              let targetUser = await findUserByName(targetName);
              
              if (targetUser) {
                let newCoins = (targetUser.data.coins || 0) + amount;
                await db.collection("users").doc(targetUser.id).update({ coins: newCoins });
                
                // If giving to yourself, update local profile too
                if (targetUser.id === userId) {
                  myProfile.coins = newCoins;
                  document.getElementById("coinsDisplay").textContent = newCoins;
                  document.getElementById("shopCoinsDisplay").textContent = newCoins;
                }
                
                result = `<span style="color:var(--success)">Gave ${amount} coins to ${targetName}</span>`;
                logAdminAction(`Gave ${amount} coins to ${targetName}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
         
         
            case '/giveitem':
            if (args.length < 2) {
              result = "Usage: /giveitem [username] [itemid]<br>Use /items to see item IDs";
            } else {
              let targetName = args[0];
              let itemId = args[1];
              let item = shopItems.find(i => i.id === itemId);
              
              if (!item) {
                result = `<span style="color:var(--danger)">Item not found. Use /items to see IDs</span>`;
                break;
              }
              
              let targetUser = await findUserByName(targetName);
              
              if (targetUser) {
                let inv = targetUser.data.inventory || [];
                if (!inv.includes(itemId)) {
                  inv.push(itemId);
                  await db.collection("users").doc(targetUser.id).update({ inventory: inv });
                  result = `<span style="color:var(--success)">Gave ${item.name} to ${targetName}</span>`;
                  logAdminAction(`Gave ${item.name} to ${targetName}`);
                } else {
                  result = `<span style="color:var(--warning)">User already owns this item</span>`;
                }
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/giveall':
            let allItemIds = shopItems.map(i => i.id);
            myProfile.inventory = allItemIds;
            await db.collection("users").doc(userId).update({ inventory: allItemIds });
            updateInventory();
            result = `<span style="color:var(--success)">Gave yourself all ${allItemIds.length} items!</span>`;
            logAdminAction(`Gave themselves all items`);
            break;
            
          case '/ban':
            if (args.length < 1) {
              result = "Usage: /ban [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ banned: true });
                result = `<span style="color:var(--success)">Banned ${args[0]}</span>`;
                logAdminAction(`Banned ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/tempban':
            if (args.length < 2) {
              result = "Usage: /tempban [username] [hours]";
            } else {
              let hours = parseInt(args[1]);
              let until = Date.now() + (hours * 60 * 60 * 1000);
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ tempBanUntil: until });
                result = `<span style="color:var(--success)">Temp banned ${args[0]} for ${hours} hours</span>`;
                logAdminAction(`Temp banned ${args[0]} for ${hours} hours`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/unban':
            if (args.length < 1) {
              result = "Usage: /unban [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ banned: false, tempBanUntil: null });
                result = `<span style="color:var(--success)">Unbanned ${args[0]}</span>`;
                logAdminAction(`Unbanned ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/mute':
            if (args.length < 1) {
              result = "Usage: /mute [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ muted: true });
                result = `<span style="color:var(--success)">Muted ${args[0]}</span>`;
                logAdminAction(`Muted ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/unmute':
            if (args.length < 1) {
              result = "Usage: /unmute [username]";
            } else {
              let targetUser = await findUserByName(args[0]);
              if (targetUser) {
                await db.collection("users").doc(targetUser.id).update({ muted: false });
                result = `<span style="color:var(--success)">Unmuted ${args[0]}</span>`;
                logAdminAction(`Unmuted ${args[0]}`);
              } else {
                result = `<span style="color:var(--danger)">User not found</span>`;
              }
            }
            break;
            
          case '/announce':
            if (args.length < 1) {
              result = "Usage: /announce [message]";
            } else {
              let msg = args.join(' ');
              await db.collection("settings").doc("announcement").set({ text: msg, timestamp: Date.now() });
              result = `<span style="color:var(--success)">Announcement set!</span>`;
              logAdminAction(`Set announcement: ${msg}`);
            }
            break;
            
          case '/clearchat':
            let chats = await db.collection("chat").get();
            let batch = db.batch();
            chats.forEach(doc => batch.delete(doc.ref));
            await batch.commit();
            result = `<span style="color:var(--success)">Chat cleared!</span>`;
            logAdminAction(`Cleared all chat`);
            break;
            
          case '/stats':
            let users = await db.collection("users").get();
            let messages = await db.collection("chat").get();
            let totalCoins = 0;
            users.forEach(doc => totalCoins += (doc.data().coins || 0));
            result = `<strong>Site Stats:</strong><br>`;
            result += `Users: ${users.size}<br>`;
            result += `Messages: ${messages.size}<br>`;
            result += `Total Coins: ${totalCoins}`;
            break;
            
          case '/items':
            result = "<strong>Shop Items:</strong><br>";
            shopItems.forEach(item => {
              result += `${item.icon} ${item.id} - ${item.name}<br>`;
            });
            break;
            
          default:
            result = `<span style="color:var(--danger)">Unknown command. Use /help</span>`;
        }
      } catch (error) {
        result = `<span style="color:var(--danger)">Error: ${error.message}</span>`;
      }
      
      output.innerHTML = result;
      document.getElementById("adminCmd").value = "";
    }

    async function findUserByName(username) {
      let snapshot = await db.collection("users").get();
      let found = null;
      
      snapshot.forEach(doc => {
        let displayName = getDisplayName(doc.data().username);
        if (displayName.toLowerCase() === username.toLowerCase()) {
          found = { id: doc.id, data: doc.data() };
        }
      });
      
      return found;
    }

    async function logAdminAction(action) {
      await db.collection("auditLog").add({
        adminId: userId,
        adminName: getDisplayName(myProfile.username),
        action: action,
        timestamp: Date.now()
      });
      
      loadAuditLog();
    }

    async function loadAuditLog() {
      if (!isAdmin) return;
      
      let logs = await db.collection("auditLog")
        .orderBy("timestamp", "desc")
        .limit(20)
        .get();
      
      let html = "";
      logs.forEach(doc => {
        let log = doc.data();
        let time = new Date(log.timestamp).toLocaleString();
        html += `<div class="audit-item">`;
        html += `<span class="audit-admin">${log.adminName}</span>: `;
        html += `<span class="audit-action">${log.action}</span><br>`;
        html += `<span class="audit-time">${time}</span>`;
        html += `</div>`;
      });
      
      document.getElementById("auditLog").innerHTML = html || '<p style="color:var(--text-muted);">No actions yet.</p>';
    }

       // ===== TAB CLOAK =====
    const cloakPresets = {
      classroom: { title: 'Google Classroom', icon: 'https://www.google.com/s2/favicons?domain=classroom.google.com&sz=64' },
      docs: { title: 'Google Docs', icon: 'https://www.google.com/s2/favicons?domain=docs.google.com&sz=64' },
      drive: { title: 'Google Drive', icon: 'https://www.google.com/s2/favicons?domain=drive.google.com&sz=64' },
      gmail: { title: 'Gmail', icon: 'https://www.google.com/s2/favicons?domain=gmail.com&sz=64' },
      canvas: { title: 'Canvas', icon: 'https://www.google.com/s2/favicons?domain=instructure.com&sz=64' },
      khan: { title: 'Khan Academy', icon: 'https://www.google.com/s2/favicons?domain=khanacademy.org&sz=64' }
    };

    function setCloakPreset(preset) {
      let p = cloakPresets[preset];
      if (p) {
        applyCloak(p.title, p.icon);
        
        // Fill in the custom fields too
        document.getElementById("customCloakTitle").value = p.title;
        document.getElementById("customCloakIcon").value = p.icon;
        
        showNotification(`Tab disguised as ${p.title}`, 'success');
        playSound('click');
      }
    }

    function applyCustomCloak() {
      let title = document.getElementById("customCloakTitle").value.trim();
      let icon = document.getElementById("customCloakIcon").value.trim();
      
      if (!title) {
        showNotification("Enter a title!", 'warning');
        return;
      }
      
      // Default icon if none provided
      if (!icon) {
        icon = 'https://www.google.com/s2/favicons?domain=google.com&sz=64';
      }
      
      applyCloak(title, icon);
      showNotification(`Tab disguised as "${title}"`, 'success');
      playSound('click');
    }

    function applyCloak(title, icon) {
      document.title = title;
      document.getElementById("favicon").href = icon;
      
      // Save for auto-apply
      localStorage.setItem("cloakTitle", title);
      localStorage.setItem("cloakIcon", icon);
    }

    function resetCloak() {
      document.title = "The Gaming Hub";
      document.getElementById("favicon").href = "";
      
      document.getElementById("customCloakTitle").value = "";
      document.getElementById("customCloakIcon").value = "";
      
      localStorage.removeItem("cloakTitle");
      localStorage.removeItem("cloakIcon");
      
      showNotification("Tab cloak removed", 'success');
      playSound('click');
    }

    function saveAutoCloak() {
      let enabled = document.getElementById("autoCloakEnabled").checked;
      localStorage.setItem("autoCloakEnabled", enabled);
    }

    function loadCloak() {
      let autoEnabled = localStorage.getItem("autoCloakEnabled") === 'true';
      
      if (document.getElementById("autoCloakEnabled")) {
        document.getElementById("autoCloakEnabled").checked = autoEnabled;
      }
      
      if (autoEnabled) {
        let savedTitle = localStorage.getItem("cloakTitle");
        let savedIcon = localStorage.getItem("cloakIcon");
        
        if (savedTitle) {
          document.title = savedTitle;
          if (document.getElementById("customCloakTitle")) {
            document.getElementById("customCloakTitle").value = savedTitle;
          }
        }
        if (savedIcon) {
          document.getElementById("favicon").href = savedIcon;
          if (document.getElementById("customCloakIcon")) {
            document.getElementById("customCloakIcon").value = savedIcon;
          }
        }
      }
    }

    function openInAboutBlank() {
      let win = window.open('about:blank', '_blank');
      
      if (!win) {
        showNotification("Pop-up blocked! Allow pop-ups for this site.", 'warning');
        return;
      }
      
      win.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
          <title>${document.getElementById("customCloakTitle").value || 'Google Classroom'}</title>
          <link rel="icon" href="${document.getElementById("customCloakIcon").value || 'https://www.google.com/s2/favicons?domain=classroom.google.com&sz=64'}">
          <style>
            body { margin: 0; overflow: hidden; }
            iframe { width: 100vw; height: 100vh; border: none; }
          </style>
        </head>
        <body>
          <iframe src="${window.location.href}"></iframe>
        </body>
        </html>
      `);
      win.document.close();
      
      // Optionally close this tab or redirect
      showNotification("Opened in about:blank! You can close this tab.", 'success');
    }

    // Remove or comment out these old functions if they exist:
    // function openCloakModal() { ... }
    // function closeCloakModal() { ... }
    // ===== PARTICLES =====
   
   
    function changeParticles(type) {
      let container = document.getElementById("particles-container");
      container.innerHTML = "";
      
      localStorage.setItem("particles", type);
      
      if (type === 'none') return;
      
      for (let i = 0; i < 50; i++) {
        setTimeout(() => {
          let particle = document.createElement("div");
          particle.className = `particle ${type}`;
          particle.style.left = Math.random() * 100 + 'vw';
          particle.style.animationDuration = (Math.random() * 5 + 5) + 's';
          particle.style.animationDelay = (Math.random() * 5) + 's';
          
          if (type === 'confetti') {
            particle.style.background = `hsl(${Math.random() * 360}, 100%, 50%)`;
          } else if (type === 'hearts') {
            particle.textContent = '';
          }
          
          container.appendChild(particle);
        }, i * 100);
      }
    }

    // ===== THEMES =====
    function changeTheme(theme) {
      document.body.dataset.theme = theme;
      localStorage.setItem("theme", theme);
    }

    function changeFont(font) {
      document.body.className = `font-${font}`;
      localStorage.setItem("font", font);
    }

    function toggleCompactMode() {
      let compact = document.getElementById("compactMode").checked;
      document.body.classList.toggle("compact-mode", compact);
      localStorage.setItem("compactMode", compact);
    }

    // ===== SETTINGS =====
    function setCustomBg() {
      let url = document.getElementById("bgUrl").value.trim();
      if (url) {
        document.getElementById("customBg").style.backgroundImage = `url(${url})`;
        localStorage.setItem("customBg", url);
        showNotification("Background set!", 'success');
      }
    }

    function clearCustomBg() {
      document.getElementById("customBg").style.backgroundImage = '';
      document.getElementById("bgUrl").value = '';
      localStorage.removeItem("customBg");
    }

    function toggleSound() {
      soundEnabled = !soundEnabled;
      localStorage.setItem("soundEnabled", soundEnabled);
      document.getElementById("soundToggle").textContent = soundEnabled ? '' : '';
      document.getElementById("soundToggle").classList.toggle("muted", !soundEnabled);
      document.getElementById("soundEnabled").checked = soundEnabled;
    }

    function toggleSoundSetting() {
      soundEnabled = document.getElementById("soundEnabled").checked;
      localStorage.setItem("soundEnabled", soundEnabled);
      document.getElementById("soundToggle").textContent = soundEnabled ? '' : '';
    }

    function saveSettings() {
      notifSound = document.getElementById("notifSound").checked;
      localStorage.setItem("notifSound", notifSound);
    }

    let panicUrl = localStorage.getItem("panicUrl") || "https://classroom.google.com";

    function savePanicUrl() {
      panicUrl = document.getElementById("panicUrl").value;
      localStorage.setItem("panicUrl", panicUrl);
      showNotification("Panic URL saved!", 'success');
    }

    // Panic button
    document.addEventListener("keydown", function(e) {
      if (e.key === "`") {
        e.preventDefault();
        window.location.href = panicUrl;
      }
    });

    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
      document.querySelectorAll(".page").forEach(p => p.style.display = "none");
      document.getElementById(pageId).style.display = "block";
      playSound('click');
      window.scrollTo(0, 0);
    }

    // ===== SIDEBAR =====
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("open");
      document.querySelector(".sidebar-toggle").textContent = document.getElementById("sidebar").classList.contains("open") ? "" : "";
      playSound('click');
    }

function showSidebarTab(tabId, btn) {
  document.querySelectorAll(".sidebar-panel").forEach(p => p.classList.remove("active"));
  document.querySelectorAll(".sidebar-tab").forEach(t => t.classList.remove("active"));
  document.getElementById(tabId).classList.add("active");
  btn.classList.add("active");
  
  try {
    if (tabId === "adminTab") loadAuditLog();
    if (tabId === "onlineTab") loadOnlineUsers();
    if (tabId === "achievementsTab") renderAchievements('all');
    if (tabId === "musicTab") renderMusicPlaylist();
  } catch(e) {
    console.error("Tab error:", e);
  }
  
  playSound('click');
}

    // ===== PROFILE MODAL =====
    async function viewProfile(uid) {
      let doc = await db.collection("users").doc(uid).get();
      if (!doc.exists) return;
      
      let user = doc.data();
      let { level } = calculateLevel(user.xp || 0);
      
      document.getElementById("modalProfilePic").src = user.pic;
      document.getElementById("modalProfileName").textContent = getDisplayName(user.username);
      document.getElementById("modalProfileRole").textContent = getRole(user.username);
      document.getElementById("modalProfileLevel").textContent = `LVL ${level}`;
      document.getElementById("modalProfileBio").textContent = user.bio || "No bio";
      
      if (user.equippedBanner) {
        document.getElementById("modalProfileBanner").style.backgroundImage = `url(${user.equippedBanner})`;
      }
      
      document.getElementById("modalProfileStats").innerHTML = `
        <div class="profile-modal-stat">
          <div class="profile-modal-stat-num">${user.gamesPlayed || 0}</div>
          <div class="profile-modal-stat-label">Games</div>
        </div>
        <div class="profile-modal-stat">
          <div class="profile-modal-stat-num">${(user.friends || []).length}</div>
          <div class="profile-modal-stat-label">Friends</div>
        </div>
        <div class="profile-modal-stat">
          <div class="profile-modal-stat-num">${user.messagesSent || 0}</div>
          <div class="profile-modal-stat-label">Messages</div>
        </div>
      `;
      
      let actions = "";
      if (uid !== userId) {
        let isFriend = (myProfile?.friends || []).includes(uid);
        actions += `<button class="sidebar-btn sidebar-btn-blue" onclick="openDmWith('${uid}'); closeProfileModal();"> Message</button>`;
        actions += isFriend 
          ? `<button class="sidebar-btn sidebar-btn-red" onclick="removeFriend('${uid}'); closeProfileModal();">Remove</button>`
          : `<button class="sidebar-btn sidebar-btn-green" onclick="sendFriendRequest('${uid}'); closeProfileModal();">Add Friend</button>`;
      }
      document.getElementById("modalProfileActions").innerHTML = actions;
      
      document.getElementById("profileModal").classList.add("open");
    }

    function closeProfileModal() {
      document.getElementById("profileModal").classList.remove("open");
    }

    function viewTeamProfile(name) {
      db.collection("users").get().then(snapshot => {
        snapshot.forEach(doc => {
          if (getDisplayName(doc.data().username).toLowerCase() === name.toLowerCase()) {
            viewProfile(doc.id);
          }
        });
      });
    }

    // ===== FRIENDS =====
    async function sendFriendRequest(targetId) {
      let targetDoc = await db.collection("users").doc(targetId).get();
      if (!targetDoc.exists) return;
      
      let requests = targetDoc.data().friendRequests || [];
      if (!requests.includes(userId)) {
        requests.push(userId);
        await db.collection("users").doc(targetId).update({ friendRequests: requests });
        showNotification("Friend request sent!", 'success');
      }
    }

    async function loadFriendRequests() {
      if (!myProfile?.friendRequests?.length) {
        document.getElementById("friendRequests").innerHTML = '<p style="color:var(--text-muted);">No pending requests.</p>';
        return;
      }
      
      let html = "";
      for (let reqId of myProfile.friendRequests) {
        let doc = await db.collection("users").doc(reqId).get();
        if (doc.exists) {
          let user = doc.data();
          html += `<div class="friend-card">
            <img src="${user.pic}">
            <div class="friend-card-info">
              <div class="friend-card-name">${getDisplayName(user.username)}</div>
            </div>
            <button class="friend-btn sidebar-btn-green" onclick="acceptFriend('${reqId}')"></button>
            <button class="friend-btn sidebar-btn-red" onclick="declineFriend('${reqId}')"></button>
          </div>`;
        }
      }
      document.getElementById("friendRequests").innerHTML = html;
    }

    async function acceptFriend(reqId) {
      let myFriends = myProfile.friends || [];
      myFriends.push(reqId);
      
      let myRequests = myProfile.friendRequests || [];
      myRequests = myRequests.filter(r => r !== reqId);
      
      myProfile.friends = myFriends;
      myProfile.friendRequests = myRequests;
      
      await db.collection("users").doc(userId).update({ friends: myFriends, friendRequests: myRequests });
      
      let reqDoc = await db.collection("users").doc(reqId).get();
      if (reqDoc.exists) {
        let theirFriends = reqDoc.data().friends || [];
        theirFriends.push(userId);
        await db.collection("users").doc(reqId).update({ friends: theirFriends });
      }
      
      showNotification("Friend added!", 'success');
      updateProfileDisplay();
   
    trackFriendAdded();
    
    }

    async function declineFriend(reqId) {
      let myRequests = myProfile.friendRequests.filter(r => r !== reqId);
      myProfile.friendRequests = myRequests;
      await db.collection("users").doc(userId).update({ friendRequests: myRequests });
      updateProfileDisplay();
    }

    async function loadFriends() {
      if (!myProfile?.friends?.length) {
        document.getElementById("friendsList").innerHTML = '<p style="color:var(--text-muted);">No friends yet.</p>';
        return;
      }
      
      let html = "";
      for (let friendId of myProfile.friends) {
        let doc = await db.collection("users").doc(friendId).get();
        if (doc.exists) {
          let friend = doc.data();
          let online = isUserOnline(friend.lastSeen);
          html += `<div class="friend-card" onclick="viewProfile('${friendId}')">
            <img src="${friend.pic}">
            <div class="friend-card-info">
              <div class="friend-card-name">${online ? '<span class="status-dot status-online"></span>' : '<span class="status-dot status-offline"></span>'}${getDisplayName(friend.username)}</div>
              <div class="friend-card-status">${friend.status || ''}</div>
            </div>
            <button class="friend-btn sidebar-btn-blue" onclick="event.stopPropagation(); openDmWith('${friendId}')"></button>
          </div>`;
        }
      }
      document.getElementById("friendsList").innerHTML = html;
    }

    async function removeFriend(friendId) {
      myProfile.friends = myProfile.friends.filter(f => f !== friendId);
      await db.collection("users").doc(userId).update({ friends: myProfile.friends });
      
      let friendDoc = await db.collection("users").doc(friendId).get();
      if (friendDoc.exists) {
        let theirFriends = friendDoc.data().friends.filter(f => f !== userId);
        await db.collection("users").doc(friendId).update({ friends: theirFriends });
      }
      
      updateProfileDisplay();
    }

    // ===== ONLINE USERS =====
    async function loadOnlineUsers() {
      let snapshot = await db.collection("users").get();
      let online = [], offline = [];
      
      snapshot.forEach(doc => {
        let user = { id: doc.id, ...doc.data() };
        if (isUserOnline(user.lastSeen)) online.push(user);
        else offline.push(user);
      });
      
      let html = "";
      online.forEach(user => {
        html += `<div class="friend-card" onclick="viewProfile('${user.id}')">
          <img src="${user.pic}">
          <div class="friend-card-info">
            <div class="friend-card-name"><span class="status-dot status-online"></span>${getDisplayName(user.username)}</div>
          </div>
        </div>`;
      });
      document.getElementById("onlineUsersList").innerHTML = html || '<p style="color:var(--text-muted);">No one online</p>';
      document.getElementById("onlineCountSidebar").textContent = `${online.length} online`;
      document.getElementById("onlineCount").textContent = `${online.length} online`;
      document.getElementById("statOnlineNow").textContent = online.length;
    }

    // ===== SEARCH =====
    async function searchUsers() {
      let query = document.getElementById("userSearch").value.toLowerCase().trim();
      if (!query) {
        document.getElementById("userSearchResults").innerHTML = "";
        return;
      }
      
      let snapshot = await db.collection("users").limit(10).get();
      let html = "";
      
      snapshot.forEach(doc => {
        let user = doc.data();
        let name = getDisplayName(user.username);
        if (name.toLowerCase().includes(query) && doc.id !== userId) {
          html += `<div class="friend-card" onclick="viewProfile('${doc.id}')">
            <img src="${user.pic}">
            <div class="friend-card-info">
              <div class="friend-card-name">${name}</div>
            </div>
          </div>`;
        }
      });
      
      document.getElementById("userSearchResults").innerHTML = html || '<p style="color:var(--text-muted);">No users found.</p>';
    }

    // ===== FAVORITES =====
    let favorites = JSON.parse(localStorage.getItem("favorites")) || [];

    function toggleFavorite(starEl) {
      let card = starEl.closest('.game-card');
      let name = card.dataset.game;
      let link = card.closest('.game-link').href;
      
      let idx = favorites.findIndex(f => f.name === name);
      if (idx === -1) {
        favorites.push({ name, url: link });
        starEl.textContent = "";
        starEl.classList.add("favorited");
      } else {
        favorites.splice(idx, 1);
        starEl.textContent = "";
        starEl.classList.remove("favorited");
      }
      
      localStorage.setItem("favorites", JSON.stringify(favorites));
      playSound('click');
    
    trackFavorites();
    }

    function clearFavorites() {
      favorites = [];
      localStorage.removeItem("favorites");
      showNotification("Favorites cleared!", 'success');
    }

    function playRandomGame() {
      let allGames = document.querySelectorAll('.game-link');
      let random = allGames[Math.floor(Math.random() * allGames.length)];
      if (random) {
        window.open(random.href, '_blank');
        earnCoinsFromGame('Random Game');
      }
    }

    // ===== GAME DATA =====
    const gameData = [
      { name: "Classroom Resources", url: "https://sites.google.com/view/drive-u-7-home/home", icon: "" },
      { name: "Game Compilation", url: "https://sites.google.com/site/thegamecompilation/home", icon: "" },
      { name: "Unblocked Games Top", url: "https://sites.google.com/site/unblockedgamestop", icon: "" },
      { name: "WatchDocumentaries Games", url: "https://watchdocumentaries.com/games", icon: "" },
      { name: "MSN Play", url: "https://www.msn.com/en-us/play", icon: "" },
      { name: "Unblocked Games Mix", url: "https://www.symbaloo.com/mix/newunblockedgames", icon: "" },
      { name: "Unblocked Games 77", url: "https://sites.google.com/site/unblockedgames77", icon: "7" },
      { name: "Unblocked Games 76", url: "https://www.symbaloo.com/mix/agariounblockedschool", icon: "" },
      { name: "Hooda Math Games", url: "https://www.hoodamath.com/Games", icon: "" },
      { name: "Cool Math Games", url: "https://www.coolmathgames.com", icon: "" },
      { name: "Friv Games", url: "https://www.friv.com", icon: "" }
    ];

    function renderGameCards() {
      let container = document.getElementById("gamesPage1");
      let allContainer = document.getElementById("allGamesList");
      
      let html = "";
      gameData.forEach(game => {
        let isFav = favorites.some(f => f.name === game.name);
        html += `<a href="${game.url}" target="_blank" class="game-link" onclick="earnCoinsFromGame('${game.name}')">
          <div class="game-card" data-game="${game.name}">
            <span class="fav-star ${isFav ? 'favorited' : ''}" onclick="event.preventDefault(); event.stopPropagation(); toggleFavorite(this);">${isFav ? '' : ''}</span>
            <div class="game-thumbnail">${game.icon}</div>
            <div class="game-info"><h3>${game.name}</h3></div>
          </div>
        </a>`;
      });
      
      if (container) container.innerHTML = html;
      if (allContainer) allContainer.innerHTML = html;
      document.getElementById("statTotalGames").textContent = gameData.length;
    }

    // ===== RESET ACCOUNT =====
    async function resetAccount() {
      if (!confirm("Delete your account? This cannot be undone!")) return;
      if (!confirm("LAST CHANCE! Are you sure?")) return;
      
      await db.collection("users").doc(userId).delete();
      localStorage.clear();
      location.reload();
    }

    // ===== ANNOUNCEMENTS =====
    function loadAnnouncement() {
      db.collection("settings").doc("announcement").onSnapshot(doc => {
        let banner = document.getElementById("announcementBanner");
        if (doc.exists && doc.data().text) {
          banner.textContent = " " + doc.data().text;
          banner.classList.add("show");
        } else {
          banner.classList.remove("show");
        }
      });
    }

    async function setAnnouncement() {
      if (!isAdmin) return;
      let text = document.getElementById("announcementInput").value.trim();
      if (!text) return;
      await db.collection("settings").doc("announcement").set({ text, timestamp: Date.now() });
      document.getElementById("announcementInput").value = "";
      logAdminAction(`Set announcement: ${text}`);
    }

    async function clearAnnouncement() {
      if (!isAdmin) return;
      await db.collection("settings").doc("announcement").delete();
      logAdminAction("Cleared announcement");
    }

// ===== MUSIC PLAYER =====
let musicPlaylist = JSON.parse(localStorage.getItem("musicPlaylist")) || [];
let musicCurrentIndex = -1;
let musicAudio = new Audio();
let musicIsPlaying = false;
let musicRepeat = false;
let musicShuffle = false;

musicAudio.volume = 0.5;

musicAudio.addEventListener('timeupdate', updateMusicProgress);
musicAudio.addEventListener('ended', handleSongEnd);
musicAudio.addEventListener('loadedmetadata', () => {
  document.getElementById("musicDuration").textContent = formatMusicTime(musicAudio.duration);
});

musicAudio.addEventListener('error', () => {
  document.getElementById("musicSongStatus").textContent = " Error loading audio";
  document.getElementById("musicSongStatus").style.color = "var(--danger)";
});



function formatMusicTime(seconds) {
  if (isNaN(seconds)) return "0:00";
  let mins = Math.floor(seconds / 60);
  let secs = Math.floor(seconds % 60);
  return `${mins}:${secs.toString().padStart(2, '0')}`;
}

function updateMusicProgress() {
  if (musicAudio.duration) {
    let percent = (musicAudio.currentTime / musicAudio.duration) * 100;
    document.getElementById("musicProgressFill").style.width = percent + "%";
    document.getElementById("musicCurrentTime").textContent = formatMusicTime(musicAudio.currentTime);
  }
}

function seekMusic(event) {
  if (!musicAudio.duration) return;
  let bar = document.getElementById("musicProgressBar");
  let rect = bar.getBoundingClientRect();
  let percent = (event.clientX - rect.left) / rect.width;
  musicAudio.currentTime = percent * musicAudio.duration;
}

function handleSongEnd() {
  if (musicRepeat) {
    musicAudio.currentTime = 0;
    musicAudio.play();
  } else if (musicShuffle) {
    let randomIndex;
    do {
      randomIndex = Math.floor(Math.random() * musicPlaylist.length);
    } while (randomIndex === musicCurrentIndex && musicPlaylist.length > 1);
    playSongAtIndex(randomIndex);
  } else {
    nextSong();
  }
}

function addSong() {
  let urlInput = document.getElementById("musicUrlInput");
  let nameInput = document.getElementById("musicSongName");
  let url = urlInput.value.trim();
  let name = nameInput.value.trim();

  if (!url) {
    showNotification("Paste an audio URL!", 'warning');
    return;
  }

  if (!name) {
    // Extract name from URL
    try {
      let parts = url.split('/');
      name = decodeURIComponent(parts[parts.length - 1].split('?')[0]);
      if (name.length > 50) name = name.substring(0, 50);
      if (!name) name = "Song " + (musicPlaylist.length + 1);
    } catch (e) {
      name = "Song " + (musicPlaylist.length + 1);
    }
  }

  musicPlaylist.push({ name: name, url: url });
  localStorage.setItem("musicPlaylist", JSON.stringify(musicPlaylist));

  urlInput.value = "";
  nameInput.value = "";

  renderMusicPlaylist();
  showNotification(`Added "${name}" to playlist!`, 'success');
  playSound('click');

  // Auto-play if it's the first song
  if (musicPlaylist.length === 1) {
    playSongAtIndex(0);
  }
}

function removeSong(index) {
  let wasPlaying = index === musicCurrentIndex;

  musicPlaylist.splice(index, 1);
  localStorage.setItem("musicPlaylist", JSON.stringify(musicPlaylist));

  if (wasPlaying) {
    musicAudio.pause();
    musicIsPlaying = false;
    document.getElementById("musicPlayBtn").textContent = "";

    if (musicPlaylist.length > 0) {
      let newIndex = index >= musicPlaylist.length ? 0 : index;
      playSongAtIndex(newIndex);
    } else {
      musicCurrentIndex = -1;
      document.getElementById("musicSongTitle").textContent = "No song playing";
      document.getElementById("musicSongStatus").textContent = "Add songs to get started";
      document.getElementById("musicProgressFill").style.width = "0%";
      document.getElementById("musicCurrentTime").textContent = "0:00";
      document.getElementById("musicDuration").textContent = "0:00";
    }
  } else if (index < musicCurrentIndex) {
    musicCurrentIndex--;
  }

  renderMusicPlaylist();
  playSound('click');
}

function playSongAtIndex(index) {
  if (index < 0 || index >= musicPlaylist.length) return;

  musicCurrentIndex = index;
  let song = musicPlaylist[index];

  musicAudio.src = song.url;
  musicAudio.play().then(() => {
    musicIsPlaying = true;
    document.getElementById("musicPlayBtn").textContent = "";
    document.getElementById("musicSongTitle").textContent = song.name;
    document.getElementById("musicSongStatus").textContent = `Playing  ${index + 1}/${musicPlaylist.length}`;
    document.getElementById("musicSongStatus").style.color = "#1db954";
    renderMusicPlaylist();
  }).catch(e => {
    console.error("Music play error:", e);
    document.getElementById("musicSongStatus").textContent = " Couldn't play this URL";
    document.getElementById("musicSongStatus").style.color = "var(--danger)";
  });
}

function togglePlayPause() {
  if (musicPlaylist.length === 0) {
    showNotification("Add songs first!", 'warning');
    return;
  }

  if (musicCurrentIndex === -1) {
    playSongAtIndex(0);
    return;
  }

  if (musicIsPlaying) {
    musicAudio.pause();
    musicIsPlaying = false;
    document.getElementById("musicPlayBtn").textContent = "";
    document.getElementById("musicSongStatus").textContent = "Paused";
    document.getElementById("musicSongStatus").style.color = "var(--text-muted)";
  } else {
    musicAudio.play().then(() => {
      musicIsPlaying = true;
      document.getElementById("musicPlayBtn").textContent = "";
      document.getElementById("musicSongStatus").textContent = `Playing  ${musicCurrentIndex + 1}/${musicPlaylist.length}`;
      document.getElementById("musicSongStatus").style.color = "#1db954";
    }).catch(e => {
      console.error("Play error:", e);
    });
  }
}

function nextSong() {
  if (musicPlaylist.length === 0) return;

  let nextIndex;
  if (musicShuffle) {
    do {
      nextIndex = Math.floor(Math.random() * musicPlaylist.length);
    } while (nextIndex === musicCurrentIndex && musicPlaylist.length > 1);
  } else {
    nextIndex = (musicCurrentIndex + 1) % musicPlaylist.length;
  }

  playSongAtIndex(nextIndex);
}

function prevSong() {
  if (musicPlaylist.length === 0) return;

  // If more than 3 seconds in, restart current song
  if (musicAudio.currentTime > 3) {
    musicAudio.currentTime = 0;
    return;
  }

  let prevIndex = (musicCurrentIndex - 1 + musicPlaylist.length) % musicPlaylist.length;
  playSongAtIndex(prevIndex);
}

function toggleRepeat() {
  musicRepeat = !musicRepeat;
  document.getElementById("repeatBtn").classList.toggle("active", musicRepeat);
  showNotification(musicRepeat ? "Repeat ON" : "Repeat OFF", 'info');
  playSound('click');
}

function toggleShuffle() {
  musicShuffle = !musicShuffle;
  document.getElementById("shuffleBtn").classList.toggle("active", musicShuffle);
  showNotification(musicShuffle ? "Shuffle ON" : "Shuffle OFF", 'info');
  playSound('click');
}

function changeVolume(value) {
  musicAudio.volume = value / 100;
  localStorage.setItem("musicVolume", value);
}

function renderMusicPlaylist() {
  let container = document.getElementById("musicPlaylist");

  if (musicPlaylist.length === 0) {
    container.innerHTML = '<p style="color: var(--text-muted); font-size: 12px; text-align: center;">No songs yet</p>';
    return;
  }

  let html = "";
  musicPlaylist.forEach((song, index) => {
    let isPlaying = index === musicCurrentIndex;
    html += `
      <div class="music-sidebar-playlist-item ${isPlaying ? 'playing' : ''}" onclick="playSongAtIndex(${index})">
        <span class="music-sidebar-playlist-item-num">${isPlaying ? '' : (index + 1)}</span>
        <span class="music-sidebar-playlist-item-name">${song.name}</span>
        <button class="music-sidebar-playlist-item-remove" onclick="event.stopPropagation(); removeSong(${index})" title="Remove"></button>
      </div>
    `;
  });

  container.innerHTML = html;
}




// Load saved volume
let savedVolume = localStorage.getItem("musicVolume");
if (savedVolume) {
  musicAudio.volume = savedVolume / 100;
  document.addEventListener('DOMContentLoaded', () => {
    let slider = document.getElementById("musicVolume");
    if (slider) slider.value = savedVolume;
  });
}

// Render playlist on load
document.addEventListener('DOMContentLoaded', () => {
  renderMusicPlaylist();
});

// ===== ACHIEVEMENTS SYSTEM =====
const ACHIEVEMENTS = [
  // Gaming achievements
  { id: 'first_game', name: 'First Steps', desc: 'Play your first game', icon: '', category: 'gaming', rarity: 'bronze', goal: 1, reward: { coins: 25, xp: 10 } },
  { id: 'games_10', name: 'Getting Started', desc: 'Play 10 games', icon: '', category: 'gaming', rarity: 'bronze', goal: 10, reward: { coins: 50, xp: 25 } },
  { id: 'games_50', name: 'Gamer', desc: 'Play 50 games', icon: '', category: 'gaming', rarity: 'silver', goal: 50, reward: { coins: 150, xp: 75 } },
  { id: 'games_100', name: 'Dedicated Gamer', desc: 'Play 100 games', icon: '', category: 'gaming', rarity: 'gold', goal: 100, reward: { coins: 300, xp: 150 } },
  { id: 'games_500', name: 'Gaming Legend', desc: 'Play 500 games', icon: '', category: 'gaming', rarity: 'platinum', goal: 500, reward: { coins: 1000, xp: 500 } },
  
  { id: 'flappy_10', name: 'Baby Bird', desc: 'Score 10 in Flappy Bird', icon: '', category: 'gaming', rarity: 'bronze', goal: 10, reward: { coins: 30, xp: 15 } },
  { id: 'flappy_25', name: 'Flying High', desc: 'Score 25 in Flappy Bird', icon: '', category: 'gaming', rarity: 'silver', goal: 25, reward: { coins: 75, xp: 40 } },
  { id: 'flappy_50', name: 'Sky Master', desc: 'Score 50 in Flappy Bird', icon: '', category: 'gaming', rarity: 'gold', goal: 50, reward: { coins: 200, xp: 100 } },
  
  { id: 'tetris_1000', name: 'Block Builder', desc: 'Score 1000 in Tetris', icon: '', category: 'gaming', rarity: 'bronze', goal: 1000, reward: { coins: 40, xp: 20 } },
  { id: 'tetris_5000', name: 'Tetris Pro', desc: 'Score 5000 in Tetris', icon: '', category: 'gaming', rarity: 'silver', goal: 5000, reward: { coins: 100, xp: 50 } },
  { id: 'tetris_10000', name: 'Tetris Master', desc: 'Score 10000 in Tetris', icon: '', category: 'gaming', rarity: 'gold', goal: 10000, reward: { coins: 250, xp: 125 } },
  
  { id: 'pong_win', name: 'Pong Champion', desc: 'Win a game of Pong', icon: '', category: 'gaming', rarity: 'bronze', goal: 1, reward: { coins: 50, xp: 25 } },
  { id: 'pong_wins_10', name: 'Pong Master', desc: 'Win 10 games of Pong', icon: '', category: 'gaming', rarity: 'silver', goal: 10, reward: { coins: 150, xp: 75 } },
  { id: 'pong_flawless', name: 'Flawless Victory', desc: 'Win Pong 7-0', icon: '', category: 'gaming', rarity: 'gold', goal: 1, reward: { coins: 200, xp: 100 } },
  
  { id: 'breakout_level_5', name: 'Brick Breaker', desc: 'Reach level 5 in Breakout', icon: '', category: 'gaming', rarity: 'silver', goal: 5, reward: { coins: 100, xp: 50 } },
  { id: 'breakout_level_10', name: 'Demolition Expert', desc: 'Reach level 10 in Breakout', icon: '', category: 'gaming', rarity: 'gold', goal: 10, reward: { coins: 250, xp: 125 } },
  
  { id: 'snake_50', name: 'Sneaky Snake', desc: 'Score 50 in Snake', icon: '', category: 'gaming', rarity: 'bronze', goal: 50, reward: { coins: 30, xp: 15 } },
  { id: 'snake_100', name: 'Slithering Pro', desc: 'Score 100 in Snake', icon: '', category: 'gaming', rarity: 'silver', goal: 100, reward: { coins: 80, xp: 40 } },
  
  { id: 'memory_20', name: 'Good Memory', desc: 'Complete Memory Match in under 20 moves', icon: '', category: 'gaming', rarity: 'silver', goal: 1, reward: { coins: 75, xp: 40 } },
  { id: 'memory_15', name: 'Perfect Memory', desc: 'Complete Memory Match in under 15 moves', icon: '', category: 'gaming', rarity: 'gold', goal: 1, reward: { coins: 150, xp: 75 } },
  
  { id: 'reach_2048', name: '2048!', desc: 'Reach 2048 tile in 2048', icon: '', category: 'gaming', rarity: 'gold', goal: 1, reward: { coins: 200, xp: 100 } },
  
  { id: 'casino_win', name: 'Lucky', desc: 'Win in the casino', icon: '', category: 'gaming', rarity: 'bronze', goal: 1, reward: { coins: 25, xp: 10 } },
  { id: 'casino_jackpot', name: 'JACKPOT!', desc: 'Hit a jackpot in slots', icon: '', category: 'gaming', rarity: 'platinum', goal: 1, reward: { coins: 500, xp: 250 } },
  
  // Social achievements
  { id: 'first_message', name: 'Hello World', desc: 'Send your first chat message', icon: '', category: 'social', rarity: 'bronze', goal: 1, reward: { coins: 15, xp: 5 } },
  { id: 'messages_50', name: 'Chatty', desc: 'Send 50 messages', icon: '', category: 'social', rarity: 'bronze', goal: 50, reward: { coins: 50, xp: 25 } },
  { id: 'messages_200', name: 'Social Butterfly', desc: 'Send 200 messages', icon: '', category: 'social', rarity: 'silver', goal: 200, reward: { coins: 100, xp: 50 } },
  { id: 'messages_500', name: 'Chatterbox', desc: 'Send 500 messages', icon: '', category: 'social', rarity: 'gold', goal: 500, reward: { coins: 200, xp: 100 } },
  { id: 'messages_1000', name: 'Legendary Talker', desc: 'Send 1000 messages', icon: '', category: 'social', rarity: 'platinum', goal: 1000, reward: { coins: 500, xp: 250 } },
  
  { id: 'first_friend', name: 'Friendly', desc: 'Add your first friend', icon: '', category: 'social', rarity: 'bronze', goal: 1, reward: { coins: 25, xp: 10 } },
  { id: 'friends_5', name: 'Popular', desc: 'Have 5 friends', icon: '', category: 'social', rarity: 'silver', goal: 5, reward: { coins: 75, xp: 40 } },
  { id: 'friends_10', name: 'Social Star', desc: 'Have 10 friends', icon: '', category: 'social', rarity: 'gold', goal: 10, reward: { coins: 150, xp: 75 } },
  { id: 'friends_25', name: 'Influencer', desc: 'Have 25 friends', icon: '', category: 'social', rarity: 'platinum', goal: 25, reward: { coins: 400, xp: 200 } },
  
  { id: 'set_bio', name: 'About Me', desc: 'Set your bio', icon: '', category: 'social', rarity: 'bronze', goal: 1, reward: { coins: 15, xp: 5 } },
  { id: 'set_pic', name: 'Picture Perfect', desc: 'Set a custom profile picture', icon: '', category: 'social', rarity: 'bronze', goal: 1, reward: { coins: 20, xp: 10 } },
  { id: 'set_status', name: 'Status Update', desc: 'Set your status', icon: '', category: 'social', rarity: 'bronze', goal: 1, reward: { coins: 15, xp: 5 } },
  
  // Wealth achievements
  { id: 'coins_100', name: 'Pocket Change', desc: 'Earn 100 coins total', icon: '', category: 'wealth', rarity: 'bronze', goal: 100, reward: { coins: 25, xp: 10 } },
  { id: 'coins_500', name: 'Saving Up', desc: 'Earn 500 coins total', icon: '', category: 'wealth', rarity: 'bronze', goal: 500, reward: { coins: 50, xp: 25 } },
  { id: 'coins_1000', name: 'Making Bank', desc: 'Earn 1000 coins total', icon: '', category: 'wealth', rarity: 'silver', goal: 1000, reward: { coins: 100, xp: 50 } },
  { id: 'coins_5000', name: 'Rich', desc: 'Earn 5000 coins total', icon: '', category: 'wealth', rarity: 'gold', goal: 5000, reward: { coins: 250, xp: 125 } },
  { id: 'coins_10000', name: 'Wealthy', desc: 'Earn 10000 coins total', icon: '', category: 'wealth', rarity: 'platinum', goal: 10000, reward: { coins: 500, xp: 250 } },
  
  { id: 'first_purchase', name: 'Shopper', desc: 'Buy your first item', icon: '', category: 'wealth', rarity: 'bronze', goal: 1, reward: { coins: 25, xp: 10 } },
  { id: 'purchases_5', name: 'Collector', desc: 'Buy 5 items', icon: '', category: 'wealth', rarity: 'silver', goal: 5, reward: { coins: 75, xp: 40 } },
  { id: 'purchases_15', name: 'Hoarder', desc: 'Buy 15 items', icon: '', category: 'wealth', rarity: 'gold', goal: 15, reward: { coins: 200, xp: 100 } },
  { id: 'purchases_all', name: 'Own Everything', desc: 'Buy all shop items', icon: '', category: 'wealth', rarity: 'diamond', goal: 1, reward: { coins: 1000, xp: 500 } },
  
  // Dedication achievements
  { id: 'level_5', name: 'Rising Star', desc: 'Reach level 5', icon: '', category: 'dedication', rarity: 'bronze', goal: 5, reward: { coins: 50, xp: 0 } },
  { id: 'level_10', name: 'Experienced', desc: 'Reach level 10', icon: '', category: 'dedication', rarity: 'silver', goal: 10, reward: { coins: 100, xp: 0 } },
  { id: 'level_25', name: 'Veteran', desc: 'Reach level 25', icon: '', category: 'dedication', rarity: 'gold', goal: 25, reward: { coins: 250, xp: 0 } },
  { id: 'level_50', name: 'Elite', desc: 'Reach level 50', icon: '', category: 'dedication', rarity: 'platinum', goal: 50, reward: { coins: 500, xp: 0 } },
  { id: 'level_100', name: 'Legendary', desc: 'Reach level 100', icon: '', category: 'dedication', rarity: 'diamond', goal: 100, reward: { coins: 2000, xp: 0 } },
  
  { id: 'streak_3', name: 'Consistent', desc: 'Visit 3 days in a row', icon: '', category: 'dedication', rarity: 'bronze', goal: 3, reward: { coins: 50, xp: 25 } },
  { id: 'streak_7', name: 'Dedicated', desc: 'Visit 7 days in a row', icon: '', category: 'dedication', rarity: 'silver', goal: 7, reward: { coins: 150, xp: 75 } },
  { id: 'streak_30', name: 'Committed', desc: 'Visit 30 days in a row', icon: '', category: 'dedication', rarity: 'gold', goal: 30, reward: { coins: 500, xp: 250 } },
  
  { id: 'xp_1000', name: 'XP Hunter', desc: 'Earn 1000 XP total', icon: '', category: 'dedication', rarity: 'bronze', goal: 1000, reward: { coins: 50, xp: 0 } },
  { id: 'xp_10000', name: 'XP Master', desc: 'Earn 10000 XP total', icon: '', category: 'dedication', rarity: 'silver', goal: 10000, reward: { coins: 150, xp: 0 } },
  { id: 'xp_50000', name: 'XP Legend', desc: 'Earn 50000 XP total', icon: '', category: 'dedication', rarity: 'gold', goal: 50000, reward: { coins: 400, xp: 0 } },
  
  { id: 'music_playlist', name: 'DJ', desc: 'Add 5 songs to your playlist', icon: '', category: 'dedication', rarity: 'bronze', goal: 5, reward: { coins: 30, xp: 15 } },
  { id: 'minigames_all', name: 'Jack of All Games', desc: 'Play all mini games', icon: '', category: 'dedication', rarity: 'silver', goal: 1, reward: { coins: 150, xp: 75 } },
  { id: 'favorites_5', name: 'Curator', desc: 'Favorite 5 games', icon: '', category: 'dedication', rarity: 'bronze', goal: 5, reward: { coins: 30, xp: 15 } }
];

let achievementProgress = {};
let unlockedAchievements = [];
let totalCoinsEarned = 0;
let totalXpEarned = 0;
let loginStreak = 0;
let gamesPlayedList = [];
let pongWins = 0;

// Load achievements from Firebase/localStorage
async function loadAchievements() {
  if (myProfile) {
    achievementProgress = myProfile.achievementProgress || {};
    unlockedAchievements = myProfile.unlockedAchievements || [];
    totalCoinsEarned = myProfile.totalCoinsEarned || 0;
    totalXpEarned = myProfile.totalXpEarned || 0;
    loginStreak = myProfile.loginStreak || 0;
    gamesPlayedList = myProfile.gamesPlayedList || [];
    pongWins = myProfile.pongWins || 0;
    
    // Check daily login streak
    checkLoginStreak();
  }
  
  updateAchievementBadge();
}

// Save achievements to Firebase
async function saveAchievements() {
  if (!myProfile) return;
  
  try {
    await db.collection("users").doc(userId).update({
      achievementProgress: achievementProgress,
      unlockedAchievements: unlockedAchievements,
      totalCoinsEarned: totalCoinsEarned,
      totalXpEarned: totalXpEarned,
      loginStreak: loginStreak,
      gamesPlayedList: gamesPlayedList,
      pongWins: pongWins,
      lastLoginDate: new Date().toDateString()
    });
  } catch (e) {
    console.error("Error saving achievements:", e);
  }
}

// Check login streak
function checkLoginStreak() {
  let today = new Date().toDateString();
  let lastLogin = myProfile.lastLoginDate;
  
  if (!lastLogin) {
    loginStreak = 1;
  } else {
    let lastDate = new Date(lastLogin);
    let todayDate = new Date(today);
    let diffTime = todayDate - lastDate;
    let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    if (diffDays === 1) {
      loginStreak++;
      showNotification(` ${loginStreak} day streak!`, 'success');
    } else if (diffDays > 1) {
      loginStreak = 1;
    }
    // If same day, keep streak as is
  }
  
  // Check streak achievements
  checkAchievement('streak_3', loginStreak);
  checkAchievement('streak_7', loginStreak);
  checkAchievement('streak_30', loginStreak);
  
  saveAchievements();
}



// Show achievement category
function showAchievementCategory(category, btn) {
  document.querySelectorAll('.achievements-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  renderAchievements(category);
}

// Render achievements list
function renderAchievements(category) {
  let list = document.getElementById("achievementsList");
  let filtered = category === 'all' 
    ? ACHIEVEMENTS 
    : ACHIEVEMENTS.filter(a => a.category === category);
  
  let unlocked = unlockedAchievements.length;
  let total = ACHIEVEMENTS.length;
  let percent = Math.round((unlocked / total) * 100);
  
  document.getElementById("achievementsUnlocked").textContent = unlocked;
  document.getElementById("achievementsTotal").textContent = total;
  document.getElementById("achievementsPercent").textContent = percent + '%';
  
  // Sort: unlocked first, then by rarity
  let rarityOrder = { diamond: 0, platinum: 1, gold: 2, silver: 3, bronze: 4 };
  
  filtered.sort((a, b) => {
    let aUnlocked = unlockedAchievements.includes(a.id);
    let bUnlocked = unlockedAchievements.includes(b.id);
    
    if (aUnlocked && !bUnlocked) return -1;
    if (!aUnlocked && bUnlocked) return 1;
    
    return rarityOrder[a.rarity] - rarityOrder[b.rarity];
  });
  
  let html = "";
  
  filtered.forEach(achievement => {
    let isUnlocked = unlockedAchievements.includes(achievement.id);
    let progress = achievementProgress[achievement.id] || 0;
    let progressPercent = Math.min((progress / achievement.goal) * 100, 100);
    
    html += `
      <div class="achievement-sidebar-card ${isUnlocked ? 'unlocked' : 'locked'}">
        <div class="achievement-sidebar-icon">${achievement.icon}</div>
        <div class="achievement-sidebar-content">
          <div class="achievement-sidebar-header">
            <span class="achievement-sidebar-name">${achievement.name}</span>
            <span class="achievement-sidebar-rarity rarity-${achievement.rarity}">${achievement.rarity}</span>
          </div>
          <div class="achievement-sidebar-desc">${achievement.desc}</div>
          
          ${!isUnlocked ? `
            <div class="achievement-sidebar-progress">
              <div class="achievement-sidebar-progress-fill" style="width: ${progressPercent}%"></div>
            </div>
            <div class="achievement-sidebar-progress-text">${progress} / ${achievement.goal}</div>
          ` : `
            <div class="achievement-sidebar-unlocked"> Unlocked</div>
          `}
          
          <div class="achievement-sidebar-reward">
            ${achievement.reward.coins > 0 ? ` ${achievement.reward.coins}` : ''}
            ${achievement.reward.xp > 0 ? `  ${achievement.reward.xp} XP` : ''}
          </div>
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html || '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No achievements yet!</p>';
}

    
    // Check and potentially unlock an achievement
function checkAchievement(achievementId, currentValue) {
  if (unlockedAchievements.includes(achievementId)) return;
  
  let achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
  if (!achievement) return;
  
  // Update progress
  achievementProgress[achievementId] = Math.max(
    achievementProgress[achievementId] || 0,
    currentValue
  );
  
  // Check if goal reached
  if (currentValue >= achievement.goal) {
    unlockAchievement(achievementId);
  }
  
  saveAchievements();
}

// Unlock an achievement
function unlockAchievement(achievementId) {
  if (unlockedAchievements.includes(achievementId)) return;
  
  let achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
  if (!achievement) return;
  
  unlockedAchievements.push(achievementId);
  achievementProgress[achievementId] = achievement.goal;
  
  // Show notification
  showAchievementNotification(achievement);
  
  // Give rewards (without triggering more achievement checks to avoid loops)
  if (achievement.reward.coins > 0) {
    myProfile.coins = (myProfile.coins || 0) + achievement.reward.coins;
    document.getElementById("coinsDisplay").textContent = myProfile.coins;
    document.getElementById("shopCoinsDisplay").textContent = myProfile.coins;
  }
  
  if (achievement.reward.xp > 0) {
    myProfile.xp = (myProfile.xp || 0) + achievement.reward.xp;
    updateXPBar();
  }
  
  // Save to Firebase
  db.collection("users").doc(userId).update({
    coins: myProfile.coins,
    xp: myProfile.xp,
    unlockedAchievements: unlockedAchievements,
    achievementProgress: achievementProgress
  });
  
  updateAchievementBadge();
  playSound('notification');
  createConfetti();
}

// Show achievement unlock notification
function showAchievementNotification(achievement) {
  let notif = document.createElement('div');
  notif.className = 'achievement-notification';
  
  notif.innerHTML = `
    <div class="achievement-notification-icon">${achievement.icon}</div>
    <div class="achievement-notification-content">
      <div class="achievement-notification-title"> Achievement Unlocked!</div>
      <div class="achievement-notification-name">${achievement.name}</div>
      <div class="achievement-notification-reward">
        ${achievement.reward.coins > 0 ? `+${achievement.reward.coins} ` : ''}
        ${achievement.reward.xp > 0 ? `+${achievement.reward.xp} XP` : ''}
      </div>
    </div>
  `;
  
  document.body.appendChild(notif);
  
  setTimeout(() => {
    notif.remove();
  }, 5000);
}

// Update badge on achievements button
function updateAchievementBadge() {
  let newUnlocks = 0;
  let lastSeen = parseInt(localStorage.getItem('achievementsSeen') || 0);
  
  if (unlockedAchievements.length > lastSeen) {
    newUnlocks = unlockedAchievements.length - lastSeen;
  }
  
  let ping = document.getElementById("achievementPing");
  if (newUnlocks > 0) {
    ping.textContent = newUnlocks;
    ping.style.display = 'flex';
  } else {
    ping.style.display = 'none';
  }
}

// Mark achievements as seen when modal opened
function markAchievementsSeen() {
  localStorage.setItem('achievementsSeen', unlockedAchievements.length);
  updateAchievementBadge();
}

// Track various stats for achievements
function trackGamePlayed(gameName) {
  if (!gamesPlayedList.includes(gameName)) {
    gamesPlayedList.push(gameName);
  }
  
  let totalGames = myProfile.gamesPlayed || 0;
  
  checkAchievement('first_game', 1);
  checkAchievement('games_10', totalGames);
  checkAchievement('games_50', totalGames);
  checkAchievement('games_100', totalGames);
  checkAchievement('games_500', totalGames);
  
  // Check if all minigames played
  let allMiniGames = ['snake', 'minesweeper', 'tetris', 'pong', 'breakout', 'flappy', 'memory', 'tictactoe', 'clicker', '2048'];
  let playedAll = allMiniGames.every(g => gamesPlayedList.includes(g));
  if (playedAll) {
    checkAchievement('minigames_all', 1);
  }
  
  saveAchievements();
}

function trackCoinsEarned(amount) {
  totalCoinsEarned += amount;
  
  checkAchievement('coins_100', totalCoinsEarned);
  checkAchievement('coins_500', totalCoinsEarned);
  checkAchievement('coins_1000', totalCoinsEarned);
  checkAchievement('coins_5000', totalCoinsEarned);
  checkAchievement('coins_10000', totalCoinsEarned);
  
  saveAchievements();
}

function trackXpEarned(amount) {
  totalXpEarned += amount;
  
  checkAchievement('xp_1000', totalXpEarned);
  checkAchievement('xp_10000', totalXpEarned);
  checkAchievement('xp_50000', totalXpEarned);
  
  saveAchievements();
}

function trackLevelUp(newLevel) {
  checkAchievement('level_5', newLevel);
  checkAchievement('level_10', newLevel);
  checkAchievement('level_25', newLevel);
  checkAchievement('level_50', newLevel);
  checkAchievement('level_100', newLevel);
}

function trackMessageSent() {
  let messages = myProfile.messagesSent || 0;
  
  checkAchievement('first_message', 1);
  checkAchievement('messages_50', messages);
  checkAchievement('messages_200', messages);
  checkAchievement('messages_500', messages);
  checkAchievement('messages_1000', messages);
}

function trackFriendAdded() {
  let friends = (myProfile.friends || []).length;
  
  checkAchievement('first_friend', 1);
  checkAchievement('friends_5', friends);
  checkAchievement('friends_10', friends);
  checkAchievement('friends_25', friends);
}

function trackProfileUpdated(type) {
  if (type === 'bio') checkAchievement('set_bio', 1);
  if (type === 'pic') checkAchievement('set_pic', 1);
  if (type === 'status') checkAchievement('set_status', 1);
}

function trackPurchase() {
  let items = (myProfile.inventory || []).length;
  
  checkAchievement('first_purchase', 1);
  checkAchievement('purchases_5', items);
  checkAchievement('purchases_15', items);
  
  // Check if owns all items
  if (items >= shopItems.length) {
    checkAchievement('purchases_all', 1);
  }
}

function trackMusicPlaylist() {
  let songs = musicPlaylist.length;
  checkAchievement('music_playlist', songs);
}

function trackFavorites() {
  let favs = favorites.length;
  checkAchievement('favorites_5', favs);
}


    
    // ===== INITIALIZATION =====
    async function init() {
      try {
        let savedTheme = localStorage.getItem("theme");
        if (savedTheme) {
          document.body.dataset.theme = savedTheme;
          document.getElementById("themeSelect").value = savedTheme;
        }

        let savedFont = localStorage.getItem("font");
        if (savedFont) {
          document.body.className = `font-${savedFont}`;
          document.getElementById("fontSelect").value = savedFont;
        }

        let savedParticles = localStorage.getItem("particles");
        if (savedParticles && savedParticles !== 'none') {
          changeParticles(savedParticles);
          document.getElementById("particleSelect").value = savedParticles;
        }

        let savedCompact = localStorage.getItem("compactMode") === 'true';
        if (savedCompact) {
          document.body.classList.add("compact-mode");
          document.getElementById("compactMode").checked = true;
        }

        let savedBg = localStorage.getItem("customBg");
        if (savedBg) {
          document.getElementById("customBg").style.backgroundImage = `url(${savedBg})`;
          document.getElementById("bgUrl").value = savedBg;
        }

        let savedPanic = localStorage.getItem("panicUrl");
        if (savedPanic) {
          document.getElementById("panicUrl").value = savedPanic;
          panicUrl = savedPanic;
        }

        document.getElementById("soundEnabled").checked = soundEnabled;
        document.getElementById("notifSound").checked = notifSound;
        document.getElementById("soundToggle").textContent = soundEnabled ? '' : '';

        loadCloak();
        document.getElementById("loadingQuote").textContent = getRandomQuote();

        renderGameCards();
        renderMiniGames();
        renderCasinoGames();

      } catch (e) {
        console.error("Settings load error:", e);
      }

      try {
        await checkFirstVisit();

        if (await checkIfBanned()) return;

        loadChat();
        loadTypingIndicators();
        loadAnnouncement();
        loadOnlineUsers();

        try {
          let users = await db.collection("users").get();
          document.getElementById("statTotalUsers").textContent = users.size;

          let msgs = await db.collection("chat").get();
          document.getElementById("statTotalMessages").textContent = msgs.size;
        } catch (e) {
          console.error("Stats load error:", e);
        }

        setInterval(loadOnlineUsers, 30000);

      } catch (e) {
        console.error("Firebase init error:", e);
        showNotification("Some features may be unavailable", 'warning');
      }

      setTimeout(() => {
        document.getElementById("loadingScreen").classList.add("hidden");
      }, 1500);
    }

    init();
  </script>
</body>
</html>
